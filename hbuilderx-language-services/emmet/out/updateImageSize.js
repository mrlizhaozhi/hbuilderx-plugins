"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.updateImageSize=void 0;const vscode_1=require("vscode"),path=require("path"),imageSizeHelper_1=require("./imageSizeHelper"),util_1=require("./util"),locateFile_1=require("./locateFile"),css_parser2_1=require("css-parser2"),parseDocument_1=require("./parseDocument");function updateImageSize(){if(!(0,util_1.validate)()||!vscode_1.window.activeTextEditor)return;const e=vscode_1.window.activeTextEditor,t=Array.from(e.selections).reverse().map((t=>{const n=t.isReversed?t.active:t.anchor;return(0,util_1.isStyleSheet)(e.document.languageId)?updateImageSizeCSSFile(e,n):updateImageSizeHTML(e,n)}));return Promise.all(t).then((t=>e.edit((e=>{t.forEach((t=>{t.forEach((t=>{e.replace(t.range,t.newText)}))}))}))))}function updateImageSizeHTML(e,t){const n=getImageHTMLNode(e,t),r=n&&getImageSrcHTML(n);return r?(0,locateFile_1.locateFile)(path.dirname(e.document.fileName),r).then(imageSizeHelper_1.getImageSize).then((n=>{const o=getImageHTMLNode(e,t);return o&&getImageSrcHTML(o)===r?updateHTMLTag(e,o,n.width,n.height):[]})).catch((e=>(console.warn("Error while updating image size:",e),[]))):updateImageSizeStyleTag(e,t)}function updateImageSizeStyleTag(e,t){return updateImageSizeCSS(e,t,(e=>{const n=e.document,r=(0,parseDocument_1.getRootNode)(n,!0),o=n.offsetAt(t),i=(0,util_1.getFlatNode)(r,o,!0);if(i&&"style"===i.name&&i.open&&i.close&&i.open.end<o&&i.close.start>o){const e=" ".repeat(i.open.end)+n.getText().substring(i.open.end,i.close.start),t=(0,css_parser2_1.default)(e),r=(0,util_1.getFlatNode)(t,o,!0);return r&&"property"===r.type?r:null}return null}))}function updateImageSizeCSSFile(e,t){return updateImageSizeCSS(e,t,getImageCSSNode)}function updateImageSizeCSS(e,t,n){const r=n(e,t),o=r&&getImageSrcCSS(e,r,t);return o?(0,locateFile_1.locateFile)(path.dirname(e.document.fileName),o).then(imageSizeHelper_1.getImageSize).then((r=>{const i=n(e,t);return i&&getImageSrcCSS(e,i,t)===o?updateCSSNode(e,i,r.width,r.height):[]})).catch((e=>(console.warn("Error while updating image size:",e),[]))):Promise.reject(new Error("No valid image source"))}function getImageHTMLNode(e,t){const n=e.document,r=(0,parseDocument_1.getRootNode)(n,!0),o=n.offsetAt(t),i=(0,util_1.getFlatNode)(r,o,!0);return i&&"img"===i.name.toLowerCase()?i:null}function getImageCSSNode(e,t){const n=e.document,r=(0,parseDocument_1.getRootNode)(n,!0),o=n.offsetAt(t),i=(0,util_1.getFlatNode)(r,o,!0);return i&&"property"===i.type?i:null}function getImageSrcHTML(e){const t=getAttribute(e,"src");if(t)return t.value.value}function getImageSrcCSS(e,t,n){if(!t)return;const r=findUrlToken(e,t,n);if(!r)return;let o=r.item(0);return o&&"string"===o.type&&(o=o.item(0)),o&&o.valueOf()}function updateHTMLTag(e,t,n,r){const o=e.document,i=getAttribute(t,"src");if(!i)return[];const a=getAttribute(t,"width"),u=getAttribute(t,"height"),s=getAttributeQuote(e,i),g=t.attributes[t.attributes.length-1].end;let d=[],l="";return a?d.push(new vscode_1.TextEdit((0,util_1.offsetRangeToVsRange)(o,a.value.start,a.value.end),String(n))):l+=` width=${s}${n}${s}`,u?d.push(new vscode_1.TextEdit((0,util_1.offsetRangeToVsRange)(o,u.value.start,u.value.end),String(r))):l+=` height=${s}${r}${s}`,l&&d.push(new vscode_1.TextEdit((0,util_1.offsetRangeToVsRange)(o,g,g),l)),d}function updateCSSNode(e,t,n,r){const o=e.document,i=t.parent,a=(0,util_1.getCssPropertyFromRule)(i,"width"),u=(0,util_1.getCssPropertyFromRule)(i,"height"),s=t.separator||": ",g=getPropertyDelimitor(e,t);let d=[];t.terminatorToken||d.push(new vscode_1.TextEdit((0,util_1.offsetRangeToVsRange)(o,t.end,t.end),";"));let l="";return a?d.push(new vscode_1.TextEdit((0,util_1.offsetRangeToVsRange)(o,a.valueToken.start,a.valueToken.end),`${n}px`)):l+=`${g}width${s}${n}px;`,u?d.push(new vscode_1.TextEdit((0,util_1.offsetRangeToVsRange)(o,u.valueToken.start,u.valueToken.end),`${r}px`)):l+=`${g}height${s}${r}px;`,l&&d.push(new vscode_1.TextEdit((0,util_1.offsetRangeToVsRange)(o,t.end,t.end),l)),d}function getAttribute(e,t){return t=t.toLowerCase(),e&&e.attributes.find((e=>e.name.toString().toLowerCase()===t))}function getAttributeQuote(e,t){const n=t.value?t.value.end:t.end,r=t.end;return n===r?"":e.document.getText().substring(n,r)}function findUrlToken(e,t,n){const r=e.document.offsetAt(n);for(let e,n=0,o=t.parsedValue.length;n<o;n++)if((0,util_1.iterateCSSToken)(t.parsedValue[n],(t=>!("url"===t.type&&t.start<=r&&t.end>=r)||(e=t,!1))),e)return e}function getPropertyDelimitor(e,t){let n;return(n=t.previousSibling||t.parent.contentStartToken)?e.document.getText().substring(n.end,t.start):(n=t.nextSibling||t.parent.contentEndToken)?e.document.getText().substring(t.end,n.start):""}exports.updateImageSize=updateImageSize;