"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DefaultCompletionItemProvider=void 0;const vscode=require("vscode"),vscode_css_languageservice_1=require("vscode-css-languageservice"),utils_1=require("../../utils"),abbreviationActions_1=require("./abbreviationActions"),parseDocument_1=require("./parseDocument"),util_1=require("./util");class DefaultCompletionItem extends vscode.CompletionItem{}class DefaultCompletionItemProvider{provideCompletionItems(e,t,i,n){const o=this.provideCompletionItemsInternal(e,t,n);if(o)return o.then((e=>{if(!e||!e.items.length)return this.lastCompletionType=void 0,e;const t=e.items[0],i=t.documentation?t.documentation.toString():"";return i.startsWith("<")?this.lastCompletionType="html":i.indexOf(":")>0&&i.endsWith(";")?this.lastCompletionType="css":this.lastCompletionType=void 0,e}));this.lastCompletionType=void 0}provideCompletionItemsInternal(e,t,i){var n,o;let s=vscode.workspace.getConfiguration().get("emmet.codeassist");if(void 0===s&&(s=!0),!s)return;const a=(0,util_1.getPackageJsonConfiguration)(),r=a.excludeLanguages?a.excludeLanguages:[];if(r.indexOf(e.languageId)>-1)return;if(("vue"===e.languageId||"nvue"===e.languageId)&&e.getText(new vscode.Range(new vscode.Position(t.line,0),t)).replace(/\s/g,"").includes("<style"))return;if(("vue"===e.languageId||"nvue"===e.languageId||"html"===e.languageId)&&e.getText(new vscode.Range(new vscode.Position(t.line,0),t)).replace(/\s/g,"").includes("{{"))return;const l=(0,util_1.getMappingForIncludedLanguages)(),d=!!l[e.languageId];let u=(0,util_1.getEmmetMode)(d?l[e.languageId]:e.languageId,l,r);if(!u||"never"===a.showExpandedAbbreviation||(d||"jsx"===u)&&"always"!==a.showExpandedAbbreviation)return;let c,g,m=u,p="html"===m||"jsx"===m||"xml"===m;const v=(0,util_1.toLSTextDocument)(e);t=e.validatePosition(t);const f=new vscode.Range(t.line,0,t.line,t.character);if(e.getText(f).trimStart().startsWith("//"))return;const h=(0,util_1.getEmmetHelper)();if("html"===m){if(i.triggerKind===vscode.CompletionTriggerKind.TriggerForIncompleteCompletions)switch(this.lastCompletionType){case"html":p=!1;break;case"css":p=!1,m="css"}if(p){const i=e.offsetAt(t),s=(0,parseDocument_1.getRootNode)(e,!0),a=(0,util_1.getHtmlFlatNode)(e.getText(),s,i,!1);if(a)if("script"===a.name){const e=a.attributes.find((e=>"type"===e.name.toString()));if(!e)return;{const t=e.value.toString();if("application/javascript"===t||"text/javascript"===t){if(!(0,abbreviationActions_1.getSyntaxFromArgs)({language:"javascript"}))return;p=!1}else util_1.allowedMimeTypesInScriptTag.includes(t)&&(p=!1)}}else if("style"===a.name)m="css",p=!1;else{const e=a.attributes.find((e=>"style"===e.name.toString()));e&&(null===(n=e.value)||void 0===n?void 0:n.start)<=i&&i<=(null===(o=e.value)||void 0===o?void 0:o.end)&&(m="css",p=!1)}}}const x=(0,util_1.isStyleSheet)(m)?{lookAhead:!1,syntax:"stylesheet"}:{lookAhead:!0,syntax:"markup"},b=h.extractAbbreviation(v,t,x);if(!b||!h.isAbbreviationValid(m,b.abbreviation))return;const _=e.offsetAt(t);if((0,util_1.isStyleSheet)(e.languageId)&&i.triggerKind!==vscode.CompletionTriggerKind.TriggerForIncompleteCompletions){if(p=!0,c=!0===a.optimizeStylesheetParsing&&e.lineCount>1e3?(0,util_1.parsePartialStylesheet)(e,t):(0,parseDocument_1.getRootNode)(e,!0),!c)return;g=(0,util_1.getFlatNode)(c,_,!0)}if(!(0,util_1.isStyleSheet)(e.languageId)&&(0,util_1.isStyleSheet)(m)&&i.triggerKind!==vscode.CompletionTriggerKind.TriggerForIncompleteCompletions){if(p=!0,c=(0,parseDocument_1.getRootNode)(e,!0),!c)return;let i=(0,util_1.getFlatNode)(c,_,!0),n=(0,util_1.getEmbeddedCssNodeIfAny)(e,i,t);g=(0,util_1.getFlatNode)(n,_,!0)}if(p&&!(0,abbreviationActions_1.isValidLocationForEmmetAbbreviation)(e,c,g,m,_,toRange(b.abbreviationRange)))return;let I=Promise.resolve();if(!(0,util_1.isStyleSheet)(m)&&("javascript"===e.languageId||"javascriptreact"===e.languageId||"typescript"===e.languageId||"typescriptreact"===e.languageId)){let t=b.abbreviation;I=t.startsWith("this.")?Promise.resolve(!0):vscode.commands.executeCommand("vscode.executeDocumentSymbolProvider",e.uri).then((e=>e&&e.find((e=>t===e.name||t.startsWith(e.name+".")&&!/>|\*|\+/.test(t)))))}return I.then((i=>{if(i)return;const n=(0,util_1.getEmmetConfiguration)(m),o=h.doComplete((0,util_1.toLSTextDocument)(e),t,m,n);if(o&&o.items&&1===o.items.length){if("widows: ;"===o.items[0].label)return;const i=e.getText(new vscode.Range(new vscode.Position(t.line,0),t));if("max-resolution: ;"===o.items[0].label&&!i.includes("media"))return;if(o.items[0].label.startsWith("@media")&&i.includes("saturate("))return}let s=[];return o&&o.items&&o.items.forEach((e=>{var t,i;let n=new DefaultCompletionItem(e.label);if(null===(t=e.documentation)||void 0===t?void 0:t.toString().startsWith("<")){let t=e.documentation.toString();e.documentation=t.replace(/</g,"&lt;").replace(/>/g,"&gt;")}n.documentation=e.documentation,n.detail=e.detail,n.insertText=new vscode.SnippetString(e.textEdit.newText);let o=e.textEdit.range;n.range=new vscode.Range(o.start.line,o.start.character,o.end.line,o.end.character),n.filterText=e.filterText,n.sortText=e.sortText,!0===a.showSuggestionsAsSnippets&&(n.kind=vscode.CompletionItemKind.Snippet);const r=e.documentation?e.documentation.toString():"";if(r.includes(":")){const e=r.indexOf(":"),t=r.substring(0,e).trim();let i=!1;const o=(0,vscode_css_languageservice_1.getDefaultCSSDataProvider)().provideProperties().find((e=>e.name===t));if(o&&o.restrictions){for(const e of o.restrictions){(0,utils_1.includesList)(e,utils_1.numberType)&&(i=!0);break}i&&(n.data={hxOption:{altMode:!0}})}}(null===(i=e.documentation)||void 0===i?void 0:i.toString().startsWith("&lt;"))&&e.label.includes("*")&&(n.data={hxOption:{altMode:!0}}),s.push(n)})),new vscode.CompletionList(s,!0)}))}}function toRange(e){return new vscode.Range(e.start.line,e.start.character,e.end.line,e.end.character)}exports.DefaultCompletionItemProvider=DefaultCompletionItemProvider;