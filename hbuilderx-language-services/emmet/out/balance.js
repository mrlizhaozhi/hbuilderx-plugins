"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.balanceIn=exports.balanceOut=void 0;const vscode=require("vscode"),util_1=require("./util"),parseDocument_1=require("./parseDocument");let balanceOutStack=[],lastBalancedSelections=[];function balanceOut(){balance(!0)}function balanceIn(){balance(!1)}function balance(e){if(!(0,util_1.validate)(!1)||!vscode.window.activeTextEditor)return;const t=vscode.window.activeTextEditor,n=t.document,o=(0,parseDocument_1.getRootNode)(n,!0);if(!o)return;const a=e?getRangeToBalanceOut:getRangeToBalanceIn;let s=t.selections.map((e=>a(n,o,e)));areSameSelections(lastBalancedSelections,t.selections)?e?areSameSelections(t.selections,s)||balanceOutStack.push(t.selections):balanceOutStack.length&&(s=balanceOutStack.pop()):balanceOutStack=e?[t.selections]:[],t.selections=s,lastBalancedSelections=t.selections}function getRangeToBalanceOut(e,t,n){const o=e.offsetAt(n.start),a=(0,util_1.getHtmlFlatNode)(e.getText(),t,o,!1);if(!a)return n;if(!a.open||!a.close)return(0,util_1.offsetRangeToSelection)(e,a.start,a.end);let s,l;return a.close.start<=o&&a.close.end>o?(s=(0,util_1.offsetRangeToSelection)(e,a.close.start,a.open.end),l=(0,util_1.offsetRangeToSelection)(e,a.close.end,a.open.start)):(s=(0,util_1.offsetRangeToSelection)(e,a.open.end,a.close.start),l=(0,util_1.offsetRangeToSelection)(e,a.open.start,a.close.end)),s.contains(n)&&!s.isEqual(n)?s:l.contains(n)&&!l.isEqual(n)?l:n}function getRangeToBalanceIn(e,t,n){const o=e.offsetAt(n.start),a=(0,util_1.getHtmlFlatNode)(e.getText(),t,o,!0);if(!a)return n;const s=e.offsetAt(n.start),l=e.offsetAt(n.end);if(a.open&&a.close){const t=s===a.start&&l===a.end,n=s>a.open.start&&s<a.open.end,o=s>a.close.start&&s<a.close.end;if(t||n||o)return(0,util_1.offsetRangeToSelection)(e,a.open.end,a.close.start)}if(!a.firstChild)return n;const c=a.firstChild;return s===c.start&&l===c.end&&c.open&&c.close?(0,util_1.offsetRangeToSelection)(e,c.open.end,c.close.start):(0,util_1.offsetRangeToSelection)(e,c.start,c.end)}function areSameSelections(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!e[n].isEqual(t[n]))return!1;return!0}exports.balanceOut=balanceOut,exports.balanceIn=balanceIn;