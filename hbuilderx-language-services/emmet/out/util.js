"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSyntaxes=exports.getPathBaseName=exports.toLSTextDocument=exports.isNumber=exports.isStyleAttribute=exports.getEmbeddedCssNodeIfAny=exports.getCssPropertyFromDocument=exports.getCssPropertyFromRule=exports.iterateCSSToken=exports.getEmmetConfiguration=exports.getPackageJsonConfiguration=exports.sameNodes=exports.getNodesInBetween=exports.findPrevWord=exports.findNextWord=exports.getDeepestFlatNode=exports.offsetRangeToVsRange=exports.offsetRangeToSelection=exports.isOffsetInsideOpenOrCloseTag=exports.setupCdataNodeSubtree=exports.setupScriptNodeSubtree=exports.getHtmlFlatNode=exports.allowedMimeTypesInScriptTag=exports.getFlatNode=exports.parsePartialStylesheet=exports.getEmmetMode=exports.getMappingForIncludedLanguages=exports.validate=exports.isStyleSheet=exports.LANGUAGE_MODES=exports.migrateEmmetExtensionsPath=exports.updateEmmetExtensionsPath=exports.getEmmetHelper=exports.setHomeDir=void 0;const css_parser2_1=require("css-parser2"),html_matcher_1=require("@emmetio/html-matcher"),vscode=require("vscode"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),bufferStream_1=require("./bufferStream"),parseDocument_1=require("./parseDocument");let _emmetHelper,_currentExtensionsPath,_homeDir;function setHomeDir(e){_homeDir=e}function getEmmetHelper(){return _emmetHelper||(_emmetHelper=require("@vscode/emmet-helper")),_emmetHelper}function updateEmmetExtensionsPath(e=!1){var t;const s=getEmmetHelper();let r=[];if(r||(r=[]),e||_currentExtensionsPath!==r){_currentExtensionsPath=r;const e=(null===(t=vscode.workspace.workspaceFolders)||void 0===t?void 0:t.length)?vscode.workspace.workspaceFolders.map((e=>e.uri)):void 0,o=vscode.workspace.fs;s.updateExtensionsPath(r,o,e,_homeDir).catch((e=>{Array.isArray(r)&&r.length&&vscode.window.showErrorMessage(e.message)}))}}function migrateEmmetExtensionsPath(){}function isStyleSheet(e){return["css","scss","sass","less","stylus"].includes(e)}function validate(e=!0){let t=vscode.window.activeTextEditor;return t?!(!e&&isStyleSheet(t.document.languageId)):(console.error("Emmet Error: No editor is active. (util.ts.ts::validate)"),!1)}function getMappingForIncludedLanguages(){const e={},t=Object.assign({},{handlebars:"html",php:"html",vue:"html"},{});return Object.keys(t).forEach((s=>{"string"==typeof t[s]&&exports.LANGUAGE_MODES[t[s]]&&(e[s]=t[s])})),e}function getEmmetMode(e,t,s){if(!e||s.includes(e))return;"jsx-tags"===e&&(e="javascriptreact"),t[e]&&(e=t[e]),/\b(typescriptreact|javascriptreact|jsx-tags)\b/.test(e)?e="jsx":"sass-indented"===e?e="sass":"jade"!==e&&"pug"!==e||(e="pug");const r=getSyntaxes();return r.markup.includes(e)||r.stylesheet.includes(e)?e:void 0}exports.setHomeDir=setHomeDir,exports.getEmmetHelper=getEmmetHelper,exports.updateEmmetExtensionsPath=updateEmmetExtensionsPath,exports.migrateEmmetExtensionsPath=migrateEmmetExtensionsPath,exports.LANGUAGE_MODES={html:["!",".","}",":","*","$","]","/",">","0","1","2","3","4","5","6","7","8","9"],jade:["!",".","}",":","*","$","]","/",">","0","1","2","3","4","5","6","7","8","9"],slim:["!",".","}",":","*","$","]","/",">","0","1","2","3","4","5","6","7","8","9"],haml:["!",".","}",":","*","$","]","/",">","0","1","2","3","4","5","6","7","8","9"],xml:[".","}","*","$","]","/",">","0","1","2","3","4","5","6","7","8","9"],xsl:["!",".","}","*","$","/","]",">","0","1","2","3","4","5","6","7","8","9"],css:[":","!","-","0","1","2","3","4","5","6","7","8","9"],scss:[":","!","-","0","1","2","3","4","5","6","7","8","9"],sass:[":","!","0","1","2","3","4","5","6","7","8","9"],less:[":","!","-","0","1","2","3","4","5","6","7","8","9"],stylus:[":","!","0","1","2","3","4","5","6","7","8","9"],javascriptreact:["!",".","}","*","$","]","/",">","0","1","2","3","4","5","6","7","8","9"],typescriptreact:["!",".","}","*","$","]","/",">","0","1","2","3","4","5","6","7","8","9"]},exports.isStyleSheet=isStyleSheet,exports.validate=validate,exports.getMappingForIncludedLanguages=getMappingForIncludedLanguages,exports.getEmmetMode=getEmmetMode;const closeBrace=125,openBrace=123,slash=47,star=42;function parsePartialStylesheet(e,t){const s="css"===e.languageId,r=e.offsetAt(t);let o=0,n=e.getText().length;const a=r-5e3,i=a>0?a:o,p=new bufferStream_1.DocumentStreamReader(e,r);function l(){const t=e.positionAt(p.pos).line;if(!s&&g!==t){g=t;const s=e.lineAt(g).text.indexOf("//");s>-1&&(p.pos=e.offsetAt(new vscode.Position(g,s)))}}function u(){var t;47===p.peek()&&(42===p.backUp(1)?p.pos=null!==(t=function(t){let s=e.getText().substring(0,t).lastIndexOf("/*");if(-1!==s)return s}(p.pos))&&void 0!==t?t:o:p.next())}function c(){var t;if(p.eat(47))if(p.eat(47)&&!s){const t=e.positionAt(p.pos).line;p.pos=e.offsetAt(new vscode.Position(t+1,0))}else p.eat(42)&&(p.pos=null!==(t=function(t){let s=e.getText().substring(t).indexOf("*/");if(-1!==s)return s+=2+t,s}(p.pos))&&void 0!==t?t:n)}for(;!p.eof()&&!p.eat(125);)47===p.peek()?c():p.next();p.eof()||(n=p.pos),p.pos=r;let d=1,g=t.line,f=!1;for(;!f&&d>0&&!p.sof();){switch(l(),p.backUp(1)){case 123:d--;break;case 125:s?(p.next(),o=p.pos,f=!0):d++;break;case 47:u()}(t.line-e.positionAt(p.pos).line>100||p.pos<=i)&&(f=!0)}g=e.positionAt(p.pos).line,d=0;let m=!1;for(;!f&&!p.sof()&&!m&&d>=0;){l();const e=p.backUp(1);if(!/\s/.test(String.fromCharCode(e))){switch(e){case 47:u();break;case 125:d++;break;case 123:d--;break;default:d||(m=!0)}!p.sof()&&m&&(o=p.pos)}}try{const t=" ".repeat(o)+e.getText().substring(o,n);return(0,css_parser2_1.default)(t)}catch(e){return}}function getFlatNode(e,t,s){if(e)return o(e.children);function r(e){var r;if(!e)return;const n=e.start,a=e.end;if(n<t&&a>t||s&&n<=t&&a>=t)return null!==(r=o(e.children))&&void 0!==r?r:e;if("close"in e){const t=e;if(t.open&&!t.close)return o(t.children)}}function o(e){for(let t=0;t<e.length;t++){const s=r(e[t]);if(s)return s}}}function getHtmlFlatNode(e,t,s,r){var o,n;let a=getFlatNode(t,s,r);if(a){if("script"===a.name&&0===a.children.length){const t=setupScriptNodeSubtree(e,a);t&&(a=null!==(o=getHtmlFlatNode(t,a,s,r))&&void 0!==o?o:a)}else if("cdata"===a.type){a=null!==(n=getHtmlFlatNode(setupCdataNodeSubtree(e,a),a,s,r))&&void 0!==n?n:a}return a}}function setupScriptNodeSubtree(e,t){if("script"===t.name&&t.attributes&&t.attributes.some((e=>"type"===e.name.toString()&&exports.allowedMimeTypesInScriptTag.includes(e.value.toString())))&&t.open){const s=" ".repeat(t.open.end),r=t.close?t.close.start:t.end,o=s+e.substring(t.open.end,r);return(0,html_matcher_1.default)(o).children.forEach((e=>{t.children.push(e),e.parent=t})),o}return""}function setupCdataNodeSubtree(e,t){const s=t.start+"<![CDATA[".length,r=t.end-"]]>".length,o=" ".repeat(s)+e.substring(s,r);return(0,html_matcher_1.default)(o).children.forEach((e=>{t.children.push(e),e.parent=t})),o}function isOffsetInsideOpenOrCloseTag(e,t){const s=e;return!!(s.open&&t>s.open.start&&t<s.open.end||s.close&&t>s.close.start&&t<s.close.end)}function offsetRangeToSelection(e,t,s){const r=e.positionAt(t),o=e.positionAt(s);return new vscode.Selection(r,o)}function offsetRangeToVsRange(e,t,s){const r=e.positionAt(t),o=e.positionAt(s);return new vscode.Range(r,o)}function getDeepestFlatNode(e){if(!e||!e.children||0===e.children.length||!e.children.find((e=>"comment"!==e.type)))return e;for(let t=e.children.length-1;t>=0;t--)if("comment"!==e.children[t].type)return getDeepestFlatNode(e.children[t])}function findNextWord(e,t){let s,r,o=-1===t,n=!1,a=!1;for(;t<e.length-1;)if(t++,o){if(!o||n||" "!==e[t])if(n){if(" "===e[t]){r=t,a=!0;break}}else s=t,n=!0}else" "===e[t]&&(o=!0);return n&&!a&&(r=e.length),[s,r]}function findPrevWord(e,t){let s,r,o=t===e.length,n=!1,a=!1;for(;t>-1;)if(t--,o){if(!o||a||" "!==e[t])if(a){if(" "===e[t]){s=t+1,n=!0;break}}else r=t+1,a=!0}else" "===e[t]&&(o=!0);return a&&!n&&(s=0),[s,r]}function getNodesInBetween(e,t){if(sameNodes(e,t))return[e];if(!sameNodes(e.parent,t.parent)){if(t.start<e.start)return[t];if(t.start<e.end)return[e];for(;e.parent&&e.parent.end<t.start;)e=e.parent;for(;t.parent&&t.parent.start>e.start;)t=t.parent}const s=[];let r=e;const o=t.end;for(;r&&o>r.start;)s.push(r),r=r.nextSibling;return s}function sameNodes(e,t){return!e&&!t||!(!e||!t)&&(e.start===t.start&&e.end===t.end)}function getPackageJsonConfiguration(){var e,t;let s=require("../package.json"),r={},o=null===(t=null===(e=null==s?void 0:s.contributes)||void 0===e?void 0:e.configuration)||void 0===t?void 0:t.properties;if(o)for(let e in o)r[e.substring(6)]=o[e].default;return r}function getEmmetConfiguration(e){const t=getPackageJsonConfiguration(),s=Object.assign({},t.syntaxProfiles||{}),r=Object.assign({},t.preferences||{});return"jsx"!==e&&"xml"!==e&&"xsl"!==e||(s[e]=s[e]||{},"object"!=typeof s[e]||s[e].hasOwnProperty("self_closing_tag")||s[e].hasOwnProperty("selfClosingStyle")||(s[e]=Object.assign(Object.assign({},s[e]),{selfClosingStyle:"jsx"===e?"xhtml":"xml"}))),{preferences:r,showExpandedAbbreviation:t.showExpandedAbbreviation,showAbbreviationSuggestions:t.showAbbreviationSuggestions,syntaxProfiles:s,variables:t.variables,excludeLanguages:t.excludeLanguages,showSuggestionsAsSnippets:t.showSuggestionsAsSnippets}}function iterateCSSToken(e,t){for(let s=0,r=e.size;s<r;s++)if(!1===t(e.item(s))||!1===iterateCSSToken(e.item(s),t))return!1;return!0}function getCssPropertyFromRule(e,t){return e.children.find((e=>"property"===e.type&&e.name===t))}function getCssPropertyFromDocument(e,t){const s=e.document,r=(0,parseDocument_1.getRootNode)(s,!0),o=s.offsetAt(t),n=getFlatNode(r,o,!0);if(isStyleSheet(e.document.languageId))return n&&"property"===n.type?n:null;const a=n;if(a&&"style"===a.name&&a.open&&a.close&&a.open.end<o&&a.close.start>o){const e=" ".repeat(a.start)+s.getText().substring(a.start,a.end),t=getFlatNode((0,css_parser2_1.default)(e),o,!0);return t&&"property"===t.type?t:null}return null}function getEmbeddedCssNodeIfAny(e,t,s){if(!t)return;const r=t;if(r&&r.open&&r.close){const t=e.offsetAt(s);if(r.open.end<t&&t<=r.close.start&&"style"===r.name){const t=" ".repeat(r.open.end)+e.getText().substring(r.open.end,r.close.start);return(0,css_parser2_1.default)(t)}}}function isStyleAttribute(e,t){if(!e)return!1;const s=e,r=(s.attributes||[]).findIndex((e=>"style"===e.name.toString()));if(-1===r)return!1;const o=s.attributes[r];return t>=o.value.start&&t<=o.value.end}function isNumber(e){return"number"==typeof e}function toLSTextDocument(e){return vscode_languageserver_textdocument_1.TextDocument.create(e.uri.toString(),e.languageId,e.version,e.getText())}function getPathBaseName(e){const t=e.split("/").pop(),s=t?t.split("\\").pop():"";return null!=s?s:""}function getSyntaxes(){return{markup:["html","xml","xsl","jsx","js","pug","slim","haml"],stylesheet:["css","sass","scss","less","sss","stylus"]}}exports.parsePartialStylesheet=parsePartialStylesheet,exports.getFlatNode=getFlatNode,exports.allowedMimeTypesInScriptTag=["text/html","text/plain","text/x-template","text/template","text/ng-template"],exports.getHtmlFlatNode=getHtmlFlatNode,exports.setupScriptNodeSubtree=setupScriptNodeSubtree,exports.setupCdataNodeSubtree=setupCdataNodeSubtree,exports.isOffsetInsideOpenOrCloseTag=isOffsetInsideOpenOrCloseTag,exports.offsetRangeToSelection=offsetRangeToSelection,exports.offsetRangeToVsRange=offsetRangeToVsRange,exports.getDeepestFlatNode=getDeepestFlatNode,exports.findNextWord=findNextWord,exports.findPrevWord=findPrevWord,exports.getNodesInBetween=getNodesInBetween,exports.sameNodes=sameNodes,exports.getPackageJsonConfiguration=getPackageJsonConfiguration,exports.getEmmetConfiguration=getEmmetConfiguration,exports.iterateCSSToken=iterateCSSToken,exports.getCssPropertyFromRule=getCssPropertyFromRule,exports.getCssPropertyFromDocument=getCssPropertyFromDocument,exports.getEmbeddedCssNodeIfAny=getEmbeddedCssNodeIfAny,exports.isStyleAttribute=isStyleAttribute,exports.isNumber=isNumber,exports.toLSTextDocument=toLSTextDocument,exports.getPathBaseName=getPathBaseName,exports.getSyntaxes=getSyntaxes;