"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.toggleComment=void 0;const vscode=require("vscode"),util_1=require("./util"),css_parser2_1=require("css-parser2"),parseDocument_1=require("./parseDocument");let startCommentStylesheet,endCommentStylesheet,startCommentHTML,endCommentHTML;function toggleComment(){if(!(0,util_1.validate)()||!vscode.window.activeTextEditor)return;setupCommentSpacing();const e=vscode.window.activeTextEditor,t=(0,parseDocument_1.getRootNode)(e.document,!0);return t?e.edit((n=>{let o=[];Array.from(e.selections).reverse().forEach((n=>{const s=(0,util_1.isStyleSheet)(e.document.languageId)?toggleCommentStylesheet(e.document,n,t):toggleCommentHTML(e.document,n,t);s.length>0&&o.push(s)})),o.sort(((e,t)=>{let n=e[0].range.start.line-t[0].range.start.line;return 0===n?e[0].range.start.character-t[0].range.start.character:n}));let s=new vscode.Position(0,0);for(const e of o)e[0].range.end.isAfterOrEqual(s)&&e.forEach((e=>{n.replace(e.range,e.newText),s=e.range.end}))})):void 0}function toggleCommentHTML(e,t,n){const o=t.isReversed?t.active:t.anchor,s=t.isReversed?t.anchor:t.active,r=e.offsetAt(o),a=e.offsetAt(s),i=e.getText(),d=(0,util_1.getHtmlFlatNode)(i,n,r,!0),l=(0,util_1.getHtmlFlatNode)(i,n,a,!0);if(!d||!l)return[];if((0,util_1.sameNodes)(d,l)&&"style"===d.name&&d.open&&d.close&&d.open.end<r&&d.close.start>a){const n=" ".repeat(d.open.end)+i.substring(d.open.end,d.close.start),o=(0,css_parser2_1.default)(n);return toggleCommentStylesheet(e,t,o)}let c=(0,util_1.getNodesInBetween)(d,l),m=[];return c.forEach((t=>{m=m.concat(getRangesToUnCommentHTML(t,e))})),"comment"===d.type||(m.push(new vscode.TextEdit((0,util_1.offsetRangeToVsRange)(e,c[0].start,c[0].start),startCommentHTML)),m.push(new vscode.TextEdit((0,util_1.offsetRangeToVsRange)(e,c[c.length-1].end,c[c.length-1].end),endCommentHTML))),m}function getRangesToUnCommentHTML(e,t){let n=[];return"comment"===e.type?(n.push(new vscode.TextEdit((0,util_1.offsetRangeToVsRange)(t,e.start,e.start+startCommentHTML.length),"")),n.push(new vscode.TextEdit((0,util_1.offsetRangeToVsRange)(t,e.end-endCommentHTML.length,e.end),"")),n):(e.children.forEach((e=>{n=n.concat(getRangesToUnCommentHTML(e,t))})),n)}function toggleCommentStylesheet(e,t,n){const o=t.isReversed?t.active:t.anchor,s=t.isReversed?t.anchor:t.active;let r=e.offsetAt(o),a=e.offsetAt(s);const i=(0,util_1.getFlatNode)(n,r,!0),d=(0,util_1.getFlatNode)(n,a,!0);t.isEmpty?i&&(r=i.start,a=i.end,t=(0,util_1.offsetRangeToSelection)(e,r,a)):(r=adjustStartNodeCss(i,r,n),a=adjustEndNodeCss(d,a,n),t=(0,util_1.offsetRangeToSelection)(e,r,a));let l=[],c=[];return n.comments.forEach((n=>{const o=(0,util_1.offsetRangeToVsRange)(e,n.start,n.end);t.intersection(o)&&(l.push(o),c.push(new vscode.TextEdit((0,util_1.offsetRangeToVsRange)(e,n.start,n.start+startCommentStylesheet.length),"")),c.push(new vscode.TextEdit((0,util_1.offsetRangeToVsRange)(e,n.end-endCommentStylesheet.length,n.end),"")))})),c.length>0?c:[new vscode.TextEdit(new vscode.Range(t.start,t.start),startCommentStylesheet),new vscode.TextEdit(new vscode.Range(t.end,t.end),endCommentStylesheet)]}function setupCommentSpacing(){startCommentStylesheet="/* ",endCommentStylesheet=" */",startCommentHTML="\x3c!-- ",endCommentHTML=" --\x3e"}function adjustStartNodeCss(e,t,n){for(const e of n.comments)if(e.start<=t&&t<=e.end)return t;if(!e)return t;if("property"===e.type)return e.start;const o=e;if(t<o.contentStartToken.end||!o.firstChild)return o.start;if(t<o.firstChild.start)return t;let s=o.firstChild;for(;s.nextSibling&&t>s.end;)s=s.nextSibling;return s.start}function adjustEndNodeCss(e,t,n){for(const e of n.comments)if(e.start<=t&&t<=e.end)return t;if(!e)return t;if("property"===e.type)return e.end;const o=e;if(t===o.contentEndToken.end||!o.firstChild)return o.end;if(t>o.children[o.children.length-1].end)return t;let s=o.children[o.children.length-1];for(;s.previousSibling&&t<s.start;)s=s.previousSibling;return s.end}exports.toggleComment=toggleComment;