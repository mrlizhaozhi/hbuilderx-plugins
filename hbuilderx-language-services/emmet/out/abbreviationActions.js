"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,a){function o(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getSyntaxFromArgs=exports.isValidLocationForEmmetAbbreviation=exports.expandEmmetAbbreviation=exports.wrapWithAbbreviation=void 0;const vscode=require("vscode"),nls=require("vscode-nls"),parseDocument_1=require("./parseDocument"),util_1=require("./util"),localize=nls.loadMessageBundle(),trimRegex=/[\u00a0]*[\d#\-\*\u2022]+\.?/,hexColorRegex=/^#[\da-fA-F]{0,6}$/;function wrapWithAbbreviation(e){return __awaiter(this,void 0,void 0,(function*(){if(!(0,util_1.validate)(!1))return!1;const t=vscode.window.activeTextEditor,n=t.document;(e=e||{}).language||(e.language=n.languageId);const r=getSyntaxFromArgs(e)||"html",i=(0,parseDocument_1.getRootNode)(n,!0),a=(0,util_1.getEmmetHelper)(),o=Array.from(t.selections).sort(((e,t)=>e.start.compareTo(t.start))).map((e=>{let t=e;{let{start:e,end:r}=t;const a=n.offsetAt(e),o=n.getText(),s=(0,util_1.getHtmlFlatNode)(o,i,a,!0);if(s&&(0,util_1.isOffsetInsideOpenOrCloseTag)(s,a)){e=n.positionAt(s.start);const t=n.positionAt(s.end);r=t.isAfter(r)?t:r}const c=n.offsetAt(r),l=(0,util_1.getHtmlFlatNode)(o,i,c,!0);if(l&&(0,util_1.isOffsetInsideOpenOrCloseTag)(l,c)){const t=n.positionAt(l.start);e=t.isBefore(e)?t:e;const i=n.positionAt(l.end);r=i.isAfter(r)?i:r}t=new vscode.Range(e,r)}if(!t.isSingleLine&&0===t.end.character){const e=t.end.line-1;t=new vscode.Range(t.start,n.lineAt(e).range.end)}t.isEmpty&&(t=n.lineAt(t.start).range);const r=n.lineAt(t.start);return!r.isEmptyOrWhitespace&&r.firstNonWhitespaceCharacterIndex>t.start.character&&(t=t.with(new vscode.Position(t.start.line,r.firstNonWhitespaceCharacterIndex))),t})).reduce(((e,t)=>(e.length>0&&t.intersection(e[e.length-1])?e.push(t.union(e.pop())):e.push(t),e)),[]),s=t.selections;t.selections=o.map((e=>new vscode.Selection(e.start,e.end)));const c=o.map((e=>{let t;const r=n.getText(e),i=n.lineAt(e.start).text.match(/^(\s*)/),a=i?i[1]:"";return t=e.isSingleLine?[r]:r.split("\n"+a).map((e=>e.trimEnd())),t=t.map((e=>e.replace(/(\$\d)/g,"\\$1"))),{previewRange:e,originalRange:e,originalContent:r,textToWrapInPreview:t,baseIndent:a}})),{tabSize:l,insertSpaces:d}=t.options,u=d?" ".repeat(l):"\t";function p(){return t.edit((e=>{for(const t of c)e.replace(t.previewRange,t.originalContent),t.previewRange=t.originalRange}),{undoStopBefore:!1,undoStopAfter:!1})}let g=!1;function f(e,n){return __awaiter(this,void 0,void 0,(function*(){const i=!!e&&!!e.trim()&&a.isAbbreviationValid(r,e)?a.extractAbbreviationFromText(e,r):void 0;if(!i)return g&&(g=!1,yield p()),!1;const{abbreviation:o,filter:s}=i;if(n){const e=c.map((e=>({syntax:r,abbreviation:o,rangeToReplace:e.originalRange,textToWrap:e.textToWrapInPreview,filter:s,indent:u,baseIndent:e.baseIndent})));return g=!0,function(e){let n=new vscode.Range(0,0,0,0),r=new vscode.Range(0,0,0,0),i=0;return t.edit((t=>{for(let a=0;a<c.length;a++){const o=expandAbbr(e[a])||"";if(!o)break;const s=c[a].previewRange,l=o.replace(/\$\{[\d]*\}/g,"|").replace(/\$\{[\d]*:([^}]*)\}/g,((e,t)=>t)).replace(/\\\$/g,"$");t.replace(s,l);const d=l.split("\n"),u=s.end.line-s.start.line+1,p=d.length-u,g=s.start.line+i;let f=s.start.character;const v=s.end.line+i+p;let m=d[d.length-1].length;a>0&&v===r.end.line?(f=r.end.character+(s.start.character-n.end.character),m+=f):a>0&&g===r.end.line?f=r.end.character+(s.start.character-n.end.character):1===d.length&&(m+=s.start.character),n=c[a].previewRange,r=new vscode.Range(g,f,v,m),c[a].previewRange=r,i+=p}}),{undoStopBefore:!1,undoStopAfter:!1})}(e)}const l=c.map((e=>({syntax:r,abbreviation:o,rangeToReplace:e.originalRange,textToWrap:e.textToWrapInPreview,filter:s,indent:u})));return g&&(g=!1,yield p()),expandAbbreviationInRange(t,l,!1)}))}let v="";const m=localize("wrapWithAbbreviationPrompt","Enter Abbreviation"),b=e&&e.abbreviation?e.abbreviation:yield vscode.window.showInputBox({prompt:m,validateInput:function(e){return e!==v&&(v=e,f(e,!0)),""}}),x=yield f(b,!1);return x||(t.selections=s),x}))}function expandEmmetAbbreviation(e){let t=vscode.workspace.getConfiguration().get("emmet.codeassist");if(void 0===t&&(t=!0),!t)return fallbackTab();if(!(0,util_1.validate)()||!vscode.window.activeTextEditor)return fallbackTab();if(1===vscode.window.activeTextEditor.selections.length&&vscode.window.activeTextEditor.selection.isEmpty){const e=vscode.window.activeTextEditor.selection.anchor;if(0===e.character)return fallbackTab();const t=e.translate(0,-1),n=vscode.window.activeTextEditor.document.getText(new vscode.Range(t,e));if(" "===n||"\t"===n)return fallbackTab()}if((e=e||{}).language){const e=(0,util_1.getPackageJsonConfiguration)();if((e.excludeLanguages?e.excludeLanguages:[]).indexOf(vscode.window.activeTextEditor.document.languageId)>-1)return fallbackTab()}else e.language=vscode.window.activeTextEditor.document.languageId;let n=getSyntaxFromArgs(e);if(!n)return fallbackTab();const r=vscode.window.activeTextEditor;if(r.selections.find((e=>!e.isEmpty)))return fallbackTab();const i=[];let a,o=!0;const s=(0,util_1.getEmmetHelper)(),c=r.selections.slice(0);let l;function d(){if(l)return l;const e=!0===(0,util_1.getPackageJsonConfiguration)().optimizeStylesheetParsing;return l=1===r.selections.length&&(0,util_1.isStyleSheet)(r.document.languageId)&&e&&r.document.lineCount>1e3?(0,util_1.parsePartialStylesheet)(r.document,r.selection.isReversed?r.selection.anchor:r.selection.active):(0,parseDocument_1.getRootNode)(r.document,!0),l}return c.sort(((e,t)=>{const n=e.isReversed?e.anchor:e.active,r=t.isReversed?t.anchor:t.active;return-1*n.compareTo(r)})),c.forEach((t=>{const c=t.isReversed?t.anchor:t.active;if("vue"===e.language){const e=r.document,t=e.offsetAt(c),i=(0,parseDocument_1.getRootNode)(e,!0),a=(0,util_1.getHtmlFlatNode)(e.getText(),i,t,!1);"style"===(null==a?void 0:a.name)&&(n="css")}const[l,u,p]=((e,t,n,i)=>{n=e.validatePosition(n);let a=t,o=e.getText(a);if(!a.isEmpty){const e=s.extractAbbreviationFromText(o,i);return e?[a,e.abbreviation,e.filter]:[null,"",""]}const c=r.document.lineAt(n.line).text.substr(0,n.character);if("html"===i){const e=c.match(/<(\w+)$/);if(e)return o=e[1],a=new vscode.Range(n.translate(0,-(o.length+1)),n),[a,o,""]}const l=s.extractAbbreviation((0,util_1.toLSTextDocument)(r.document),n,{lookAhead:!1});if(!l)return[null,"",""];const{abbreviationRange:d,abbreviation:u,filter:p}=l;return[new vscode.Range(d.start.line,d.start.character,d.end.line,d.end.character),u,p]})(r.document,t,c,n);if(!l)return;if(!s.isAbbreviationValid(n,u))return;if((0,util_1.isStyleSheet)(n)&&u.endsWith(":"))return;const g=r.document.offsetAt(c);let f=(0,util_1.getFlatNode)(d(),g,!0),v=!0,m=n;if("html"===r.document.languageId)if((0,util_1.isStyleAttribute)(f,g))m="css",v=!1;else{const e=(0,util_1.getEmbeddedCssNodeIfAny)(r.document,f,c);e&&(f=(0,util_1.getFlatNode)(e,g,!0),m="css")}v&&!isValidLocationForEmmetAbbreviation(r.document,d(),f,m,g,l)||(a?o&&a!==u&&(o=!1):a=u,i.push({syntax:m,abbreviation:u,rangeToReplace:l,filter:p}))})),expandAbbreviationInRange(r,i,o).then((e=>e?Promise.resolve(!0):fallbackTab()))}function fallbackTab(){return Promise.resolve(!1)}function isValidLocationForEmmetAbbreviation(e,t,n,r,i,a){if((0,util_1.isStyleSheet)(r)){const o=t;if(o&&(o.comments||[]).some((e=>i>=e.start&&i<=e.end)))return!1;if(!n)return!0;const s=e.getText(new vscode.Range(a.start.line,a.start.character,a.end.line,a.end.character));if(s.startsWith("@"))return!0;if("sass"!==r&&"stylus"!==r&&"property"===n.type){if(n.parent&&"rule"!==n.parent.type&&"at-rule"!==n.parent.type)return!1;const e=n;if(e.terminatorToken&&e.separator&&i>=e.separatorToken.end&&i<=e.terminatorToken.start&&-1===s.indexOf(":"))return hexColorRegex.test(s)||"!"===s;if(!e.terminatorToken&&e.separator&&i>=e.separatorToken.end&&-1===s.indexOf(":"))return hexColorRegex.test(s)||"!"===s;if(hexColorRegex.test(s)||"!"===s)return!1}if("rule"!==n.type&&"at-rule"!==n.type)return!0;const c=n;if(i>c.contentStartToken.end)return!0;if(c.parent&&("rule"===c.parent.type||"at-rule"===c.parent.type)&&c.selectorToken){const t=e.positionAt(i),n=e.positionAt(c.selectorToken.start),r=e.positionAt(c.selectorToken.end);if(t.line!==r.line&&n.character===a.start.character&&n.line===a.start.line)return!0}return!1}const o="<",s=n;let c=0;if(s){if("script"===s.name){const e=(s.attributes||[]).filter((e=>"type"===e.name.toString()))[0],t=e?e.value.toString():"";if(util_1.allowedMimeTypesInScriptTag.indexOf(t)>-1)return!0;return!!(!t||"application/javascript"===t||"text/javascript"===t)&&!!getSyntaxFromArgs({language:"javascript"})}if(!s.open||!s.close||!(s.open.end<=i&&i<=s.close.start))return!1;c=s.open.end;let e=s.firstChild;for(;e&&!(e.end>i);)c=e.end,e=e.nextSibling}const l=e.positionAt(c);let d=e.getText(new vscode.Range(l.line,l.character,a.start.line,a.start.character));if(d.length>500&&(d=d.substr(d.length-500)),!d.trim())return!0;let u=!0,p=!1,g=d.length-1;if(d[g]===o)return!1;for(;g>=0;){const e=d[g];if(g--,p||!/\s/.test(e))if("?"!==e||d[g]!==o){if(/\s/.test(e)&&d[g]===o)g--;else if(e===o||">"===e)if(g>=0&&"\\"===d[g])g--;else{if(">"===e){if(g>=0&&"="===d[g])continue;break}if(e===o){u=!p;break}}}else g--;else p=!0}return u}function expandAbbreviationInRange(e,t,n){if(!t||0===t.length)return Promise.resolve(!1);const r=[];if(!n)return t.sort(((e,t)=>t.rangeToReplace.start.compareTo(e.rangeToReplace.start))).forEach((t=>{const n=expandAbbr(t);n&&r.push(e.insertSnippet(new vscode.SnippetString(n),t.rangeToReplace,{undoStopBefore:!1,undoStopAfter:!1}))})),0===r.length?Promise.resolve(!1):Promise.all(r).then((()=>Promise.resolve(!0)));const i=expandAbbr(t[0]),a=t.map((e=>e.rangeToReplace));return i?e.insertSnippet(new vscode.SnippetString(i),a):Promise.resolve(!1)}function expandAbbr(e){const t=(0,util_1.getEmmetHelper)(),n=t.getExpandOptions(e.syntax,(0,util_1.getEmmetConfiguration)(e.syntax),e.filter);let r;e.textToWrap&&(e.textToWrap=e.textToWrap.map((e=>e.replace(/\$\{/g,"\\${"))),e.filter&&e.filter.includes("t")&&(e.textToWrap=e.textToWrap.map((e=>e.replace(trimRegex,"").trim()))),n.text=e.textToWrap,n.options&&(e.rangeToReplace.isSingleLine||(n.options["output.inlineBreak"]=1),e.indent&&(n.options["output.indent"]=e.indent),e.baseIndent&&(n.options["output.baseIndent"]=e.baseIndent)));try{r=t.expandAbbreviation(e.abbreviation,n)}catch(e){console.error("[PluginHost] EMMEt: Failed to expand abbreviation")}return r}function getSyntaxFromArgs(e){var t,n;const r=(0,util_1.getMappingForIncludedLanguages)(),i=(0,util_1.getPackageJsonConfiguration)(),a=e.language,o=e.parentMode,s=i.excludeLanguages?i.excludeLanguages:[];if(s.includes(a))return;let c=(0,util_1.getEmmetMode)(null!==(t=r[a])&&void 0!==t?t:a,r,s);return c||(c=(0,util_1.getEmmetMode)(null!==(n=r[o])&&void 0!==n?n:o,r,s)),c}exports.wrapWithAbbreviation=wrapWithAbbreviation,exports.expandEmmetAbbreviation=expandEmmetAbbreviation,exports.isValidLocationForEmmetAbbreviation=isValidLocationForEmmetAbbreviation,exports.getSyntaxFromArgs=getSyntaxFromArgs;