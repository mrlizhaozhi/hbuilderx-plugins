"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.removeTag=void 0;const vscode=require("vscode"),parseDocument_1=require("./parseDocument"),util_1=require("./util");function removeTag(){if(!(0,util_1.validate)(!1)||!vscode.window.activeTextEditor)return;const e=vscode.window.activeTextEditor,t=e.document,n=(0,parseDocument_1.getRootNode)(t,!0);if(!n)return;let r=Array.from(e.selections).reverse().reduce(((t,r)=>t.concat(getRangesToRemove(e.document,n,r))),[]);return e.edit((e=>{r.forEach((t=>{e.delete(t)}))}))}function getRangesToRemove(e,t,n){const r=e.offsetAt(n.start),a=(0,util_1.getHtmlFlatNode)(e.getText(),t,r,!0);if(!a)return[];let i,o;if(a.open&&(i=(0,util_1.offsetRangeToVsRange)(e,a.open.start,a.open.end)),a.close&&(o=(0,util_1.offsetRangeToVsRange)(e,a.close.start,a.close.end)),i&&o){const t=new vscode.Range(i.end.line,i.end.character,o.start.line,o.start.character),n=new vscode.Range(i.start.line,i.start.character,o.end.line,o.end.character);if(""===e.getText(t).trim()&&"pre"!==a.name)return[n]}let s=[];if(i&&(s.push(i),o)){const t=calculateIndentAmountToRemove(e,i,o);let n,r;for(let a=i.start.line+1;a<o.start.line;a++)e.lineAt(a).isEmptyOrWhitespace||(s.push(new vscode.Range(a,0,a,t)),void 0===n&&(n=a),r=a);entireLineIsTag(e,o)&&r?s.push(new vscode.Range(r,e.lineAt(r).range.end.character,o.end.line,o.end.character)):s.push(o),entireLineIsTag(e,i)&&n&&(s[1]=new vscode.Range(i.start.line,i.start.character,n,e.lineAt(n).firstNonWhitespaceCharacterIndex),s.shift())}return s}function entireLineIsTag(e,t){if(t.start.line===t.end.line){const n=e.lineAt(t.start).text,r=e.getText(t);if(n.trim()===r)return!0}return!1}function calculateIndentAmountToRemove(e,t,n){const r=t.start.line,a=n.start.line,i=e.lineAt(r).firstNonWhitespaceCharacterIndex,o=e.lineAt(a).firstNonWhitespaceCharacterIndex;let s;for(let t=r+1;t<a;t++){const n=e.lineAt(t);if(!n.isEmptyOrWhitespace){const e=n.firstNonWhitespaceCharacterIndex;s=s?Math.min(s,e):e}}let c=0;return s&&(c=s<i||s<o?0:Math.min(s-i,s-o)),c}exports.removeTag=removeTag;