"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isFollowedBy=exports.isStringLiteral=exports.isImportElement=exports.isObjectLiteralKey=exports.findExportThisExpressionAtOffset=exports.findExportDefaultObjectExpressionAtKeyOffset=exports.inExportDefaultObjectExpression=exports.getTouchingPropertyName=exports.getTokenAtPosition=exports.getRelevantTokens=exports.getTypeName=exports.isInString=exports.getArgumentsSpecialStringType=void 0;const ts=require("typescript/lib/tsserverlibrary"),nodes_1=require("../common/nodes");function getArgumentsSpecialStringType(e,t,n){var o;let i=n.languageService.getSignatureHelpItems(e,t,void 0);if(i){let e=i.items;if(e.length>0){let t=e[0],n=i.argumentIndex;if((null==t?void 0:t.parameters)&&(null===(o=null==t?void 0:t.parameters)||void 0===o?void 0:o.length)>n){let e=t.parameters[n],o="";null==e||e.displayParts.forEach((e=>{o+=e.text}));let i=o.split(":");if(2===i.length){return i[1].split("|")}}}}return[]}function getTokenAtPosition(e,t){return getTokenAtPositionWorker(e,t,!0,void 0,!1)}function getTokenAtPositionWorker(e,t,n,o,i){let s=e;e:for(;;){for(const r of s.getChildren(e)){if((n?r.getFullStart():r.getStart(e,!0))>t)break;const l=r.getEnd();if(t<l||t===l&&(r.kind===ts.SyntaxKind.EndOfFileToken||i)){s=r;continue e}if(o&&l===t){const n=findPrecedingToken(t,e,r);if(n&&o(n))return n}}return s}}function isNonWhitespaceToken(e){return ts.isToken(e)}function some(e,t){if(e){if(!t)return e.length>0;for(const n of e)if(t(n))return!0}return!1}function binarySearchKey(e,t,n,o,i){if(!some(e))return-1;let s=i||0,r=e.length-1;for(;s<=r;){const i=s+(r-s>>1);switch(o(n(e[i],i),t)){case-1:s=i+1;break;case 0:return i;case 1:r=i-1}}return~s}function nodeHasTokens(e,t){return e.kind!==ts.SyntaxKind.EndOfFileToken&&0!==e.getWidth(t)}function findRightmostChildNodeWithTokens(e,t,n){for(let o=t-1;o>=0;o--){e[o];if(nodeHasTokens(e[o],n))return e[o]}}function findRightmostToken(e,t){if(isNonWhitespaceToken(e))return e;const n=e.getChildren(t);if(0===n.length)return e;const o=findRightmostChildNodeWithTokens(n,n.length,t);return o&&findRightmostToken(o,t)}function findPrecedingToken(e,t,n,o){const i=function n(i){if(isNonWhitespaceToken(i)&&i.kind!==ts.SyntaxKind.EndOfFileToken)return i;const s=i.getChildren(t),r=binarySearchKey(s,e,((e,t)=>t),((t,n)=>e<s[t].end?!s[t-1]||e>=s[t-1].end?0:1:-1));if(r>=0&&s[r]){const i=s[r];if(e<i.end){const l=i.getStart(t,!o);if(l>=e||!nodeHasTokens(i,t)){const e=findRightmostChildNodeWithTokens(s,r,t);return e&&findRightmostToken(e,t)}return n(i)}}const l=findRightmostChildNodeWithTokens(s,s.length,t);return l&&findRightmostToken(l,t)}(n||t);return i}function getRelevantTokens(e,t){console.log(`getRelevantTokens params: ${e}`);const n=findPrecedingToken(e,t);if(console.log(`previous token pos: ${null==n?void 0:n.pos}`),console.log(`previous token end: ${null==n?void 0:n.end}`),console.log(`previous token kind: ${null==n?void 0:n.kind}`),n&&e<=n.end&&(isMemberName(n)||isKeyword(n.kind))){console.log("getRelevatTokens enter if");const e=findPrecedingToken(n.getFullStart(),t,void 0);return console.log(`context token pos: ${null==e?void 0:e.pos}`),console.log(`context token end: ${null==e?void 0:e.end}`),{contextToken:e,previousToken:n}}return{contextToken:n,previousToken:n}}function isMemberName(e){return e.kind===ts.SyntaxKind.Identifier}function isKeyword(e){return ts.SyntaxKind.FirstKeyword<=e&&e<=ts.SyntaxKind.LastKeyword}function getTouchingPropertyName(e,t){return getTouchingToken(e,t,(e=>isPropertyNameLiteral(e)||isKeyword(e.kind)))}function getTouchingToken(e,t,n){return getTokenAtPositionWorker(e,t,!1,n,!1)}function isPropertyNameLiteral(e){switch(e.kind){case ts.SyntaxKind.Identifier:case ts.SyntaxKind.StringLiteral:case ts.SyntaxKind.NoSubstitutionTemplateLiteral:case ts.SyntaxKind.NumericLiteral:return!0;default:return!1}}function getLeftmostAccessExpression(e){for(;isAccessExpression(e);)e=e.expression;return e}function isAccessExpression(e){return e.kind===ts.SyntaxKind.PropertyAccessExpression||e.kind===ts.SyntaxKind.ElementAccessExpression}function nodeIsMissing(e){return void 0===e||e.pos===e.end&&e.pos>=0&&e.kind!==ts.SyntaxKind.EndOfFileToken}function isCallExpression(e){return e.kind===ts.SyntaxKind.CallExpression}function last(e){return e[e.length-1]}function isLiteralImportTypeNode(e){return ts.isImportTypeNode(e)&&ts.isLiteralTypeNode(e.argument)&&ts.isStringLiteral(e.argument.literal)}function isInRightSideOfInternalImportEqualsDeclaration(e){for(;e.parent.kind===ts.SyntaxKind.QualifiedName;)e=e.parent;return isInternalModuleImportEqualsDeclaration(e.parent)}function isInternalModuleImportEqualsDeclaration(e){return e.kind===ts.SyntaxKind.ImportEqualsDeclaration&&e.moduleReference.kind!==ts.SyntaxKind.ExternalModuleReference}function skipAlias(e,t){return e.flags&ts.SymbolFlags.Alias?t.getAliasedSymbol(e):e}function symbolCanBeReferencedAtTypeLocation(e,t,n=new Map){const o=e;return!!(o.flags&ts.SymbolFlags.Type)||t.isUnknownSymbol(o)||!!(o.flags&ts.SymbolFlags.Module)&&t.getExportsOfModule(o).some((e=>symbolCanBeReferencedAtTypeLocation(e,t,n)))}function isInString(e,t,n=findPrecedingToken(t,e)){if(n&&isStringTextContainingNode(n)){const o=n.getStart(e),i=n.getEnd();if(o<t&&t<i)return!0;if(t===i)return!!n.isUnterminated}return!1}function isStringTextContainingNode(e){return e.kind===ts.SyntaxKind.StringLiteral||isTemplateLiteralKind(e.kind)}function isTemplateLiteralKind(e){return ts.SyntaxKind.FirstTemplateToken<=e&&e<=ts.SyntaxKind.LastTemplateToken}function getTypeName(e,t,n){const o=getRelevantTokens(n,t);o.previousToken;let i=o.contextToken;console.log(`context token start:  ${null==i?void 0:i.pos}`),console.log(`context token end: ${null==i?void 0:i.end}`),console.log(`context token kind:  ${null==i?void 0:i.kind}`);const s=e.getTypeChecker();let r,l=getTokenAtPosition(t,n),a=l,d=!1,c=!1;if(i){let e=i.parent;if(console.log(`parent kind: ${e.kind}`),console.log(`parent pos: ${e.pos}`),console.log(`parent end: ${e.end}`),i.kind===ts.SyntaxKind.DotToken||i.kind===ts.SyntaxKind.QuestionDotToken)switch(console.log("contextToken kind dot"),d=i.kind===ts.SyntaxKind.DotToken,c=i.kind===ts.SyntaxKind.QuestionDotToken,console.log(`parent kind: ${e.kind}`),e.kind){case ts.SyntaxKind.PropertyAccessExpression:console.log(`parent pos: ${e.pos}`),console.log(`parent end: ${e.end}`),r=e,a=r.expression;const n=getLeftmostAccessExpression(r);if(console.log(`node kind: ${a.kind}`),nodeIsMissing(n)||(isCallExpression(a)||ts.isFunctionLike(a))&&a.end===i.pos&&a.getChildCount(t)&&last(a.getChildren(t)).kind!==ts.SyntaxKind.CloseParenToken)return;break;case ts.SyntaxKind.QualifiedName:a=e.left;break;case ts.SyntaxKind.ModuleDeclaration:a=e.name;break;case ts.SyntaxKind.ImportType:a=e;break;case ts.SyntaxKind.MetaProperty:a=e.getFirstToken(t);break;default:return}}let p=!1,f=[];(d||c)&&function(){var e;console.log("get typescript member symbol");const t=isLiteralImportTypeNode(a),n=t&&!a.isTypeOf,o=isInRightSideOfInternalImportEqualsDeclaration(a);if(ts.isEntityName(a)||t||ts.isPropertyAccessExpression(a)){console.log("entity name");const i=ts.isModuleDeclaration(a.parent);i&&(p=!0);let r=s.getSymbolAtLocation(a);if(console.log(`symbol node start: ${a.pos}`),console.log(`symbol node end: ${a.end}`),console.log(`symbol node kind: ${a.kind}`),console.log(`symbol node flags: ${a.flags}`),console.log(`symbol text: ${r.escapedName}`),r){console.log("enter symbol if"),console.log(`symbol flags: ${r.flags}`),console.log(`symbol declarations length: ${r.declarations.length}`);{console.log("enter symbol second if");const l=s.getExportsOfModule(r),d=e=>s.isValidPropertyAccess(t?a:a.parent,e.name),c=e=>symbolCanBeReferencedAtTypeLocation(e,s),p=i?e=>{var t;return!!(e.flags&ts.SymbolFlags.Namespace)&&!(null===(t=e.declarations)||void 0===t?void 0:t.every((e=>e.parent===a.parent)))}:o?e=>c(e)||d(e):n?c:d;for(const e of l)p(e)&&f.push(e);if(//!isTypeLocation &&
r.declarations&&r.declarations.some((e=>e.kind!==ts.SyntaxKind.SourceFile&&e.kind!==ts.SyntaxKind.ModuleDeclaration&&e.kind!==ts.SyntaxKind.EnumDeclaration))){console.log("enter symbol third if");let t=s.getTypeOfSymbolAtLocation(r,a);t.getSymbol()&&console.log("type is: ",null===(e=t.getSymbol())||void 0===e?void 0:e.escapedName)}}}}}()}function findExportThisExpressionAtOffset(e,t){if(!e)return;if(e.statements.find(ts.isExportAssignment)){let n=getTokenAtPosition(e,t-1);if(n.getStart()<=t&&t<=n.getEnd()){let n=(0,nodes_1.findNodePathByOffset)(e,t);for(let e=n.length-1;e>=0;--e){let o=n[e];if(o.getStart()<=t&&t<=o.getEnd()&&(o.kind==ts.SyntaxKind.CallExpression||o.kind==ts.SyntaxKind.ElementAccessExpression||o.kind==ts.SyntaxKind.PropertyAccessExpression)){if(o.expression){let e=o.parent;for(;e&&e.kind!==ts.SyntaxKind.ExportAssignment&&e.kind!==ts.SyntaxKind.FunctionDeclaration;)e=e.parent;if(!e||e.kind!=ts.SyntaxKind.FunctionDeclaration)return o}}}}return n||void 0}}function findExportDefaultObjectExpressionAtKeyOffset(e,t){if(!e)return;let n=e.statements.find(ts.isExportAssignment);if(n){let e=n.expression;if(e&&ts.isObjectLiteralExpression(e)&&e.pos<=t&&e.end>=t){let n=e.properties,o=n.find((n=>{if(!(n.pos>t||n.end<t))return n.name&&n.name.pos<=t&&n.name.end>=t?e:void 0})),i=n.length>0?n[n.length-1]:void 0;if(o||null==i||i.end<t)return e}}}function inExportDefaultObjectExpression(e,t){return void 0!==findExportDefaultObjectExpressionAtKeyOffset(e,t)}function isStringLiteral(e,t){let n=getTokenAtPosition(e,t);if((null==n?void 0:n.kind)===ts.SyntaxKind.StringLiteral){return{isInString:!0,flag:n.getText().startsWith("'")?"'":'"'}}return{isInString:!1}}function isObjectLiteralKey(e,t){let n=getTokenAtPosition(e,t);for(;n&&!ts.isSourceFile(n)&&!ts.isObjectLiteralExpression(n);)n=n.parent;if(n&&ts.isObjectLiteralExpression(n)){let e=n.properties,o=e.find((e=>!(e.pos>t||e.end<t)&&!!(e.name&&e.name.pos<=t&&e.name.end>=t))),i=e.length>0?e[e.length-1]:void 0;if(o||null==i||i.end<t)return!0}return!1}function isImportElement(e,t){let n=getTokenAtPosition(e,t);return!(!n.parent||n.parent.kind!=ts.SyntaxKind.NamedImports&&n.parent.kind!=ts.SyntaxKind.ImportSpecifier&&!isJSX(n))||(!(!n||!n.parent||n.parent.kind!==ts.SyntaxKind.ObjectBindingPattern&&n.parent.kind!==ts.SyntaxKind.BindingElement)||!(!n||n.kind!==ts.SyntaxKind.ObjectBindingPattern))}function isFollowedBy(e,t,n){let o=getTokenAtPosition(e,t);if(o){if(ts.createScanner(ts.ScriptTarget.ESNext,!0,ts.LanguageVariant.Standard,e.text,void 0,o.end).scan()===ts.SyntaxKind.OpenParenToken)return!0}return!1}function isJSX(e){return(e.kind===ts.SyntaxKind.JsxText||e.kind===ts.SyntaxKind.Identifier)&&(e.parent.kind===ts.SyntaxKind.JsxSelfClosingElement||e.parent.kind===ts.SyntaxKind.JsxElement)}exports.getArgumentsSpecialStringType=getArgumentsSpecialStringType,exports.getTokenAtPosition=getTokenAtPosition,exports.getRelevantTokens=getRelevantTokens,exports.getTouchingPropertyName=getTouchingPropertyName,exports.isInString=isInString,exports.getTypeName=getTypeName,exports.findExportThisExpressionAtOffset=findExportThisExpressionAtOffset,exports.findExportDefaultObjectExpressionAtKeyOffset=findExportDefaultObjectExpressionAtKeyOffset,exports.inExportDefaultObjectExpression=inExportDefaultObjectExpression,exports.isStringLiteral=isStringLiteral,exports.isObjectLiteralKey=isObjectLiteralKey,exports.isImportElement=isImportElement,exports.isFollowedBy=isFollowedBy;