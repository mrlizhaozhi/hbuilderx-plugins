"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSClientDBNode=exports.ClientDBCollection=exports.ClientDBAliasParser=exports.ClientDBAliasTokenize=void 0;const typescript=require("typescript"),commonHandler_1=require("./commonHandler"),jsonc_1=require("jsonc");class ClientDBAliasTokenize{static isKey(e){return!(!/[0-9A-Za-z]/.test(e)&&-1==="-_$.".indexOf(e))}static isWhiteSpace(e){return/\s/.test(e)}static next(e,t){return e[++t]}static read(e,t){let s=t,i="",n=e[t];for(;this.isKey(n);){if(i+=n,t===e.length-1){t++;break}n=this.next(e,t),t++}return{tokenType:"IDENTIFIER",value:i,start:s,end:t-1}}static tokenize(e){let t=[],s=e.length-1,i=-1;for(;i<s&&i!==s-1;){let s=this.next(e,i);for(i++;this.isWhiteSpace(s);)s=this.next(e,i),i++;let n=i;if(this.KnownTokenTypes.has(s))t.push({tokenType:this.KnownTokenTypes.get(s),value:s,start:n,end:n+1});else{let s=this.read(e,i);t.push(s),i=s.end}}return t}}exports.ClientDBAliasTokenize=ClientDBAliasTokenize,ClientDBAliasTokenize.KnownTokenTypes=new Map([["{","LBRACE"],["}","RBRACE"],[",","COMMA"]]);class ClientDBAliasParser{static unexpectedToken(e){throw new Error(`field syntax error: ${e.value}`)}static toObject(e,t,s,i,n,r){if(0===e.length)return null;let l={};for(;e[0]<t-1;){let o=e[0],a=s[++o];if(!a)break;switch(-1===i.indexOf(a.tokenType)&&this.unexpectedToken(a),e[0]=o,a.tokenType){case"IDENTIFIER":switch(n){case"identifier":"as"!==a.value&&this.unexpectedToken(a),n="as";break;case"as":{"IDENTIFIER"!==a.tokenType&&this.unexpectedToken(a);const[e,t]=jsonc_1.jsonc.safe.parse(a.value);l[r]=e?a.value:t,n="";break}case"":{r=a.value,n="identifier";const[e,t]=jsonc_1.jsonc.safe.parse(r);l[r]=e?r:t;break}default:this.unexpectedToken(a)}(i=[]).push("IDENTIFIER","COMMA","LBRACE","RBRACE");break;case"LBRACE":{let o=r;n="",r="",(i=[]).push("IDENTIFIER"),l[o]=this.toObject(e,t,s,i,n,r);break}case"RBRACE":return n="",(i=[]).push("COMMA"),l;case"COMMA":n="",(i=[]).push("IDENTIFIER","RBRACE");break;default:this.unexpectedToken(a)}}return l}static parse(e){let t=ClientDBAliasTokenize.tokenize(e),s=t.length;return this.toObject([-1],s,t,["IDENTIFIER"],"","")}static transform(e){let t=Object.create(null);for(let s of Object.keys(e)){let i=e[s];if("object"==typeof i)t[s]=this.transform(i);else{const[e,n]=jsonc_1.jsonc.safe.parse(s);t[i]=e?s:n}}return t}}exports.ClientDBAliasParser=ClientDBAliasParser;class ClientDBCollection{constructor(e){this._name=e,this._properties=new Map}getName(){return this._name}setName(e){this._name=e}getProperties(){return this._properties}setProperties(e){this._properties=e}addProperty(e,t){this._properties.set(e,t)}}exports.ClientDBCollection=ClientDBCollection;class JSClientDBNode{constructor(e){this._projectPath=e}getCollections(){return this._collections}setCollections(e){e.length>0?this._collections=Array.from([e[0]]):this._collections=null}getFields(){return this._fields}setFields(e){this._fields=e}getWhere(){return this._where}setWhere(e){this._where=e}setGetone(e){this._getone=e}isGetone(){return this._getone}getVslots(){return this._vslots}setVslot(e){this._vslots=e}getDataStruct(){if(this._collections.length>0){if(this._fields){const e=ClientDBAliasParser.parse(this._fields);return this.isGetone()?JSON.stringify(ClientDBAliasParser.transform(e)):"["+JSON.stringify(ClientDBAliasParser.transform(e))+"]"}{let e=new Set;for(let t of this._collections){let s=this.parseSchema(t).getProperties();for(let t of s.keys())e.add(t)}if(e.size>0){let t=Array.from(e).join(",");return this.isGetone()?"{"+t.replace("{",":{")+"}":"[{"+t.replace("{",":{")+"}]"}}}}parseSchema(e){return(0,commonHandler_1.parseSchema)(e,this._projectPath)}getCollection(e,t){return(0,commonHandler_1.getCollection)(e,t,this._projectPath)}parseUniModuleSchema(e,t){return(0,commonHandler_1.parseUniModuleSchema)(e,t)}getFieldType(e,t){return(0,commonHandler_1.getFieldType)(e,t,this._projectPath)}computeVSlotDefaults(){let e=new Map,t="let"+this._vslots+"=__clientDBSlots__",s=typescript.createSourceFile("",t,typescript.ScriptTarget.Latest);if(s){let t=new Map([["error","new Error()"],["loading","loading=true"],["options","new Object()"],["pagination","new Object()"]]);if(s.statements.length>0){let i=s.statements[0];if(i.kind===typescript.SyntaxKind.VariableStatement){let s=i.declarationList.declarations;for(let i=0;i<s.length;++i){let n=s[i].name;if(n.kind===typescript.SyntaxKind.ObjectBindingPattern)for(let s=0;s<n.elements.length;++s){let i=n.elements[s];if(i.kind===typescript.SyntaxKind.BindingElement){let s=i.name;s.kind===typescript.SyntaxKind.Identifier&&("data"===s.escapedText?e.set("data",this.getDataStruct()):e.set(s.escapedText,t.get(s.escapedText)))}}}}}}return e}getFieldElements(e){let t=[];if(0==this._collections.length)return null;let s=e.split("/");if(s.length>0){let e=this.computeFields();for(let t of s){if(0==t.trim().length)continue;let s=e.get(t);s&&s.refCollection&&(e=s.refCollection.getProperties())}e.forEach(((e,s)=>{t.push({name:s,desc:e.desc,type:e.typeName,owningType:e.owningCollection})})),t.push({name:"as"})}return t}computeFields(){let e=new Map;for(let e of this._collections)try{let t=this.parseSchema(e.trim());if(t)return t.getProperties()}catch(e){}return e}}exports.JSClientDBNode=JSClientDBNode;