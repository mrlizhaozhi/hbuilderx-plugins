"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getVueThisLangusgeService=void 0;const path=require("path"),ts=require("typescript"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),indexlib_1=require("../../../indexlib"),string_1=require("../common/string"),type_resolve_1=require("../common/type-resolve"),ParseUtil_1=require("../languageserver/ParseUtil"),vueVersion_1=require("../vueParse/vueVersion"),cVueDataString="VueDataString",cVueEventString="VueEventString",cVuexCommitString="Store<any>.commit: Commit\n(type: string, payload?: any, options?: CommitOptions)",cVuexDispatchString="Store<any>.dispatch: Dispatch\n(type: string, payload?: any, options?: DispatchOptions)";let currentTextDocument=vscode_languageserver_textdocument_1.TextDocument.create("init","javascript",0,""),vueThisDocVersion=1;const vueThisDocProvider=function(){let e=new Map;return{get version(){return""+vueThisDocVersion},setDocuments(t){e.clear(),t.forEach((t=>{e.set(t.uri,t)}))},get documents(){let t=[];return e.forEach(((e,i)=>{t.push(i)})),t.push(),t},compilerOptions:{allowNonTsExtensions:!0,allowJs:!0,lib:["lib.esnext.d.ts"],target:ts.ScriptTarget.Latest,moduleResolution:ts.ModuleResolutionKind.Classic,experimentalDecorators:!1},getDocumentSnapshot(t){let i="";return e.has(t)&&(i=e.get(t).getText()),{getText:(e,t)=>i.substring(e,t),getLength:()=>i.length,getChangeRange:()=>{}}},hasDocument:t=>e.has(t),getDocumentVersion:t=>""+e.get(t).version}}();function makeFilePath(e,t){return vscode_uri_1.URI.file(path.join(e,t)).toString()}function getVueThisLangusgeService(e,t){var i;let n=e.createTSLanguageService(vueThisDocProvider);const o=Object.create(null);for(let e of Object.keys(n)){const t=n[e];o[e]=(...e)=>t.apply(n,e)}let r=e.fsPath,s=t.getText(),l=!1,a=n.getProgram();if(!a)return;let u=0,c=!1;if(t&&t.expression){let e=t.expression,n=a.getTypeChecker();if(e.kind==ts.SyntaxKind.ThisKeyword)c=!0;else{let t=0;for(;e.kind==ts.SyntaxKind.PropertyAccessExpression;)t++,e=e.expression;let o=n.getSymbolAtLocation(e);if(o&&o.valueDeclaration&&o.valueDeclaration.kind==ts.SyntaxKind.VariableDeclaration){u=(null===(i=null==e?void 0:e.getText())||void 0===i?void 0:i.length)||0;let n=o.valueDeclaration.initializer;(null==n?void 0:n.kind)==ts.SyntaxKind.ThisKeyword&&(l=!0,c=0==t)}}}if(!s.startsWith("this.")&&!l)return;let d=t.getSourceFile().statements.find(ts.isExportAssignment);if(!d||!ts.isObjectLiteralExpression(d.expression))return;let p="import { ComponentPublicInstance } from 'vue';\n\timport VueRouter, { Route } from 'vue-router';\n\timport { Store } from 'vuex';\n\tlet _vue: ComponentPublicInstance & {\t$route: Route; $router: VueRouter; } & { $store: Store<any>; };";2===(0,vueVersion_1.vueVersion)(r)&&(p="import Vue from 'vue';\n\t\timport VueRouter from 'vue-router';\n\t\timport Vuex from 'vuex';\n\t\tlet _vue: Vue;");let g=`import scriptExport from './__virtual-script.vue';\n\t${p}\n\tlet $$_dataType = scriptExport.data();\n\tlet $$_setupType = scriptExport.setup();\n\tlet $$_methods = scriptExport.methods;\n\tlet $$_props = scriptExport.props;\n\tlet $$_computed = scriptExport.computed;\n\t$$_dataType.;\n`,m=g.length-2;u=0==u?5:u+1;let f=g.length;g+="_vue."+s.slice(u)+";\r\n";let v=g.length,h="$e$t",x={start:v,end:v};vueThisDocVersion++;const S=t.getSourceFile().getFullText();let y=makeFilePath(r,"__virtual-script.vue.ts"),_=vscode_languageserver_textdocument_1.TextDocument.create(y,"typescript",vueThisDocVersion,S),D=makeFilePath(r,"interpolation-script.ts"),T=vscode_languageserver_textdocument_1.TextDocument.create(D,"typescript",vueThisDocVersion,g);if(vueThisDocProvider.setDocuments([_,T]),a=n.getProgram(),a){let e=a.getTypeChecker(),t=a.getSourceFile(T.uri);if(t){let i=e.getSymbolsInScope(t,ts.SymbolFlags.Variable);if(i){let t=[],n=[];for(let o of i){let i=o.escapedName.toString();if(i.startsWith("$$_")){let r=e.getTypeOfSymbolAtLocation(o,o.valueDeclaration),s=e.getPropertiesOfType(r);for(let e of s){let o=e.escapedName.toString();t.push(`let ${o} = ${i}.${o};`),n.push(o)}}}g+=t.join("\r\n"),x.end=g.length,g+="\r\nconst $e$t={\r\n"+n.join(",")+"\r\n};\r\n",v=g.length,g+="$e$t."+s.slice(u),vueThisDocVersion++,T=vscode_languageserver_textdocument_1.TextDocument.create(D,"typescript",vueThisDocVersion,g),vueThisDocProvider.setDocuments([_,T])}}}v===g.length&&(g+=s,vueThisDocVersion++,T=vscode_languageserver_textdocument_1.TextDocument.create(D,"typescript",vueThisDocVersion,g),vueThisDocProvider.setDocuments([_,T])),o.getCompletionsAtPosition=(e,i,o)=>{let s="this.".length;const l=i-t.getStart()-u+5;let a=null;if(t.kind===ts.SyntaxKind.CallExpression){a=t;let e=t.expression,i=null==e?void 0:e.getText();i&&(s=i.length-1)}let d=n.getQuickInfoAtPosition(T.uri,s+f);if("method"===(null==d?void 0:d.kind)){let e=ts.displayPartsToString(d.displayParts);if(null==e?void 0:e.includes(cVueDataString)){let e=n.getCompletionsAtPosition(T.uri,m,o);if(e)return e}else if(null==e?void 0:e.includes(cVueEventString))return getVueComponentEventCompletions(t.getSourceFile(),i,r)}else if("property"===(null==d?void 0:d.kind)&&a){let e=checkVuexStoreMethod(i,d,a);if(e)return getVuexMethodsCompletions(e,r)}let p,g=[];return g.push(n.getCompletionsAtPosition(T.uri,l+v,o)),g.push(n.getCompletionsAtPosition(T.uri,l+f,o)),c&&g.push(getVuexMapStateCompletion(t.getSourceFile())),g.forEach((e=>{e&&(p?p.entries.push(...e.entries):p=e)})),p},o.getCompletionEntryDetails=(e,i,o,r,s,l,a)=>{const c=i-t.getStart()-u+5;let d=c+v,p=n.getCompletionEntryDetails(T.uri,d,o,r,s,l,a);if(!p){let e=c+f;return n.getCompletionEntryDetails(T.uri,e,o,r,s,l,a)}return p};const V=(e,i)=>{var o;let s=(0,type_resolve_1.getTouchingPropertyName)(t.getSourceFile(),i),l=ts.createTextSpan(s.getStart(),s.getWidth());const a=i-t.getStart()-u+5;if(t.kind===ts.SyntaxKind.CallExpression){let a=t,u=a.expression;if(u&&u.kind===ts.SyntaxKind.PropertyAccessExpression){let t=n.getQuickInfoAtPosition(T.uri,f+(null===(o=u.getText())||void 0===o?void 0:o.length));if("property"===(null==t?void 0:t.kind)){ts.displayPartsToString(t.displayParts);let n=checkVuexStoreMethod(i,t,a);if(n&&(null==s?void 0:s.kind)===ts.SyntaxKind.StringLiteral){return{textSpan:l,definitions:findVuexMethodsDefinition(e,n,s.getText(),r)}}}}}let c=n.getDefinitionAtPosition(T.uri,a+v);if((null==c?void 0:c.length)>0){let e=[];for(e.push(...c);e.length>0;){let i=e.pop();if(i.fileName==D)if(i.kind!=ts.ScriptElementKind.memberVariableElement&&i.kind!=ts.ScriptElementKind.functionElement||i.containerName!=h){if((i.kind==ts.ScriptElementKind.letElement||i.kind==ts.ScriptElementKind.functionElement)&&x.start<i.textSpan.start&&i.textSpan.start+i.textSpan.length<x.end){let t=n.getDefinitionAtPosition(T.uri,i.contextSpan.start+i.contextSpan.length-1);t&&e.push(...t)}}else{let t=n.getDefinitionAtPosition(T.uri,i.textSpan.start);t&&e.push(...t)}else if(i.fileName===y)return i.fileName=t.getSourceFile().fileName,{textSpan:l,definitions:[i]}}}else{let e=n.getDefinitionAtPosition(T.uri,a+f);if(e)return{textSpan:l,definitions:e}}if(c)return{textSpan:l,definitions:c}};return o.getDefinitionAtPosition=(e,t)=>{var i;return null===(i=V(e,t))||void 0===i?void 0:i.definitions},o.getDefinitionAndBoundSpan=V,o.getQuickInfoAtPosition=(e,i)=>{let o=i-t.getStart()-u+5;if(o>4){let e=n.getQuickInfoAtPosition(T.uri,o+v);return e&&e.kind||(e=n.getQuickInfoAtPosition(T.uri,o+f)),e}},o}function getVueComponentEventCompletions(e,t,i){let n=function(){let t=e.statements.find(ts.isExportAssignment);if(t){let e=t.getChildren().find(ts.isObjectLiteralExpression);if(e){let t=e.properties.find((e=>e.kind==ts.SyntaxKind.PropertyAssignment&&/['\"]?name['\"]?/.test(e.name.getText())));if(t){let e=t.initializer;if(ts.isStringLiteral(e)){let t=e.text,i=t[0];"'"!=i&&'"'!=i||(t=t.slice(0));let n=t[t.length-1];return"'"!=n&&'"'!=n||(t=t.slice(0,-1)),t}}}}return""}();if(n){const e=/[A-Z]/;let t=n.search(e),o="";for(;t>=0;)o+=n.slice(0,t),o+="-"+n[t].toLocaleLowerCase(),n=n.slice(t+1),t=n.search(e);o+=n;let r=vscode_uri_1.URI.file(i).toString();const s=indexlib_1.IndexDataStore.load({uri:r,name:""});let l=[],a={entries:l,isGlobalCompletion:!1,isMemberCompletion:!0,isNewIdentifierLocation:!1};return s.allIndexData().forEach(((e,t)=>{var i;let n=e["vue-components"];if(n instanceof Array)for(let e=0;e<n.length;e++){const t=n[e];if(t.label==o){const e=null===(i=null==t?void 0:t.data)||void 0===i?void 0:i.events;e instanceof Array&&e.forEach((e=>{"string"==typeof e&&l.push({name:e,kind:ts.ScriptElementKind.functionElement,sortText:"aa"})}));break}}})),a}}function checkVuexStoreMethod(e,t,i){let n=i.arguments,o=n&&n.length>0?n[0]:void 0;if(o&&o.kind===ts.SyntaxKind.StringLiteral&&o.pos<=e&&e<=o.end){const e=ts.displayPartsToString(t.displayParts);if(e.includes(cVuexCommitString))return"commit";if(e.includes(cVuexDispatchString))return"dispatch"}return""}function getVuexMethodsCompletions(e,t){let i=vscode_uri_1.URI.file(t).toString();const n=indexlib_1.IndexDataStore.load({uri:i,name:""});let o=[],r={entries:o,isGlobalCompletion:!1,isMemberCompletion:!0,isNewIdentifierLocation:!1},s="commit"==e,l=!s&&"dispatch"==e;if(n.allIndexData().forEach(((e,t)=>{var i,n;let r=e["vuex-construct"];if(r instanceof Array)for(let e=0;e<r.length;e++){const t=r[e];if("construct-args"==t.label){let e;s?e=null===(i=t.data)||void 0===i?void 0:i.mutations:l&&(e=null===(n=t.data)||void 0===n?void 0:n.actions),e instanceof Array&&e.forEach((e=>{var t;let i=null!==(t=null==e?void 0:e.name)&&void 0!==t?t:"";i&&o.push({name:i,kind:ts.ScriptElementKind.memberVariableElement,sortText:"aa"})}))}}})),r.entries.length>0)return r}function findVuexMethodsDefinition(e,t,i,n){let o=(0,string_1.removeQuote)(i);if(!o)return[];let r=vscode_uri_1.URI.file(n).toString();const s=indexlib_1.IndexDataStore.load({uri:r,name:""});let l=[],a="commit"==t,u=!a&&"dispatch"==t;return s.allIndexData().forEach(((e,t)=>{var i,n;let r=e["vuex-construct"],s=vscode_uri_1.URI.parse(t).fsPath;if(r instanceof Array){for(let e=0;e<r.length;e++){const t=r[e];if("construct-args"==t.label){let e;a?e=null===(i=t.data)||void 0===i?void 0:i.mutations:u&&(e=null===(n=t.data)||void 0===n?void 0:n.actions),e instanceof Array&&e.forEach((e=>{var t,i;let n=null!==(t=null==e?void 0:e.name)&&void 0!==t?t:"",r=null!==(i=null==e?void 0:e.offset)&&void 0!==i?i:-1;n==o&&r>=0&&l.push({name:n,kind:ts.ScriptElementKind.memberVariableElement,fileName:s,textSpan:{start:r,length:o.length},containerName:"",containerKind:ts.ScriptElementKind.unknown})}))}}}})),l}function getVuexMapStateCompletion(e){let t=[],i={entries:t,isGlobalCompletion:!1,isMemberCompletion:!0,isNewIdentifierLocation:!1};return ParseUtil_1.ParseUtil.getVuexState(e).forEach((e=>{t.push({name:e,kind:ts.ScriptElementKind.memberVariableElement,sortText:e})})),i}exports.getVueThisLangusgeService=getVueThisLangusgeService;