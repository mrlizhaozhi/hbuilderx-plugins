"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const hxproject_1=require("./hxproject"),ts=require("typescript"),path=require("path"),type_resolve_1=require("../common/type-resolve"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument");let optionTextDocument=vscode_languageserver_textdocument_1.TextDocument.create("","typescript",1,"");const vueOptionDocProvider={get version(){return""+optionTextDocument.version},compilerOptions:{allowNonTsExtensions:!0,allowJs:!0,lib:["lib.esnext.d.ts"],target:ts.ScriptTarget.Latest,moduleResolution:ts.ModuleResolutionKind.NodeJs,experimentalDecorators:!1},getDefaultLibs(e){let t=[],o=hxproject_1.hx.getExtensionRootPath();return t.push(path.join(o,"builtin-dts","node_modules","vue","types","index.d.ts")),t.push(path.join(o,"builtin-dts","node_modules","@vue","composition-api/dist/vue-composition-api.d.ts")),t.push(path.join(o,"builtin-dts","node_modules","vue@3","types","index.d.ts")),t.push(path.join(o,"builtin-dts","node_modules","vuex","types","index.d.ts")),e.kind!==hxproject_1.hx.HXProjectKind.UniApp&&e.kind!==hxproject_1.hx.HXProjectKind.UniApp_Cli||t.push(path.join(o,"builtin-dts","node_modules","@dcloudio","types","index.d.ts")),t},get documents(){return[optionTextDocument.uri]},getDocumentSnapshot(e){let t="";return e==optionTextDocument.uri&&(t=optionTextDocument.getText()),{getText:(e,o)=>t.substring(e,o),getLength:()=>t.length,getChangeRange:()=>{}}},getDocumentVersion:e=>e==optionTextDocument.uri?""+optionTextDocument.version:"1",hasDocument:e=>e==optionTextDocument.uri,resolveModuleNameOverride(e,t,o,n,i,r,s,u){if("vue"==t){let e=hxproject_1.hx.getExtensionRootPath();return{isExternalLibraryImport:!0,resolvedFileName:path.join(e,"builtin-dts","node_modules","vue","types","index.d.ts")}}}};function createOptionHelperDocument(e,t,o,n){let i="import Vue from 'vue';\n\t\t\t  new Vue(\n\t\t\t",r=i.length-o-1;return i+=t,i+=")",{doc:vscode_languageserver_textdocument_1.TextDocument.create(e,"typescript",n,i),offsetDelta:r}}function getVueLanguageService(e,t){let o=e.createTSLanguageService(vueOptionDocProvider);return optionTextDocument=t,o}function create(e){const t=e.languageService,o=e.languageServiceHost,n=e.project,i=Object.create(null);for(let e of Object.keys(t)){const o=t[e];i[e]=(...e)=>o.apply(t,e)}return i.getCompletionEntryDetails=(e,i,r,s,u,l,p)=>{let c=t.getProgram().getSourceFile(e);if(e.endsWith(".vue")||e.endsWith(".nvue")){let t=(0,type_resolve_1.findExportDefaultObjectExpressionAtKeyOffset)(c,i);if(t){let{doc:a,offsetDelta:d}=createOptionHelperDocument(e+".ts",t.getText(c),t.pos,parseInt(null==o?void 0:o.getProjectVersion()));return getVueLanguageService(n,a).getCompletionEntryDetails(a.uri,i+d,r,s,u,l,p)}}return t.getCompletionEntryDetails(e,i,r,s,u,l,p)},i.getCompletionsAtPosition=(e,i,r)=>{let s=t.getProgram().getSourceFile(e);if(e.endsWith(".vue")||e.endsWith(".nvue")){let t=(0,type_resolve_1.findExportDefaultObjectExpressionAtKeyOffset)(s,i);if(t){let{doc:u,offsetDelta:l}=createOptionHelperDocument(e+".ts",t.getText(s),t.pos,parseInt(null==o?void 0:o.getProjectVersion()));return getVueLanguageService(n,u).getCompletionsAtPosition(u.uri,i+l,r)}}return t.getCompletionsAtPosition(e,i,r)},i.getDefinitionAtPosition=(e,i)=>{if(e.endsWith(".vue")||e.endsWith(".nvue")){let r=t.getProgram().getSourceFile(e),s=(0,type_resolve_1.findExportDefaultObjectExpressionAtKeyOffset)(r,i);if(s){let{doc:t,offsetDelta:u}=createOptionHelperDocument(e+".ts",s.getText(r),s.pos,parseInt(null==o?void 0:o.getProjectVersion()));return getVueLanguageService(n,t).getDefinitionAtPosition(t.uri,i+u)}}return t.getDefinitionAtPosition(e,i)},i.getQuickInfoAtPosition=(e,i)=>{if(e.endsWith(".vue")||e.endsWith(".nvue")){let r=t.getProgram().getSourceFile(e),s=(0,type_resolve_1.findExportDefaultObjectExpressionAtKeyOffset)(r,i);if(s){let{doc:t,offsetDelta:u}=createOptionHelperDocument(e+".ts",s.getText(r),s.pos,parseInt(null==o?void 0:o.getProjectVersion()));return getVueLanguageService(n,t).getQuickInfoAtPosition(t.uri,i+u)}}return t.getQuickInfoAtPosition(e,i)},i.getDefinitionAndBoundSpan=(e,o)=>t.getDefinitionAndBoundSpan(e,o),i}exports.default={create:create};