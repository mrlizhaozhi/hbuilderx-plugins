"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const hxproject_1=require("./hxproject"),uniCloudPath_1=require("../common/uniCloudPath"),ts=require("typescript"),fs=require("fs"),path=require("path");function getType(e,t,n){let i=n.getSymbolsInScope(t,ts.SymbolFlags.Type).find((t=>t.escapedName===e));if(i)return n.getDeclaredTypeOfSymbol(i)}function isUniCloudImportObjectExpression(e,t){var n,i;if(e.kind!==ts.SyntaxKind.PropertyAccessExpression)return!1;let r=e,l=r.expression;if("importObject"!==(null===(n=r.name)||void 0===n?void 0:n.text))return!1;let o=t.getSymbolAtLocation(l);if(o){let e=t.getTypeOfSymbol(o);if("UniCloud"==(null===(i=null==e?void 0:e.symbol)||void 0===i?void 0:i.escapedName))return!0}return!1}function checkCallExpression(e,t,n,i,r,l){if(isUniCloudImportObjectExpression(i.expression,n)&&i.arguments.length>=1&&ts.isStringLiteralLike(i.arguments[0])){let r,l=i.arguments[0].text;(0,uniCloudPath_1.getAllCloudFunctions)(e.fsPath).forEach((e=>{e.name==l&&fs.existsSync(path.join(e.path,"index.obj.js"))&&(r=path.join(e.path,"index.obj.js"))}));let o=ts.createSourceFile(r,hxproject_1.hx.readFiletoString(r),ts.ScriptTarget.Latest);n.bindSourceFile(o,t);let s=n.getSymbolOfNode(o);if(s){const e=n.resolveExternalModuleSymbol(s);if(e)return n.getTypeOfSymbol(e)}}}function getContextualType(e,t,n,i,r){var l,o,s,a;let d=i.parent;if(d&&d.kind==ts.SyntaxKind.ReturnStatement){let t=i.getSourceFile();if(e.isUnicloudSource(t.fileName)&&"index.obj.js"===path.basename(t.fileName)){let e,t=ts.findAncestor(d,ts.isFunctionLike);if((null===(l=null==t?void 0:t.parent)||void 0===l?void 0:l.kind)===ts.SyntaxKind.PropertyAssignment){let n=t.parent;n.parent&&n.parent.kind===ts.SyntaxKind.ObjectLiteralExpression&&(e=n.parent)}else(null===(o=null==t?void 0:t.parent)||void 0===o?void 0:o.kind)===ts.SyntaxKind.ObjectLiteralExpression&&(e=t.parent);if((null===(s=null==e?void 0:e.parent)||void 0===s?void 0:s.getText()).startsWith("module.exports")){let e=n.getSymbolsInScope(d,ts.SymbolFlags.Namespace).find((e=>"UniCloud"===e.escapedName||"UniCloudNamespace"===e.escapedName));if(e){let t=null===(a=e.exports)||void 0===a?void 0:a.get("UniCloudError");if(t)return n.getDeclaredTypeOfSymbol(t)}}}}}function checkExpression(e,t,n,i,r,l){var o,s,a,d;const p=i.kind;if(p===ts.SyntaxKind.Identifier){let e=i,t=n.getResolvedSymbol(e);if(t&&t.valueDeclaration){let e=t.valueDeclaration;if((null===(o=e.parent)||void 0===o?void 0:o.kind)===ts.SyntaxKind.CatchClause&&(null===(a=null===(s=e.parent)||void 0===s?void 0:s.parent)||void 0===a?void 0:a.kind)===ts.SyntaxKind.TryStatement){let t=e.parent.parent.tryBlock.statements;if(t&&t.length>0){let e=n.getSymbolsInScope(t[0],ts.SymbolFlags.Variable);for(let r=0;r<t.length;r++){let l=t[r],o=/(\w+)\.(\w+)\s*\(/.exec(l.getText());if(o){let r=o[1],l=e.find((e=>e.escapedName===r));if(l&&l.valueDeclaration&&l.valueDeclaration.getText().indexOf(".importObject(")>=0){let e=n.getSymbolsInScope(t[0],ts.SymbolFlags.Namespace).find((e=>"UniCloud"===e.escapedName||"UniCloudNamespace"===e.escapedName));if(!e)return getType("Error",i,n);let r=null===(d=e.exports)||void 0===d?void 0:d.get("UniCloudError");if(r)return n.getDeclaredTypeOfSymbol(r)}}}}return getType("Error",i,n)}}}else if(p===ts.SyntaxKind.PropertyAccessExpression){if(isUniCloudImportObjectExpression(i,n)&&i.parent.kind===ts.SyntaxKind.CallExpression){let o=n.defaultCheckExpression(i,r,l),s=n.getSignaturesOfType(o,ts.SignatureKind.Call);return s&&s.forEach((o=>{o.resolvedReturnType=checkCallExpression(e,t,n,i.parent,r,l)})),o}}else if(p===ts.SyntaxKind.CallExpression){return checkCallExpression(e,t,n,i,r,l)}}exports.default={checkExpression:checkExpression,getContextualType:getContextualType};