"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createPlugin=void 0;const ts=require("typescript/lib/tsserverlibrary"),fs=require("fs"),path=require("path"),hxproject_1=require("./hxproject"),uniCloudServerTsServerPluign_1=require("./uniCloudServerTsServerPluign"),project_resolve_1=require("../project-resolve");function createPlugin(e){let r="",t=hxproject_1.hx.getProject(e.project.getCurrentDirectory());if(t){r=t.fsPath,console.log(`root path: ${r}`),hxproject_1.hx.getDefaultLibs(t).forEach((r=>{e.project.addMissingFileRoot(ts.server.toNormalizedPath(r))}));let o=new Set,s=path.resolve(__dirname,"../../../frameworkdts");fs.existsSync(s)&&fs.statSync(s).isDirectory()&&fs.readdirSync(s).forEach((t=>{let i=path.join(s,t,"index.d.ts");-1!=(0,project_resolve_1.getLibraries)(r).findIndex((e=>t===e))&&(o.add(t),e.project.addMissingFileRoot(ts.server.toNormalizedPath(i)))}));let i=(0,project_resolve_1.getSettingPath)(r),l=path.resolve(i,"../../../types");fs.existsSync(l)&&fs.statSync(l).isDirectory()&&fs.readdirSync(l).forEach((t=>{let s=path.join(l,t,"index.d.ts");-1!=(0,project_resolve_1.getLibraries)(r).findIndex((e=>t===e))&&(o.add(t),e.project.addMissingFileRoot(ts.server.toNormalizedPath(s)))})),setInterval((()=>{let t=new Set((0,project_resolve_1.getLibraries)(r));for(let r of o)if(!t.has(r)){let t=s+"/"+r+"/index.d.ts";if(fs.existsSync(t)||(t=l+"/"+r+"/index.d.ts"),fs.existsSync(t)){let r=e.project.getScriptInfo(t);e.project.removeFile(r,!0,!0)}}for(let r of t)if(!o.has(r)){let t=s+"/"+r+"/index.d.ts";fs.existsSync(t)||(t=l+"/"+r+"/index.d.ts"),fs.existsSync(t)&&e.project.addMissingFileRoot(ts.server.toNormalizedPath(t))}}),2e3);const a=e.project.resolveModuleNames;return e.project.resolveModuleNames=(r,o,s,i,l,c)=>{let n=a.apply(e.project,[r,o,s,i,l,c]);for(let s=0;s<n.length;s++)n[s]||(n[s]=hxproject_1.hx.resolveModuleName(t,r[s],o,l,e.project));return n},uniCloudServerTsServerPluign_1.default.create({project:t,languageService:e.languageService,languageServiceHost:e.languageServiceHost,config:e.config})}return e.languageService}exports.createPlugin=createPlugin;