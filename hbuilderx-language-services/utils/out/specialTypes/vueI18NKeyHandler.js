"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.gotoDefinition=exports.doHover=exports.doComplete=void 0;const fs=require("fs"),path=require("path"),tsserverlibrary_1=require("typescript/lib/tsserverlibrary"),vscode_json_languageservice_1=require("vscode-json-languageservice"),vscode_languageserver_1=require("vscode-languageserver"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),index_1=require("../index");function getJsonServer(){const e={resolveRelativePath:(e,t)=>{const r=t.substring(0,t.lastIndexOf("/")+1);return vscode_uri_1.Utils.resolvePath(vscode_uri_1.URI.parse(r),e).toString()}};return(0,vscode_json_languageservice_1.getLanguageService)({workspaceContext:e,contributions:[],clientCapabilities:vscode_json_languageservice_1.ClientCapabilities.LATEST})}function treeApply(e,t){e&&t(e)&&e.children&&e.children.forEach((e=>{treeApply(e,t)}))}function getNodeFromKey(e,t){const r=e.root;let n=[];return treeApply(r,(e=>("property"===e.type&&e.keyNode.value===t&&n.push(e),!0))),n}function getNodeFromValue(e,t){const r=e.root;let n=[];return treeApply(r,(e=>("property"===e.type&&e.valueNode.value===t&&n.push(e),!0))),n}function getCurrentI18nLanguageFile(e){let t,r=path.join(e.sourceRoot,"manifest.json"),n=fs.readFileSync(r),o=vscode_languageserver_textdocument_1.TextDocument.create(r,"json",1,n.toString()),i=getJsonServer().parseJSONDocument(o),s=getNodeFromKey(i,"locale"),a="zh-Hans";if(s.length>0){a=s[0].valueNode.value}let l=path.join(e.sourceRoot,"locale"),u=fs.readdirSync(l);if(!u)return t;if(u.length<1)return t;let d=u.filter((e=>{if(!e.includes("uni")&&e.endsWith(".json"))return e}));if(!d.includes(a+".json")){let e=getNodeFromKey(i,"fallbackLocale"),t="en";if(s.length>0&&(t=e[0].value),!d.includes(a+".json"))return}return t=path.join(l,a+".json"),t}function doComplete(e,t,r){let n=[];if(!r.workspaceFolder)return n;let o=index_1.hx.createProject(r.workspaceFolder);if(!o)return n;if(o.kind!==index_1.hx.HXProjectKind.UniApp&&o.kind!==index_1.hx.HXProjectKind.UniApp_Cli)return n;let i=getCurrentI18nLanguageFile(o);if(i){const e=getJsonServer(),t=fs.readFileSync(i),r=vscode_languageserver_textdocument_1.TextDocument.create(i,"json",1,t.toString());treeApply(e.parseJSONDocument(r).root,(e=>("property"===e.type&&n.push({label:e.keyNode.value,detail:i,documentation:e.valueNode.value,kind:vscode_languageserver_1.CompletionItemKind.Text}),!0)))}return n}function doHover(e,t){let r;if(!t.workspaceFolder)return r;let n=index_1.hx.createProject(t.workspaceFolder);if(!n)return r;if(n.kind!==index_1.hx.HXProjectKind.UniApp&&n.kind!==index_1.hx.HXProjectKind.UniApp_Cli)return r;let o=getCurrentI18nLanguageFile(n);if(o){const t=getJsonServer(),n=fs.readFileSync(o),i=vscode_languageserver_textdocument_1.TextDocument.create(o,"json",1,n.toString()),s=getNodeFromKey(t.parseJSONDocument(i),e);if(!s)return r;const a=s[0];if(!a||!a.keyNode)return r;const l={text:a.valueNode.value,kind:"string"};r={kind:tsserverlibrary_1.ScriptElementKind.string,kindModifiers:e,textSpan:{start:a.keyNode.offset,length:a.keyNode.length},documentation:[l]}}return r}function gotoDefinition(e,t){let r=[];if(!t.workspaceFolder)return r;let n=index_1.hx.createProject(t.workspaceFolder);if(!n)return r;if(n.kind!==index_1.hx.HXProjectKind.UniApp&&n.kind!==index_1.hx.HXProjectKind.UniApp_Cli)return r;let o=getCurrentI18nLanguageFile(n);if(o){const t=getJsonServer(),n=fs.readFileSync(o),i=vscode_languageserver_textdocument_1.TextDocument.create(o,"json",1,n.toString()),s=getNodeFromKey(t.parseJSONDocument(i),e);if(!s)return r;const a=s[0];if(!a||!a.keyNode)return r;let l={kind:tsserverlibrary_1.ScriptElementKind.string,name:e,containerKind:void 0,containerName:e,textSpan:{start:a.keyNode.offset,length:a.keyNode.length},fileName:o};r.push(l)}return r}exports.doComplete=doComplete,exports.doHover=doHover,exports.gotoDefinition=gotoDefinition;