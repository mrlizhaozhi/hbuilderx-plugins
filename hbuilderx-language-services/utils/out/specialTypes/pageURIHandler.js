"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.doComplete=void 0;const fs=require("fs"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),uniCloudPath_1=require("../common/uniCloudPath"),c_UnpakcageDir="unpackage",c_DistDir="dist",c_UniModules="uni_modules",c_NodeModules="node_modules",c_AppVue="App.vue";class CollectingResourceVisitor{constructor(e,t,i,o,r,s,l){this._isHTML=!1,this._visitedFileCount=0,this._configRootPath="",this._isHTML=o,this._startTimer=Date.parse((new Date).toString()),this._result=e,this._currentPath=t,this._rootPath=i,this._pageExtends=r||[".vue","nvue"],this._prefix=s,this._configRootPath=l}createFileProposal(e,t,i){return{kind:vscode_languageserver_protocol_1.CompletionItemKind.File,label:e.replace(/\\/g,"/")}}createFileSpecialProposal(e,t,i,o){if(t.toLocaleLowerCase()===c_AppVue.toLocaleLowerCase())return;if(this._configRootPath.length>0){if(!t.startsWith(this._configRootPath))return;t=t.substring(0,this._configRootPath.length)}let r=t.lastIndexOf(".");-1==this._pageExtends.findIndex((e=>".png"==e))&&(t=t.substring(0,r));let s=this.createFileProposal(t,i,o);e.add(s)}shouleAppendRelativeFile(e){return!(e.startsWith("../")||e.startsWith("./")||e.startsWith("/")||e.startsWith("@/"))}getResults(){return this._result}visit(e){this._visitedFileCount++;let t=e,i=path.basename(e);if(i===c_NodeModules||"unpackage"===i||"dist"===i||i===c_AppVue)return!1;let o=path.extname(e);if(o&&o.length>0&&-1===this._pageExtends.indexOf(o))return!1;if(o&&o.length>0){let o=path.relative(this._rootPath,e),{computeAbsoluePath:r,pathPrefix:s}=checkComputeAbsolute(this._prefix),l=o;if(l.startsWith(c_UniModules)&&(0,uniCloudPath_1.isNotUniModulesPages)(l))return!1;if(i.startsWith("."))return!1;if(""==(e=computeFileNameWithCurrentFile(e,r,s,this._rootPath,this._currentPath)))return!1;if(this.createFileSpecialProposal(this._result,e,i,this._isHTML),this.shouleAppendRelativeFile(e))e="./"+e;else{let e="/"+path.relative(this._rootPath,t);this.createFileSpecialProposal(this._result,e,i,this._isHTML)}return!1}return!0}}function relativeURI(e,t){e=e.replace(/\\/g,"/"),t=t.replace(/\\/g,"/");let i=e.split("/"),o=t.split("/"),r=0;for(let e=0;e<i.length&&o.length-1>=e&&i[e].toLocaleLowerCase()===o[e].toLocaleLowerCase();++e)r++;let s=[];for(let e=r+1;e<i.length;++e)s.push("../");for(let e=r;e<o.length;++e)s.push(o[e]),s.push(e<o.length-1?"/":"");return s.join("")}function computeFileNameWithCurrentFile(e,t,i,o,r){if(t){let t=path.relative(o,e);return path.isAbsolute(t)?i+t:""}if("./"===i){let t=path.dirname(r);if(!e.startsWith(t))return""}return i+relativeURI(r,e)}function accept(e,t,i){if(fs.existsSync(i)){let o=[];o.push(i),t.forEach((e=>o.unshift(e)));let r=new Set;for(;o.length>0;){let t=o.pop();fs.existsSync(t)&&(r.has(t)||(r.add(t),e.visit(t)&&fs.statSync(t).isDirectory()&&fs.readdirSync(t).forEach((e=>{o.push(path.join(t,e))}))))}}}function doComplete(e,t,i){var o;let r=[],s=new Set,l=null==i?void 0:i.workspaceFolder,a=[],n=null===(o=vscode_uri_1.URI.parse(t.uri))||void 0===o?void 0:o.fsPath,{configRootPath:u,prefix:h}=getRootPath(null==i?void 0:i.jsonDocument,t.offsetAt(e)),p=new CollectingResourceVisitor(s,n,l,!1,null==i?void 0:i.extends,h,u);for(;n!=vscode_uri_1.URI.file(l).fsPath;){fs.existsSync(n)&&fs.statSync(n).isDirectory()&&a.push(n),n=path.dirname(n)}accept(p,a,l),r.push(...p.getResults());let c=r.filter((e=>{if("/App"!==e.label)return e}));return t.uri.endsWith("vue")&&(c=c.filter((e=>{if(e.label.startsWith("/"))return e}))),c}function getRootPath(e,t){var i;let o=null==e?void 0:e.getNodeFromOffset(t),r=null==o?void 0:o.value,s=null==o?void 0:o.parent;if("property"===(null==s?void 0:s.type)&&(s=null==s?void 0:s.parent,"object"===(null==s?void 0:s.type)&&(s=null==s?void 0:s.parent,"array"===(null==s?void 0:s.type)&&(s=null==s?void 0:s.parent,"property"===(null==s?void 0:s.type)&&(s=null==s?void 0:s.parent,"object"===(null==s?void 0:s.type))))))for(let e of null===(i=s)||void 0===i?void 0:i.properties)if("root"===e.keyNode.value){if("string"==typeof e.valueNode.value){return{configRootPath:e.valueNode.value+"/",prefix:r||""}}break}return{configRootPath:"",prefix:r||""}}function checkComputeAbsolute(e){return e.startsWith("/")?{computeAbsoluePath:!0,pathPrefix:"/"}:e.startsWith("./")?{computeAbsoluePath:!1,pathPrefix:"./"}:{computeAbsoluePath:!1,pathPrefix:""}}CollectingResourceVisitor.VISIT_TIMEOUT=100,exports.doComplete=doComplete;