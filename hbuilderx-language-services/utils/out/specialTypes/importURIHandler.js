"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.gotoDefinition=exports.doComplete=void 0;const fs=require("fs"),jsonc_1=require("jsonc"),path=require("path"),ts=require("typescript"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),type_resolve_1=require("../common/type-resolve"),hxproject_1=require("../languageserver/hxproject"),ProjectFileFilter_1=require("../languageserver/ProjectFileFilter"),project_resolve_1=require("../project-resolve");function getBuiltInLibs(e){return(0,project_resolve_1.isUniAppVue)(e)&&!(0,project_resolve_1.isUniAppCli)(e)?["vue","vuex","vue-router","@dcloudio/uni-app"]:[]}function doComplete(e,o,r){let t=[],i=(o.uri.endsWith(".vue")||o.uri.endsWith(".nvue"),(0,type_resolve_1.getTokenAtPosition)(r.sourceFile,o.offsetAt(e))),s="";i.kind===ts.SyntaxKind.StringLiteral&&(s=i.text);let l=(0,ProjectFileFilter_1.getCompletionFilesSync)(r.workspaceFolder,{extensionFilters:[".js",".vue"],prefixPath:s,timeout:1e3},o.uri);if(r.workspaceFolder&&(0,project_resolve_1.isUniAppVue)(r.workspaceFolder)&&!(0,project_resolve_1.isUniAppCli)(r.workspaceFolder)){let e=path.join(r.workspaceFolder,"abc.js");e=vscode_uri_1.URI.file(e).toString();let o=(0,ProjectFileFilter_1.getCompletionFilesSync)(r.workspaceFolder,{extensionFilters:[".js",".vue"],prefixPath:"",timeout:1e3},e);null==o||o.files.forEach((e=>{t.push({label:"@/"+e.relative,kind:e.isDir?vscode_languageserver_protocol_1.CompletionItemKind.Folder:vscode_languageserver_protocol_1.CompletionItemKind.File})}))}if(null==l||l.files.forEach((e=>{t.push({label:e.relative,kind:e.isDir?vscode_languageserver_protocol_1.CompletionItemKind.Folder:vscode_languageserver_protocol_1.CompletionItemKind.File})})),r.workspaceFolder){let e=r.workspaceFolder+"/package.json";if(fs.existsSync(e)){const[o,r]=jsonc_1.jsonc.safe.parse(fs.readFileSync(e).toString());if(!o)if(r.dependencies&&"object"==typeof r.dependencies)for(let e of Object.keys(r.dependencies))t.push({label:e});else if(r.devDependencies&&"object"==typeof r.devDependencies)for(let e of Object.keys(r.devDependencies))t.push({label:e})}""===s&&getBuiltInLibs(r.workspaceFolder).forEach((e=>{t.push({label:e})}))}return t}function gotoDefinition(e,o){let r=[];if(e.startsWith("@/")&&o.workspaceFolder){let t=o.workspaceFolder,i=e.replace("@",t).replace(/\\/g,"/"),s={start:vscode_languageserver_protocol_1.Position.create(0,0),end:vscode_languageserver_protocol_1.Position.create(0,0)};r.unshift({originSelectionRange:o.range,targetUri:hxproject_1.hx.toNormalizedUri(i),targetRange:s,targetSelectionRange:s})}return r}exports.doComplete=doComplete,exports.gotoDefinition=gotoDefinition;