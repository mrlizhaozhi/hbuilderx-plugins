"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.gotoDefinition=exports.doComplete=exports.getClassList=exports.getIDList=exports.isHTMLDocument=exports.isCSSDocument=exports.isJSDocument=void 0;const typescript=require("typescript"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),indexlib_1=require("../../../indexlib");function getJSReference(e){return e.references.filter((e=>e.type===indexlib_1.ReferenceFileType.Script))}function getCSSReference(e){return e.references.filter((e=>e.type===indexlib_1.ReferenceFileType.CSS))}function getReferenceByType(e,t){return e.references.filter((e=>e.type===t))}function isJSDocument(e){return"javascript"===e.languageId||"typescript"===e.languageId}function isCSSDocument(e){return"css"===e.languageId||"stylus"===e.languageId||"scss"===e.languageId||"sass"===e.languageId}function isHTMLDocument(e){return"html"===e.languageId||"html_es6"===e.languageId||"pug"===e.languageId}function getList(e,t){let n=new Map;for(const[i,s]of e.allIndexData().entries()){let e=s[t]||null;e&&e instanceof Array&&e.forEach((e=>{n.has(e.label)?n.get(e.label).add(i):n.set(e.label,new Set([i]))}))}return n}function getIDList(e){return getList(e,indexlib_1.IndexDataCategory.ID)}function getClassList(e){return getList(e,indexlib_1.IndexDataCategory.CLASS)}function doComplete(e,t,n){let i=[],s=indexlib_1.IndexDataStore.load({uri:vscode_uri_1.URI.file(n.workspaceFolder).toString(),name:""}),o=new Map,r=getIDList(s);if(isHTMLDocument(t)){let e=s.indexData(t.uri)[indexlib_1.IndexDataCategory.ID]||null;e&&e instanceof Array&&e.forEach((e=>{o.set(e.label,e.description||e.label)}))}else{let e=new Map;if(isJSDocument(t))for(const[t,n]of s.allIndexData().entries())(t.endsWith(".js")||t.endsWith(".ts"))&&e.set(t,n);else if(isCSSDocument(t))for(const[t,n]of s.allIndexData().entries())(t.endsWith(".css")||t.endsWith(".scss")||t.endsWith(".sass")||t.endsWith(".stylus"))&&e.set(t,n);if(e.size>0&&e.has(t.uri)){e.get(t.uri).references.forEach((e=>{for(const[t,n]of r.entries())n.has(e.uri)&&o.set(t,e.uri)}))}else for(const[e,t]of r.entries()){let n=[];t.forEach((e=>{e.endsWith(".css")||n.push(e)})),n.length>0&&o.set(e,n.join("\n"))}}for(const[e,t]of o.entries())i.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,label:e,detail:t});for(const[e,t]of r.entries())if(!o.has(e)){let n=[];t.forEach((e=>{e.endsWith(".css")||n.push(e)})),n.length>0&&i.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,label:e,detail:Array.from(t).join("\n")})}return i}exports.isJSDocument=isJSDocument,exports.isCSSDocument=isCSSDocument,exports.isHTMLDocument=isHTMLDocument,exports.getIDList=getIDList,exports.getClassList=getClassList,exports.doComplete=doComplete;const HTML_FIEL_REG=/.html?/i;function gotoDefinition(e,t){if(!t.workspaceFolder||!t.fileName)return;const n=t.fileName;let i=n.startsWith("file://")?vscode_uri_1.URI.parse(n).toString():vscode_uri_1.URI.file(n).toString(),s=vscode_uri_1.URI.file(t.workspaceFolder).toString(),o=indexlib_1.IndexDataStore.load({uri:s,name:""}).allIndexData(),r=new Set,l=[i];for(;l.length>0;){let n=l.shift(),i=n.lastIndexOf(".");if(i<=0)continue;let s=n.slice(i);if((".html"==s||".htm"==s)&&!r.has(n)){let i=o.get(n);if(i){let s=i[indexlib_1.IndexDataCategory.ID];for(let i=0;i<s.length;i++){let o=s[i];if(o.type===indexlib_1.IndexItemType.DEF&&o.label==e&&"number"==typeof o.offset){o.position.character,o.label.length;let i=t.token.getStart();return t.token.kind==typescript.SyntaxKind.StringLiteral&&(i+=t.token.getText().indexOf(e)),{definitions:[{resolvedDefinition:{textSpanPosition:o.position},textSpan:{start:o.offset,length:e.length},fileName:vscode_uri_1.URI.parse(n).fsPath,originSelectionRange:t.range}],textSpan:{start:i,length:e.length}}}}}}r.add(n),o.forEach(((e,t)=>{if(!r.has(t)){e.references.some((e=>e.uri==n))&&l.push(t)}}))}}exports.gotoDefinition=gotoDefinition;