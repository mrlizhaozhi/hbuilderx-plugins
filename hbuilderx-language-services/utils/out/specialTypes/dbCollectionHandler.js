"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.gotoDefinition=exports.doComplete=void 0;const path=require("path"),fs=require("fs"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),uniCloudPath_1=require("../common/uniCloudPath");function doComplete(e,t,n){let a=[],r=t.getText(n.replaceRange),i=new Set;if(r.trim().length>0){r.split(",").forEach((e=>{i.add(e.trim())}))}let o=new Set;for(let e=0;e<uniCloudPath_1.providers.length;++e){let t=uniCloudPath_1.providers[e],a=path.join(null==n?void 0:n.workspaceFolder,(0,uniCloudPath_1.getCloudDatabaseRoot)(t));fs.existsSync(a)&&(fs.statSync(a).isDirectory()&&fs.readdirSync(a).forEach((e=>{let t=path.join(a,e);fs.statSync(t).isFile()&&e.endsWith(".schema.json")&&o.add(path.basename(t,".schema.json"))})))}return getUniModuleSchema(o,null==n?void 0:n.workspaceFolder),o.forEach((e=>{e.length>0&&a.push({label:e,kind:vscode_languageserver_protocol_1.CompletionItemKind.Variable,documentation:e})})),a}function getUniModuleSchema(e,t){let n=uniModules(t);for(let t of n)fs.readdirSync(t).forEach((n=>{let a=path.join(t,n);fs.statSync(a).isFile()&&n.endsWith(".schema.json")&&e.add(path.basename(a,".schema.json"))}))}function uniModules(e){let t=[],n=path.join(e,(0,uniCloudPath_1.getUniModulesDir)());return fs.existsSync(n)&&fs.statSync(n).isDirectory()&&fs.readdirSync(n).forEach((a=>{let r=path.join(n,a);if(fs.statSync(r).isDirectory())for(let n=0;n<uniCloudPath_1.providers.length;++n){let r=path.join(e,(0,uniCloudPath_1.getUniModuleDatabase)(a,uniCloudPath_1.providers[n]));fs.existsSync(r)&&fs.statSync(r).isDirectory()&&t.push(r)}})),t}function findUniModuleSchema(e,t){let n,a=uniModules(e);for(let e of a){let n=fs.readdirSync(e);for(let a of n){let n=path.join(e,a);if(fs.statSync(n).isFile()&&a.endsWith(".schema.json")){if(path.basename(a,".schema.json")==t)return n}}}return n}function findTarget(e,t){let n=e.split(","),a=0,r=0;for(let e of n){if(a<=t&&t<=a+e.length){r=a+e.length;break}a+=e.length}for(","==e.charAt(a)&&(a+=1,r+=1);" "==e.charAt(a);)a++;for(;" "==e.charAt(r);)r--;return{pos:a,end:r}}function gotoDefinition(e,t){if(null==t?void 0:t.workspaceFolder){let n=t.workspaceFolder,{pos:a,end:r}=findTarget(e,t.offset);e=e.substring(a,r).trim();for(let i=0;i<uniCloudPath_1.providers.length;++i){let o=uniCloudPath_1.providers[i],s=path.join(n,(0,uniCloudPath_1.getCloudDatabaseRoot)(o));if(fs.existsSync(s)&&fs.statSync(s).isDirectory()){let n=fs.readdirSync(s);for(let i=0;i<n.length;++i){if(path.basename(n[i],".schema.json")==e){let e="jql-helper-docs.ts"==t.fileName;return t.fileName.endsWith(".ts")||t.fileName.endsWith(".js")?{definitions:[{textSpan:{start:0,length:0},fileName:path.join(s,n[i]),contextSpan:{start:0,length:0}}],textSpan:{start:e?t.token.pos+t.offset-uniCloudPath_1.jqlPrefix.length:t.token.pos+a+1,length:r-a}}:{definitions:[{textSpan:{start:0,length:0},originSelectionRange:{start:{line:t.range.start.line,character:t.range.start.character+a},end:{line:t.range.end.line,character:t.range.start.character+r}},targetRange:{start:{line:0,character:0},end:{line:0,character:0}},targetSelectionRange:{start:{line:0,character:0},end:{line:0,character:0}},fileName:path.join(s,n[i])}]}}}}}let i=findUniModuleSchema(n,e);if(i){if(t.fileName.endsWith(".ts")||t.fileName.endsWith(".js")){return{definitions:[{textSpan:{start:0,length:0},fileName:i,contextSpan:{start:0,length:0}}],textSpan:{start:"jql-helper-docs.ts"==t.fileName?t.token.pos+t.offset-uniCloudPath_1.jqlPrefix.length:t.token.pos+t.offset,length:r-a}}}return{textSpan:{start:0,length:0},originSelectionRange:{start:{line:t.range.start.line,character:t.range.start.character},end:{line:t.range.end.line,character:t.range.end.character}},fileName:i,targetRange:{start:{line:0,character:0},end:{line:0,character:0}},targetSelectionRange:{start:{line:0,character:0},end:{line:0,character:0}}}}}}exports.doComplete=doComplete,exports.gotoDefinition=gotoDefinition;