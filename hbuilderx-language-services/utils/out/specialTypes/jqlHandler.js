"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.gotoDefinition=exports.doComplete=void 0;const typescript=require("typescript"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),index_1=require("./index"),nodes_1=require("../common/nodes"),commonHandler_1=require("../common/commonHandler");function calcFieldPropsals(e,t){let n=[];return e.split(",").forEach((e=>{let o=(0,commonHandler_1.parseSchema)(e.trim(),t);if(o)for(const[e,t]of o.getProperties().entries())n.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,label:e,detail:t.desc})})),n}function doComplete(e,t,n){var o;if(n&&n.locationType===index_1.SpecialValueLocationType.IN_HTML)return doDBComponentComplete(e,t,n);let i=[],r=n.sourceFile,l=(0,nodes_1.findNodePathByOffset)(r,t.offsetAt(e)),s=l.length-1,p=l[s]||null;if(p&&(s-=1,p=l[s]||null,p))if((null==p?void 0:p.kind)===typescript.SyntaxKind.PropertyAssignment||(null==p?void 0:p.kind)===typescript.SyntaxKind.ShorthandPropertyAssignment)s-=1,p=l[s],p&&(null==p||p.kind,typescript.SyntaxKind.ObjectLiteralExpression);else{let e=null;if(p.kind==typescript.SyntaxKind.CallExpression)e=p;else{for(;p&&(null==p?void 0:p.kind)!==typescript.SyntaxKind.ExpressionStatement;)s-=1,p=l[s];if(p&&(null==p?void 0:p.kind)===typescript.SyntaxKind.ExpressionStatement){let t=p.expression;t.kind===typescript.SyntaxKind.CallExpression&&(e=t)}}for(;e.kind===typescript.SyntaxKind.CallExpression;){let t=e.expression;if(t.kind===typescript.SyntaxKind.PropertyAccessExpression){if("collection"===t.name.getText()){let t=e.arguments;if((null==t?void 0:t.length)>0&&(null===(o=t[0])||void 0===o?void 0:o.kind)===typescript.SyntaxKind.StringLiteral){let e=t[0].text;i.push(...calcFieldPropsals(e,null==n?void 0:n.workspaceFolder))}break}e=t.expression}}}return i}function doDBComponentComplete(e,t,n){if(!n.htmlContext||!n.workspaceFolder)return[];const o=n.htmlContext.attributes;return"where"==n.htmlContext.currentAttribute.name&&o.collection?calcFieldPropsals(o.collection,n.workspaceFolder):[]}function gotoDefinition(){}exports.doComplete=doComplete,exports.gotoDefinition=gotoDefinition;