"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getDeprecatedPseudoList=exports.getCompletionDataFromScanner=exports.getCompletionTypeFromScanner=exports.isValueInNode=exports.getTokenList=void 0;const vscode_languageserver_1=require("vscode-languageserver"),core_1=require("../../../../core"),extraProcessor_1=require("../grammar/extraProcessor"),util_1=require("../utils/util"),{Scanner:Scanner}=require("vscode-css-languageservice/lib/umd/parser/cssScanner"),{LESSScanner:LESSScanner}=require("vscode-css-languageservice/lib/umd/parser/lessScanner"),{SCSSScanner:SCSSScanner}=require("vscode-css-languageservice/lib/umd/parser/scssScanner"),SnippetFormat=vscode_languageserver_1.InsertTextFormat.Snippet,retriggerCommand={title:"Suggest",command:"editor.action.triggerSuggest"};function getTokenList(e){let t=Scanner;"scss"===e.languageId&&(t=SCSSScanner),"less"===e.languageId&&(t=LESSScanner),t.prototype.setSource(e.getText());let o,n=[];for(;o=t.prototype.scan(),n.push(o),o.type!==core_1.TokenType.EOF;);return n}function getContextTokenCollection(e,t){let o;if(!(e.length<2)){for(let n=0;n<e.length-1&&n!==e.length-1;n++)if(e[n].offset<=t&&e[n+1].offset>t){o={peekToken:e[n],nextToken:e[n+1],peekIndex:n,nextIndex:n+1};break}return o}}function getCompletionType(e,t){return{type:e,parentType:e,nodeType:e,parentNodeType:e,isNode:!1,context:t}}function getSimpleCompletionType(e,t){for(let o=e.length-1;o>=0;o--){if(e[o].offset>=t)continue;const n=e[o];if(n.type===core_1.TokenType.CurlyR)return getCompletionType(core_1.NodeType.Selector);if(n.type===core_1.TokenType.BracketL){let t;return t=e[o-1].type===core_1.TokenType.Whitespace?e[Math.max(o-2,0)].text:e[o-1].text,getCompletionType(core_1.NodeType.AttributeSelector,t)}if(n.type===core_1.TokenType.CurlyL)return getCompletionType(core_1.NodeType.Property);if(n.type===core_1.TokenType.SemiColon)return getCompletionType(core_1.NodeType.Property);if(n.type===core_1.TokenType.Colon){let t;return t=e[o-1].type===core_1.TokenType.Whitespace?e[Math.max(o-2,0)].text:e[o-1].text,getCompletionType(core_1.NodeType.Value,t)}}}function inParentheses(e,t,o,n){let r={peekToken:void 0,nextToken:void 0,peekIndex:0,nextIndex:0},i=e.peekIndex-1;for(;i>=0;i--){const e=t[i];if(r.peekToken&&r.nextToken)break;e.type!==o||r.peekToken||(r.peekToken=e,r.peekIndex=i),e.type!==n||r.nextToken||(r.nextToken=e,r.nextIndex=i)}if(r.peekToken&&!(r.nextToken&&r.nextToken.offset>r.peekToken.offset))return r}function isURILiteral(e,t){let o=e.includes("url("),n=t.includes(")");if(o&&n)return getCompletionType(core_1.NodeType.URILiteral)}function isMedia(e){if(e.includes("@media"))return getCompletionType(core_1.NodeType.Media)}function isImport(e){if(e.includes("@import"))return getCompletionType(core_1.NodeType.Import)}function isCharset(e){if(e.includes("@charset"))return{isNode:!1,context:"charset"}}function isAttributeSelector(e,t){const o=inParentheses(e,t,core_1.TokenType.BracketL,core_1.TokenType.BracketR);if(o&&o){let e,n=o.peekIndex-1;return n>0&&(t[n].type===core_1.TokenType.Whitespace&&n--,0!==n&&(e=t[n].text)),getCompletionType(core_1.NodeType.AttributeSelector,e)}}function isPseudoSelector(e,t,o){const n=inParentheses(t,o,core_1.TokenType.CurlyL,core_1.TokenType.CurlyR);let r,i=!1;if(n){if(!(0,core_1.getLineTextFromOffset)(e,n.peekToken.offset).includes("@media")&&"css"===e.languageId)return;i=!0}let s=t.peekIndex-1;if(!(s<0||(o[s].type===core_1.TokenType.Ident&&s--,s<0||o[s].type!==core_1.TokenType.Colon||(s--,r=":",s<0)))){if(i){let e=t.nextIndex-1;if(o[e].type===core_1.TokenType.Ident&&e++,e>o.length-1)return;if(o[e].type===core_1.TokenType.Whitespace&&e++,e>o.length-1)return;if(o[e].type===core_1.TokenType.SemiColon)return;o[s].type===core_1.TokenType.Colon&&(r="::")}else o[s].type===core_1.TokenType.Colon&&(r="::");return getCompletionType(core_1.NodeType.PseudoSelector,r)}}function isSelector(e,t,o,n){const r=inParentheses(t,o,core_1.TokenType.CurlyL,core_1.TokenType.CurlyR);let i;if(r){if(!(0,core_1.getLineTextFromOffset)(e,r.peekToken.offset).includes("@media")&&"css"===e.languageId)return;const t=(0,core_1.getLineTextFromOffset)(e,n);if(t.includes(":")||t.includes(";"))return;i="isExtStyle"}return getCompletionType(core_1.NodeType.Selector,i)}function isAttribute(e,t,o){if(inParentheses(e,t,core_1.TokenType.CurlyL,core_1.TokenType.CurlyR)){let o=e.peekIndex-1;if(o<0)return;if(t[o].type===core_1.TokenType.SemiColon)return getCompletionType(core_1.NodeType.Property);if(t[o].type===core_1.TokenType.Ident&&o--,o<0)return;if(t[o].type===core_1.TokenType.Whitespace&&o--,o<0)return;if(t[o].type===core_1.TokenType.Colon)return;if(t[o].type!==core_1.TokenType.SemiColon&&t[o].type!==core_1.TokenType.CurlyL)return;return getCompletionType(core_1.NodeType.Property)}}function isExclamatory(e,t,o){if(inParentheses(t,o,core_1.TokenType.CurlyL,core_1.TokenType.CurlyR)){let e=t.peekIndex;if(o[e].type!==core_1.TokenType.Exclamation&&e--,o[e].type===core_1.TokenType.Exclamation)return getCompletionType(core_1.NodeType.Declaration)}}function isValue(e,t){if(!inParentheses(e,t,core_1.TokenType.CurlyL,core_1.TokenType.CurlyR))return;let o=!1,n=e.nextIndex-1;if(t[n].type===core_1.TokenType.Ident&&n++,t[n].type===core_1.TokenType.Whitespace&&n++,n<t.length-1&&t[n].type===core_1.TokenType.SemiColon&&(o=!0),!o)return;let r=!1,i=e.peekIndex-1;if(!(i<0)&&(t[i].type===core_1.TokenType.CustomToken&&i--,!(t[i].type===core_1.TokenType.Whitespace&&(i--,i<0))&&(t[i].type===core_1.TokenType.Ident&&i--,!(i<0)&&(t[i].type===core_1.TokenType.Length&&i--,!(i<0)&&(t[i].type===core_1.TokenType.CustomToken&&i--,!(i<0)&&(t[i].type===core_1.TokenType.Whitespace&&i--,!(i<0)&&(t[i].type===core_1.TokenType.Colon&&(r=!0),r))))))){if(i--,i<0)return;let e;if(t[i].type===core_1.TokenType.Whitespace&&i--,i<0)return;return e=t[i].text,getCompletionType(core_1.NodeType.Value,e)}}function getCompletionTypeFromScanner(e,t){const o=getTokenList(e);if(o.length<1)return;const n=e.offsetAt(t),r=(0,core_1.getLineTextFromOffset)(e,n),i=(0,core_1.getLeftLineTextFromOffset)(e,n),s=(0,core_1.getRightLineTextFromOffset)(e,n),c=getContextTokenCollection(o,n);if(!c&&o.length>2){let e=getSimpleCompletionType(o,n);if(!e){const e=isURILiteral(i,s);if(e)return e;const t=isMedia(r);if(t)return t;const o=isImport(r);if(o)return o;const n=isCharset(r);if(n)return n}return e}if(!c)return;const a=isURILiteral(i,s);if(a)return a;const l=isMedia(r);if(l)return l;const p=isImport(r);if(p)return p;const u=isCharset(r);if(u)return u;const d=isAttributeSelector(c,o);if(d)return d;const g=isPseudoSelector(e,c,o);if(g)return g;const T=isSelector(e,c,o,n);if(T)return T;const _=isAttribute(c,o,n);if(_)return _;const y=isExclamatory(r,c,o);if(y)return y;const m=isValue(c,o);return m||void 0}function getSelectorData(e,t,o){let n=[];n=getPseudoSelectorData(e,t);const r=e.provideAtDirectives();for(const e of r)n.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_1.CompletionItemKind.Keyword});for(const e of core_1.html5Tags)n.push({label:e,textEdit:vscode_languageserver_1.TextEdit.replace(t,e),kind:vscode_languageserver_1.CompletionItemKind.Keyword});for(const e of core_1.svgElements)n.push({label:e,textEdit:vscode_languageserver_1.TextEdit.replace(t,e),kind:vscode_languageserver_1.CompletionItemKind.Keyword});return"isExtStyle"===o.context&&(n=n.concat(getPropertyData(e,t))),n}function getPropertyData(e,t){let o=[];const n=e.provideProperties();for(const e of n){const n=(255-("number"==typeof e.relevance?Math.min(Math.max(e.relevance,0),99):50)).toString(16),r=(0,core_1.startsWith)(e.name,"-")?core_1.SortTexts.VendorPrefixed:core_1.SortTexts.Normal;let i=e.name+": $0;";o.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(t,`${i}`),sortText:r+"_"+n,kind:vscode_languageserver_1.CompletionItemKind.Property,command:retriggerCommand,insertTextFormat:vscode_languageserver_1.InsertTextFormat.Snippet})}return o}function getColorProposals(e,t){for(const o in core_1.colors)e.push({label:o,documentation:core_1.colors[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Color});for(const o in core_1.colorKeywords)e.push({label:o,documentation:core_1.colorKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});for(const o of core_1.colorFunctions){let n=1;const r=(e,t)=>"${"+n+++":"+t+"}",i=o.func.replace(/\[?\$(\w+)\]?/g,r);e.push({label:o.func.substring(0,o.func.indexOf("(")),detail:o.func,documentation:o.desc,textEdit:vscode_languageserver_1.TextEdit.replace(t,i),insertTextFormat:SnippetFormat,kind:vscode_languageserver_1.CompletionItemKind.Function})}return e}function getPositionProposals(e,t){for(const o in core_1.positionKeywords)e.push({label:o,documentation:core_1.positionKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getRepeatStyleProposals(e,t){for(const o in core_1.repeatStyleKeywords)e.push({label:o,documentation:core_1.repeatStyleKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getLineStyleProposals(e,t){for(const o in core_1.lineStyleKeywords)e.push({label:o,documentation:core_1.lineStyleKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getLineWidthProposals(e,t){for(const o of core_1.lineWidthKeywords)e.push({label:o,textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getGeometryBoxProposals(e,t){for(const o in core_1.geometryBoxKeywords)e.push({label:o,documentation:core_1.geometryBoxKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getBoxProposals(e,t){for(const o in core_1.boxKeywords)e.push({label:o,documentation:core_1.boxKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function moveCursorInsideParenthesis(e){return e.replace(/\(\)$/,"($1)")}function getImageProposals(e,t){for(const o in core_1.imageFunctions){const n=moveCursorInsideParenthesis(o);e.push({label:o,documentation:core_1.imageFunctions[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,n),kind:vscode_languageserver_1.CompletionItemKind.Function,insertTextFormat:o!==n?SnippetFormat:void 0})}return e}function getBasicShapeProposals(e,t){for(const o in core_1.basicShapeFunctions){const n=moveCursorInsideParenthesis(o);e.push({label:o,documentation:core_1.basicShapeFunctions[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,n),kind:vscode_languageserver_1.CompletionItemKind.Function,insertTextFormat:o!==n?SnippetFormat:void 0})}return e}function getTimingFunctionProposals(e,t){for(const o in core_1.transitionTimingFunctions){const n=moveCursorInsideParenthesis(o);e.push({label:o,documentation:core_1.transitionTimingFunctions[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,n),kind:vscode_languageserver_1.CompletionItemKind.Function,insertTextFormat:o!==n?SnippetFormat:void 0})}return e}function getCSSWideKeywordProposals(e,t){for(const o in core_1.cssWideKeywords)e.push({label:o,documentation:core_1.cssWideKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getValueData(e,t,o){let n=[];if(o.context){const r=e.provideProperties().find((e=>e.name===o.context)),i=null==r?void 0:r.values,s=null==r?void 0:r.restrictions;if(i&&i.map((e=>{n.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_1.CompletionItemKind.Value})})),s)for(const e of s)switch(e){case"color":n=getColorProposals(n,t);break;case"position":n=getPositionProposals(n,t);break;case"repeat":n=getRepeatStyleProposals(n,t);break;case"line-style":n=getLineStyleProposals(n,t);break;case"line-width":n=getLineWidthProposals(n,t);break;case"geometry-box":n=getGeometryBoxProposals(n,t);break;case"box":n=getBoxProposals(n,t);break;case"image":n=getImageProposals(n,t);break;case"timing-function":n=getTimingFunctionProposals(n,t);break;case"shape":n=getBasicShapeProposals(n,t)}}return n=getCSSWideKeywordProposals(n,t),n}function getPseudoSelectorData(e,t){let o=[];const n=e.providePseudoClasses(),r=e.providePseudoElements();for(const e of n)o.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_1.CompletionItemKind.Function});for(const e of r)o.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_1.CompletionItemKind.Function});return o}function getCompletionDataFromScanner(e,t,o,n){let r=[];if(!o)return{isIncomplete:false,items:r};const i=e.offsetAt(t);let s=(0,core_1.getContextData)(e,i,' \t\n\r":{[()]},*>+;').contextRange;n.forEach((t=>{let n=[];if(o.nodeType===core_1.NodeType.Selector){const r=(0,core_1.getContextData)(e,i,' \t\n\r"{[()]},*>+;');s=r.contextRange,n=getSelectorData(t,s,o)}else o.nodeType===core_1.NodeType.Property?n=getPropertyData(t,s):o.nodeType===core_1.NodeType.Value?n=getValueData(t,s,o):o.nodeType===core_1.NodeType.PseudoSelector&&(s.start.character=s.start.character-o.context.length,n=getPseudoSelectorData(t,s));r=r.concat(n)}));let c=[];return r=r.filter((e=>{if(!c.includes(e.label))return c.push(e.label),e})),{isIncomplete:false,items:r}}function isValueInNode(e,t){const o=getTokenList(e);if(o.length<1)return;const n=e.offsetAt(t),r=getContextTokenCollection(o,n);let i;return i=r?isValue(r,o):getSimpleCompletionType(o,n),(null==i?void 0:i.nodeType)===core_1.NodeType.Value?i:void 0}function getDeprecatedPseudoList(e,t,o,n){o&&!o.isNode||(o=getCompletionTypeFromScanner(e,t));if(!(0,util_1.styleIsRightCompletionType)(o,[core_1.NodeType.PseudoSelector],[core_1.NodeType.PseudoSelector],core_1.NodeType.PseudoSelector))return n;const r=getTokenList(e);if(r.length<1)return n;const i=e.offsetAt(t),s=getContextTokenCollection(r,i),c=(0,core_1.getContextData)(e,e.offsetAt(t),void 0).leftText;let a;if(a=s?isPseudoSelector(e,s,r):getSimpleCompletionType(r,i),(null==a?void 0:a.nodeType)!==core_1.NodeType.PseudoSelector)return n;const l=t.character,p=o&&o.context&&o.context.length>0?o.context.length:0;let u=vscode_languageserver_1.Position.create(t.line,l-c.length-p);s&&""!==c&&s.peekToken.text.includes(c)&&(t=e.positionAt(s.peekToken.offset+s.peekToken.text.length));for(const e of extraProcessor_1.deprecatedPseudoElementList)n.items.push({label:e.name,documentation:e.description,tags:[vscode_languageserver_1.CompletionItemTag.Deprecated],textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(u,t),e.name),kind:vscode_languageserver_1.CompletionItemKind.Function,data:{hxKind:core_1.HxIconKind.CLASS}});return n}exports.getTokenList=getTokenList,exports.getCompletionTypeFromScanner=getCompletionTypeFromScanner,exports.getCompletionDataFromScanner=getCompletionDataFromScanner,exports.isValueInNode=isValueInNode,exports.getDeprecatedPseudoList=getDeprecatedPseudoList;