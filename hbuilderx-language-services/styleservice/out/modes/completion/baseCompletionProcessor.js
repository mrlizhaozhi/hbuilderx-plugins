"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseCompletionProcessor=void 0;const vscode_css_languageservice_1=require("vscode-css-languageservice"),vscode_languageserver_1=require("vscode-languageserver"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../../core"),entry_1=require("../../../../htmlservice/entry"),indexlib_1=require("../../../../indexlib"),styleData_1=require("../../styleData"),contextCompletionProcessor_1=require("../context/contextCompletionProcessor"),extraProcessor_1=require("../grammar/extraProcessor"),grammarProcessor_1=require("../grammar/grammarProcessor"),baseIndexProcessor_1=require("../index/baseIndexProcessor"),util_1=require("../utils/util"),{ParseErrorCollector:ParseErrorCollector}=require("vscode-css-languageservice/lib/umd/parser/cssNodes"),SnippetFormat=vscode_languageserver_1.InsertTextFormat.Snippet;class BaseCompletionProcessor{constructor(){this.getCompletionTypeFromScanner=contextCompletionProcessor_1.getCompletionTypeFromScanner,this.getCompletionDataFromScanner=contextCompletionProcessor_1.getCompletionDataFromScanner}isErrorAstNode(e,t,o){const r=e.offsetAt(t),n=ParseErrorCollector.entries(o);for(const e of n)if(e.offset+e.length<r)return!0;return!1}getCompletionTypeFromAstNode(e,t,o){var r,n;const i=e.offsetAt(t),a=(0,util_1.styleGetNodeAtOffset)(o,i);return{type:null==a?void 0:a.type,parentType:null===(r=null==a?void 0:a.parent)||void 0===r?void 0:r.type,nodeType:null==a?void 0:a.nodeType,parentNodeType:null===(n=null==a?void 0:a.parent)||void 0===n?void 0:n.nodeType,isNode:!0}}doExtraCompletion(e,t,o,r,n,i,a,s){const c=this.isErrorAstNode(t,o,r);let d=this.getCompletionTypeFromAstNode(t,o,r);return(c||0===n.items.length)&&(d=this.getCompletionTypeFromScanner(t,o),n=this.getCompletionDataFromScanner(t,o,d,a)),n.items&&(n.items=n.items.map((e=>(e=this.initData(e),e=this.kindConverted(e))))),n=this.getDeprecatedCompletionData(t,o,d,n),n=this.getFunctionsCompletionData(t,o,d,n),n=this.getMediaCompletionData(t,o,d,n),n=this.getCharsetCompletionData(t,o,d,n),n=this.getPathCompletionData(e,t,o,d,n),n=this.getPropertySelectorCompletionData(e,t,o,d,n),n=this.getExtraCompletionData(e,t,o,d,n),n=this.getSelfIdSelectorCompletionData(t,o,d,n),n=this.getIndexIdSelectorsCompletionData(e,t,o,d,n),n=this.getIndexClassSelectorsCompletionData(e,t,o,d,n),n=this.getGrammarCompletionData(e,t,o,d,n),n=this.getPxConversionCompletionData(e,t,o,d,n,i),n=this.getDeduplicationData(n),n=this.getFiltrationPseudoData(t,o,d,n),n=this.retrieveRange(t,o,d,n),n=this.getMoveCursorData(t,o,d,n),n=this.getAltMode(t,o,n),n=this.setData(n)}initData(e){let t={data:e.data};return e.data=t,e}getHxKind(e,t,o){if(e)return e;if(t||(t=vscode_languageserver_1.CompletionItemKind.Text),t===vscode_languageserver_1.CompletionItemKind.Keyword){if(core_1.html5Tags.includes(o)||core_1.svgElements.includes(o))return core_1.HxIconKind.ELEMENT;if(o.startsWith("."))return core_1.HxIconKind.CLASS;if(o.startsWith("#"))return core_1.HxIconKind.ID;if(o.startsWith("@"))return core_1.HxIconKind.ATTRIBUTE}else if(t===vscode_languageserver_1.CompletionItemKind.Function)return o.startsWith(":")?core_1.HxIconKind.CLASS:core_1.HxIconKind.FUNCTION;return core_1.HxIconKind.DEFAULT}kindConverted(e){var t;let o=e.data,r=e.label,n=e.kind,i=null===(t=e.data)||void 0===t?void 0:t.hxKind;return o.hxKind=this.getHxKind(i,n,r),e.data=o,e}getDeprecatedCompletionData(e,t,o,r){return(0,contextCompletionProcessor_1.getDeprecatedPseudoList)(e,t,o,r)}addCalcFunction(e,t,o,r){const n=e.offsetAt(o),i=(0,core_1.getLeftLineTextFromOffset)(e,n).indexOf(":"),a=e.getText(vscode_languageserver_1.Range.create(vscode_languageserver_1.Position.create(o.line,0),vscode_languageserver_1.Position.create(o.line,i))).trim(),s=(0,vscode_css_languageservice_1.getDefaultCSSDataProvider)().provideProperties();let c=!1;for(const e of s){if(a!==e.name)continue;const t=e.restrictions;if(t&&t.length>0)for(const e of t)if(c=(0,core_1.includesList)(e,core_1.calcRestrictions),c)break;if(c)break}return c&&r.items.push({label:"calc()",documentation:"Evaluates an mathematical expression. The following operators can be used: + - * /.",textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(t,o),"calc($1)$0"),kind:vscode_languageserver_1.CompletionItemKind.Function,data:{hxKind:core_1.HxIconKind.FUNCTION}}),r}getFunctionsCompletionData(e,t,o,r){if(!o)return r;const n=e.offsetAt(t),i=(0,core_1.getContextData)(e,n,' \t\n\r":{[()]},*>+;');if(""===i.context){if(!(0,util_1.styleIsRightCompletionType)(o,[core_1.NodeType.Declarations,core_1.NodeType.Ruleset],void 0,core_1.NodeType.Value))return r}else{const e=(0,util_1.styleIsRightCompletionType)(o,[core_1.NodeType.Identifier,core_1.NodeType.Term],void 0,core_1.NodeType.Value);if(o.parentType===core_1.NodeType.MixinReference)return r;if(!e)return r}r.items.push({label:"var()",documentation:"Evaluates the value of a custom variable.",textEdit:vscode_languageserver_1.TextEdit.replace(i.contextRange,"var($1)$0"),kind:vscode_languageserver_1.CompletionItemKind.Function,data:{hxKind:core_1.HxIconKind.FUNCTION}});let a=this.addCalcFunction(e,i.contextRange.start,t,r);return r.items.push(...a.items),r}getMediaType(e){if(e.endsWith("@media"))return"all";if(e.endsWith("not")||e.endsWith("only")||e.endsWith(","))return"mediaType";if(e.endsWith("("))return"mediaFeature";if(e.endsWith(")"))return"mediaLogicalOperator";for(const t of extraProcessor_1.mediaTypes)if(e.endsWith(t.name))return"mediaLogicalOperator"}getMediaCompletionData(e,t,o,r){if(!(0,util_1.styleIsRightCompletionType)(o,[core_1.NodeType.Media,core_1.NodeType.MediaQuery],void 0,core_1.NodeType.Media))return r;const n=e.offsetAt(t),i=(0,core_1.getContextData)(e,n,void 0);let a=vscode_languageserver_1.Range.create(vscode_languageserver_1.Position.create(t.line,0),i.contextRange.start),s=e.getText(a).trim(),c=this.getMediaType(s);if(!c)return r;switch(r.items=[],"all"===c&&(r.items.push({label:"ont",detail:"mediaLogicalOperator",textEdit:vscode_languageserver_1.TextEdit.replace(i.contextRange,"ont"),kind:vscode_languageserver_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}}),r.items.push({label:"only",detail:"mediaLogicalOperator",textEdit:vscode_languageserver_1.TextEdit.replace(i.contextRange,"only"),kind:vscode_languageserver_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}})),c){case"all":case"mediaType":for(const e of extraProcessor_1.mediaTypes)r.items.push({label:e.name,detail:"mediaType",documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(i.contextRange,e.name),kind:vscode_languageserver_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}});break;case"mediaLogicalOperator":for(const e of extraProcessor_1.mediaLogicalOperators)r.items.push({label:e,detail:"mediaLogicalOperator",textEdit:vscode_languageserver_1.TextEdit.replace(i.contextRange,e),kind:vscode_languageserver_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}});break;case"mediaFeature":for(const e of extraProcessor_1.mediaFeatures)r.items.push({label:e.name,detail:"mediaFeature",documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(i.contextRange,e.name),kind:vscode_languageserver_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}})}return r}getCharsetCompletionData(e,t,o,r){if(!(0,util_1.styleIsRightCompletionType)(o,[core_1.NodeType.Stylesheet],void 0,void 0,"charset"))return r;const n=e.offsetAt(t);if(!(0,core_1.getLineTextFromOffset)(e,n).includes("@charset"))return r;const i=(0,core_1.getContextData)(e,n," \t\n\r\"':{[()]},*>+").contextRange;r.items=[];for(const e of extraProcessor_1.charsetFeatures)r.items.push({label:e.name,detail:"mediaFeature",documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(i,e.name),kind:vscode_languageserver_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}});return r}getPathCompletionData(e,t,o,r,n){if(!r)return n;const i=(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.Import,core_1.NodeType.StringLiteral],void 0,core_1.NodeType.Import),a=(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.URILiteral],[core_1.NodeType.URILiteral],core_1.NodeType.URILiteral);if(!i&&!a)return n;const s=(0,core_1.getLineTextFromPosition)(t,o);if(i&&!s.includes("@import"))return n;let c=!1;(i||a&&s.includes("@import"))&&(c=!0);const d=t.offsetAt(o),l=(0,core_1.getContextData)(t,d," \t\n\r'\":{[()]},*>+");let p=[],u={range:l.contextRange,kind:core_1.StringLocationInfoKind.IN_CSS_LIKE,ast:void 0,project:e},g=new Map,_=core_1.StringServicesContainer.create(g),m=new Map;if(m.set("css",["HBuilderX.CssImportURIString"]),m.set("scss",["HBuilderX.ScssImportURIString"]),m.set("less",["HBuilderX.LessImportURIString"]),m.set("image",["HBuilderX.ImageURIString"]),m.set("font",["HBuilderX.FontURIString"]),c){let e=m.get(t.languageId);e&&(p=e),n=(0,core_1.doComplete)(p,t,o,u,_,[],!1)}else{const e=s.indexOf(":"),r=s.substring(0,e).trim(),i=(0,vscode_css_languageservice_1.newCSSDataProvider)(styleData_1.cssData).provideProperties().find((e=>e.name===r));if(!i||!i.restrictions)return n;i.restrictions.forEach((e=>{let t=m.get(e);t&&p.push(...t)})),n=(0,core_1.doComplete)(p,t,o,u,_,[],!1)}return n}getPropertySelectorCompletionData(e,t,o,r,n){if((null==r?void 0:r.isNode)&&(r=(0,contextCompletionProcessor_1.getCompletionTypeFromScanner)(t,o)),!r)return n;if(!(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.AttributeSelector],void 0,core_1.NodeType.AttributeSelector))return n;const i=t.offsetAt(o),a=(0,core_1.getContextData)(t,i,void 0),s=r.context;let c=[],d={uri:vscode_uri_1.URI.parse(e.sourceRoot).toString(),name:e.sourceRoot};c=s&&core_1.html5Tags.includes(s)?(0,entry_1.getTagAttributes)(d,s):(0,entry_1.getTagAttributes)(d),n.items=[];for(const e of c)n.items.push({label:e,textEdit:vscode_languageserver_1.TextEdit.replace(a.contextRange,e),kind:vscode_languageserver_1.CompletionItemKind.Property,data:{hxKind:core_1.HxIconKind.ATTRIBUTE}});return n}getScopedSelectorCompletionData(e,t,o,r,n){let i=vscode_uri_1.URI.parse(t.uri).fsPath;if(!i.includes(".nvue.")&&!i.includes(".vue."))return n;if(!(r=this.getCompletionTypeFromScanner(t,o)))return n;const a=(0,util_1.styleIsRightCompletionType)(r,void 0,void 0,core_1.NodeType.Value),s=(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.PseudoSelector],[core_1.NodeType.PseudoSelector],core_1.NodeType.PseudoSelector);if(!a&&!s)return n;const c=t.offsetAt(o);let d=(0,core_1.getContextData)(t,c,' \t\n\r":{[()]},*>+'),l=d.contextRange;if(a){if(d=(0,core_1.getContextData)(t,c,' \t\n\r"{[()]},*>+'),l=d.contextRange,!d.context.startsWith(":"))return n}else if(s){if(!r.context)return n;l.start.character=l.start.character-r.context.length}for(const e of extraProcessor_1.vueStyleScopedSelector)n.items.push({label:e,textEdit:vscode_languageserver_1.TextEdit.replace(l,e),kind:vscode_languageserver_1.CompletionItemKind.Function,data:{hxKind:core_1.HxIconKind.CLASS}});return n}getScopedFunctionsCompletionData(e,t,o,r,n){let i=vscode_uri_1.URI.parse(t.uri).fsPath;if(!i.includes(".nvue.")&&!i.includes(".vue."))return n;if(!r)return n;const a=t.offsetAt(o),s=(0,core_1.getContextData)(t,a,' \t\n\r":{[()]},*>+;');if(""===s.context){if(!(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.Declarations,core_1.NodeType.Ruleset],void 0,core_1.NodeType.Value))return n}else{const e=(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.Identifier,core_1.NodeType.Term],void 0,core_1.NodeType.Value);if(r.parentType===core_1.NodeType.MixinReference)return n;if(!e)return n}for(const e of extraProcessor_1.vueStyleScopedFunction)n.items.push({label:e.label,textEdit:vscode_languageserver_1.TextEdit.replace(s.contextRange,e.insertText),kind:vscode_languageserver_1.CompletionItemKind.Function,data:{hxKind:core_1.HxIconKind.FUNCTION}});return n}getExtraCompletionData(e,t,o,r,n){return n=this.getScopedSelectorCompletionData(e,t,o,r,n),n=this.getScopedFunctionsCompletionData(e,t,o,r,n)}getSelfIdSelectorCompletionData(e,t,o,r){if(!(0,util_1.styleIsRightCompletionType)(o,void 0,[core_1.NodeType.ClassSelector,core_1.NodeType.IdentifierSelector,core_1.NodeType.ElementNameSelector],core_1.NodeType.Selector))return r;const n=e.offsetAt(t),i=(0,core_1.getContextData)(e,n,void 0),a=i.context,s={};s[a]=!0;return(0,contextCompletionProcessor_1.getTokenList)(e).forEach((e=>{e.type===core_1.TokenType.Hash&&"#"===e.text.charAt(0)&&(s[e.text]||(s[e.text]=!0,r.items.push({label:e.text,textEdit:vscode_languageserver_1.TextEdit.replace(i.contextRange,e.text),kind:vscode_languageserver_1.CompletionItemKind.Keyword,data:{hxKind:core_1.HxIconKind.ID}})))})),r}getSelfClassSelectorCompletionData(e,t,o,r){if(!(0,util_1.styleIsRightCompletionType)(o,void 0,[core_1.NodeType.ClassSelector,core_1.NodeType.IdentifierSelector,core_1.NodeType.ElementNameSelector],core_1.NodeType.Selector))return r;const n=e.offsetAt(t),i=(0,core_1.getContextData)(e,n,void 0),a=i.context,s={};s[a]=!0;return(0,contextCompletionProcessor_1.getTokenList)(e).forEach((e=>{e.type===core_1.TokenType.Hash&&"."===e.text.charAt(0)&&(s[e.text]||(s[e.text]=!0,r.items.push({label:e.text,textEdit:vscode_languageserver_1.TextEdit.replace(i.contextRange,e.text),kind:vscode_languageserver_1.CompletionItemKind.Keyword,data:{hxKind:core_1.HxIconKind.CLASS}})))})),r}getIndexIdSelectorsCompletionData(e,t,o,r,n){if(!(0,util_1.styleIsRightCompletionType)(r,void 0,[core_1.NodeType.ClassSelector,core_1.NodeType.IdentifierSelector,core_1.NodeType.ElementNameSelector],core_1.NodeType.Selector))return n;let i={uri:vscode_uri_1.URI.parse(e.sourceRoot).toString(),name:e.sourceRoot},a=indexlib_1.IndexDataCategory.ID,s=t.offsetAt(o),c=(0,core_1.getContextData)(t,s,void 0).context,d=vscode_languageserver_1.Position.create(o.line,o.character-c.length),l=new baseIndexProcessor_1.BaseIndexProcessor,p=l.getIndexDataFromType(l.getWorkspaceIndexData(i),a);for(let e of p)e.length>0&&n.items.push({label:"#"+e,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(d,o),"#"+e),kind:vscode_languageserver_1.CompletionItemKind.Keyword,data:{hxKind:core_1.HxIconKind.ID}});return n}getIndexClassSelectorsCompletionData(e,t,o,r,n){if(!(0,util_1.styleIsRightCompletionType)(r,void 0,[core_1.NodeType.ClassSelector,core_1.NodeType.IdentifierSelector,core_1.NodeType.ElementNameSelector],core_1.NodeType.Selector))return n;let i={uri:vscode_uri_1.URI.parse(e.sourceRoot).toString(),name:e.sourceRoot},a=indexlib_1.IndexDataCategory.CLASS,s=t.offsetAt(o),c=(0,core_1.getContextData)(t,s,void 0).context,d=vscode_languageserver_1.Position.create(o.line,o.character-c.length),l=new baseIndexProcessor_1.BaseIndexProcessor,p=l.getIndexDataFromType(l.getWorkspaceIndexData(i),a);for(let e of p)e.length>0&&n.items.push({label:"."+e,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(d,o),"."+e),kind:vscode_languageserver_1.CompletionItemKind.Keyword,data:{hxKind:core_1.HxIconKind.CLASS}});return n}getGrammarCompletionData(e,t,o,r,n){let i={uri:vscode_uri_1.URI.parse(e.sourceRoot).toString(),name:e.sourceRoot};return(0,grammarProcessor_1.getGrammarCompletionData)(i,t,o,r,n)}pxConversion(e,t,o,r,n){const i=e.offsetAt(t),a=(0,core_1.getContextData)(e,i,' \t\n\r":{[()]},*>+;'),s=a.context;if(!s.endsWith("p")&&!s.endsWith("px"))return o;const c=r.getHostPreferences();let d=1,l=2;if(n){if(!(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2upx.enabel",!0))return o;let e=(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2upx.proportion","1"),t=(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2upx.decimalLength",2);d=parseFloat(e),l=t}else{if(!(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2rem.enabel",!0))return o;let e=(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2rem.proportion","16"),t=(0,core_1.getConfigurationValue)(c,"editor.codeassist.px2rem.decimalLength",6);d=parseFloat(e),l=t}s.endsWith("px")&&(o.items=[]),o.isIncomplete=!0;const p=s.match(/\d+/);let u="";if(p&&(u=p[0]),""===u)return o;let g=(parseFloat(u)/d).toFixed(l);return g=g.replace(/0+$/,""),g.endsWith(".")&&(g=g.substring(0,g.length-1)),n?(o.items.push({label:p+"px->"+g+"upx",sortText:"!_"+p+"px->"+g+"upx",textEdit:vscode_languageserver_1.TextEdit.replace(a.contextRange,g+"upx"),kind:vscode_languageserver_1.CompletionItemKind.Snippet,data:{hxKind:core_1.HxIconKind.SNIPPET}}),o.items.push({label:p+"px->"+g+"rpx",sortText:"!_"+p+"px->"+g+"rpx",textEdit:vscode_languageserver_1.TextEdit.replace(a.contextRange,g+"rpx"),kind:vscode_languageserver_1.CompletionItemKind.Snippet,data:{hxKind:core_1.HxIconKind.SNIPPET}})):o.items.push({label:p+"px->"+g+"rem",sortText:"!_"+p+"px->"+g+"rem",textEdit:vscode_languageserver_1.TextEdit.replace(a.contextRange,g+"rem"),kind:vscode_languageserver_1.CompletionItemKind.Snippet,data:{hxKind:core_1.HxIconKind.SNIPPET}}),o}getPxConversionCompletionData(e,t,o,r,n,i){return(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.NumericValue],void 0,core_1.NodeType.Value)?e.kind===core_1.HXProjectKind.UniApp||e.kind===core_1.HXProjectKind.UniApp_Cli?this.pxConversion(t,o,n,i,!0):this.pxConversion(t,o,n,i,!1):n}getDeduplicationData(e){let t=[];for(var o=e.items.length-1;o>=0;--o)t.includes(e.items[o].label)?e.items.splice(o,1):t.push(e.items[o].label);return e}getMoveCursorData(e,t,o,r){const n=e.offsetAt(t);let i=(0,core_1.getContextData)(e,n,void 0).leftText;const a=(0,contextCompletionProcessor_1.isValueInNode)(e,t),s=vscode_languageserver_1.Position.create(t.line,t.character-i.length),c=(0,core_1.getRightLineTextFromOffset)(e,n).indexOf(";"),d=((0,core_1.getLineTextFromOffset)(e,n),(0,core_1.getRightLineTextFromOffset)(e,n).trim()),l=(0,core_1.getLeftLineTextFromOffset)(e,n),p=l.lastIndexOf(";"),u=l.lastIndexOf(":");d.indexOf(";"),d.indexOf(":");if(-1===c)return r;if(u<p)return r;if(a&&u<t.character&&u>0){if((0,core_1.includesList)(a.context,core_1.notMoveCursorProperty,!0))for(const t of r.items){if(t.textEdit&&t.textEdit.newText.includes("$0"))continue;if(t.textEdit&&t.textEdit.newText.includes("$1"))continue;if(t.kind===vscode_languageserver_1.CompletionItemKind.Function&&t.textEdit&&t.textEdit.newText.includes("$"))continue;if(t.label.endsWith(")"))continue;let o=t.label;t.textEdit?(o=t.textEdit.newText,o.includes("$")&&(o=o.replace(/\$/g,"\\$")),t.textEdit=vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(s,e.positionAt(n+c+1)),`${o};$0`)):(o.includes("$")&&(o=o.replace(/\$/g,"\\$")),t.insertText=`${o};$0`),t.command=void 0,t.insertTextFormat=SnippetFormat}return r}return r}getFiltrationPseudoData(e,t,o,r){if(!(0,util_1.styleIsRightCompletionType)(o,[core_1.NodeType.PseudoSelector],[core_1.NodeType.PseudoSelector],core_1.NodeType.PseudoSelector))return r;let n=[];for(const e of r.items)e.label.startsWith(":")&&n.push(e);return r.items=n,r}retrieveRange(e,t,o,r){const n=(0,util_1.styleIsRightCompletionType)(o,[core_1.NodeType.ElementNameSelector],[core_1.NodeType.ElementNameSelector],core_1.NodeType.Property),i=(0,util_1.styleIsRightCompletionType)(o,[core_1.NodeType.Identifier],[core_1.NodeType.Property],core_1.NodeType.Property),a=(0,util_1.styleIsRightCompletionType)(o,[core_1.NodeType.Ruleset,core_1.NodeType.Declarations],void 0,core_1.NodeType.Property);if(!n&&!i&&!a)return r;const s=e.offsetAt(t),c=((0,core_1.getLineTextFromOffset)(e,s),(0,core_1.getRightLineTextFromOffset)(e,s)),d=(0,core_1.getLeftLineTextFromOffset)(e,s);let l=(0,core_1.getContextData)(e,s,void 0).context;const p=d.lastIndexOf(";"),u=d.lastIndexOf(":"),g=c.indexOf(";"),_=(c.indexOf(";",g+1),c.indexOf(":"));c.indexOf(":",_+1);if(u>p)return r;let m=vscode_languageserver_1.Position.create(t.line,t.character),x=vscode_languageserver_1.Position.create(t.line,t.character),v=!1;if(-1===p)return r;if(-1!==p){if(d.substring(0,d.length-l.length).endsWith(" ")&&(c.startsWith(" ")||c.startsWith("}")))return r;if(0===c.trim().length&&l.endsWith(";"))v=!0;else{if(0===c.trim().length&&!l.includes(";"))return r;0===c.trim().length&&l.includes(";")||c.startsWith(" ")&&l.includes(";")?(m.character=p+1,x.character=p+l.substring(l.indexOf(";")).length):-1!==_&&-1!==g&&_<g?c.trim().endsWith(":;")||c.trim().endsWith(": ;")?(v=!0,m.character=p+1,x.character=x.character+g+1):l.includes(";")?(m.character=p+1,x.character=x.character+c.indexOf(":")):(m.character=m.character-l.length,x.character=x.character+c.indexOf(":")):-1!==_?(v=!0,l.includes(";")&&(m.character=p+1),m.character=m.character-l.length,x.character=x.character+c.indexOf(":")+1):(m.character=p+1,x.character=p+l.substring(l.indexOf(";")).length)}}let f=vscode_languageserver_1.Range.create(m,x);return r.items.forEach((e=>{let t=e.label;e.textEdit&&(t=e.textEdit.newText),v&&e.kind==vscode_languageserver_1.CompletionItemKind.Property&&(t=e.label+": $0;",e.kind=vscode_languageserver_1.CompletionItemKind.Property,e.insertTextFormat=SnippetFormat,e.command=core_1.retriggerCommand),e.textEdit=vscode_languageserver_1.TextEdit.replace(f,t)})),r}getAltMode(e,t,o){const r=(0,contextCompletionProcessor_1.isValueInNode)(e,t);if(!r)return o;let n=!1;const i=(0,vscode_css_languageservice_1.getDefaultCSSDataProvider)().provideProperties().find((e=>e.name===r.context));if(!i||!i.restrictions)return o;for(const e of i.restrictions){(0,core_1.includesList)(e,core_1.numberRestrictions)&&(n=!0);break}return n?(o.items.map((e=>{var t,o;let r={data:null===(t=e.data)||void 0===t?void 0:t.data,hxKind:null===(o=e.data)||void 0===o?void 0:o.hxKind,hxOption:{altMode:!0}};return e.data=r,e})),o):o}setData(e){var t,o,r,n;for(const i of e.items){let e={data:null===(t=i.data)||void 0===t?void 0:t.data,hxKind:null!==(r=null===(o=i.data)||void 0===o?void 0:o.hxKind)&&void 0!==r?r:core_1.HxIconKind.ATTRIBUTE,hxOption:null===(n=i.data)||void 0===n?void 0:n.hxOption};i.data=e}return e}}exports.BaseCompletionProcessor=BaseCompletionProcessor;