"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ScssCompletionProcessor=void 0;const fs=__importStar(require("fs")),path=__importStar(require("path")),vscode_css_languageservice_1=require("vscode-css-languageservice"),vscode_languageserver_1=require("vscode-languageserver"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../../core"),entry_1=require("../../../../htmlservice/entry"),contextCompletionProcessor_1=require("../context/contextCompletionProcessor"),extraProcessor_1=require("../grammar/extraProcessor"),grammarProcessor_1=require("../grammar/grammarProcessor"),util_1=require("../utils/util"),baseCompletionProcessor_1=require("./baseCompletionProcessor"),{SCSSScanner:SCSSScanner}=require("vscode-css-languageservice/lib/umd/parser/scssScanner");class ScssCompletionProcessor extends baseCompletionProcessor_1.BaseCompletionProcessor{constructor(){super(...arguments),this.baseCompletionProcessor=new baseCompletionProcessor_1.BaseCompletionProcessor}getTagCompletionData(e,t,o,r,i){if(!(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.Media,core_1.NodeType.MediaQuery],void 0,core_1.NodeType.Media))return i;const s=t.offsetAt(o),a=(0,core_1.getContextData)(t,s,void 0).leftText;let n=(0,entry_1.getHtmlTags)(e),c=vscode_languageserver_1.Position.create(o.line,o.character-a.length);for(const e of n)i.items.push({label:e,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(c,o),e),kind:vscode_languageserver_1.CompletionItemKind.Keyword,data:{hxKind:core_1.HxIconKind.ELEMENT}});return i}getExclamatoryKeyword(e,t,o,r,i){if(!(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.Declaration,core_1.NodeType.Declarations,core_1.NodeType.VariableDeclaration],void 0,core_1.NodeType.Declaration))return i;const s=t.offsetAt(o),a=(0,core_1.getContextData)(t,s,' \t\n\r":{[()]},*>+;'),n=(0,core_1.getLineTextFromOffset)(t,s);let c=["!global","!default"];if((0,core_1.getLeftLineTextFromOffset)(t,s).includes("$"));else{if(!n.includes("@extend"))return i;c=["!optional"]}for(const e of c)i.items.push({label:e,textEdit:vscode_languageserver_1.TextEdit.replace(a.contextRange,e),kind:vscode_languageserver_1.CompletionItemKind.Property});return i}getScssGrammarCompletionData(e,t,o,r,i){if((null==r?void 0:r.parentType)===core_1.NodeType.MixinReference)return i;r&&!r.isNode||(r=this.getCompletionTypeFromScanner(t,o));const s=(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.Identifier],[core_1.NodeType.Property],core_1.NodeType.Property);return r&&s&&(r.nodeType=core_1.NodeType.Selector),(0,grammarProcessor_1.getGrammarCompletionData)(e,t,o,r,i)}getGrammarCompletionData(e,t,o,r,i){let s={uri:vscode_uri_1.URI.parse(e.sourceRoot).toString(),name:e.sourceRoot};return this.getScssGrammarCompletionData(s,t,o,r,i)}getScopedFunctionsCompletionData(e,t,o,r,i){if(!r)return i;const s=t.offsetAt(o),a=(0,core_1.getContextData)(t,s,' \t\n\r":{[()]},*>+;');if(""===a.context){if(!(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.Declarations,core_1.NodeType.Ruleset],void 0,core_1.NodeType.Value))return i}else{const e=(0,util_1.styleIsRightCompletionType)(r,[core_1.NodeType.Identifier,core_1.NodeType.Term],void 0,core_1.NodeType.Value);if(r.parentType===core_1.NodeType.MixinReference)return i;if(!e)return i}let n=vscode_uri_1.URI.parse(t.uri).fsPath;if(n.includes(".nvue.")||n.includes(".vue."))for(const e of extraProcessor_1.vueStyleScopedFunction)i.items.push({label:e.label,textEdit:vscode_languageserver_1.TextEdit.replace(a.contextRange,e.insertText),kind:vscode_languageserver_1.CompletionItemKind.Function,data:{hxKind:core_1.HxIconKind.FUNCTION}});return i}getGlobalVariable(e,t,o,r,i){if(!(0,contextCompletionProcessor_1.isValueInNode)(t,o))return i;if(e.kind!==core_1.HXProjectKind.UniApp)return i;let s=path.resolve(e.fsPath,"uni.scss");if(!fs.existsSync(s))return i;let a=vscode_languageserver_textdocument_1.TextDocument.create(s,"scss",0,fs.readFileSync(s,{encoding:"utf-8"})),n=(0,vscode_css_languageservice_1.getSCSSLanguageService)().parseStylesheet(a),c=[];n.accept((e=>{var t;return e.type===core_1.NodeType.VariableDeclaration&&e.children&&2===e.children.length&&e.children[0]&&e.children[0].getText()&&c.push({label:e.children[0].getText(),detail:null===(t=e.children[1])||void 0===t?void 0:t.getText()}),!0}));const l=t.offsetAt(o),d=(0,core_1.getContextData)(t,l,' \t\n\r":{[()]},*>+;');for(const e of c)i.items.push({label:e.label,documentation:`${e.detail}\n                定义于：<br><a href="file://${s}">${s}</a>`,textEdit:vscode_languageserver_1.TextEdit.replace(d.contextRange,e.label),kind:vscode_languageserver_1.CompletionItemKind.Property});return i}getExtraCompletionData(e,t,o,r,i){let s={uri:vscode_uri_1.URI.parse(e.sourceRoot).toString(),name:e.sourceRoot};return i=this.baseCompletionProcessor.getExtraCompletionData(e,t,o,r,i),i=this.getTagCompletionData(s,t,o,r,i),i=this.getExclamatoryKeyword(s,t,o,r,i),i=this.getScopedFunctionsCompletionData(e,t,o,r,i),i=this.getGlobalVariable(e,t,o,r,i)}doExtraCompletion(e,t,o,r,i,s,a){const n=this.isErrorAstNode(t,o,r);let c=this.getCompletionTypeFromAstNode(t,o,r);return(n||0===i.items.length)&&(c=this.getCompletionTypeFromScanner(t,o),i=this.getCompletionDataFromScanner(t,o,c,a)),i.items&&(i.items=i.items.map((e=>(e=this.initData(e),e=this.kindConverted(e))))),i=this.getDeprecatedCompletionData(t,o,c,i),i=this.getFunctionsCompletionData(t,o,c,i),i=this.getMediaCompletionData(t,o,c,i),i=this.getCharsetCompletionData(t,o,c,i),i=this.getPathCompletionData(e,t,o,c,i),i=this.getPropertySelectorCompletionData(e,t,o,c,i),i=this.getExtraCompletionData(e,t,o,c,i),i=this.getSelfIdSelectorCompletionData(t,o,c,i),i=this.getIndexIdSelectorsCompletionData(e,t,o,c,i),i=this.getIndexClassSelectorsCompletionData(e,t,o,c,i),i=this.getGrammarCompletionData(e,t,o,c,i),i=this.getPxConversionCompletionData(e,t,o,c,i,s),i=this.getDeduplicationData(i),i=this.getFiltrationPseudoData(t,o,c,i),i=this.retrieveRange(t,o,c,i),i=this.getMoveCursorData(t,o,c,i),i=this.getAltMode(t,o,i),i=this.setData(i)}}exports.ScssCompletionProcessor=ScssCompletionProcessor;