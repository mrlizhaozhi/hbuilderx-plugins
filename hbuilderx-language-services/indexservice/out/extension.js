"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.deactivate=exports.activate=void 0;const path=require("path"),vscode=require("vscode"),node_1=require("vscode-languageclient/node"),vscode_uri_1=require("vscode-uri"),client_1=require("../../utils/client"),editorWatch_1=require("./editorWatch"),fileFilter_1=require("./fileFilter"),request_1=require("./request"),hx=require("hbuilderx"),nls=require("./localize/localize"),localize=nls.loadMessageBundle(__filename);let client,clientReady=!1;function activate(e){const t=e.asAbsolutePath(path.join("indexservice","out","server","server.js"));let r;r=e.extensionMode==vscode.ExtensionMode.Development?{execArgv:["--nolazy","--inspect=6509"]}:{execArgv:["--nolazy"]};const i={run:{module:t,transport:node_1.TransportKind.ipc},debug:{module:t,transport:node_1.TransportKind.ipc,options:r}},n={documentSelector:fileFilter_1.supportLanguages,synchronize:{fileEvents:vscode.workspace.createFileSystemWatcher(fileFilter_1.supportNameGlob)},outputChannel:new client_1.LogRedirectOutputChannel("LanguageServerIndex")};client=new node_1.LanguageClient("LanguageServerIndex","LanguageServerIndex",i,n),client.start(),client.onReady().then((()=>{clientReady=!0,e.subscriptions.push((0,editorWatch_1.watchActivateTextEditor)(client))}));let s=hx.commands.registerCommand("indexService.rebuildIndex",(e=>{let t,r=null,i="";if(e instanceof Array&&e.length>0?t=e[0].workspaceFolder:e&&(t=e.workspaceFolder),t&&t.uri&&"file"==t.uri.scheme&&(i=t.name,r=vscode_uri_1.URI.file(t.uri.fsPath)),r){let e=r.toString();hx.window.setStatusBarMessage(localize("index.build.processing","正在构建项目[{0}]索引...",i),-1),client.sendRequest(request_1.RebuildProjectIndexRequest.type,{folderUri:e}).then((()=>{let e=localize("index.build.finish","项目[{0}]构建索引完成",i);hx.window.setStatusBarMessage(e,5e3)}),(e=>{let t=localize("index.build.error","项目[{0}]构建索引失败",i);if(e.message)t+=`: ${e.message}`;else if(e.data){t+=`: ${e.data.toString()}`}hx.window.setStatusBarMessage(t,5e3,"error")}))}else{let e=localize("index.build.error.invalidProject","构建索引失败: 无效的项目");hx.window.setStatusBarMessage(e,5e3,"error")}}));return e.subscriptions.push(s),{registerLanguageIndexProcessor:function(e){const t=e;try{clientReady?client.sendRequest(request_1.RegisterProcessorRequest.type,t):client.onReady().then((()=>{client.sendRequest(request_1.RegisterProcessorRequest.type,t)}))}catch(e){console.log(e)}}}}function deactivate(){if(client)return client.stop()}exports.activate=activate,exports.deactivate=deactivate;