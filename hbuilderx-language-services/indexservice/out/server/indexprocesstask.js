"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.IndexProcessTask=exports.ProjectActiveReason=void 0;const indexlib_1=require("../../../indexlib"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),fileFilter_1=require("../fileFilter"),fs=require("fs"),path=require("path"),vscode_uri_1=require("vscode-uri"),filterDirs=[".git",".svn","node_modules","unpackage",".hbuilderx"],maxFileSize=5242880,projectFiles=new Map;var ProjectActiveReason;!function(e){e[e.ActiveFile=0]="ActiveFile",e[e.RebuildIndex=1]="RebuildIndex"}(ProjectActiveReason=exports.ProjectActiveReason||(exports.ProjectActiveReason={}));class IndexProcessTask{constructor(e,t){this._storeMap=new Map,this._traverseTask=new Map,this._activatedFolders=new Map,this._processorManager=t,this._onFolderIndexFinished=new vscode_languageserver_protocol_1.Emitter,this._documents=e}addActivatedProject(e,t){if(t==ProjectActiveReason.RebuildIndex)e&&(this._activatedFolders.set(e.uri,1),this.startFolder(e));else if(t==ProjectActiveReason.ActiveFile){let t=Array.from(this._activatedFolders.keys());for(let e of t)2==this._activatedFolders.get(e)&&this._activatedFolders.delete(e);(null==e?void 0:e.uri)&&(this._activatedFolders.set(e.uri,2),this.startFolder(e))}}doProjectFileIndex(e,t={canceled:!1}){return new Promise((r=>{let s=()=>{var i,o;let a=null!==(i=projectFiles.get(e.uri))&&void 0!==i?i:[];if(t.canceled||0==a.length)return void r();if(!this._activatedFolders.has(e.uri)){for(let e of this._activatedFolders.keys())if((null!==(o=projectFiles.get(e))&&void 0!==o?o:[]).length>0)return void setTimeout(s,200);this._activatedFolders.set(e.uri,2)}let n=a.shift();this.doIndexForFile2(n,e),setTimeout(s,10)};s()}))}createTask(e){const t=e.uri;let r=!1,s=!1;projectFiles.set(t,[]);let i=e=>{if(fileFilter_1.supportNameReg.test(e))return!0;{let t=vscode_languageserver_textdocument_1.TextDocument.create(e,"",1,"");return this._processorManager.getProcessorForLanguage("").some((e=>e.support(t)))}};function o(e){const s=e;return new Promise(((e,a)=>{fs.readdir(s,{withFileTypes:!0},((n,l)=>{var d;if(n)return void a(n);const c=[];let u=null!==(d=projectFiles.get(t))&&void 0!==d?d:[];u.length>1e3||r?e():(l.forEach((e=>{const t=e.name;if(e.isFile()&&i(t)){const e=path.join(s,t);fs.statSync(e).size<5242880&&u.push(vscode_uri_1.URI.file(e).toString())}else e.isDirectory()&&!filterDirs.includes(t)&&c.push(path.join(s,t))})),u.length>1e3||0==c.length||r?e():Promise.all(c.map((e=>o(e)))).then((()=>{e()})))}))}))}let a={canceled:r},n=this.doProjectFileIndex.bind(this,e,a);return{doIndex:function(){s=!0;let t=vscode_uri_1.URI.parse(e.uri).fsPath;return t?o(t).then(n):Promise.reject("项目路径无效")},isStarted:function(){return s},cancel:function(){r=!0,a.canceled=!0}}}addProject(e,t=!1){if(!this._traverseTask.has(e.uri)){let t=this.createTask(e);this._traverseTask.set(e.uri,t)}return t&&this.startFolder(e),this.createWatch(e)}startFolder(e){let t=this._traverseTask.get(e.uri);t&&!t.isStarted()&&t.doIndex().then((()=>{}),(t=>{throw this._activatedFolders.delete(e.uri),console.log(t),t})).catch().finally((()=>{projectFiles.delete(e.uri),this._activatedFolders.delete(e.uri),this._traverseTask.delete(e.uri),this._onFolderIndexFinished.fire(e)}))}createWatch(e){return new Promise((t=>{if(this._traverseTask.has(e.uri)){let r=this._onFolderIndexFinished.event((s=>{s.uri==e.uri&&(t(),r.dispose())}))}else t()}))}removeIndexTask(e,t=!1){return new Promise((r=>{let s=()=>{if(t){let t=this.getStore(e);t.removeAll(),t.save()}},i=this._traverseTask.get(e.uri);if(i){let t=this._onFolderIndexFinished.event((i=>{i.uri==e.uri&&(s(),r(),t.dispose())}));return i.cancel(),void this.startFolder(e)}s(),r()}))}removeIndexForFile(e,t){let r=this.getStore(t);r.removeIndex(e),r.save()}doIndexForFile2(e,t){try{let r=this._documents.get(e);if(!r){let t=vscode_uri_1.URI.parse(e).fsPath;fs.existsSync(t)&&(r=vscode_languageserver_textdocument_1.TextDocument.create(e,"",1,fs.readFileSync(t,{encoding:"utf-8"})))}r&&this.doIndexForDocument2(r,t)}catch(e){}}doIndexForDocument2(e,t){let r=e.uri,s=this.getStore(t);if(s.removeIndex(r),fs.existsSync(vscode_uri_1.URI.parse(r).fsPath)){let i=e.languageId;this._processorManager.getProcessorForLanguage(i).forEach((i=>{if(i.support(e,t)){let o=i.doIndex(e,t),a=[];o["html.class"]&&o["html.class"].forEach((e=>{e.label.includes(":")||a.push(e)})),o["html.class"]=a;let n=[];o["html.id"]&&o["html.id"].forEach((e=>{e.label.includes(":")||n.push(e)})),o["html.id"]=n,s.addIndexData(r,o)}}))}s.save()}doIndexForFile(e,t){var r;let s=null!==(r=projectFiles.get(t.uri))&&void 0!==r?r:[];if(0==s.length)this.doIndexForFile2(e,t);else{(s?s.indexOf(e):-1)<0&&s.push(e)}}doIndexForDocument(e,t){this.doIndexForDocument2(e,t)}getStore(e){const t=e.uri.toString();if(!this._storeMap.has(t)){let r=indexlib_1.IndexDataStore.loadWithWrite(e);this._storeMap.set(t,r)}return this._storeMap.get(t)}}exports.IndexProcessTask=IndexProcessTask;