"use strict";var __awaiter=this&&this.__awaiter||function(e,n,o,t){return new(o||(o=Promise))((function(r,i){function s(e){try{l(t.next(e))}catch(e){i(e)}}function a(e){try{l(t.throw(e))}catch(e){i(e)}}function l(e){var n;e.done?r(e.value):(n=e.value,n instanceof o?n:new o((function(e){e(n)}))).then(s,a)}l((t=t.apply(e,n||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.StylusDefinitionProvider=void 0;const vscode_1=require("vscode"),parser_1=require("./parser"),utils_1=require("./utils");class StylusDefinitionProvider{getCurrentWorkspaceFolder(e,n){let o=[];for(const t of e)n.uri.toString().startsWith(t.uri.toString())&&o.push(t);return o.sort(((e,n)=>e.uri.toString().length-n.uri.toString().length)),o}isVariableReferenceNode(e,n){return"property"===e.nodeName&&e.expr&&"expression"===e.expr.nodeName&&"ident"===e.expr.nodes[0].nodeName&&e.expr.column<=n.character}isFunctionReferenceNode(e,n){return"call"===e.nodeName&&"selector"!==e.name||"property"===e.nodeName&&e.expr&&"expression"===e.expr.nodeName&&"call"===e.expr.nodes[0].nodeName&&e.expr.column<=n.character}getCurrentWordAtPosition(e,n){let o={word:"",type:""};for(const t of e)if(t.lineno===n.line+1&&!(t.column>n.character)){if((0,parser_1.isSelectorNode)(t)){let e="";for(const n of t.segments)e+=n.string;o.type="selector",o.word=e}this.isVariableReferenceNode(t,n)&&(o.type="variable",o.word=t.expr.nodes[0].name),this.isFunctionReferenceNode(t,n)&&(o.type="function",o.word=t.name,o.word||(o.word=t.expr.nodes[0].name))}return o}getDefinitionDataFromSelf(e,n,o){return __awaiter(this,void 0,void 0,(function*(){let t=[];for(const r of n)if("ident"===r.nodeName&&"function"===o.type){if(r.name===o.word){let n=new vscode_1.Position(r.val.lineno-1,r.val.column-1),i=new vscode_1.Position(r.val.lineno-1,o.word.length);t.push({uri:e.uri,range:new vscode_1.Range(n,i)})}}else if("ident"===r.nodeName&&"variable"===o.type){if(r.name===o.word){let n=new vscode_1.Position(r.val.lineno-1,r.column-1),i=new vscode_1.Position(r.val.lineno-1,o.word.length);t.push({uri:e.uri,range:new vscode_1.Range(n,i)})}}else if("selector"===r.nodeName&&"selector"===o.type){let n="";for(const e of r.segments)n+=e.string;if(n===o.word){let n=new vscode_1.Position(r.lineno-1,r.column-1),i=new vscode_1.Position(r.lineno-1,o.word.length);t.push({uri:e.uri,range:new vscode_1.Range(n,i)})}}return t.length>0?t:null}))}provideDefinition(e,n,o){const t=e.getText(),r=(0,parser_1.buildAst)(t),i=(0,utils_1.compact)((0,parser_1.flattenAndFilterAst)(r));let s=this.getCurrentWordAtPosition(i,n);return Promise.resolve().then((()=>this.getDefinitionDataFromSelf(e,i,s)))}}exports.StylusDefinitionProvider=StylusDefinitionProvider;