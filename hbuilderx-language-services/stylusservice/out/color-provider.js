"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.StylusColorProvider=exports.getColors=exports.extractColorsFromExpression=exports.normalizeColors=exports.getRealCallColumn=exports.getRealColumn=exports.buildCallValueFromArgs=void 0;const vscode_1=require("vscode"),parser_1=require("./parser"),colors_1=require("./colors"),buildCallValueFromArgs=o=>o.nodes.map((o=>o.nodes[0].val)).join(", ");exports.buildCallValueFromArgs=buildCallValueFromArgs;const getRealColumn=(o,e,l)=>Math.max(e[l].indexOf(o),0);exports.getRealColumn=getRealColumn;const getRealCallColumn=(o,e,l)=>{const r=Math.max(e[l].indexOf(o),0),n=e[l].slice(r);return Math.max(e[l].indexOf(o),0)+n.indexOf(")")+1};function normalizeColors(o,e){const l=[],r=new Set;return o.forEach((o=>{var n,t,s,a,i;if("ident"===o.nodeName&&colors_1.colors[o.name])try{const t=(0,colors_1.colorFromHex)(colors_1.colors[o.name]),s=`${o.lineno-1}-${(0,exports.getRealColumn)(o.name,e,o.lineno-1)}`;r.has(s)||(r.add(s),l.push(new vscode_1.ColorInformation(new vscode_1.Range(new vscode_1.Position(o.lineno-1,(0,exports.getRealColumn)(o.name,e,o.lineno-1)),new vscode_1.Position(o.lineno-1,(0,exports.getRealColumn)(o.name,e,o.lineno-1)+(null===(n=o.name)||void 0===n?void 0:n.length)||0)),new vscode_1.Color(t.red,t.green,t.blue,t.alpha))))}catch(o){}else if("rgba"===o.nodeName)try{const n=`${o.lineno-1}-${(0,exports.getRealColumn)(o.raw,e,o.lineno-1)}`;r.has(n)||(r.add(n),l.push(new vscode_1.ColorInformation(new vscode_1.Range(new vscode_1.Position(o.lineno-1,(0,exports.getRealColumn)(o.raw,e,o.lineno-1)),new vscode_1.Position(o.lineno-1,(0,exports.getRealColumn)(o.raw,e,o.lineno-1)+(null===(t=o.raw)||void 0===t?void 0:t.length)||0)),new vscode_1.Color(o.r,o.g,o.b,o.a))))}catch(o){}else if("call"===o.nodeName)try{const n=null===(i=null===(a=null===(s=null==o?void 0:o.args)||void 0===s?void 0:s.nodes)||void 0===a?void 0:a.map)||void 0===i?void 0:i.call(a,(o=>o.nodes[0].val));if(!n||n.length<3||n.length>4)return;const t=4===n.length?(0,colors_1.getNumericValue)(n[3],1):1,c=o.name,d=`${o.lineno-1}-${(0,exports.getRealColumn)(o.name,e,o.lineno-1)}`;if(r.has(d));else if(r.add(d),"rgb"===c||"rgba"===c)l.push(new vscode_1.ColorInformation(new vscode_1.Range(new vscode_1.Position(o.lineno-1,(0,exports.getRealColumn)(o.name,e,o.lineno-1)),new vscode_1.Position(o.lineno-1,(0,exports.getRealCallColumn)(o.name,e,o.lineno-1))),new vscode_1.Color((0,colors_1.getNumericValue)(n[0],255),(0,colors_1.getNumericValue)(n[1],255),(0,colors_1.getNumericValue)(n[2],255),t)));else if("hsl"===c||"hsla"===c){const r=(0,colors_1.getAngle)(n[0]),s=(0,colors_1.getNumericValue)(n[1],100),a=(0,colors_1.getNumericValue)(n[2],100),i=(0,colors_1.colorFromHSL)(r,s,a,t);l.push(new vscode_1.ColorInformation(new vscode_1.Range(new vscode_1.Position(o.lineno-1,(0,exports.getRealColumn)(o.name,e,o.lineno-1)),new vscode_1.Position(o.lineno-1,(0,exports.getRealCallColumn)(o.name,e,o.lineno-1))),new vscode_1.Color(i.red,i.green,i.blue,i.alpha)))}}catch(o){}})),r.clear(),l}function extractColorsFromExpression(o){let e=[];return"expression"===o.nodeName&&o.nodes.forEach((o=>{(0,parser_1.isColor)(o)?e.push(o):"object"===o.nodeName&&Object.keys(o.vals).forEach((l=>{e=e.concat(extractColorsFromExpression(o.vals[l]))}))})),e}function getColors(o){return(o.nodes||o||[]).reduce(((o,e)=>("ident"===e.nodeName&&(o=o.concat(extractColorsFromExpression(e.val))),"property"===e.nodeName&&e.expr&&(o=o.concat(extractColorsFromExpression(e.expr))),o)),[])}exports.getRealCallColumn=getRealCallColumn,exports.normalizeColors=normalizeColors,exports.extractColorsFromExpression=extractColorsFromExpression,exports.getColors=getColors;class StylusColorProvider{provideDocumentColors(o,e){if(e.isCancellationRequested)return[];const l=o.getText();return normalizeColors(getColors((0,parser_1.flattenAndFilterAst)((0,parser_1.buildAst)(l))),l.split("\n"))}provideColorPresentations(o,e,l){if(l.isCancellationRequested)return[];const r=[],n=Math.round(255*o.red),t=Math.round(255*o.green),s=Math.round(255*o.blue);let a;a=1===o.alpha?`rgb(${n}, ${t}, ${s})`:`rgba(${n}, ${t}, ${s}, ${o.alpha})`,r.push({label:a,textEdit:vscode_1.TextEdit.replace(e.range,a)}),a=1===o.alpha?`#${(0,colors_1.toTwoDigitHex)(n)}${(0,colors_1.toTwoDigitHex)(t)}${(0,colors_1.toTwoDigitHex)(s)}`:`#${(0,colors_1.toTwoDigitHex)(n)}${(0,colors_1.toTwoDigitHex)(t)}${(0,colors_1.toTwoDigitHex)(s)}${(0,colors_1.toTwoDigitHex)(Math.round(255*o.alpha))}`,r.push({label:a,textEdit:vscode_1.TextEdit.replace(e.range,a)});const i=(0,colors_1.hslFromColor)(o);return a=1===i.a?`hsl(${i.h}, ${Math.round(100*i.s)}%, ${Math.round(100*i.l)}%)`:`hsla(${i.h}, ${Math.round(100*i.s)}%, ${Math.round(100*i.l)}%, ${i.a})`,r.push({label:a,textEdit:vscode_1.TextEdit.replace(e.range,a)}),r}}exports.StylusColorProvider=StylusColorProvider;