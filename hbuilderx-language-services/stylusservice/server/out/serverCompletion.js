"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getValues=exports.getProperties=exports.getAtRules=exports.getAllSymbols=exports.findPropertySchema=exports.getPropertyName=exports.isValue=exports.isAtRule=exports.isClassOrId=void 0;const vscode_css_languageservice_1=require("vscode-css-languageservice"),vscode_languageserver_1=require("vscode-languageserver"),built_in_1=require("./built-in"),css_built_in_1=require("./css-built-in"),languageFacts_1=require("./languageFacts"),parser_1=require("./parser"),utils_1=require("./utils");function isClassOrId(e){return e.startsWith(".")||e.startsWith("#")||e.startsWith("&")}function isAtRule(e){return e.startsWith("@")}function isValue(e,t){const r=getPropertyName(t),s=findPropertySchema(e,r);return!(!r||!s)}function getPropertyName(e){return e.trim().replace(":"," ").split(" ")[0]}function findPropertySchema(e,t){return e.provideProperties().find((e=>e.name===t))}function _variableSymbol(e,t,r){const s=e.name,i=Number(e.val.lineno)-1,l={label:s};return l.detail=t[i].trim(),l.kind=vscode_languageserver_1.CompletionItemKind.Variable,l}function _functionSymbol(e,t){const r={label:e.name};return r.kind=vscode_languageserver_1.CompletionItemKind.Function,r}function _selectorSymbol(e,t,r){const s=e.segments[0],i={label:s.string?e.segments.map((e=>e.string)).join(""):s.nodes.map((e=>e.name)).join("")};return i.kind=vscode_languageserver_1.CompletionItemKind.Class,i}function _selectorCallSymbol(e,t){const r=Number(e.lineno)-1,s={label:(0,utils_1.prepareName)(t[r])};return s.kind=vscode_languageserver_1.CompletionItemKind.Class,s}function getAllSymbols(e,t){var r;const s=(0,parser_1.buildAst)(e),i=e.split("\n"),l=null===(r=(0,parser_1.flattenAndFilterAst)(s))||void 0===r?void 0:r.filter((e=>e&&-1===["media","keyframes","atrule","import","require","supports","literal"].indexOf(e.nodeName))),o=null==l?void 0:l.map((e=>(0,parser_1.isVariableNode)(e)?_variableSymbol(e,i,t):(0,parser_1.isFunctionNode)(e)?_functionSymbol(e,i):(0,parser_1.isSelectorNode)(e)?_selectorSymbol(e,i,t):(0,parser_1.isSelectorCallNode)(e)?_selectorCallSymbol(e,i):void 0));if(o&&void 0!==o[0])return o}function getAtRules(e,t){return isAtRule(t)?e.provideAtDirectives().map((e=>{var t;const r={label:e.name};return r.detail=null===(t=e.description)||void 0===t?void 0:t.toString(),r.kind=vscode_languageserver_1.CompletionItemKind.Keyword,r})):[]}function getProperties(e,t,r){return isClassOrId(t)||isAtRule(t)?[]:e.provideProperties().map((e=>{const t={label:e.name};return t.insertText=e.name+(r?": ":" "),t.documentation=(0,languageFacts_1.getPropertyDescription)(e).value,t.kind=vscode_languageserver_1.CompletionItemKind.Property,t}))}function getValues(e,t){const r=findPropertySchema(e,getPropertyName(t));return r&&r.values?r.values.map((e=>{var t;const r={label:e.name};return r.detail=null===(t=e.description)||void 0===t?void 0:t.toString(),r.insertText=e.name.replace(")","$0)"),r.kind=vscode_languageserver_1.CompletionItemKind.Value,r})):[]}exports.isClassOrId=isClassOrId,exports.isAtRule=isAtRule,exports.isValue=isValue,exports.getPropertyName=getPropertyName,exports.findPropertySchema=findPropertySchema,exports.getAllSymbols=getAllSymbols,exports.getAtRules=getAtRules,exports.getProperties=getProperties,exports.getValues=getValues;class StylusServerCompletion{provideCompletionItems(e,t){const r=vscode_languageserver_1.Position.create(t.line,0),s=(0,vscode_css_languageservice_1.getDefaultCSSDataProvider)(),i=vscode_languageserver_1.Range.create(r,t),l=e.getText(i).trim(),o=e.getText();let n=[],a=[],u=[],c=[],p=[];isValue(s,l)?(c=getValues(s,l),p=getAllSymbols(o,l),p&&(n=(0,utils_1.compact)(p).filter((e=>e.kind===vscode_languageserver_1.CompletionItemKind.Variable)))):(a=getAtRules(s,l),u=getProperties(s,l,!0),p=getAllSymbols(o,l),p&&(n=(0,utils_1.compact)(p)));let d=[];return d=d.concat(n,a,u,c,css_built_in_1.default,built_in_1.default),l.startsWith(".")&&(d=d.filter((e=>e.label.startsWith(l)))),{isIncomplete:!1,items:d}}}exports.default=StylusServerCompletion;