"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseCompletionProcessor=void 0;const path_1=require("path"),vscode_css_languageservice_1=require("vscode-css-languageservice"),vscode_languageserver_1=require("vscode-languageserver"),vscode_uri_1=require("vscode-uri"),entry_1=require("../../../../htmlservice/entry"),indexlib_1=require("../../../../indexlib"),utils_1=require("../../../../utils"),contextCompletionProcessor_1=require("../context/contextCompletionProcessor"),extraProcessor_1=require("../grammar/extraProcessor"),grammarProcessor_1=require("../grammar/grammarProcessor"),baseIndexProcessor_1=require("../index/baseIndexProcessor"),util_1=require("../utils/util"),{Scanner:Scanner}=require("vscode-css-languageservice/lib/umd/parser/cssScanner"),{ParseErrorCollector:ParseErrorCollector}=require("vscode-css-languageservice/lib/umd/parser/cssNodes"),SnippetFormat=vscode_languageserver_1.InsertTextFormat.Snippet,retriggerCommand={title:"Suggest",command:"editor.action.triggerSuggest"};class BaseCompletionProcessor{constructor(){this.getCompletionTypeFromScanner=contextCompletionProcessor_1.getCompletionTypeFromScanner,this.getCompletionDataFromScanner=contextCompletionProcessor_1.getCompletionDataFromScanner,this.getGrammarCompletionData=grammarProcessor_1.getGrammarCompletionData}async doExtraCompletion(e,t,i,r,a,n,o){const s=this.isErrorAstNode(t,i,r);let l=this.getCompletionTypeFromAstNode(t,i,r);return(s||0===o.items.length)&&(l=this.getCompletionTypeFromScanner(t,i),o=await this.getCompletionDataFromScanner(t,i,l)),o=await this.getHxKindConvertedCompletionData(o),o=await this.getSelfIdSelectorCompletionData(t,i,l,o),o=await this.getDeprecatedCompletionData(t,i,l,o),o=await this.getFunctionsCompletionData(t,i,l,o),o=await this.getMediaCompletionData(t,i,l,o),o=await this.getCharsetCompletionData(t,i,l,o),o=await this.getPathCompletionData(e,t,i,l,o),o=await this.getPropertySelectorCompletionData(e,t,i,l,o),o=await this.getExtraCompletionData(e,t,i,l,a,n,o),o=await this.getIndexIdSelectorsCompletionData(e,t,i,l,o),o=await this.getIndexClassSelectorsCompletionData(e,t,i,l,o),o=await this.getGrammarCompletionData(e,t,i,l,o),o=await this.getPxConversionCompletionData(e,t,i,l,a,n,o),o=await this.getDeduplicationData(o),o=await this.getFiltrationPseudoData(t,i,l,o),o=await this.retrieveRange(t,i,l,o),o=await this.getMoveCursorData(t,i,l,o),o=await this.getAltMode(t,i,o)}isErrorAstNode(e,t,i){const r=e.offsetAt(t),a=ParseErrorCollector.entries(i);for(const e of a)if(e.offset+e.length<r)return!0;return!1}getCompletionTypeFromAstNode(e,t,i){var r,a;const n=e.offsetAt(t),o=(0,util_1.getNodeAtOffset)(i,n);return{type:null==o?void 0:o.type,parentType:null===(r=null==o?void 0:o.parent)||void 0===r?void 0:r.type,nodeType:null==o?void 0:o.nodeType,parentNodeType:null===(a=null==o?void 0:o.parent)||void 0===a?void 0:a.nodeType,isNode:!0}}getHxKind(e,t,i){if(e)return e;if(t||(t=vscode_languageserver_1.CompletionItemKind.Text),t===vscode_languageserver_1.CompletionItemKind.Keyword){if(util_1.html5Tags.includes(i)||util_1.svgElements.includes(i))return utils_1.HxIconKind.ELEMENT;if(i.startsWith("."))return utils_1.HxIconKind.CLASS;if(i.startsWith("#"))return utils_1.HxIconKind.ID;if(i.startsWith("@"))return utils_1.HxIconKind.ATTRIBUTE}else if(t===vscode_languageserver_1.CompletionItemKind.Function){if(i.endsWith("()"))return utils_1.HxIconKind.FUNCTION;if(i.startsWith(":"))return utils_1.HxIconKind.CLASS}return utils_1.HxIconKind.DEFAULT}async getHxKindConvertedCompletionData(e){var t;for(const i of e.items){let e;i.data&&(e=i.data);let r=i.kind,a=i.label,n=null===(t=i.data)||void 0===t?void 0:t.hxKind;i.data={hxKind:this.getHxKind(n,r,a),oriData:e}}return e}async getSelfIdSelectorCompletionData(e,t,i,r){if(!(0,util_1.isRightCompletionType)(i,void 0,[util_1.NodeType.ClassSelector,util_1.NodeType.IdentifierSelector,util_1.NodeType.ElementNameSelector],util_1.NodeType.Selector))return r;let a=e.offsetAt(t),n=(0,util_1.getCurrentWord)(e,a);const o={};o[n]=!0;e.getText();let s=vscode_languageserver_1.Position.create(t.line,t.character-n.length);const l=(0,contextCompletionProcessor_1.getTokenList)(e);for(let e=0;e<l.length;e++)l[e].type===util_1.TokenType.Hash&&("#"!==l[e].text.charAt(0)||o[l[e].text]||(o[l[e].text]=!0,r.items.push({label:l[e].text,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(s,t),l[e].text),kind:vscode_languageserver_1.CompletionItemKind.Keyword,data:{hxKind:utils_1.HxIconKind.ID}})));return r}async getSelfClassSelectorCompletionData(e,t,i,r){if(!(0,util_1.isRightCompletionType)(i,void 0,[util_1.NodeType.ClassSelector,util_1.NodeType.IdentifierSelector,util_1.NodeType.ElementNameSelector],util_1.NodeType.Selector))return r;let a=e.offsetAt(t),n=(0,util_1.getCurrentWord)(e,a);const o={};o[n]=!0;const s=e.getText();let l=vscode_languageserver_1.Position.create(t.line,t.character-n.length);o[n]=!0;return(0,vscode_css_languageservice_1.getCSSLanguageService)().parseStylesheet(e).accept((e=>{if(e.type===util_1.NodeType.SimpleSelector&&e.length>0){const i=s.substring(e.offset,e.length);return"."!==i.charAt(0)||o[i]||(o[i]=!0,r.items.push({label:i,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(l,t),i),kind:vscode_languageserver_1.CompletionItemKind.Keyword})),!1}return!0})),r}addCalcFunction(e,t,i,r){const a=e.offsetAt(i),n=(0,util_1.getOffsetLeftLineText)(e,a).indexOf(":"),o=e.getText(vscode_languageserver_1.Range.create(vscode_languageserver_1.Position.create(i.line,0),vscode_languageserver_1.Position.create(i.line,n))).trim(),s=(0,vscode_css_languageservice_1.getDefaultCSSDataProvider)().provideProperties();let l=!1;for(const e of s){if(o!==e.name)continue;const t=e.restrictions;if(t&&t.length>0)for(const e of t)if(l=(0,util_1.includesList)(e,util_1.calcRestrictionTypes),l)break;if(l)break}return l&&r.items.push({label:"calc()",documentation:"Evaluates an mathematical expression. The following operators can be used: + - * /.",textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(t,i),"calc()"),kind:vscode_languageserver_1.CompletionItemKind.Function}),r}async getFunctionsCompletionData(e,t,i,r){if(!i)return r;const a=e.offsetAt(t),n=(0,util_1.getCurrentWord)(e,a);if(""===n){if(!(0,util_1.isRightCompletionType)(i,[util_1.NodeType.Declarations,util_1.NodeType.Ruleset],void 0,util_1.NodeType.Value))return r}else{if(!(0,util_1.isRightCompletionType)(i,[util_1.NodeType.Identifier,util_1.NodeType.Term],void 0,util_1.NodeType.Value))return r}let o=vscode_languageserver_1.Position.create(t.line,t.character-n.length);r.items.push({label:"var()",documentation:"Evaluates the value of a custom variable.",textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(o,t),"var()"),kind:vscode_languageserver_1.CompletionItemKind.Function});let s=this.addCalcFunction(e,o,t,r);return r.items.push(...s.items),r}getMediaType(e){if(e.endsWith("@media"))return"all";if(e.endsWith("not")||e.endsWith("only")||e.endsWith(","))return"mediaType";if(e.endsWith("("))return"mediaFeature";if(e.endsWith(")"))return"mediaLogicalOperator";for(const t of extraProcessor_1.mediaTypes)if(e.endsWith(t.name))return"mediaLogicalOperator"}async getMediaCompletionData(e,t,i,r){if(!(0,util_1.isRightCompletionType)(i,[util_1.NodeType.Media,util_1.NodeType.MediaQuery],void 0,util_1.NodeType.Media))return r;let a=e.offsetAt(t),n=(0,util_1.getCurrentWord)(e,a),o=(vscode_languageserver_1.Range.create(vscode_languageserver_1.Position.create(t.line,0),t),vscode_languageserver_1.Range.create(vscode_languageserver_1.Position.create(t.line,0),vscode_languageserver_1.Position.create(t.line,t.character-n.length))),s=e.getText(o).trim(),l=vscode_languageserver_1.Position.create(t.line,t.character-n.length),c=this.getMediaType(s);if(r.items=[],!c)return r;switch("all"===c&&(r.items.push({label:"ont",detail:"mediaLogicalOperator",textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(l,t),"ont"),kind:vscode_languageserver_1.CompletionItemKind.Property}),r.items.push({label:"only",detail:"mediaLogicalOperator",textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(l,t),"only"),kind:vscode_languageserver_1.CompletionItemKind.Property})),c){case"all":case"mediaType":for(const e of extraProcessor_1.mediaTypes)r.items.push({label:e.name,detail:"mediaType",documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(l,t),e.name),kind:vscode_languageserver_1.CompletionItemKind.Property});break;case"mediaLogicalOperator":for(const e of extraProcessor_1.mediaLogicalOperators)r.items.push({label:e,detail:"mediaLogicalOperator",textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(l,t),e),kind:vscode_languageserver_1.CompletionItemKind.Property});break;case"mediaFeature":for(const e of extraProcessor_1.mediaFeatures)r.items.push({label:e.name,detail:"mediaFeature",documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(l,t),e.name),kind:vscode_languageserver_1.CompletionItemKind.Property})}return r}async getCharsetCompletionData(e,t,i,r){if(!(0,util_1.isRightCompletionType)(i,[util_1.NodeType.Stylesheet],void 0,void 0,"charset"))return r;const a=e.offsetAt(t),n=(0,util_1.getOffsetLeftLineText)(e,a),o=(0,util_1.getOffsetRightLineText)(e,a),s=n.indexOf('"'),l=n.indexOf("'");if(-1===s&&-1===l)return r;let c=vscode_languageserver_1.Position.create(t.line,s+1),d=vscode_languageserver_1.Position.create(t.line,o.indexOf('"')+n.length);l>-1&&(c=vscode_languageserver_1.Position.create(t.line,l+1),d=vscode_languageserver_1.Position.create(t.line,o.indexOf("'")+n.length));const u=vscode_languageserver_1.Range.create(c,d);if(n.includes("@charset")){r.items=[];for(const e of extraProcessor_1.charsetFeatures)r.items.push({label:e.name,detail:"mediaFeature",documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(u,e.name),kind:vscode_languageserver_1.CompletionItemKind.Property})}return r}getFileIconType(e){let t=utils_1.HxIconKind.FILE;return(0,util_1.includesList)(e,utils_1.DefaultFileExtensions.image)?t=utils_1.HxIconKind.IMAGE:(0,util_1.includesList)(e,utils_1.DefaultFileExtensions.font)?t=utils_1.HxIconKind.FILE:(0,util_1.includesList)(e,[".css",".scss",".less"])?t=utils_1.HxIconKind.CSS:(0,util_1.includesList)(e,[".js"])&&(t=utils_1.HxIconKind.JS),t}async getUrlFilePath(e,t,i,r){let a={extensionFilters:[".css"],prefixPath:i,limit:100,timeout:300,withCurrentLevelFolder:!0};(0,util_1.includesList)(r,util_1.imageUrlProperty)?a.extensionFilters=utils_1.DefaultFileExtensions.image:(0,util_1.includesList)(r,["src"])?a.extensionFilters=utils_1.DefaultFileExtensions.font:"cssFile"===r?(a.extensionFilters.push(`.${t.languageId}`),a.extensionFilters=[...new Set(a.extensionFilters)]):a.extensionFilters=[];let n=[],o=await(0,utils_1.getCompletionFiles)(e,a,t.uri);if(null!==o)for(const e of o.files){const t=e.relative.lastIndexOf("."),r=e.relative.substring(t);let a=this.getFileIconType(r);e.isDir&&(a=utils_1.HxIconKind.FOLDER),""===i&&(e.relative.includes("/")||(e.relative="./"+e.relative)),n.push({label:e.relative,data:{hxKind:a}})}return n}supportAtPathAndSort(e,t,i,r,a){let n={isIncomplete:!0,items:[]},o=vscode_uri_1.URI.parse(e.uri).fsPath,s=[];if((0,utils_1.getProjectType)(o)===utils_1.ProjectType.PT_UniApp_Vue)for(const e of a){if(e.data.hxKind===utils_1.HxIconKind.FOLDER)continue;let a=i+e.label,n=(0,path_1.resolve)((0,path_1.dirname)(t),a);n=n.replace(o,"@").replace(/\\/g,"/"),s.push({label:n,textEdit:vscode_languageserver_1.TextEdit.replace(r,n),kind:vscode_languageserver_1.CompletionItemKind.Property,data:e.data})}a.push(...s);for(const e of a){let t="z",i="z";e.data.hxKind!==utils_1.HxIconKind.FOLDER&&(t="a"),e.label.startsWith("@")&&(i="a"),e.label.startsWith("./")&&(i="b"),n.items.push({label:e.label,textEdit:vscode_languageserver_1.TextEdit.replace(r,e.label),kind:vscode_languageserver_1.CompletionItemKind.Property,sortText:t+i+"_"+e.label,data:e.data})}return n}async getPathCompletionData(e,t,i,r,a){if(!e)return a;const n=(0,util_1.isRightCompletionType)(r,[util_1.NodeType.Import,util_1.NodeType.StringLiteral],void 0,util_1.NodeType.Import),o=(0,util_1.isRightCompletionType)(r,[util_1.NodeType.URILiteral],[util_1.NodeType.URILiteral],util_1.NodeType.URILiteral);if(!n&&!o)return a;const s=(0,util_1.getLineTextFromPosition)(t,i);if(n&&!s.includes("@import"))return a;const l=s.indexOf('"'),c=s.indexOf("'"),d=s.indexOf(":"),u=s.indexOf("(");let g;if(-1===l&&-1===c){if(!o)return a;g=vscode_languageserver_1.Position.create(i.line,u+1)}else g=vscode_languageserver_1.Position.create(i.line,l+1),c>-1&&(g=vscode_languageserver_1.Position.create(i.line,c+1));let _=vscode_languageserver_1.Range.create(g,i),p=t.getText(_);const m=s.substring(0,d).trim();p.lastIndexOf("/")>0&&(g=vscode_languageserver_1.Position.create(g.line,g.character+p.lastIndexOf("/")+1)),"/"===p&&(g=vscode_languageserver_1.Position.create(g.line,g.character+1)),_=vscode_languageserver_1.Range.create(g,i);let v=[];return"@"===p&&(p=""),n||o&&s.includes("@import")?v=await this.getUrlFilePath(e,t,p,"cssFile"):o&&(v=await this.getUrlFilePath(e,t,p,m)),0===v.length?a:(a.isIncomplete=!0,a=this.supportAtPathAndSort(e,vscode_uri_1.URI.parse(t.uri).fsPath,p,_,v))}async getDeprecatedCompletionData(e,t,i,r){return r=(0,contextCompletionProcessor_1.getDeprecatedPseudoList)(e,t,i,r),r=(0,contextCompletionProcessor_1.getPointerEventsMissingValues)(e,t,i,r)}async getExtraCompletionData(e,t,i,r,a,n,o){return o}async getPropertySelectorCompletionData(e,t,i,r,a){if(!(0,util_1.isRightCompletionType)(r,[util_1.NodeType.AttributeSelector],void 0,util_1.NodeType.AttributeSelector))return a;(null==r?void 0:r.isNode)&&(r=(0,contextCompletionProcessor_1.getCompletionTypeFromScanner)(t,i));let n=t.offsetAt(i),o=(0,util_1.getCurrentWord)(t,n),s=null==r?void 0:r.context,l=[];l=s&&util_1.html5Tags.includes(s)?(0,entry_1.getTagAttributes)(e,s):(0,entry_1.getTagAttributes)(e);let c=vscode_languageserver_1.Position.create(i.line,i.character-o.length);a.items=[];for(const e of l)a.items.push({label:e,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(c,i),e),kind:vscode_languageserver_1.CompletionItemKind.Property});return a}async webPxConversion(e,t,i,r,a){let n=e.offsetAt(t),o=(0,util_1.getCurrentWord)(e,n);if(!o.endsWith("p")&&!o.endsWith("px"))return a;if(!i)return a;if(!r)return a;if(!await(0,util_1.getHXSettings)("editor.codeassist.px2rem.enabel",i,r))return a;let s=await(0,util_1.getHXSettings)("editor.codeassist.px2rem.proportion",i,r),l=await(0,util_1.getHXSettings)("editor.codeassist.px2rem.decimalLength",i,r);s||(s=1),l||(l=2);let c=vscode_languageserver_1.Position.create(t.line,t.character-o.length),d=o.match(/\d+/),u="";d&&(u=d[0]);let g=(parseFloat(u)/s).toFixed(l);return g=g.replace(/0+$/,""),g.endsWith(".")&&(g=g.substring(0,g.length-1)),""===u||a.items.push({label:d+"px->"+g+"rem",textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(c,t),g+"rem"),kind:vscode_languageserver_1.CompletionItemKind.Snippet}),a}async uniPxConversion(e,t,i,r,a){let n=e.offsetAt(t),o=(0,util_1.getCurrentWord)(e,n);if(!o.endsWith("p")&&!o.endsWith("px"))return a;if(!i)return a;if(!r)return a;if(!await(0,util_1.getHXSettings)("editor.codeassist.px2upx.enabel",i,r))return a;let s=await(0,util_1.getHXSettings)("editor.codeassist.px2upx.proportion",i,r),l=await(0,util_1.getHXSettings)("editor.codeassist.px2upx.decimalLength",i,r);s||(s=1),l||(l=2);let c=vscode_languageserver_1.Position.create(t.line,t.character-o.length),d=o.match(/\d+/),u="";d&&(u=d[0]);let g=(parseFloat(u)/s).toFixed(l);return g=g.replace(/0+$/,""),g.endsWith(".")&&(g=g.substring(0,g.length-1)),""===u||(a.items.push({label:d+"px->"+g+"upx",textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(c,t),g+"upx"),kind:vscode_languageserver_1.CompletionItemKind.Snippet}),a.items.push({label:d+"px->"+g+"rpx",textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(c,t),g+"rpx"),kind:vscode_languageserver_1.CompletionItemKind.Snippet})),a}async getPxConversionCompletionData(e,t,i,r,a,n,o){if(!(0,util_1.isRightCompletionType)(r,[util_1.NodeType.NumericValue],void 0,util_1.NodeType.Value))return o;if(e){let r=vscode_uri_1.URI.parse(t.uri).fsPath,s=vscode_uri_1.URI.parse(e.uri).fsPath;if((0,utils_1.getProjectType)(s)===utils_1.ProjectType.PT_UniApp_Vue&&(r.endsWith(".nvue")||r.endsWith(".vue")||r.endsWith(".css")||r.endsWith(".scss")||r.endsWith(".less")||r.endsWith(".styl")))return this.uniPxConversion(t,i,a,n,o)}return this.webPxConversion(t,i,a,n,o)}async getIndexIdSelectorsCompletionData(e,t,i,r,a){if(!(0,util_1.isRightCompletionType)(r,void 0,[util_1.NodeType.ClassSelector,util_1.NodeType.IdentifierSelector,util_1.NodeType.ElementNameSelector],util_1.NodeType.Selector))return a;if(!e)return a;let n=indexlib_1.IndexDataCategory.ID,o=t.offsetAt(i),s=(0,util_1.getCurrentWord)(t,o),l=vscode_languageserver_1.Position.create(i.line,i.character-s.length),c=new baseIndexProcessor_1.BaseIndexProcessor,d=c.getIndexDataFromType(c.getWorkspaceIndexData(e),n);for(let e of d)e.length>0&&a.items.push({label:"#"+e,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(l,i),"#"+e),kind:vscode_languageserver_1.CompletionItemKind.Keyword,data:{hxKind:utils_1.HxIconKind.ID}});return a}async getIndexClassSelectorsCompletionData(e,t,i,r,a){if(!(0,util_1.isRightCompletionType)(r,void 0,[util_1.NodeType.ClassSelector,util_1.NodeType.IdentifierSelector,util_1.NodeType.ElementNameSelector],util_1.NodeType.Selector))return a;if(!e)return a;let n=indexlib_1.IndexDataCategory.CLASS,o=t.offsetAt(i),s=(0,util_1.getCurrentWord)(t,o),l=vscode_languageserver_1.Position.create(i.line,i.character-s.length),c=new baseIndexProcessor_1.BaseIndexProcessor,d=c.getIndexDataFromType(c.getWorkspaceIndexData(e),n);for(let e of d)e.length>0&&a.items.push({label:"."+e,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(l,i),"."+e),kind:vscode_languageserver_1.CompletionItemKind.Keyword,data:{hxKind:utils_1.HxIconKind.CLASS}});return a}getDeduplicationDataSync(e){let t=[];for(var i=e.items.length-1;i>=0;--i)t.includes(e.items[i].label)?e.items.splice(i,1):t.push(e.items[i].label);return e}async getDeduplicationData(e){return this.getDeduplicationDataSync(e)}async getMoveCursorData(e,t,i,r){const a=e.offsetAt(t),n=(0,util_1.getCurrentWord)(e,a),o=(0,contextCompletionProcessor_1.isValueInNode)(e,t),s=vscode_languageserver_1.Position.create(t.line,t.character-n.length),l=(0,util_1.getOffsetRightLineText)(e,a).indexOf(";"),c=((0,util_1.getLineTextFromOffset)(e,a),(0,util_1.getOffsetRightLineText)(e,a).trim()),d=(0,util_1.getOffsetLeftLineText)(e,a),u=d.lastIndexOf(";"),g=d.lastIndexOf(":");c.indexOf(";"),c.indexOf(":");if(-1===l)return r;if(g<u)return r;if(o&&g<t.character&&g>0){if((0,util_1.includesList)(o.context,util_1.notMoveCursorProperty,!0))for(const t of r.items){if(t.textEdit&&t.textEdit.newText.includes("$"))continue;if(t.label.endsWith(")"))continue;let i=t.label;t.textEdit?(i=t.textEdit.newText,i.includes("$")&&(i=i.replace(/\$/g,"\\$")),t.textEdit=vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(s,e.positionAt(a+l+1)),`${i};$0`)):(i.includes("$")&&(i=i.replace(/\$/g,"\\$")),t.insertText=`${i};$0`),t.command=void 0,t.insertTextFormat=vscode_languageserver_1.InsertTextFormat.Snippet}return r}return r}async getFiltrationPseudoData(e,t,i,r){if(!(0,util_1.isRightCompletionType)(i,[util_1.NodeType.PseudoSelector],[util_1.NodeType.PseudoSelector],util_1.NodeType.PseudoSelector))return r;let a=[];for(const e of r.items)e.label.startsWith(":")&&a.push(e);return r.items=a,r}async retrieveRange(e,t,i,r){const a=(0,util_1.isRightCompletionType)(i,[util_1.NodeType.ElementNameSelector],[util_1.NodeType.ElementNameSelector],util_1.NodeType.Property),n=(0,util_1.isRightCompletionType)(i,[util_1.NodeType.Identifier],[util_1.NodeType.Property],util_1.NodeType.Property),o=(0,util_1.isRightCompletionType)(i,[util_1.NodeType.Ruleset,util_1.NodeType.Declarations],void 0,util_1.NodeType.Property);if(!a&&!n&&!o)return r;const s=e.offsetAt(t),l=((0,util_1.getLineTextFromOffset)(e,s),(0,util_1.getOffsetRightLineText)(e,s)),c=(0,util_1.getOffsetLeftLineText)(e,s),d=(0,util_1.getCurrentWord)(e,s),u=c.lastIndexOf(";"),g=c.lastIndexOf(":"),_=l.indexOf(";"),p=(l.indexOf(";",_+1),l.indexOf(":"));l.indexOf(":",p+1);if(g>u)return r;let m=vscode_languageserver_1.Position.create(t.line,t.character),v=vscode_languageserver_1.Position.create(t.line,t.character),h=!1;if(-1===u)return r;if(-1!==u){if(c.substring(0,c.length-d.length).endsWith(" ")&&l.startsWith(" "))return r;if(0===l.trim().length&&d.endsWith(";"))h=!0;else{if(0===l.trim().length&&!d.includes(";"))return r;0===l.trim().length&&d.includes(";")||l.startsWith(" ")&&d.includes(";")?(m.character=u+1,v.character=u+d.substring(d.indexOf(";")).length):-1!==p&&-1!==_&&p<_?l.trim().endsWith(":;")||l.trim().endsWith(": ;")?(h=!0,m.character=u+1,v.character=v.character+_+1):d.includes(";")?(m.character=u+1,v.character=v.character+l.indexOf(":")):(m.character=m.character-d.length,v.character=v.character+l.indexOf(":")):-1!==p?(h=!0,d.includes(";")&&(m.character=u+1),m.character=m.character-d.length,v.character=v.character+l.indexOf(":")+1):(m.character=u+1,v.character=u+d.substring(d.indexOf(";")).length)}}let f=vscode_languageserver_1.Range.create(m,v);return r.items.forEach((e=>{let t=e.label;e.textEdit&&(t=e.textEdit.newText),h&&e.kind==vscode_languageserver_1.CompletionItemKind.Property&&(t=e.label+": $0;",e.kind=vscode_languageserver_1.CompletionItemKind.Property,e.insertTextFormat=vscode_languageserver_1.InsertTextFormat.Snippet,e.command=retriggerCommand),e.textEdit=vscode_languageserver_1.TextEdit.replace(f,t)})),r}async getAltMode(e,t,i){const r=(0,contextCompletionProcessor_1.isValueInNode)(e,t);if(r){let e=!1;const t=(0,vscode_css_languageservice_1.getDefaultCSSDataProvider)().provideProperties().find((e=>e.name===r.context));if(!t||!t.restrictions)return i;for(const i of t.restrictions){(0,util_1.includesList)(i,util_1.numberType)&&(e=!0);break}e&&i.items.forEach((e=>{e.data||(e.data={}),e.data.hxOption={altMode:!0}}))}return i}}exports.BaseCompletionProcessor=BaseCompletionProcessor;