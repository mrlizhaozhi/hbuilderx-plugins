"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseDefinitionProcessor=void 0;const vscode_css_languageservice_1=require("vscode-css-languageservice"),vscode_languageserver_1=require("vscode-languageserver"),vscode_uri_1=require("vscode-uri"),node_1=require("../../../../htmlservice/entry/out/node"),node_2=require("../../../../indexlib/out/node"),node_3=require("../../../../serverinterface/out/node"),out_1=require("../../../../utils/out"),baseIndexProcessor_1=require("../index/baseIndexProcessor"),util_1=require("../utils/util");class BaseDefinitionProcessor{locationToLocationLink(e,t){if(e.length<=0)return[];let o=[];for(const i of e)o.push(vscode_languageserver_1.LocationLink.create(i.uri,i.range,i.range,t));return o}async getDefinitionDataFromID(e,t,o,i,r){let n=[],s=[];if(r&&n.unshift(r),"css"!==t.languageId)return this.locationToLocationLink(n);const a=(0,util_1.getLocationFromPosition)(t,i,o);if(!a)return this.locationToLocationLink(n);const c=t.getText(a.range);if(!c.startsWith("#"))return this.getDefinitionDataFromAtPath(e,t,o,i,r);if(!e)return this.locationToLocationLink(n,a.range);let u={text:c.substring(1),type:node_3.SymbolType.ElementId},l=(0,node_1.getLanguageServerExt)();if(!l||!l.findSymbol)return this.locationToLocationLink(n,a.range);let g=await l.findSymbol(t,u,e);return s.push(...g instanceof Array?g:[g]),s.length>0&&n.unshift(...s),this.locationToLocationLink(n,a.range)}getDefinitionDataFromAtPath(e,t,o,i,r){let n=[];r&&n.unshift(r);const s=t.offsetAt(o),a=(0,util_1.getNodeAtOffset)(i,s),c=(0,util_1.getLocationFromPosition)(t,i,o);if(!c)return this.locationToLocationLink(n);const u=t.getText(c.range).replace(/'/g,"").replace(/"/g,"");if(!c)return this.locationToLocationLink(n);if(!e)return this.locationToLocationLink(n,c.range);if(u.startsWith("@")&&a.parent.nodeType===util_1.NodeType.URILiteral){let t=vscode_uri_1.URI.parse(e.uri).fsPath,o=u.replace("@",t).replace(/\\/g,"/");n.unshift({uri:out_1.hx.toNormalizedUri(o),range:{start:vscode_languageserver_1.Position.create(0,0),end:vscode_languageserver_1.Position.create(0,0)}})}return this.locationToLocationLink(n,c.range)}getDefinedListFromIndexFile(e,t){let o=[];if(e.length<=0)return o;let i=util_1.NodeType.ClassSelector;for(const r of e){let e=r.lastIndexOf("."),n=r.substring(e+1),s=(0,util_1.createDocument)(r,n),a=(0,util_1.createAstNode)(s,n),c=(0,util_1.getLocationFromText)(s,a,i,"."+t.text);0!==c.length&&o.push(...c)}return o}getDefinitionFromClass(e,t,o){if(void 0===e)return[];if(o.type!==node_3.SymbolType.StyleClass)return[];if(!o.sourceDocument)return[];let i,r=node_2.ReferenceFileType.CSS;i=(0,vscode_css_languageservice_1.getCSSLanguageService)().parseStylesheet(t),"scss"===t.languageId?i=(0,vscode_css_languageservice_1.getSCSSLanguageService)().parseStylesheet(t):"less"===t.languageId&&(i=(0,vscode_css_languageservice_1.getLESSLanguageService)().parseStylesheet(t));let n=[];if(i.accept((e=>{if(e.type===util_1.NodeType.ClassSelector){if(o.text===e.getText().replace(".","")){let o=t.positionAt(e.offset),i=t.positionAt(e.offset+e.getText().length),r=vscode_languageserver_1.Range.create(o,i);n.push(vscode_languageserver_1.Location.create(t.uri,r))}if(n.length>0)return!1}return!0})),n.length>0)return n;let s=(new baseIndexProcessor_1.BaseIndexProcessor).getIndexDataFromFile(e,o.sourceDocument.uri),a=[];for(const e of s)for(const t of e.references)t.type===r&&a.push(t.uri);return n=this.getDefinedListFromIndexFile(a,o),n}async getBaseLocationLink(e,t,o,i,r){let n=[];i=(0,vscode_css_languageservice_1.getCSSLanguageService)().parseStylesheet(t),"scss"===t.languageId?i=(0,vscode_css_languageservice_1.getSCSSLanguageService)().parseStylesheet(t):"less"===t.languageId&&(i=(0,vscode_css_languageservice_1.getLESSLanguageService)().parseStylesheet(t)),r&&n.unshift(r);if(!(0,util_1.getLocationFromPosition)(t,i,o))return this.locationToLocationLink(n);return this.getDefinitionDataFromAtPath(e,t,o,i,r)}}exports.BaseDefinitionProcessor=BaseDefinitionProcessor;