"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getPointerEventsMissingValues=exports.getDeprecatedPseudoList=exports.getCompletionDataFromScanner=exports.getCompletionTypeFromScanner=exports.isValueInNode=exports.getTokenList=void 0;const vscode_css_languageservice_1=require("vscode-css-languageservice"),vscode_languageserver_1=require("vscode-languageserver"),utils_1=require("../../../../utils"),extraProcessor_1=require("../grammar/extraProcessor"),util_1=require("../utils/util"),{Scanner:Scanner}=require("vscode-css-languageservice/lib/umd/parser/cssScanner"),{LESSScanner:LESSScanner}=require("vscode-css-languageservice/lib/umd/parser/lessScanner"),{SCSSScanner:SCSSScanner}=require("vscode-css-languageservice/lib/umd/parser/scssScanner"),{ParseErrorCollector:ParseErrorCollector}=require("vscode-css-languageservice/lib/umd/parser/cssNodes"),SnippetFormat=vscode_languageserver_1.InsertTextFormat.Snippet,retriggerCommand={title:"Suggest",command:"editor.action.triggerSuggest"};function getTokenList(e){let t=Scanner;"scss"===e.languageId&&(t=SCSSScanner),"less"===e.languageId&&(t=LESSScanner),t.prototype.setSource(e.getText());let o,n=[];for(;o=t.prototype.scan(),n.push(o),o.type!==util_1.TokenType.EOF;);return n}function getContextTokenCollection(e,t){let o;for(let n=0;n<e.length-2;n++)if(e[n].offset<=t&&e[n+1].offset>t){o={peekToken:e[n],nextToken:e[n+1],peekIndex:n,nextIndex:n+1};break}return o}function getCompletionType(e,t){return{type:e,parentType:e,nodeType:e,parentNodeType:e,isNode:!1,context:t}}function getSimpleCompletionType(e,t){for(let o=e.length-1;o>=0;o--){if(e[o].offset>=t)continue;const n=e[o];if(n.type===util_1.TokenType.CurlyR)return getCompletionType(util_1.NodeType.Selector);if(n.type===util_1.TokenType.BracketL){let t;return t=e[o-1].type===util_1.TokenType.Whitespace?e[Math.max(o-2,0)].text:e[o-1].text,getCompletionType(util_1.NodeType.AttributeSelector,t)}if(n.type===util_1.TokenType.CurlyL)return getCompletionType(util_1.NodeType.Property);if(n.type===util_1.TokenType.SemiColon)return getCompletionType(util_1.NodeType.Property);if(n.type===util_1.TokenType.Colon){let t;return t=e[o-1].type===util_1.TokenType.Whitespace?e[Math.max(o-2,0)].text:e[o-1].text,getCompletionType(util_1.NodeType.Value,t)}}}function inParentheses(e,t,o,n){let r={peekToken:void 0,nextToken:void 0,peekIndex:0,nextIndex:0},i=e.peekIndex-1;for(;i>0;i--){const e=t[i];if(r.peekToken&&r.nextToken)break;e.type!==o||r.peekToken||(r.peekToken=e,r.peekIndex=i),e.type!==n||r.nextToken||(r.nextToken=e,r.nextIndex=i)}if(r.peekToken&&!(r.nextToken&&r.nextToken.offset>r.peekToken.offset))return r}function isSelector(e,t,o){const n=inParentheses(t,o,util_1.TokenType.CurlyL,util_1.TokenType.CurlyR);if(n){if(!(0,util_1.getLineTextFromOffset)(e,n.peekToken.offset).includes("@media"))return}return getCompletionType(util_1.NodeType.Selector)}function isAttributeSelector(e,t){const o=inParentheses(e,t,util_1.TokenType.BracketL,util_1.TokenType.BracketR);if(o){let e,n=o.peekIndex-1;return t[n].type===util_1.TokenType.Whitespace&&n>0&&n--,e=t[n].text,getCompletionType(util_1.NodeType.AttributeSelector,e)}}function isAttribute(e,t,o){if(inParentheses(e,t,util_1.TokenType.CurlyL,util_1.TokenType.CurlyR)){let o=e.peekIndex;if(t[o].type===util_1.TokenType.SemiColon)return;if(e.peekToken.type===util_1.TokenType.Whitespace&&o--,t[o].type===util_1.TokenType.CurlyL||t[o].type===util_1.TokenType.SemiColon||o--,t[o].type===util_1.TokenType.Whitespace&&o--,t[o].type===util_1.TokenType.CurlyL||t[o].type===util_1.TokenType.SemiColon)return getCompletionType(util_1.NodeType.Property)}}function isValue(e,t){if(inParentheses(e,t,util_1.TokenType.CurlyL,util_1.TokenType.CurlyR)){let o=e.peekIndex;if(t[o].type===util_1.TokenType.SemiColon&&o--,e.peekToken.type===util_1.TokenType.Whitespace&&o--,t[o].type===util_1.TokenType.Colon||o--,t[o].type!==util_1.TokenType.Whitespace&&t[o].type!==util_1.TokenType.Ident||o--,t[o].type===util_1.TokenType.Colon){let e;if(o--,t[o].type===util_1.TokenType.Whitespace&&o--,e=t[o].text,"&"===e)return;return getCompletionType(util_1.NodeType.Value,e)}}}function isMedia(e){if(e.includes("@media"))return getCompletionType(util_1.NodeType.Media)}function isImport(e){if(e.includes("@import"))return getCompletionType(util_1.NodeType.Import)}function isCharset(e){if(e.includes("@charset"))return{isNode:!1,context:"charset"}}function isPseudoSelector(e,t,o){const n=inParentheses(t,o,util_1.TokenType.CurlyL,util_1.TokenType.CurlyR);let r,i=!1;if(n){if(!(0,util_1.getLineTextFromOffset)(e,n.peekToken.offset).includes("@media")&&"css"===e.languageId)return;i=!0}let s=t.peekIndex-1;if(o[s].type===util_1.TokenType.Ident&&s--,o[s].type===util_1.TokenType.Colon&&(s--,o[s].type===util_1.TokenType.Delim||!i))return r=":",s>=0&&o[s].type===util_1.TokenType.Colon&&(r="::"),getCompletionType(util_1.NodeType.PseudoSelector,r)}function isURILiteral(e,t){let o=e.includes("url("),n=t.includes(")");if(o&&n)return getCompletionType(util_1.NodeType.URILiteral)}function isExclamatory(e,t,o){if(inParentheses(t,o,util_1.TokenType.CurlyL,util_1.TokenType.CurlyR)){let e=t.peekIndex;if(o[e].type===util_1.TokenType.SemiColon&&e--,o[e].type!==util_1.TokenType.Exclamation&&e--,o[e].type===util_1.TokenType.Exclamation)return getCompletionType(util_1.NodeType.Declaration)}}function getCompletionTypeFromScanner(e,t){const o=getTokenList(e);if(o.length<1)return;const n=e.offsetAt(t),r=(0,util_1.getLineTextFromPosition)(e,t),i=(0,util_1.getOffsetLeftLineText)(e,n),s=(0,util_1.getOffsetRightLineText)(e,n),a=getContextTokenCollection(o,n);if(!a){let e=getSimpleCompletionType(o,n);if(!e){const e=isMedia(r),t=isImport(r),o=isCharset(r),n=isURILiteral(i,s);if(n)return n;if(e)return e;if(t)return t;if(o)return o}return e}const l=isSelector(e,a,o),c=isAttributeSelector(a,o),u=isAttribute(a,o,n),p=isValue(a,o),d=isMedia(r),g=isImport(r),_=isCharset(r),T=isPseudoSelector(e,a,o),m=isURILiteral(i,s),y=isExclamatory(r,a,o);return m||(d||(g||(_||(c||(T||(l||(u||(p||(y||void 0)))))))))}function getSelectorData(e,t){let o=[];o=getPseudoSelectorData(e,t);const n=e.provideAtDirectives();for(const e of n)o.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_1.CompletionItemKind.Keyword});for(const e of util_1.html5Tags)o.push({label:e,textEdit:vscode_languageserver_1.TextEdit.replace(t,e),kind:vscode_languageserver_1.CompletionItemKind.Keyword});for(const e of util_1.svgElements)o.push({label:e,textEdit:vscode_languageserver_1.TextEdit.replace(t,e),kind:vscode_languageserver_1.CompletionItemKind.Keyword});return o}function getPropertyData(e,t,o,n){let r=[];const i=e.provideProperties();t.end.character;for(const e of i){let t=retriggerCommand;const i=(255-("number"==typeof e.relevance?Math.min(Math.max(e.relevance,0),99):50)).toString(16),s=(0,util_1.startsWith)(e.name,"-")?util_1.SortTexts.VendorPrefixed:util_1.SortTexts.Normal;let a=e.name+": $0;";const l=o.offsetAt(n),c=((0,util_1.getLineTextFromOffset)(o,l),(0,util_1.getOffsetRightLineText)(o,l)),u=(0,util_1.getOffsetLeftLineText)(o,l),p=(0,util_1.getContextData)(o,l),d=p.leftText,g=u.lastIndexOf(";"),_=(u.lastIndexOf(":"),c.indexOf(";")),T=c.indexOf(":");let m=vscode_languageserver_1.Position.create(n.line,n.character),y=vscode_languageserver_1.Position.create(n.line,n.character),f=!1;-1===g&&0===c.trim().length?(m.character=p.contextRange.start.character,y.character=p.contextRange.end.character,f=!0):0===c.trim().length&&d.endsWith(";")?f=!0:0!==c.trim().length||d.includes(";")?0===c.trim().length&&d.includes(";")?(m.character=g+1,y.character=g+d.substring(d.indexOf(";")).length,f=!0):-1!==T&&-1!==_&&T<_?c.trim().endsWith(":;")||c.trim().endsWith(": ;")?(f=!0,m.character=g+1,y.character=y.character+_+1):d.includes(";")?(m.character=g+1,y.character=y.character+c.indexOf(":")):(m.character=m.character-d.length,y.character=y.character+c.indexOf(":")):-1!==T?(f=!0,d.includes(";")&&(m.character=g+1),m.character=m.character-d.length,y.character=y.character+c.indexOf(":")+1):(m.character=p.contextRange.start.character,y.character=p.contextRange.end.character,f=!0):(m.character=p.contextRange.start.character,f=!0);let v=vscode_languageserver_1.Range.create(m,y);f||(a=e.name,t=void 0),r.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(v,`${a}`),sortText:s+"_"+i,kind:vscode_languageserver_1.CompletionItemKind.Property,command:t,insertTextFormat:vscode_languageserver_1.InsertTextFormat.Snippet})}return r}function getColorProposals(e,t){for(const o in util_1.colors)e.push({label:o,documentation:util_1.colors[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Color});for(const o in util_1.colorKeywords)e.push({label:o,documentation:util_1.colorKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});for(const o of util_1.colorFunctions){let n=1;const r=(e,t)=>"${"+n+++":"+t+"}",i=o.func.replace(/\[?\$(\w+)\]?/g,r);e.push({label:o.func.substring(0,o.func.indexOf("(")),detail:o.func,documentation:o.desc,textEdit:vscode_languageserver_1.TextEdit.replace(t,i),insertTextFormat:SnippetFormat,kind:vscode_languageserver_1.CompletionItemKind.Function})}return e}function getPositionProposals(e,t){for(const o in util_1.positionKeywords)e.push({label:o,documentation:util_1.positionKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getRepeatStyleProposals(e,t){for(const o in util_1.repeatStyleKeywords)e.push({label:o,documentation:util_1.repeatStyleKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getLineStyleProposals(e,t){for(const o in util_1.lineStyleKeywords)e.push({label:o,documentation:util_1.lineStyleKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getLineWidthProposals(e,t){for(const o of util_1.lineWidthKeywords)e.push({label:o,textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getGeometryBoxProposals(e,t){for(const o in util_1.geometryBoxKeywords)e.push({label:o,documentation:util_1.geometryBoxKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getBoxProposals(e,t){for(const o in util_1.boxKeywords)e.push({label:o,documentation:util_1.boxKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function moveCursorInsideParenthesis(e){return e.replace(/\(\)$/,"($1)")}function getImageProposals(e,t){for(const o in util_1.imageFunctions){const n=moveCursorInsideParenthesis(o);e.push({label:o,documentation:util_1.imageFunctions[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,n),kind:vscode_languageserver_1.CompletionItemKind.Function,insertTextFormat:o!==n?SnippetFormat:void 0})}return e}function getBasicShapeProposals(e,t){for(const o in util_1.basicShapeFunctions){const n=moveCursorInsideParenthesis(o);e.push({label:o,documentation:util_1.basicShapeFunctions[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,n),kind:vscode_languageserver_1.CompletionItemKind.Function,insertTextFormat:o!==n?SnippetFormat:void 0})}return e}function getTimingFunctionProposals(e,t){for(const o in util_1.transitionTimingFunctions){const n=moveCursorInsideParenthesis(o);e.push({label:o,documentation:util_1.transitionTimingFunctions[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,n),kind:vscode_languageserver_1.CompletionItemKind.Function,insertTextFormat:o!==n?SnippetFormat:void 0})}return e}function getCSSWideKeywordProposals(e,t){for(const o in util_1.cssWideKeywords)e.push({label:o,documentation:util_1.cssWideKeywords[o],textEdit:vscode_languageserver_1.TextEdit.replace(t,o),kind:vscode_languageserver_1.CompletionItemKind.Value});return e}function getValueData(e,t,o){let n=[];if(o.context){const r=e.provideProperties().find((e=>e.name===o.context)),i=null==r?void 0:r.values,s=null==r?void 0:r.restrictions;if(i&&i.map((e=>{n.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_1.CompletionItemKind.Value})})),s)for(const e of s)switch(e){case"color":n=getColorProposals(n,t);break;case"position":n=getPositionProposals(n,t);break;case"repeat":n=getRepeatStyleProposals(n,t);break;case"line-style":n=getLineStyleProposals(n,t);break;case"line-width":n=getLineWidthProposals(n,t);break;case"geometry-box":n=getGeometryBoxProposals(n,t);break;case"box":n=getBoxProposals(n,t);break;case"image":n=getImageProposals(n,t);break;case"timing-function":n=getTimingFunctionProposals(n,t);break;case"shape":n=getBasicShapeProposals(n,t)}}return n=getCSSWideKeywordProposals(n,t),n}function getPseudoSelectorData(e,t){let o=[];const n=e.providePseudoClasses(),r=e.providePseudoElements();for(const e of n)o.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_1.CompletionItemKind.Function});for(const e of r)o.push({label:e.name,documentation:e.description,textEdit:vscode_languageserver_1.TextEdit.replace(t,e.name),kind:vscode_languageserver_1.CompletionItemKind.Function});return o}async function getCompletionDataFromScanner(e,t,o){var n;let r=[];if(o){const i=e.offsetAt(t),s=(0,vscode_css_languageservice_1.getDefaultCSSDataProvider)();(0,util_1.getLineTextFromOffset)(e,i);let a=(0,util_1.getContextData)(e,i,";"),l=vscode_languageserver_1.Range.create(a.contextRange.start,a.contextRange.end);o.nodeType===util_1.NodeType.Selector?r=getSelectorData(s,l):o.nodeType===util_1.NodeType.AttributeSelector||(o.nodeType===util_1.NodeType.Property?r=getPropertyData(s,l,e,t):o.nodeType===util_1.NodeType.Value?r=getValueData(s,l,o):o.nodeType===util_1.NodeType.PseudoSelector&&o.context&&(l.start.character=l.start.character-(null===(n=o.context)||void 0===n?void 0:n.length),r=getPseudoSelectorData(s,l)))}return{isIncomplete:!1,items:r}}function isValueInNode(e,t){const o=getTokenList(e);if(o.length<1)return;const n=e.offsetAt(t),r=getContextTokenCollection(o,n);let i;return i=r?isValue(r,o):getSimpleCompletionType(o,n),(null==i?void 0:i.nodeType)===util_1.NodeType.Value?i:void 0}function getDeprecatedPseudoList(e,t,o,n){o=getCompletionTypeFromScanner(e,t);if(!(0,util_1.isRightCompletionType)(o,[util_1.NodeType.PseudoSelector],[util_1.NodeType.PseudoSelector],util_1.NodeType.PseudoSelector))return n;const r=getTokenList(e);if(r.length<1)return n;const i=e.offsetAt(t),s=getContextTokenCollection(r,i),a=(0,util_1.getCurrentWord)(e,e.offsetAt(t));let l;if(l=s?isPseudoSelector(e,s,r):getSimpleCompletionType(r,i),(null==l?void 0:l.nodeType)!==util_1.NodeType.PseudoSelector)return n;const c=t.character,u=o&&o.context&&o.context.length>0?o.context.length:0;let p=vscode_languageserver_1.Position.create(t.line,c-a.length-u);s&&""!==a&&s.peekToken.text.includes(a)&&(t=e.positionAt(s.peekToken.offset+s.peekToken.text.length));for(const e of extraProcessor_1.deprecatedPseudoElementList)n.items.push({label:e.name,documentation:e.description,tags:[vscode_languageserver_1.CompletionItemTag.Deprecated],textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(p,t),e.name),kind:vscode_languageserver_1.CompletionItemKind.Function,data:{hxKind:utils_1.HxIconKind.CLASS}});return n}function getPointerEventsMissingValues(e,t,o,n){if(!(o=getCompletionTypeFromScanner(e,t)))return n;return(0,util_1.isRightCompletionType)(o,[util_1.NodeType.Value],[util_1.NodeType.Value],util_1.NodeType.Value)?("pointer-events"!==o.context||n.items.push({label:extraProcessor_1.pointerEventsMissingValue.name,documentation:extraProcessor_1.pointerEventsMissingValue.description,textEdit:vscode_languageserver_1.TextEdit.replace(vscode_languageserver_1.Range.create(t,t),extraProcessor_1.pointerEventsMissingValue.name),kind:vscode_languageserver_1.CompletionItemKind.Property}),n):n}exports.getTokenList=getTokenList,exports.getCompletionTypeFromScanner=getCompletionTypeFromScanner,exports.getCompletionDataFromScanner=getCompletionDataFromScanner,exports.isValueInNode=isValueInNode,exports.getDeprecatedPseudoList=getDeprecatedPseudoList,exports.getPointerEventsMissingValues=getPointerEventsMissingValues;