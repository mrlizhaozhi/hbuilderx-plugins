"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.startServer=void 0;const vscode_css_languageservice_1=require("vscode-css-languageservice"),vscode_languageserver_1=require("vscode-languageserver"),vscode_uri_1=require("vscode-uri"),entry_1=require("../../entry"),customData_1=require("./customData"),languageModelCache_1=require("./languageModelCache"),requests_1=require("./requests"),documentContext_1=require("./utils/documentContext"),runner_1=require("./utils/runner");var CustomDataChangedNotification;function startServer(e,t){const n=new vscode_languageserver_1.TextDocuments(vscode_css_languageservice_1.TextDocument);n.listen(e);const r=(0,languageModelCache_1.getLanguageModelCache)(10,60,(e=>d(e).parseStylesheet(e)));n.onDidClose((e=>{r.onDocumentRemoved(e.document)})),e.onShutdown((()=>{r.dispose()}));let o,i=!1,u=Number.MAX_VALUE,c=!1,s=Promise.resolve();const a={},l=()=>Promise.reject("Not Ready");let g={getContent:l,stat:l,readDirectory:l};function d(t){let n=a[t.languageId];return n||(e.console.log("Document type is "+t.languageId+", using css instead."),n=a.css),n}e.onInitialize((n=>{function r(e,t){const r=e.split(".");let o=n.capabilities;for(let e=0;o&&e<r.length;e++){if(!o.hasOwnProperty(r[e]))return t;o=o[r[e]]}return o}o=n.workspaceFolders,Array.isArray(o)||(o=[],n.rootPath&&o.push({name:"",uri:vscode_uri_1.URI.file(n.rootPath).toString()})),g=(0,requests_1.getRequestService)(n.initializationOptions.handledSchemas||["file"],e,t);const s=!!r("textDocument.completion.completionItem.snippetSupport",!1);i=!!r("workspace.configuration",!1),u=r("textDocument.foldingRange.rangeLimit",Number.MAX_VALUE),c=r("workspace.workspaceFolders",!1),a.css=(0,vscode_css_languageservice_1.getCSSLanguageService)({fileSystemProvider:g,clientCapabilities:n.capabilities}),a.scss=(0,vscode_css_languageservice_1.getSCSSLanguageService)({fileSystemProvider:g,clientCapabilities:n.capabilities}),a.less=(0,vscode_css_languageservice_1.getLESSLanguageService)({fileSystemProvider:g,clientCapabilities:n.capabilities});return{capabilities:{textDocumentSync:vscode_languageserver_1.TextDocumentSyncKind.Incremental,completionProvider:s?{resolveProvider:!1,triggerCharacters:["/","-"]}:void 0,hoverProvider:!0,documentSymbolProvider:!0,referencesProvider:!0,definitionProvider:!0,documentHighlightProvider:!0,documentLinkProvider:{resolveProvider:!1},codeActionProvider:!0,renameProvider:!0,colorProvider:{},foldingRangeProvider:!0,selectionRangeProvider:!0,workspace:{workspaceFolders:{supported:!0}}}}})),e.onInitialized((()=>{c&&(e.client.register(vscode_languageserver_1.DidChangeWorkspaceFoldersNotification.type),e.onNotification(vscode_languageserver_1.DidChangeWorkspaceFoldersNotification.type,(e=>{const t=e.event.added,r=e.event.removed,i=[];if(o)for(const e of o)r.some((t=>t.uri===e.uri))||t.some((t=>t.uri===e.uri))||i.push(e);o=i.concat(t),n.all().forEach(p)})))}));let m={};n.onDidClose((e=>{delete m[e.document.uri]})),e.onDidChangeConfiguration((e=>{!function(e){for(const t in a)a[t].configure(e[t]);m={},n.all().forEach(p)}(e.settings)}));const f={};function v(e){const t=f[e.uri];t&&(clearTimeout(t),delete f[e.uri])}function p(t){v(t),f[t.uri]=setTimeout((()=>{delete f[t.uri],function(t){const n=function(t){if(i){let n=m[t.uri];if(!n){const r={items:[{scopeUri:t.uri,section:t.languageId}]};n=e.sendRequest(vscode_languageserver_1.ConfigurationRequest.type,r).then((e=>e[0])),m[t.uri]=n}return n}return Promise.resolve(void 0)}(t);Promise.all([n,s]).then((async([e])=>{r.get(t)}),(n=>{e.console.error((0,runner_1.formatError)(`Error while validating ${t.uri}`,n))}))}(t)}),500)}n.onDidChangeContent((e=>{p(e.document)})),n.onDidClose((t=>{v(t.document),e.sendDiagnostics({uri:t.document.uri,diagnostics:[]})})),e.onCompletion(((t,u)=>(0,runner_1.runSafeAsync)((async()=>{const u=n.get(t.textDocument.uri);if(u){await s;const n=r.get(u),c=(0,documentContext_1.getDocumentContext)(u.uri,o);let a=await d(u).doComplete2(u,t.position,n,c);const l=(0,entry_1.getCurrentWorkspaceFolder)(o,u)[0],g=(0,entry_1.getExtraServer)(u),m=t.position,f=n;return a=await g.doExtraCompletion(l,u,m,f,e,i,a),a}return null}),null,`Error while computing completions for ${t.textDocument.uri}`,u))),e.onHover(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);if(t){await s;const n=r.get(t);return d(t).doHover(t,e.position,n)}return null}),null,`Error while computing hover for ${e.textDocument.uri}`,t))),e.onDocumentSymbol(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);if(t){await s;const e=r.get(t);let n=d(t).findDocumentSymbols(t,e),i=(0,entry_1.getCurrentWorkspaceFolder)(o,t)[0];return(0,entry_1.getExtraServer)(t).doDocumentSymbol(i,n)}return[]}),[],`Error while computing document symbols for ${e.textDocument.uri}`,t))),e.onDefinition(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);if(t){await s;const n=r.get(t);let i=d(t).findDefinition(t,e.position,n),u=(0,entry_1.getCurrentWorkspaceFolder)(o,t)[0],c=await(0,entry_1.getExtraServer)(t).doDefinition(u,t,e.position,n,i);return c.length<=0?null:c}return null}),null,`Error while computing definitions for ${e.textDocument.uri}`,t))),e.onDocumentHighlight(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);if(t){await s;const n=r.get(t);return d(t).findDocumentHighlights(t,e.position,n)}return[]}),[],`Error while computing document highlights for ${e.textDocument.uri}`,t))),e.onDocumentLinks((async(e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);if(t){await s;const e=(0,documentContext_1.getDocumentContext)(t.uri,o),n=r.get(t);return d(t).findDocumentLinks2(t,n,e)}return[]}),[],`Error while computing document links for ${e.textDocument.uri}`,t))),e.onReferences(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);if(t){await s;const n=r.get(t);return d(t).findReferences(t,e.position,n)}return[]}),[],`Error while computing references for ${e.textDocument.uri}`,t))),e.onDocumentFormatting(((t,r)=>(0,runner_1.runSafeAsync)((async()=>{const r=n.get(t.textDocument.uri);if(r){await s;return await(0,entry_1.getExtraServer)(r).doFormatting(r,t.options,e,i)}return[]}),[],`Error while formatting for ${t.textDocument.uri}`,r))),e.onCodeAction(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);if(t){await s;const n=r.get(t);return d(t).doCodeActions(t,e.range,e.context,n)}return[]}),[],`Error while computing code actions for ${e.textDocument.uri}`,t))),e.onDocumentColor(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);if(t){await s;const e=r.get(t);return d(t).findDocumentColors(t,e)}return[]}),[],`Error while computing document colors for ${e.textDocument.uri}`,t))),e.onColorPresentation(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);if(t){await s;const n=r.get(t);return d(t).getColorPresentations(t,n,e.color,e.range)}return[]}),[],`Error while computing color presentations for ${e.textDocument.uri}`,t))),e.onRenameRequest(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);if(t){await s;const n=r.get(t);return d(t).doRename(t,e.position,e.newName,n)}return null}),null,`Error while computing renames for ${e.textDocument.uri}`,t))),e.onFoldingRanges(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri);return t?(await s,d(t).getFoldingRanges(t,{rangeLimit:u})):null}),null,`Error while computing folding ranges for ${e.textDocument.uri}`,t))),e.onSelectionRanges(((e,t)=>(0,runner_1.runSafeAsync)((async()=>{const t=n.get(e.textDocument.uri),o=e.positions;if(t){await s;const e=r.get(t);return d(t).getSelectionRanges(t,o,e)}return[]}),[],`Error while computing selection ranges for ${e.textDocument.uri}`,t))),e.onNotification(CustomDataChangedNotification.type,(function(e){s=(0,customData_1.fetchDataProviders)(e,g).then((e=>{for(const t in a)a[t].setDataProviders(!0,e)}))})),e.listen()}!function(e){e.type=new vscode_languageserver_1.NotificationType("css/customDataChanged")}(CustomDataChangedNotification||(CustomDataChangedNotification={})),exports.startServer=startServer;