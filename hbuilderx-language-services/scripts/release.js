const fs=require("fs-extra"),f=require("fs"),path=require("path"),execa=require("execa"),glob=require("glob"),os=require("os");async function run(){let e=execa("npm",["run","build"],{stdio:"inherit"});try{await e}catch(s){return console.error(s),void process.exit(e.exitCode)}let s=path.dirname(__dirname),i=path.join(s,"preDist"),t=path.join(s,"dist");fs.pathExistsSync(i)&&fs.removeSync(i),fs.pathExistsSync(t)&&fs.removeSync(t);let o=path.join(os.tmpdir(),"hbuilderx-language-services-tmp");fs.pathExistsSync(o)&&fs.removeSync(o),f.mkdirSync(o),fs.copySync(path.dirname(__dirname),o,{filter:(e,s)=>f.lstatSync(e).isDirectory()?!(e.indexOf("/builtin-dts/")<0&&(e.endsWith("/node_modules")||e.endsWith("/.vscode")||e.endsWith("/.git"))):!/package-lock\.json$/.test(e)&&(!!(/.*\.js$/.test(e)||/.*\.json/.test(e)||e.indexOf("/builtin-dts/")>=0||e.indexOf("/frameworkdts/")>=0)&&(console.log("+"+e),!0))},(e=>{if(e)return console.error(e);console.log("success!")})),fs.moveSync(o,i,{overwrite:!0},(e=>{if(e)return console.error(e);console.log("copy to dist success!")})),fs.copySync(path.dirname(__dirname)+"/jsservice/out/tsplugins",i+"/jsservice/out/tsplugins",{filter:()=>!0},(e=>{if(e)return console.error(e);console.log("copy dcloudio插件 success!")})),console.log("RUN COPY COMPRESS"),await execa("gulp",[],{stdio:"inherit",cwd:s}),console.log("RUN COPY COMPRESS END"),await execa("npm",["install","--production","--registry=https://registry.npmmirror.com"],{stdio:"inherit",cwd:t});["/node_modules/typescript/bin/","/node_modules/typescript/loc/","/node_modules/typescript/lib/typescript.js","/node_modules/typescript/lib/tsserver.js","/node_modules/typescript/lib/tsserverlibrary.js","/node_modules/typescript/lib/typescript.d.ts","/node_modules/typescript/lib/typescriptServices.js","/node_modules/typescript/lib/typescriptServices.d.ts","/node_modules/typescript/lib/tsc.js"].forEach((e=>{fs.removeSync(t+e)}));["tsserver.js","tsserverlibrary.js"].forEach((e=>{fs.copyFileSync(path.join(s,"node_modules/typescript/lib",e),path.join(t,"node_modules/typescript/lib",e));let i=fs.readFileSync(path.join(t,"node_modules/typescript/lib",e));i.indexOf("IMPORT:hack by dcloudio")<0&&(console.error("typescript库文件["+e+"],未检查到修改的代码！"),process.exit(999)),i.indexOf("IMPORT:hack by dcloudio2")<0&&(console.error("typescript库文件["+e+"],未检查到修改的代码2！"),process.exit(999))}));let r=path.join(t,"node_modules/typescript/package.json"),n=require(r);n.main="./lib/tsserverlibrary.js",fs.writeFileSync(r,JSON.stringify(n)),removeFilterFiles([".d.ts",".js.map",".md"],path.join(t,"node_modules"),["typescript"]),console.log("BUILD RELEASE PKG:OK")}function removeFilterFiles(e,s,i){let t=fs.readdirSync(s,{withFileTypes:!0});for(let o=0;o<t.length;o++){let r=t[o];if(r.isDirectory()){if(i&&i.indexOf(r.name)>=0)continue;removeFilterFiles(e,path.join(s,r.name))}else r.isFile()&&e.forEach((e=>{r.name.endsWith(e)&&(fs.removeSync(path.join(s,r.name)),console.log("-"+path.join(s,r.name)))}))}}run();