"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.IndexDataStore=void 0;const IndexProcessor_1=require("./IndexProcessor"),fs=require("fs"),path=require("path"),md5=require("md5");class IndexDataStoreLoader{constructor(e){this.fileIndexMap=new Map,this.folderRoot=e,"darwin"===process.platform?this.indexDir=path.join(process.env.HOME||".","Library","Application Support","HBuilder X","indexdb"):this.indexDir=path.join(process.env.APPDATA||".","HBuilder X","indexdb")}load(){let e=md5(this.folderRoot.uri).toLowerCase();try{let t=JSON.parse(fs.readFileSync(path.join(this.indexDir,e),{encoding:"utf-8"}));for(let e in t)this.fileIndexMap.set(e,t[e])}catch(e){}}save(){}removeIndex(e){}removeAll(){}addIndexData(e,t){}indexData(e){return this.fileIndexMap.get(e)||new IndexProcessor_1.IndexData}allIndexData(){return this.fileIndexMap}getAllColorIndex(e){let t=[],r=[];if(e){let t=this.fileIndexMap.get(e);t&&r.push(t)}return this.fileIndexMap.forEach(((t,n)=>{n!==e&&r.push(t)})),r.forEach((e=>{let r=e[IndexProcessor_1.IndexDataCategory.COLOR];r&&r instanceof Array&&t.unshift(...r)})),t}}class IndexDataStoreWriterImpl extends IndexDataStoreLoader{constructor(e){super(e)}save(){let e=md5(this.folderRoot.uri).toLowerCase();try{fs.existsSync(this.indexDir)||fs.mkdirSync(this.indexDir,{recursive:!0});let t={};this.fileIndexMap.forEach(((e,r)=>{t[r]=e}));const r=JSON.stringify(t);fs.writeFileSync(path.join(this.indexDir,e),r,{encoding:"utf-8"})}catch(e){}}addIndexData(e,t){var r;const n=e;this.fileIndexMap.has(n)||this.fileIndexMap.set(n,new IndexProcessor_1.IndexData);let i=this.fileIndexMap.get(n);for(let e of t.categories){-1===i.categories.indexOf(e)&&i.categories.push(e);const r=t[e];if(r instanceof Array){let t=r;t.length>0&&(i[e]instanceof Array?i[e].concat(t):i[e]=t)}}i.references&&i.references.length>0?null===(r=t.references)||void 0===r||r.forEach((e=>{var t,r;-1!==(null===(t=i.references)||void 0===t?void 0:t.indexOf(e))&&(null===(r=i.references)||void 0===r||r.push(e))})):i.references=t.references}removeIndex(e){this.fileIndexMap.delete(e)}removeAll(){this.fileIndexMap.clear()}}var IndexDataStore;!function(e){e.load=function(e){let t=new IndexDataStoreLoader(e);return t.load(),t},e.loadWithWrite=function(e){let t=new IndexDataStoreWriterImpl(e);return t.load(),t}}(IndexDataStore=exports.IndexDataStore||(exports.IndexDataStore={}));