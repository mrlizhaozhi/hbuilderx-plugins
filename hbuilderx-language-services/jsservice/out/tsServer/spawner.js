"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TypeScriptServerSpawner=void 0;const path=require("path"),vscode=require("vscode"),typescriptService_1=require("../typescriptService"),api_1=require("../utils/api"),configuration_1=require("../utils/configuration"),server_1=require("./server");class TypeScriptServerSpawner{constructor(e,r,t,i,s,a,o,n){this._versionProvider=e,this._versionManager=r,this._logDirectoryProvider=t,this._pluginPathsProvider=i,this._logger=s,this._telemetryReporter=a,this._tracer=o,this._factory=n}spawn(e,r,t,i,s,a){let o;const n=this.getCompositeServerType(e,r,t);switch(n){case 1:case 2:{const r=2===n;o=new server_1.SyntaxRoutingTsServer({syntax:this.spawnTsServer("syntax",e,t,i,s),semantic:this.spawnTsServer("semantic",e,t,i,s)},a,r);break}case 0:o=this.spawnTsServer("main",e,t,i,s);break;case 3:o=this.spawnTsServer("syntax",e,t,i,s)}return this.shouldUseSeparateDiagnosticsServer(t)?new server_1.GetErrRoutingTsServer({getErr:this.spawnTsServer("diagnostics",e,t,i,s),primary:o},a):o}getCompositeServerType(e,r,t){var i,s;if(!r.has(typescriptService_1.ClientCapability.Semantic))return 3;switch(t.separateSyntaxServer){case 0:return 0;case 1:return(null===(i=e.apiVersion)||void 0===i?void 0:i.gte(api_1.default.v340))?(null===(s=e.apiVersion)||void 0===s?void 0:s.gte(api_1.default.v400))?2:1:0}}shouldUseSeparateDiagnosticsServer(e){return e.enableProjectDiagnostics}spawnTsServer(e,r,t,i,s){const a=r.apiVersion||api_1.default.defaultVersion,o=s.create(e,this._tracer),{args:n,tsServerLogFile:p}=this.getTsServerArgs(e,t,r,a,i,o.cancellationPipeName);TypeScriptServerSpawner.isLoggingEnabled(t)&&(p?this._logger.info(`<${e}> Log file: ${p}`):this._logger.error(`<${e}> Could not create log directory`)),this._logger.info(`<${e}> Forking...`);const c=this._factory.fork(r.tsServerPath,n,e,t,this._versionManager);return this._logger.info(`<${e}> Starting...`),new server_1.ProcessBasedTsServer(e,this.kindToServerType(e),c,p,o,r,this._telemetryReporter,this._tracer)}kindToServerType(e){return"syntax"===e?typescriptService_1.ServerType.Syntax:typescriptService_1.ServerType.Semantic}getTsServerArgs(e,r,t,i,s,a){const o=[];let n;if("syntax"===e&&(i.gte(api_1.default.v401)?o.push("--serverMode","partialSemantic"):o.push("--syntaxOnly")),i.gte(api_1.default.v250)?o.push("--useInferredProjectPerProjectRoot"):o.push("--useSingleInferredProject"),(r.disableAutomaticTypeAcquisition||"syntax"===e||"diagnostics"===e)&&o.push("--disableAutomaticTypingAcquisition"),"semantic"!==e&&"main"!==e||o.push("--enableTelemetry"),a&&o.push("--cancellationPipeName",a+"*"),TypeScriptServerSpawner.isLoggingEnabled(r)){let e=this._logDirectoryProvider.getNewLogDirectory();e=path.resolve(__dirname,"../../"),e&&(n=path.join(e,"tsserver.log"),o.push("--logVerbosity",configuration_1.TsServerLogLevel.toString(r.tsServerLogLevel)),o.push("--logFile",n))}const p=this._pluginPathsProvider.getPluginPaths();if(s.plugins.length){o.push("--globalPlugins",s.plugins.map((e=>e.name)).join(","));const e=t.path===this._versionProvider.defaultVersion.path;for(const r of s.plugins)(e||r.enableForWorkspaceTypeScriptVersions)&&p.push(r.path)}return 0!==p.length&&o.push("--pluginProbeLocations",p.join(",")),r.npmLocation&&o.push("--npmLocation",`"${r.npmLocation}"`),i.gte(api_1.default.v260)&&o.push("--locale",TypeScriptServerSpawner.getTsLocale(r)),i.gte(api_1.default.v291)&&o.push("--noGetErrOnBackgroundUpdate"),i.gte(api_1.default.v345)&&o.push("--validateDefaultNpmLocation"),{args:o,tsServerLogFile:n}}static isLoggingEnabled(e){return e.tsServerLogLevel!==configuration_1.TsServerLogLevel.Off}static getTsLocale(e){return e.locale?e.locale:vscode.env.language}}exports.TypeScriptServerSpawner=TypeScriptServerSpawner;