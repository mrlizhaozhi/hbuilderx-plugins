"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.register=void 0;const vscode=require("vscode"),vscode_json_languageservice_1=require("vscode-json-languageservice"),vscode_uri_1=require("vscode-uri"),specialStringHandler=require("../../../core/out/plugins/SpecialStringsHandlers"),utils_1=require("../../../utils"),packageSchema_1=require("../schemas/packageSchema"),pagesSchema_1=require("../schemas/pagesSchema"),schemaSchema_1=require("../schemas/schemaSchema"),arrays_1=require("../utils/arrays"),schemaMgr=require("./schemaManager");function fixString(e){return e.startsWith('"')&&e.endsWith('"')?e.substring(1,e.length-1):e}function generatorSnippetString(e){(null==e?void 0:e.includes("{$1},"))&&(e=e.replace("{$1},","{\n\t$1\n},")),(null==e?void 0:e.includes("{$1}"))&&(e=e.replace("{$1}","{\n\t$0\n}")),(null==e?void 0:e.includes("[$1],"))&&(e=e.replace("[$1],","[\n\t$1\n],")),(null==e?void 0:e.includes("[$1]"))&&(e=e.replace("[$1]","[\n\t$0\n],"));const t=specialStringHandler.getSpecialTypes();for(let n of t)if(null==e?void 0:e.includes(n))return e=e.replace(n,"");return e||""}class JsonCompletionItemProvider{async provideCompletionItems(e,t,n){var i,a,r,s;let o=[],l=vscode_json_languageservice_1.TextDocument.create(e.uri.toString(),"json",1,e.getText()),c=await vscode.workspace.getWorkspaceFolder(e.uri);schemaMgr.registerSchema("packageSchema",packageSchema_1.PackageSchema,["package.json"]),schemaMgr.registerSchema("pagesSchema",pagesSchema_1.PagesSchema,["pages.json"]),schemaMgr.registerSchema("schemaJsonSchema",schemaSchema_1.SchemaJsonSchema,["*.schema.json"]);const d=(0,vscode_json_languageservice_1.getLanguageService)({schemaRequestService:schemaMgr.findSchema});schemaMgr.setLanguageConfig(d,vscode_uri_1.URI.parse(e.uri.toString()).fsPath,c);const g=d.parseJSONDocument(l);let u=l.getText({start:{line:t.line,character:t.character-1},end:t}),m=l.getText({start:t,end:{line:t.line,character:t.character+1}}),v='"'===u||'"'===m;const p=await d.doComplete(l,t,g);let h=!1;if((null===(i=null==p?void 0:p.items)||void 0===i?void 0:i.length)&&(null===(a=null==p?void 0:p.items)||void 0===a?void 0:a.length)>0){let e=null===(r=null==p?void 0:p.items[0])||void 0===r?void 0:r.label;if(e=fixString(e),specialStringHandler.hasType(e)||specialStringHandler.hasType(`HBuilderX.${e}`)){let n=g.getNodeFromOffset(l.offsetAt(t)),i=null==n?void 0:n.offset,a=null;if(n&&i){a=l.positionAt(i);let r={...a};r.character+=1;let d={...r};d.character+=n.length-2;let u={start:r,end:d},m=utils_1.hx.createProject(null==c?void 0:c.uri.toString()),v=specialStringHandler.doComplete([e.includes("HBuilderX.")?e:`HBuilderX.${e}`],l,t,{range:u,kind:specialStringHandler.StringLocationInfoKind.IN_JSON_LIKE,ast:g,project:m},specialStringHandler.StringServicesContainer.create(void 0),[],!1);h=v.isIncomplete;for(let t of v.items){let n,i;n=t.kind,"HBuilderX.VueI18NKeyString"===e?(t.label="%"+t.label+"%",i=t.textEdit?"%"+t.textEdit.newText+"%":void 0,n=12):i=t.textEdit?t.textEdit.newText:void 0;let a=t.textEdit?t.textEdit.range:u;o.push({kind:n,label:t.label,documentation:(null===(s=t.documentation)||void 0===s?void 0:s.kind)?t.documentation.value:t.documentation,range:new vscode.Range(new vscode.Position(a.start.line,a.start.character),new vscode.Position(a.end.line,a.end.character)),insertText:i})}}}else null==p||p.items.forEach((e=>{var t,n,i,a,r,s;let l=(null===(t=e.textEdit)||void 0===t?void 0:t.newText)&&-1!=(null===(n=e.textEdit)||void 0===n?void 0:n.newText.search("1"));o.push({kind:e.kind,label:e.label,documentation:(null===(i=e.documentation)||void 0===i?void 0:i.kind)?e.documentation.value:e.documentation,insertText:l?new vscode.SnippetString(generatorSnippetString(null===(a=e.textEdit)||void 0===a?void 0:a.newText)):null===(r=e.textEdit)||void 0===r?void 0:r.newText,range:null===(s=e.textEdit)||void 0===s?void 0:s.range,filterText:v?`"${e.label}"`:e.label,command:l?{title:"Suggest",command:"editor.action.triggerSuggest"}:void 0})}))}o=o.filter((e=>!e.label.includes("@title/"))),o=o.filter((e=>!e.label.includes("@description/"))),o=o.filter((e=>!e.label.startsWith("extensions")));let S=vscode_json_languageservice_1.Range.create(vscode_json_languageservice_1.Position.create(8,20),vscode_json_languageservice_1.Position.create(8,22));l.getText(S);return{isIncomplete:h,items:o}}async resolveCompletionItem(e,t){return e}}function register(){const e=["**/package.json","**/database/*.schema.json","**/pages.json","**/manifest.json","**/settings.json"];let t=(0,arrays_1.flatten)(["json","jsonc","json_tm"].map((t=>e.map((e=>({language:t,pattern:e}))))));return vscode.languages.registerCompletionItemProvider(t,new JsonCompletionItemProvider)}exports.register=register;