"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.register=void 0;const fs=require("fs"),path=require("path"),vscode=require("vscode"),vscode_json_languageservice_1=require("vscode-json-languageservice"),vscode_uri_1=require("vscode-uri"),out_1=require("../../../utils/out"),packageSchema_1=require("../schemas/packageSchema"),pagesSchema_1=require("../schemas/pagesSchema"),schemaSchema_1=require("../schemas/schemaSchema"),arrays_1=require("../utils/arrays"),schemaMgr=require("./schemaManager");function getJsonServer(){const e={resolveRelativePath:(e,t)=>{const r=t.substring(0,t.lastIndexOf("/")+1);return vscode_uri_1.Utils.resolvePath(vscode_uri_1.URI.parse(r),e).toString()}};return(0,vscode_json_languageservice_1.getLanguageService)({workspaceContext:e,contributions:[],clientCapabilities:vscode_json_languageservice_1.ClientCapabilities.LATEST})}function treeApply(e,t){e&&t(e)&&e.children&&e.children.forEach((e=>{treeApply(e,t)}))}function getNodeFromKey(e,t){const r=e.root;let a=[];return treeApply(r,(e=>("property"===e.type&&e.keyNode.value===t&&a.push(e),!0))),a}function getCurrentI18nLanguageFile(e){let t,r=path.join(e.sourceRoot,"manifest.json"),a=fs.readFileSync(r),n=vscode_json_languageservice_1.TextDocument.create(r,"json",1,a.toString()),s=getJsonServer().parseJSONDocument(n),o=getNodeFromKey(s,"locale"),i="zh-Hans";if(o.length>0){let e=o[0];if(!e.valueNode)return t;i=e.valueNode.value}let c=path.join(e.sourceRoot,"locale"),g=fs.readdirSync(c);if(!g)return t;if(g.length<1)return t;let u=[];for(const e of g)!e.includes("uni")&&e.endsWith(".json")&&u.push(e);if(!u.includes(i+".json")){let e=getNodeFromKey(s,"fallbackLocale"),t="en";if(o.length>0&&(t=e[0].value),!u.includes(i+".json"))return}return t=path.join(c,i+".json"),t}class JsonDefinitionProvider{async doDefinitionFromI18n(e,t,r,a,n){let s=null,o=[],i=await e.getMatchingSchemas(r,n),c=n.getNodeFromOffset(r.offsetAt(a));if(!c||"string"!==c.type||!c.parent||"property"!==c.parent.type||!c.value.startsWith("%"))return s;let g=[];for(const e of i)if(e.node===c){g=e.schema.enum;break}if(!g)return s;let u={workspaceFolder:null==t?void 0:t.uri.fsPath};for(const e of g){let t=(0,out_1.gotoDefinition)(e,c.value.replace(/%/g,""),u);if(!t)return s;let a=out_1.hx.createProject(u.workspaceFolder);if(!a)return s;let n=getCurrentI18nLanguageFile(a);if(!n)return s;const i=fs.readFileSync(n),g=vscode_json_languageservice_1.TextDocument.create("data"+n,"json",1,i.toString());if(!t)return s;if(t.length<1)return s;let l=g.positionAt(t[0].textSpan.start),h=g.positionAt(t[0].textSpan.start);h.character=h.character+t[0].textSpan.length;let p=new vscode.Range(new vscode.Position(l.line,l.character),new vscode.Position(h.line,h.character)),d=r.positionAt(c.offset),f=new vscode.Range(new vscode.Position(d.line,d.character+2),new vscode.Position(d.line,d.character+c.length-2)),m={targetUri:vscode_uri_1.URI.file(n),targetRange:p,targetSelectionRange:p,originSelectionRange:f};o.push(m)}return o.length>0?o:s}async provideDefinition(e,t,r){let a=await vscode.workspace.getWorkspaceFolder(e.uri);schemaMgr.registerSchema("packageSchema",packageSchema_1.PackageSchema,["package.json"]),schemaMgr.registerSchema("pagesSchema",pagesSchema_1.PagesSchema,["pages.json"]),schemaMgr.registerSchema("schemaJsonSchema",schemaSchema_1.SchemaJsonSchema,["*.schema.json"]);const n=(0,vscode_json_languageservice_1.getLanguageService)({schemaRequestService:schemaMgr.findSchema});schemaMgr.setLanguageConfig(n,vscode_uri_1.URI.parse(e.uri.toString()).fsPath,a);const s=vscode_json_languageservice_1.TextDocument.create(e.uri.toString(),e.languageId,1,e.getText()),o=n.parseJSONDocument(s);let i=await this.doDefinitionFromI18n(n,a,s,t,o);if(i)return i}}function register(){const e=["**/package.json","**/database/*.schema.json","**/pages.json","**/manifest.json","**/settings.json"],t=(0,arrays_1.flatten)(["json","jsonc","json_tm"].map((t=>e.map((e=>({language:t,pattern:e}))))));return vscode.languages.registerDefinitionProvider(t,new JsonDefinitionProvider)}exports.register=register;