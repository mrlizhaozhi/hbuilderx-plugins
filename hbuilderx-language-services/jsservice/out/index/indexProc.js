"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createFileIndexProcessor=void 0;const ts=require("typescript"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),indexlib_1=require("../../../indexlib"),utils_1=require("../../../utils"),utils_2=require("./utils"),vueCustomDirectivesProc_1=require("./vueCustomDirectivesProc"),vueRouterProc_1=require("./vueRouterProc"),vuexProc_1=require("./vuexProc");let docVersion=0;function getLanguageSerivceHost(){let e=vscode_languageserver_textdocument_1.TextDocument.create("init","javascript",1,"");const t={get version(){return""+(e.version+docVersion)},get compilerOptions(){return{allowNonTsExtensions:!0,allowJs:!0,lib:["lib.es6.d.ts"],target:ts.ScriptTarget.Latest,moduleResolution:ts.ModuleResolutionKind.Classic,experimentalDecorators:!1}},get documents(){return[e.uri]},getDocumentSnapshot(t){let r="";return t===e.uri&&(r=e.getText()),{getText:(e,t)=>r.substring(e,t),getLength:()=>r.length,getChangeRange:()=>{}}},getDocumentVersion:t=>t==e.uri?""+(e.version+docVersion):"1",hasDocument:t=>t==e.uri};return{getLanguaserService(r,s){e=r,docVersion++;let i=utils_1.hx.getProject(s.uri);if(i)return i.createTSLanguageService(t)}}}function mergeIndexData(e,t){e.categories.forEach((r=>{-1===t.categories.indexOf(r)&&(t.categories.push(r),t[r]=[]);let s=e[r];s.length>0&&t[r].push(...s)})),t.references.push(...e.references)}const host=getLanguageSerivceHost();class JavascriptIndexProcessor{constructor(e){this.lastUri="",this.lastProcTime=-1,this.astIndexProcs=[],this.processorMnger=e}support(e,t,r){if(this.lastUri&&e.uri==this.lastUri&&process.uptime()-this.lastProcTime<1)return!1;if(this.lastUri="","javascript"==e.languageId||"javascript_es6"==e.languageId)return!0;return e.uri.toLowerCase().endsWith(".js")}searchAst(e,t,r){function s(e){let t=e.getChildren(),r=t.findIndex((e=>e.kind==ts.SyntaxKind.NewKeyword));if(r>=0){let e=t[r+1];if(e)switch(e.kind){case ts.SyntaxKind.Identifier:case ts.SyntaxKind.PropertyAccessExpression:return e}}}let i=this;if(0!=i.astIndexProcs.filter((e=>e.onCallExpression||e.onNewExpression)).length)return function t(n,o){if(o<10){const a=n.getChildren();for(let n=0;n<a.length;n++){let c=a[n],u=utils_2.tsConvert.asTsNewExpression(a[n]);if(u){let t=s(u);t&&i.astIndexProcs.forEach((s=>{var i;let n=null===(i=s.onNewExpression)||void 0===i?void 0:i.call(s,e,u,t);n&&mergeIndexData(n,r)}))}let l=utils_2.tsConvert.asTsCallExpression(a[n]);l&&i.astIndexProcs.forEach((t=>{var s;let i=null===(s=t.onCallExpression)||void 0===s?void 0:s.call(t,e,l);i&&mergeIndexData(i,r)})),t(c,o+1)}}}(t,0)}doIndex(e,t,r){if(!t)return new indexlib_1.IndexData;let s={source:r,ws:t};if(this.astIndexProcs=[],[(0,vueRouterProc_1.getVueRouterIndexProc)(t),(0,vuexProc_1.getVuexIndexProc)(t),(0,vueCustomDirectivesProc_1.getVueDirectivesProc)(t)].forEach((t=>{t.support(e,s)&&this.astIndexProcs.push(t)})),0===this.astIndexProcs.length)return new indexlib_1.IndexData;let i=new indexlib_1.IndexData,n=host.getLanguaserService(e,t);if(n){let t=n.getProgram(),r=(t.getTypeChecker(),t.getSourceFile(e.uri));if(r){for(let t=0;t<r.statements.length;t++){let s=r.statements[t];switch(s.kind){case ts.SyntaxKind.ImportDeclaration:{let t=s;this.astIndexProcs.forEach((r=>{var s;let n=null===(s=r.onImportDeclaration)||void 0===s?void 0:s.call(r,e,t);n&&mergeIndexData(n,i)}))}break;case ts.SyntaxKind.ExportAssignment:{let t=s;this.astIndexProcs.forEach((r=>{var s;let n=null===(s=r.onExportAssignment)||void 0===s?void 0:s.call(r,e,t);n&&mergeIndexData(n,i)}))}}}this.searchAst(e,r,i)}}return this.lastUri=e.uri,this.lastProcTime=process.uptime(),i}}function createFileIndexProcessor(e){return new JavascriptIndexProcessor(e)}exports.createFileIndexProcessor=createFileIndexProcessor;