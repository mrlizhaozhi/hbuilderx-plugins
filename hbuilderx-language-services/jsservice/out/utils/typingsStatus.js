"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AtaProgressReporter=void 0;const vscode=require("vscode"),vscode_nls_1=require("vscode-nls"),dispose_1=require("./dispose"),localize=(0,vscode_nls_1.loadMessageBundle)(),typingsInstallTimeout=3e4;class TypingsStatus extends dispose_1.Disposable{constructor(s){super(),this._acquiringTypings=new Map,this._client=s,this._register(this._client.onDidBeginInstallTypings((s=>this.onBeginInstallTypings(s.eventId)))),this._register(this._client.onDidEndInstallTypings((s=>this.onEndInstallTypings(s.eventId))))}dispose(){super.dispose();for(const s of this._acquiringTypings.values())clearTimeout(s)}get isAcquiringTypings(){return Object.keys(this._acquiringTypings).length>0}onBeginInstallTypings(s){this._acquiringTypings.has(s)||this._acquiringTypings.set(s,setTimeout((()=>{this.onEndInstallTypings(s)}),3e4))}onEndInstallTypings(s){const e=this._acquiringTypings.get(s);e&&clearTimeout(e),this._acquiringTypings.delete(s)}}exports.default=TypingsStatus;class AtaProgressReporter extends dispose_1.Disposable{constructor(s){super(),this._promises=new Map,this._register(s.onDidBeginInstallTypings((s=>this._onBegin(s.eventId)))),this._register(s.onDidEndInstallTypings((s=>this._onEndOrTimeout(s.eventId)))),this._register(s.onTypesInstallerInitializationFailed((s=>this.onTypesInstallerInitializationFailed())))}dispose(){super.dispose(),this._promises.forEach((s=>s()))}_onBegin(s){const e=setTimeout((()=>this._onEndOrTimeout(s)),3e4),i=new Promise((i=>{this._promises.set(s,(()=>{clearTimeout(e),i()}))}));vscode.window.withProgress({location:vscode.ProgressLocation.Window,title:localize("installingPackages","Fetching data for better TypeScript IntelliSense")},(()=>i))}_onEndOrTimeout(s){const e=this._promises.get(s);e&&(this._promises.delete(s),e())}async onTypesInstallerInitializationFailed(){const s=vscode.workspace.getConfiguration("typescript");if(s.get("check.npmIsInstalled",!0)){const e={title:localize("typesInstallerInitializationFailed.doNotCheckAgain","Don't Show Again")};await vscode.window.showWarningMessage(localize("typesInstallerInitializationFailed.title","Could not install typings files for JavaScript language features. Please ensure that NPM is installed or configure 'typescript.npm' in your user settings. Click [here]({0}) to learn more.","https://go.microsoft.com/fwlink/?linkid=847635"),e)===e&&s.update("check.npmIsInstalled",!1,!0)}}}exports.AtaProgressReporter=AtaProgressReporter;