"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.register=exports.templateToSnippet=void 0;const vscode=require("vscode"),nls=require("vscode-nls"),typeConverters=require("../utils/typeConverters"),localize=nls.loadMessageBundle(),defaultJsDoc=new vscode.SnippetString("/**\n * $0\n */");class JsDocCompletionItem extends vscode.CompletionItem{constructor(e,t){super("/** */",vscode.CompletionItemKind.Snippet),this.document=e,this.position=t,this.detail=localize("typescript.jsDocCompletionItem.documentation","JSDoc comment"),this.sortText="\0";const s=e.lineAt(t.line).text,o=s.slice(0,t.character).match(/\/\**\s*$/),n=s.slice(t.character).match(/^\s*\**\//),i=t.translate(0,o?-o[0].length:0),r=new vscode.Range(i,t.translate(0,n?n[0].length:0));this.range={inserting:r,replacing:r}}}class JsDocCompletionProvider{constructor(e){this.client=e}async provideCompletionItems(e,t,s){const o=this.client.toOpenedFilePath(e);if(!o)return;const n=typeConverters.Position.toFileLocationRequestArgs(o,t),i=await this.client.execute("docCommentTemplate",n,s);if("response"!==i.type||!i.body)return;const r=new JsDocCompletionItem(e,t);return"/** */"===i.body.newText?r.insertText=defaultJsDoc:r.insertText=templateToSnippet(i.body.newText),{items:[]}}isPotentiallyValidDocCompletionPosition(e,t){const s=e.lineAt(t.line).text,o=s.slice(0,t.character);if(!/^\s*$|\/\*\*\s*$|^\s*\/\*\*+\s*$/.test(o))return!1;const n=s.slice(t.character);return/^\s*(\*+\/)?\s*$/.test(n)}}function templateToSnippet(e){let t=1;return e=(e=(e=(e=e.replace(/\$/g,"\\$")).replace(/^\s*(?=(\/|[ ]\*))/gm,"")).replace(/^(\/\*\*\s*\*[ ]*)$/m,(e=>e+"$0"))).replace(/\* @param([ ]\{\S+\})?\s+(\S+)\s*$/gm,((e,s,o)=>{let n="* @param ";return" {any}"===s||" {*}"===s?n+=`{\${${t++}:*}} `:s&&(n+=s+" "),n+=o+` \${${t++}}`,n})),new vscode.SnippetString(e)}function register(e,t,s){return vscode.languages.registerCompletionItemProvider(e.syntax,new JsDocCompletionProvider(s),"*")}exports.templateToSnippet=templateToSnippet,exports.register=register;