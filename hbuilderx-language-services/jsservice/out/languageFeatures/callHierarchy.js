"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.register=void 0;const path=require("path"),vscode=require("vscode"),PConst=require("../protocol.const"),typescriptService_1=require("../typescriptService"),api_1=require("../utils/api"),dependentRegistration_1=require("../utils/dependentRegistration"),modifiers_1=require("../utils/modifiers"),typeConverters=require("../utils/typeConverters");class TypeScriptCallHierarchySupport{constructor(e){this.client=e}async prepareCallHierarchy(e,r,t){const i=this.client.toOpenedFilePath(e);if(!i)return;const o=typeConverters.Position.toFileLocationRequestArgs(i,r),n=await this.client.execute("prepareCallHierarchy",o,t);return"response"===n.type&&n.body?Array.isArray(n.body)?n.body.map(fromProtocolCallHierarchyItem):fromProtocolCallHierarchyItem(n.body):void 0}async provideCallHierarchyIncomingCalls(e,r){const t=this.client.toPath(e.uri);if(!t)return;const i=typeConverters.Position.toFileLocationRequestArgs(t,e.selectionRange.start),o=await this.client.execute("provideCallHierarchyIncomingCalls",i,r);return"response"===o.type&&o.body?o.body.map(fromProtocolCallHierchyIncomingCall):void 0}async provideCallHierarchyOutgoingCalls(e,r){const t=this.client.toPath(e.uri);if(!t)return;const i=typeConverters.Position.toFileLocationRequestArgs(t,e.selectionRange.start),o=await this.client.execute("provideCallHierarchyOutgoingCalls",i,r);return"response"===o.type&&o.body?o.body.map(fromProtocolCallHierchyOutgoingCall):void 0}}function isSourceFileItem(e){return e.kind===PConst.Kind.script||e.kind===PConst.Kind.module&&1===e.selectionSpan.start.line&&1===e.selectionSpan.start.offset}function fromProtocolCallHierarchyItem(e){var r;const t=isSourceFileItem(e),i=t?path.basename(e.file):e.name,o=t?vscode.workspace.asRelativePath(path.dirname(e.file)):null!==(r=e.containerName)&&void 0!==r?r:"",n=new vscode.CallHierarchyItem(typeConverters.SymbolKind.fromProtocolScriptElementKind(e.kind),i,o,vscode.Uri.file(e.file),typeConverters.Range.fromTextSpan(e.span),typeConverters.Range.fromTextSpan(e.selectionSpan)),a=e.kindModifiers?(0,modifiers_1.parseKindModifier)(e.kindModifiers):void 0;return(null==a?void 0:a.has(PConst.KindModifiers.depreacted))&&(n.tags=[vscode.SymbolTag.Deprecated]),n}function fromProtocolCallHierchyIncomingCall(e){return new vscode.CallHierarchyIncomingCall(fromProtocolCallHierarchyItem(e.from),e.fromSpans.map(typeConverters.Range.fromTextSpan))}function fromProtocolCallHierchyOutgoingCall(e){return new vscode.CallHierarchyOutgoingCall(fromProtocolCallHierarchyItem(e.to),e.fromSpans.map(typeConverters.Range.fromTextSpan))}function register(e,r){return(0,dependentRegistration_1.conditionalRegistration)([(0,dependentRegistration_1.requireMinVersion)(r,TypeScriptCallHierarchySupport.minVersion),(0,dependentRegistration_1.requireSomeCapability)(r,typescriptService_1.ClientCapability.Semantic)],(()=>vscode.languages.registerCallHierarchyProvider(e.semantic,new TypeScriptCallHierarchySupport(r))))}TypeScriptCallHierarchySupport.minVersion=api_1.default.v380,exports.register=register;