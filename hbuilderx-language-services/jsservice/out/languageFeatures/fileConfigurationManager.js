"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode=require("vscode"),api_1=require("../utils/api"),dispose_1=require("../utils/dispose"),fileSchemes=require("../utils/fileSchemes"),languageModeIds_1=require("../utils/languageModeIds"),objects_1=require("../utils/objects"),resourceMap_1=require("../utils/resourceMap");function areFileConfigurationsEqual(e,t){return(0,objects_1.equals)(e,t)}class FileConfigurationManager extends dispose_1.Disposable{constructor(e,t){super(),this.client=e,this.formatOptions=new resourceMap_1.ResourceMap(void 0,{onCaseInsenitiveFileSystem:t}),vscode.workspace.onDidCloseTextDocument((e=>{this.formatOptions.delete(e.uri)}),void 0,this._disposables)}async ensureConfigurationForDocument(e,t){const n=this.getFormattingOptions(e);if(n)return this.ensureConfigurationOptions(e,n,t)}getFormattingOptions(e){const t=vscode.window.visibleTextEditors.find((t=>t.document.fileName===e.fileName));return t?{tabSize:t.options.tabSize,insertSpaces:t.options.insertSpaces}:void 0}async ensureConfigurationOptions(e,t,n){const i=this.client.toOpenedFilePath(e);if(!i)return;const r=this.getFileOptions(e,t),o=this.formatOptions.get(e.uri);if(o){const e=await o;if(e&&areFileConfigurationsEqual(e,r))return}let s;this.formatOptions.set(e.uri,new Promise((e=>s=e)));const a={file:i,...r};try{const e=await this.client.execute("configure",a,n);s("response"===e.type?r:void 0)}finally{s(void 0)}}async setGlobalConfigurationFromDocument(e,t){const n=this.getFormattingOptions(e);if(!n)return;const i={file:void 0,...this.getFileOptions(e,n)};await this.client.execute("configure",i,t)}reset(){this.formatOptions.clear()}getFileOptions(e,t){return{formatOptions:this.getFormatOptions(e,t),preferences:this.getPreferences(e)}}getFormatOptions(e,t){const n=vscode.workspace.getConfiguration((0,languageModeIds_1.isTypeScriptDocument)(e)?"typescript.format":"javascript.format",e.uri);return{tabSize:t.tabSize,indentSize:t.tabSize,convertTabsToSpaces:t.insertSpaces,newLineCharacter:"\n",insertSpaceAfterCommaDelimiter:n.get("insertSpaceAfterCommaDelimiter"),insertSpaceAfterConstructor:n.get("insertSpaceAfterConstructor"),insertSpaceAfterSemicolonInForStatements:n.get("insertSpaceAfterSemicolonInForStatements"),insertSpaceBeforeAndAfterBinaryOperators:n.get("insertSpaceBeforeAndAfterBinaryOperators"),insertSpaceAfterKeywordsInControlFlowStatements:n.get("insertSpaceAfterKeywordsInControlFlowStatements"),insertSpaceAfterFunctionKeywordForAnonymousFunctions:n.get("insertSpaceAfterFunctionKeywordForAnonymousFunctions"),insertSpaceBeforeFunctionParenthesis:n.get("insertSpaceBeforeFunctionParenthesis"),insertSpaceAfterOpeningAndBeforeClosingNonemptyParenthesis:n.get("insertSpaceAfterOpeningAndBeforeClosingNonemptyParenthesis"),insertSpaceAfterOpeningAndBeforeClosingNonemptyBrackets:n.get("insertSpaceAfterOpeningAndBeforeClosingNonemptyBrackets"),insertSpaceAfterOpeningAndBeforeClosingNonemptyBraces:n.get("insertSpaceAfterOpeningAndBeforeClosingNonemptyBraces"),insertSpaceAfterOpeningAndBeforeClosingTemplateStringBraces:n.get("insertSpaceAfterOpeningAndBeforeClosingTemplateStringBraces"),insertSpaceAfterOpeningAndBeforeClosingJsxExpressionBraces:n.get("insertSpaceAfterOpeningAndBeforeClosingJsxExpressionBraces"),insertSpaceAfterTypeAssertion:n.get("insertSpaceAfterTypeAssertion"),placeOpenBraceOnNewLineForFunctions:n.get("placeOpenBraceOnNewLineForFunctions"),placeOpenBraceOnNewLineForControlBlocks:n.get("placeOpenBraceOnNewLineForControlBlocks"),semicolons:n.get("semicolons")}}getPreferences(e){if(this.client.apiVersion.lt(api_1.default.v290))return{};const t=vscode.workspace.getConfiguration((0,languageModeIds_1.isTypeScriptDocument)(e)?"typescript":"javascript",e.uri),n=vscode.workspace.getConfiguration((0,languageModeIds_1.isTypeScriptDocument)(e)?"typescript.preferences":"javascript.preferences",e.uri);return{quotePreference:this.getQuoteStylePreference(n),importModuleSpecifierPreference:getImportModuleSpecifierPreference(n),importModuleSpecifierEnding:getImportModuleSpecifierEndingPreference(n),allowTextChangesInNewFiles:e.uri.scheme===fileSchemes.file,providePrefixAndSuffixTextForRename:!1!==n.get("renameShorthandProperties",!0)&&n.get("useAliasesForRenames",!0),allowRenameOfImportPath:!0,includeAutomaticOptionalChainCompletions:t.get("suggest.includeAutomaticOptionalChainCompletions",!0),provideRefactorNotApplicableReason:!0}}getQuoteStylePreference(e){switch(e.get("quoteStyle")){case"single":return"single";case"double":return"double";default:return this.client.apiVersion.gte(api_1.default.v333)?"auto":void 0}}}function getImportModuleSpecifierPreference(e){switch(e.get("importModuleSpecifier")){case"relative":return"relative";case"non-relative":return"non-relative";default:return}}function getImportModuleSpecifierEndingPreference(e){switch(e.get("importModuleSpecifierEnding")){case"minimal":return"minimal";case"index":return"index";case"js":return"js";default:return"auto"}}exports.default=FileConfigurationManager;