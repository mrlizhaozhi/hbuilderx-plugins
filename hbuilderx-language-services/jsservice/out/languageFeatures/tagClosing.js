"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.register=void 0;const vscode=require("vscode"),api_1=require("../utils/api"),dependentRegistration_1=require("../utils/dependentRegistration"),dispose_1=require("../utils/dispose"),typeConverters=require("../utils/typeConverters");class TagClosing extends dispose_1.Disposable{constructor(e){super(),this.client=e,this._disposed=!1,this._timeout=void 0,this._cancel=void 0,vscode.workspace.onDidChangeTextDocument((e=>this.onDidChangeTextDocument(e.document,e.contentChanges)),null,this._disposables)}dispose(){super.dispose(),this._disposed=!0,this._timeout&&(clearTimeout(this._timeout),this._timeout=void 0),this._cancel&&(this._cancel.cancel(),this._cancel.dispose(),this._cancel=void 0)}onDidChangeTextDocument(e,t){const i=vscode.window.activeTextEditor&&vscode.window.activeTextEditor.document;if(e!==i||0===t.length)return;const n=this.client.toOpenedFilePath(e);if(!n)return;void 0!==this._timeout&&clearTimeout(this._timeout),this._cancel&&(this._cancel.cancel(),this._cancel.dispose(),this._cancel=void 0);const s=t[t.length-1],o=s.text[s.text.length-1];if(s.rangeLength>0||">"!==o&&"/"!==o)return;if(">"===(s.range.start.character>0?e.getText(new vscode.Range(s.range.start.translate({characterDelta:-1}),s.range.start)):""))return;const r=e.version;this._timeout=setTimeout((async()=>{if(this._timeout=void 0,this._disposed)return;const t=s.text.split(/\r\n|\n/g),i=t.length<=1?s.range.start.translate({characterDelta:s.text.length}):new vscode.Position(s.range.start.line+t.length-1,t[t.length-1].length),o=typeConverters.Position.toFileLocationRequestArgs(n,i);this._cancel=new vscode.CancellationTokenSource;const c=await this.client.execute("jsxClosingTag",o,this._cancel.token);if("response"!==c.type||!c.body)return;if(this._disposed)return;const a=vscode.window.activeTextEditor;if(!a)return;const d=c.body,u=a.document;e===u&&u.version===r&&a.insertSnippet(this.getTagSnippet(d),this.getInsertionPositions(a,i))}),100)}getTagSnippet(e){const t=new vscode.SnippetString;return t.appendPlaceholder("",0),t.appendText(e.newText),t}getInsertionPositions(e,t){const i=e.selections.map((e=>e.active));return i.some((e=>e.isEqual(t)))?i:t}}function requireActiveDocument(e){return new dependentRegistration_1.Condition((()=>{const t=vscode.window.activeTextEditor;return!(!t||!vscode.languages.match(e,t.document))}),(e=>vscode.Disposable.from(vscode.window.onDidChangeActiveTextEditor(e),vscode.workspace.onDidOpenTextDocument(e))))}function register(e,t,i){return(0,dependentRegistration_1.conditionalRegistration)([(0,dependentRegistration_1.requireMinVersion)(i,TagClosing.minVersion),(0,dependentRegistration_1.requireConfiguration)(t,"autoClosingTags"),requireActiveDocument(e.syntax)],(()=>new TagClosing(i)))}TagClosing.minVersion=api_1.default.v300,exports.register=register;