"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.register=exports.TypeScriptReferencesCodeLensProvider=void 0;const vscode=require("vscode"),nls=require("vscode-nls"),PConst=require("../../protocol.const"),server_1=require("../../tsServer/server"),typescriptService_1=require("../../typescriptService"),dependentRegistration_1=require("../../utils/dependentRegistration"),typeConverters=require("../../utils/typeConverters"),baseCodeLensProvider_1=require("./baseCodeLensProvider"),localize=nls.loadMessageBundle();class TypeScriptReferencesCodeLensProvider extends baseCodeLensProvider_1.TypeScriptBaseCodeLensProvider{constructor(e,r,n){super(e,r),this.client=e,this._cachedResponse=r,this.modeId=n}async resolveCodeLens(e,r){const n=e,t=typeConverters.Position.toFileLocationRequestArgs(n.file,n.range.start),s=await this.client.execute("references",t,r,{lowPriority:!0,executionTarget:server_1.ExectuionTarget.Semantic,cancelOnResourceChange:n.document});if("response"!==s.type||!s.body)return n.command="cancelled"===s.type?baseCodeLensProvider_1.TypeScriptBaseCodeLensProvider.cancelledCommand:baseCodeLensProvider_1.TypeScriptBaseCodeLensProvider.errorCommand,n;const o=s.body.refs.map((e=>typeConverters.Location.fromTextSpan(this.client.toResource(e.file),e))).filter((e=>!(e.uri.toString()===n.document.toString()&&e.range.start.isEqual(n.range.start))));return n.command={title:this.getCodeLensLabel(o),command:o.length?"editor.action.showReferences":"",arguments:[n.document,n.range.start,o]},n}getCodeLensLabel(e){return 1===e.length?localize("oneReferenceLabel","1 reference"):localize("manyReferenceLabel","{0} references",e.length)}extractSymbol(e,r,n){if(n&&n.kind===PConst.Kind.enum)return(0,baseCodeLensProvider_1.getSymbolRange)(e,r);switch(r.kind){case PConst.Kind.function:if(vscode.workspace.getConfiguration(this.modeId).get("referencesCodeLens.showOnAllFunctions"))return(0,baseCodeLensProvider_1.getSymbolRange)(e,r);case PConst.Kind.const:case PConst.Kind.let:case PConst.Kind.variable:if(/\bexport\b/.test(r.kindModifiers))return(0,baseCodeLensProvider_1.getSymbolRange)(e,r);break;case PConst.Kind.class:if("<class>"===r.text)break;return(0,baseCodeLensProvider_1.getSymbolRange)(e,r);case PConst.Kind.interface:case PConst.Kind.type:case PConst.Kind.enum:return(0,baseCodeLensProvider_1.getSymbolRange)(e,r);case PConst.Kind.method:case PConst.Kind.memberGetAccessor:case PConst.Kind.memberSetAccessor:case PConst.Kind.constructorImplementation:case PConst.Kind.memberVariable:if(n&&typeConverters.Position.fromLocation(n.spans[0].start).isEqual(typeConverters.Position.fromLocation(r.spans[0].start)))return null;switch(null==n?void 0:n.kind){case PConst.Kind.class:case PConst.Kind.interface:case PConst.Kind.type:return(0,baseCodeLensProvider_1.getSymbolRange)(e,r)}}return null}}function register(e,r,n,t){return(0,dependentRegistration_1.conditionalRegistration)([(0,dependentRegistration_1.requireConfiguration)(r,"referencesCodeLens.enabled"),(0,dependentRegistration_1.requireSomeCapability)(n,typescriptService_1.ClientCapability.Semantic)],(()=>vscode.languages.registerCodeLensProvider(e.semantic,new TypeScriptReferencesCodeLensProvider(n,t,r))))}exports.TypeScriptReferencesCodeLensProvider=TypeScriptReferencesCodeLensProvider,exports.register=register;