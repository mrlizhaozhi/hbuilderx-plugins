"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.register=void 0;const ts=require("typescript"),vscode=require("vscode"),nls=require("vscode-nls"),utils_1=require("../../../utils"),PConst=require("../protocol.const"),api_1=require("../utils/api"),cancellation_1=require("../utils/cancellation"),codeAction_1=require("../utils/codeAction"),modifiers_1=require("../utils/modifiers"),performance_1=require("../utils/performance"),Previewer=require("../utils/previewer"),typeConverters=require("../utils/typeConverters"),localize=nls.loadMessageBundle();class MyCompletionItem extends vscode.CompletionItem{constructor(e,t,i,n,o){if(super(i.name,MyCompletionItem.convertKind(i.kind)),this.position=e,this.document=t,this.tsEntry=i,this.completionContext=n,this.metadata=o,i.source?i.source.startsWith("lsp://")?(this.sortText=i.sortText,this.kind=MyCompletionItem.lspConvertKind(i.kind)):this.sortText="ï¿¿"+i.sortText:this.sortText=i.sortText,this.preselect=i.isRecommended,this.position=e,this.useCodeSnippet=this.kind===vscode.CompletionItemKind.Function||this.kind===vscode.CompletionItemKind.Method,this.range=this.getRangeFromReplacementSpan(i,n,e),this.commitCharacters=MyCompletionItem.getCommitCharacters(n,i),this.insertText=i.insertText,this.filterText=this.getFilterText(n.line,i.insertText),n.isMemberCompletion&&n.dotAccessorContext&&(this.filterText=n.dotAccessorContext.text+(this.insertText||this.label),!this.range)){const e=this.getFuzzyWordRange();this.range=e?{inserting:n.dotAccessorContext.range,replacing:n.dotAccessorContext.range.union(e)}:n.dotAccessorContext.range,this.insertText=this.filterText}if(i.kindModifiers){const e=(0,modifiers_1.parseKindModifier)(i.kindModifiers);if(e.has(PConst.KindModifiers.optional)&&(this.insertText||(this.insertText=this.label),this.filterText||(this.filterText=this.label)),e.has(PConst.KindModifiers.depreacted)&&(this.tags=[vscode.CompletionItemTag.Deprecated]),e.has(PConst.KindModifiers.color)&&(this.kind=vscode.CompletionItemKind.Color),i.kind===PConst.Kind.script)for(const t of PConst.KindModifiers.fileExtensionKindModifiers)if(e.has(t)){i.name.toLowerCase().endsWith(t)?this.detail=i.name:this.detail=i.name+t;break}}try{if(i.source&&i.source.startsWith("lsp://")){let e=vscode.Uri.parse(i.source);i.isSnippet&&(this.useCodeSnippet=!0,this.insertText=new vscode.SnippetString(this.insertText));let t=e.query,n=JSON.parse(t);n.command&&(this.command={title:n.command.title,command:n.command.command}),n.data&&(this.data=n.data),n.detail&&(this.detail=n.detail),n.documentation&&(this.documentation=n.documentation)}}catch(e){}this.resolveRange()}getRangeFromReplacementSpan(e,t,i){if(!e.replacementSpan)return;let n=typeConverters.Range.fromTextSpan(e.replacementSpan);return n.isSingleLine||(n=new vscode.Range(n.start.line,n.start.character,n.start.line,t.line.length)),{inserting:new vscode.Range(n.start,i),replacing:n}}getFilterText(e,t){if(this.tsEntry.name.startsWith("#")){const i=this.completionContext.wordRange,n=i?e.charAt(i.start.character):void 0;return t?t.startsWith("this.#")?"#"===n?t:t.replace(/^this\.#/,""):t:"#"===n?void 0:this.tsEntry.name.replace(/^#/,"")}if(!(null==t?void 0:t.startsWith("this.")))return(null==t?void 0:t.startsWith("["))?t.replace(/^\[['"](.+)[['"]\]$/,".$1"):this.tsEntry.name}resolveRange(){if(this.range)return;const e=this.getFuzzyWordRange();e&&(this.range={inserting:new vscode.Range(e.start,this.position),replacing:e})}getFuzzyWordRange(){if(this.completionContext.useFuzzyWordRangeLogic){const e=this.completionContext.line.slice(Math.max(0,this.position.character-this.label.length),this.position.character).toLowerCase(),t=this.label.toLowerCase();for(let i=t.length;i>=0;--i)if(e.endsWith(t.substr(0,i))&&(!this.completionContext.wordRange||this.completionContext.wordRange.start.character>this.position.character-i))return new vscode.Range(new vscode.Position(this.position.line,Math.max(0,this.position.character-i)),this.position)}return this.completionContext.wordRange}static convertKind(e){switch(e){case PConst.Kind.primitiveType:case PConst.Kind.keyword:return vscode.CompletionItemKind.Keyword;case PConst.Kind.const:case PConst.Kind.let:case PConst.Kind.variable:case PConst.Kind.localVariable:case PConst.Kind.alias:case PConst.Kind.parameter:return vscode.CompletionItemKind.Variable;case PConst.Kind.memberVariable:case PConst.Kind.memberGetAccessor:case PConst.Kind.memberSetAccessor:return vscode.CompletionItemKind.Field;case PConst.Kind.function:case PConst.Kind.localFunction:return vscode.CompletionItemKind.Function;case PConst.Kind.method:case PConst.Kind.constructSignature:case PConst.Kind.callSignature:case PConst.Kind.indexSignature:return vscode.CompletionItemKind.Method;case PConst.Kind.enum:return vscode.CompletionItemKind.Enum;case PConst.Kind.enumMember:return vscode.CompletionItemKind.EnumMember;case PConst.Kind.module:case PConst.Kind.externalModuleName:return vscode.CompletionItemKind.Module;case PConst.Kind.class:case PConst.Kind.type:return vscode.CompletionItemKind.Class;case PConst.Kind.interface:return vscode.CompletionItemKind.Interface;case PConst.Kind.warning:return vscode.CompletionItemKind.Text;case PConst.Kind.script:return vscode.CompletionItemKind.File;case PConst.Kind.directory:return vscode.CompletionItemKind.Folder;case PConst.Kind.string:return vscode.CompletionItemKind.Constant;default:return vscode.CompletionItemKind.Property}}static lspConvertKind(e){return e-1}static getCommitCharacters(e,t){if(e.isNewIdentifierLocation||!e.isInValidCommitCharacterContext)return;const i=[];switch(t.kind){case PConst.Kind.memberGetAccessor:case PConst.Kind.memberSetAccessor:case PConst.Kind.constructSignature:case PConst.Kind.callSignature:case PConst.Kind.indexSignature:case PConst.Kind.enum:case PConst.Kind.interface:i.push(".",";");break;case PConst.Kind.module:case PConst.Kind.alias:case PConst.Kind.const:case PConst.Kind.let:case PConst.Kind.variable:case PConst.Kind.localVariable:case PConst.Kind.memberVariable:case PConst.Kind.class:case PConst.Kind.function:case PConst.Kind.method:case PConst.Kind.keyword:case PConst.Kind.parameter:i.push(".",",",";"),e.enableCallCompletions&&i.push("(")}return 0===i.length?void 0:i}}class CompositeCommand{constructor(){this.id=CompositeCommand.ID}execute(...e){for(const t of e)vscode.commands.executeCommand(t.command,...t.arguments||[])}}CompositeCommand.ID="_typescript.composite";class CompletionAcceptedCommand{constructor(e,t){this.onCompletionAccepted=e,this.telemetryReporter=t,this.id=CompletionAcceptedCommand.ID}execute(e){this.onCompletionAccepted(e),e instanceof MyCompletionItem&&this.telemetryReporter.logTelemetry("completions.accept",{isPackageJsonImport:e.tsEntry.isPackageJsonImport?"true":void 0})}}CompletionAcceptedCommand.ID="_typescript.onCompletionAccepted";class ApplyCompletionCodeActionCommand{constructor(e){this.client=e,this.id=ApplyCompletionCodeActionCommand.ID}async execute(e,t){if(0===t.length)return!0;if(1===t.length)return(0,codeAction_1.applyCodeAction)(this.client,t[0],cancellation_1.nulToken);const i=await vscode.window.showQuickPick(t.map(((e,t)=>({label:e.description,description:"",index:t}))),{placeHolder:localize("selectCodeAction","Select code action to apply")});if(!i)return!1;const n=t[i.index];return!!n&&(0,codeAction_1.applyCodeAction)(this.client,n,cancellation_1.nulToken)}}var CompletionConfiguration;ApplyCompletionCodeActionCommand.ID="_typescript.applyCompletionCodeAction",function(e){e.useCodeSnippetsOnMethodSuggest="suggest.completeFunctionCalls",e.nameSuggestions="suggest.names",e.pathSuggestions="suggest.paths",e.autoImportSuggestions="suggest.autoImports",e.getConfigurationForResource=function(t,i){const n=vscode.workspace.getConfiguration(t,i);return{useCodeSnippetsOnMethodSuggest:n.get(e.useCodeSnippetsOnMethodSuggest,!1),pathSuggestions:n.get(e.pathSuggestions,!0),autoImportSuggestions:n.get(e.autoImportSuggestions,!0),nameSuggestions:n.get(e.nameSuggestions,!0)}}}(CompletionConfiguration||(CompletionConfiguration={}));class TypeScriptCompletionItemProvider{constructor(e,t,i,n,o,s,r){this.client=e,this.modeId=t,this.typingsStatus=i,this.fileConfigurationManager=n,this.telemetryReporter=s,o.register(new ApplyCompletionCodeActionCommand(this.client)),o.register(new CompositeCommand),o.register(new CompletionAcceptedCommand(r,this.telemetryReporter))}async provideCompletionItems(e,t,i,n){if(this.typingsStatus.isAcquiringTypings)return Promise.reject({label:localize({key:"acquiringTypingsLabel",comment:["Typings refers to the *.d.ts typings files that power our IntelliSense. It should not be localized"]},"Acquiring typings..."),detail:localize({key:"acquiringTypingsDetail",comment:["Typings refers to the *.d.ts typings files that power our IntelliSense. It should not be localized"]},"Acquiring typings definitions for IntelliSense.")});const o=this.client.toOpenedFilePath(e);if(!o)return null;const s=e.lineAt(t.line),r=CompletionConfiguration.getConfigurationForResource(this.modeId,e.uri);if(!this.shouldTrigger(n,s,t))return null;const a=e.getWordRangeAtPosition(t);await this.client.interruptGetErr((()=>this.fileConfigurationManager.ensureConfigurationForDocument(e,i)));const c={...typeConverters.Position.toFileLocationRequestArgs(o,t),includeExternalModuleExports:r.autoImportSuggestions,includeInsertTextCompletions:!0,triggerCharacter:this.getTsTriggerCharacter(n)};let l,d,m,p,u,g=!0,h=!1,C=!1;if(this.client.apiVersion.gte(api_1.default.v300)){const n=Date.now();try{p=await this.client.interruptGetErr((()=>this.client.execute("completionInfo",c,i)))}finally{u=Date.now()-n}if((0,performance_1.report)("provideCompletionItems",u),"response"!==p.type||!p.body)return this.logCompletionsTelemetry(u,p),null;if(g=p.body.isNewIdentifierLocation,C=p.body.isMemberCompletion,C){const i=s.text.slice(0,t.character).match(/\??\.\s*$/)||void 0;if(i){const n=new vscode.Range(t.translate({characterDelta:-i[0].length}),t);l={range:n,text:e.getText(n)}}}h=p.metadata&&p.metadata.isIncomplete,d=p.body.entries,m=p.metadata}else{const e=await this.client.interruptGetErr((()=>this.client.execute("completions",c,i)));if("response"!==e.type||!e.body)return null;d=e.body,m=e.metadata}const f={isNewIdentifierLocation:g,isMemberCompletion:C,dotAccessorContext:l,isInValidCommitCharacterContext:this.isInValidCommitCharacterContext(e,t),enableCallCompletions:!r.useCodeSnippetsOnMethodSuggest,wordRange:a,line:s.text,useCodeSnippetsOnMethodSuggest:r.useCodeSnippetsOnMethodSuggest,useFuzzyWordRangeLogic:this.client.apiVersion.lt(api_1.default.v390)};let y=!1;const x=[];for(let i of d)shouldExcludeCompletionEntry(i,r)||(x.push(new MyCompletionItem(t,e,i,f,m)),y=!!i.isPackageJsonImport);return void 0!==u&&this.logCompletionsTelemetry(u,p,y),new vscode.CompletionList(x,h)}logCompletionsTelemetry(e,t,i){}getTsTriggerCharacter(e){switch(e.triggerCharacter){case"@":return this.client.apiVersion.gte(api_1.default.v310)&&this.client.apiVersion.lt(api_1.default.v320)?void 0:"@";case"#":return this.client.apiVersion.lt(api_1.default.v381)?void 0:"#";case".":case'"':case"'":case"`":case"/":case"<":return e.triggerCharacter}}async resolveCompletionItem(e,t){var i,n;const o=this.client.toOpenedFilePath(e.document);if(!o)return;const s={...typeConverters.Position.toFileLocationRequestArgs(o,e.position),entryNames:[e.tsEntry.source||e.tsEntry.data?{name:e.tsEntry.name,source:e.tsEntry.source,data:e.tsEntry.data}:e.tsEntry.name]};let r=Date.now();const a=await this.client.interruptGetErr((()=>this.client.execute("completionEntryDetails",s,t)));if("response"!==a.type||!a.body||!a.body.length)return e;let c=Date.now()-r;(0,performance_1.report)("completionEntryDetails",c);const l=a.body[0];!e.detail&&l.displayParts.length&&(e.detail=Previewer.plain(l.displayParts)),e.documentation=this.getDocumentation(l,e);const d=this.getCodeActions(l,o),m=[{command:CompletionAcceptedCommand.ID,title:"",arguments:[e]}];d.command&&m.push(d.command),e.additionalTextEdits=d.additionalTextEdits;let p=Object();if(null===(i=e.data)||void 0===i?void 0:i.hxKind)p.insertText=e.insertText,"string"!=typeof p.insertText&&(p.insertText=null===(n=p.insertText)||void 0===n?void 0:n.value);else{let t=ts.createSourceFile(e.document.uri.fsPath,e.document.getText(),ts.ScriptTarget.ESNext,!0);p=utils_1.hx.computeJSResolveData(e.label,e.detail,e.kind,e.document.offsetAt(e.position),e.textEdit,t,!0)}(0,performance_1.report)("hx.computeJSResolveData",Date.now()-r);let u="";if("string"==typeof e.insertText){-1!==e.insertText.indexOf(e.label)&&(u=e.insertText.substring(0,e.insertText.length-e.label.length))}return p.insertText&&(e.insertText=new vscode.SnippetString(`${u}${p.insertText}`)),p.command?e.command=p.command:m.length&&(1===m.length?e.command=m[0]:e.command={command:CompositeCommand.ID,title:"",arguments:m}),"async"!==e.label&&"await"!==e.label&&"static"!==e.label||e.tsEntry&&"Snippet"===e.tsEntry.kindModifiers&&(e.insertText=new vscode.SnippetString(e.tsEntry.insertText)),e}getCodeActions(e,t){if(!e.codeActions||!e.codeActions.length)return{};const i=[];let n,o=!1;for(const n of e.codeActions)if(n.commands&&(o=!0),n.changes)for(const e of n.changes)e.fileName===t?i.push(...e.textChanges.map(typeConverters.TextEdit.fromCodeEdit)):o=!0;return o&&(n={title:"",command:ApplyCompletionCodeActionCommand.ID,arguments:[t,e.codeActions.map((e=>({commands:e.commands,description:e.description,changes:e.changes.filter((e=>e.fileName!==t))})))]}),{command:n,additionalTextEdits:i.length?i:void 0}}isInValidCommitCharacterContext(e,t){if(this.client.apiVersion.lt(api_1.default.v320)&&t.character>1){return null===e.getText(new vscode.Range(t.line,0,t.line,t.character)).match(/(\s|^)\.$/gi)}return!0}shouldTrigger(e,t,i){if(e.triggerCharacter&&this.client.apiVersion.lt(api_1.default.v290)){if('"'===e.triggerCharacter||"'"===e.triggerCharacter){const e=t.text.slice(0,i.character);if(!e.match(/\b(from|import)\s*["']$/)&&!e.match(/\b(import|require)\(['"]$/))return!1}if("/"===e.triggerCharacter){const e=t.text.slice(0,i.character);if(!e.match(/\b(from|import)\s*["'][^'"]*$/)&&!e.match(/\b(import|require)\(['"][^'"]*$/))return!1}if("@"===e.triggerCharacter){const e=t.text.slice(0,i.character);if(!e.match(/^\s*\*[ ]?@/)&&!e.match(/\/\*\*+[ ]?@/))return!1}if("<"===e.triggerCharacter)return!1}return!0}getDocumentation(e,t){const i=new vscode.MarkdownString;if(e.source){const i=`'${Previewer.plain(e.source)}'`,n=localize("autoImportLabel","Auto import from {0}",i);t.detail=`${n}\n${t.detail}`}return Previewer.addMarkdownDocumentation(i,e.documentation,e.tags),i.value.length?i:void 0}async isValidFunctionCompletionContext(e,t,i,n){try{const i=typeConverters.Position.toFileLocationRequestArgs(e,t),o=await this.client.execute("quickinfo",i,n);if("response"===o.type&&o.body)switch(o.body.kind){case"var":case"let":case"const":case"alias":return!1}}catch(e){}return null===i.lineAt(t.line).text.slice(t.character).match(/^[a-z_$0-9]*\s*\(/gi)}}function shouldExcludeCompletionEntry(e,t){return!t.nameSuggestions&&e.kind===PConst.Kind.warning||!t.pathSuggestions&&(e.kind===PConst.Kind.directory||e.kind===PConst.Kind.script||e.kind===PConst.Kind.externalModuleName)||!t.autoImportSuggestions&&e.hasAction}function register(e,t,i,n,o,s,r,a){return vscode.languages.registerCompletionItemProvider(e.syntax,new TypeScriptCompletionItemProvider(i,t,n,o,s,r,a),...TypeScriptCompletionItemProvider.triggerCharacters)}TypeScriptCompletionItemProvider.triggerCharacters=[".",'"',"'","`","/","@","<","#"],exports.register=register;