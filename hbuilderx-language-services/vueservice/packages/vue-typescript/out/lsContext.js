"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createLanguageServiceContext=void 0;const path=__importStar(require("path")),localTypes=__importStar(require("./utils/localTypes")),sourceFile_1=require("./sourceFile"),documentRegistry_1=require("./documentRegistry");function createLanguageServiceContext(e,t,i=[],r=[".vue",".md",".html"]){var o;let n,s=0;const l=(0,documentRegistry_1.createDocumentRegistry)(),a=t.getCompilationSettings(),c=t.getVueCompilationSettings(),d=new Map,f=e.ScriptSnapshot.fromString(localTypes.getTypesCode(null!==(o=c.target)&&void 0!==o?o:3)),u=new Map,p=new WeakMap,g={fileExists:t.fileExists?o=>{var n,s;const d=o.substring(0,o.lastIndexOf("."));if(r.some((e=>d.endsWith(e)))){if(!l.get(d)){if(!!(null===(n=t.fileExists)||void 0===n?void 0:n.call(t,d))){const r=t.getScriptSnapshot(d);r&&l.set(d,(0,sourceFile_1.createSourceFile)(d,r.getText(0,r.getLength()),a,c,e,i))}}}return!!l.fromEmbeddedFileName(o)||!!(null===(s=t.fileExists)||void 0===s?void 0:s.call(t,o))}:void 0,getProjectVersion:()=>s.toString(),getScriptFileNames:function(){const e=l.getDirs().map((e=>path.join(e,localTypes.typesFileName)));for(const t of l.getAllEmbeddeds())t.embedded.file.isTsHostFile&&e.push(t.embedded.file.fileName);for(const i of t.getScriptFileNames())t.isTsPlugin?e.push(i):r.some((e=>i.endsWith(e)))||e.push(i);return e},getScriptVersion:h,getScriptSnapshot:function(i){var r;const o=path.basename(i);if(o===localTypes.typesFileName)return f;const n=h(i),s=u.get(i.toLowerCase());if(s&&s[0]===n)return s[1];const a=l.fromEmbeddedFileName(i);if(a){const t=a.embedded.file.content,r=e.ScriptSnapshot.fromString(t);return u.set(i.toLowerCase(),[n,r]),r}let d=t.getScriptSnapshot(i);if(d){if((null===(r=c.experimentalSuppressUnknownJsxPropertyErrors)||void 0===r||r)&&("runtime-dom.d.ts"===o||"jsx.d.ts"===o)){let t=d.getText(0,d.getLength());t=t.replace("type ReservedProps = {","type ReservedProps = { [name: string]: any"),d=e.ScriptSnapshot.fromString(t)}return u.set(i.toLowerCase(),[n,d]),d}},readDirectory:(e,i,r,o,n)=>{var s,a;const c=null!==(a=null===(s=t.readDirectory)||void 0===s?void 0:s.call(t,e,i,r,o,n))&&void 0!==a?a:[];for(const t of l.getFileNames()){const i=path.join(e,path.basename(t));path.relative(e.toLowerCase(),t.toLowerCase()).startsWith("..")||(n||t.toLowerCase()!==i.toLowerCase()?n&&c.push(i):c.push(i))}return c},getScriptKind(t){if(r.some((e=>t.endsWith(e))))return e.ScriptKind.TSX;switch(path.extname(t)){case".js":return e.ScriptKind.JS;case".jsx":return e.ScriptKind.JSX;case".ts":return e.ScriptKind.TS;case".tsx":return e.ScriptKind.TSX;case".json":return e.ScriptKind.JSON;default:return e.ScriptKind.Unknown}}},m=new Proxy(g,{get:(e,i)=>(S(),e[i]||t[i])});return{typescriptLanguageServiceHost:m,typescriptLanguageService:e.createLanguageService(m),get sourceFiles(){return S(),l}};function S(){var o,f,u;const p=null===(o=t.getProjectVersion)||void 0===o?void 0:o.call(t);if(!(void 0===p||p!==n))return;n=p;const g=t.getScriptFileNames(),m=new Set(g.filter((e=>r.some((t=>e.endsWith(t)))))),S=new Set(g.filter((e=>!r.some((t=>e.endsWith(t)))))),h=[],v=[],y=[];let b=!1;for(const e of l.getAll())if(m.has(e.fileName)||(null===(f=t.fileExists)||void 0===f?void 0:f.call(t,e.fileName))){const i=t.getScriptSnapshot(e.fileName);e.text!==(null==i?void 0:i.getText(0,i.getLength()))&&y.push(e.fileName)}else h.push(e.fileName);for(const e of m)l.get(e)||v.push(e);for(const e of d)if(m.has(e[0])||(null===(u=t.fileExists)||void 0===u?void 0:u.call(t,e[0]))){const i=t.getScriptVersion(e[0]);e[1]!==i&&(d.set(e[0],i),b=!0)}else d.delete(e[0]),b=!0;for(const e of S)if(!d.has(e)){const i=t.getScriptVersion(e);d.set(e,i),b=!0}for(const e of h)l.delete(e)&&(b=!0);for(const r of[...v,...y]){const o=t.getScriptSnapshot(r);if(!o)continue;const n=l.get(r),s=o.getText(0,o.getLength());if(n){const e={},t={};if(!b)for(const t of n.getAllEmbeddeds())t.file.isTsHostFile&&(e[t.file.fileName]=t.file.content);if(n.text=s,!b)for(const e of n.getAllEmbeddeds())e.file.isTsHostFile&&(t[e.file.fileName]=e.file.content);(Object.keys(e).length!==Object.keys(t).length||Object.keys(e).some((i=>e[i]!==t[i])))&&(b=!0)}else l.set(r,(0,sourceFile_1.createSourceFile)(r,s,a,c,e,i)),b=!0}b&&s++}function h(i){var r,o,n;if(path.basename(i)===localTypes.typesFileName)return"";let s=l.fromEmbeddedFileName(i);if(s){if(p.has(s.embedded.file))return p.get(s.embedded.file);{let i=null!==(n=null===(o=(r=e.sys).createHash)||void 0===o?void 0:o.call(r,s.embedded.file.content))&&void 0!==n?n:s.embedded.file.content;return t.isTsc&&(i=t.getScriptVersion(s.vueFile.fileName)+":"+i),p.set(s.embedded.file,i),i}}return t.getScriptVersion(i)}}exports.createLanguageServiceContext=createLanguageServiceContext;