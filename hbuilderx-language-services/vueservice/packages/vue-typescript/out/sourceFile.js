"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.useCssVars=exports.useStyleCssClasses=exports.createSourceFile=void 0;const compiler_sfc_1=require("@vue/compiler-sfc"),reactivity_1=require("@vue/reactivity"),vue_code_gen_1=require("../../vue-code-gen"),templateGen=__importStar(require("../../vue-code-gen/out/generators/template")),refSugarRanges_1=require("../../vue-code-gen/out/parsers/refSugarRanges"),scriptRanges_1=require("../../vue-code-gen/out/parsers/scriptRanges"),scriptSetupRanges_1=require("../../vue-code-gen/out/parsers/scriptSetupRanges"),parseCssClassNames_1=require("./utils/parseCssClassNames"),parseCssVars_1=require("./utils/parseCssVars"),sourceMaps_1=require("./utils/sourceMaps"),string_1=require("./utils/string"),untrack_1=require("./utils/untrack"),file_vue_1=__importDefault(require("./plugins/file-vue")),file_html_1=__importDefault(require("./plugins/file-html")),vue_template_html_1=__importDefault(require("./plugins/vue-template-html")),vue_sfc_customblocks_1=__importDefault(require("./plugins/vue-sfc-customblocks")),vue_sfc_styles_1=__importDefault(require("./plugins/vue-sfc-styles")),vue_sfc_template_1=__importDefault(require("./plugins/vue-sfc-template")),vue_typescript_scripts_1=__importDefault(require("./plugins/vue-typescript-scripts")),vue_typescript_template_1=__importDefault(require("./plugins/vue-typescript-template")),source_map_1=require("../../source-map");function createSourceFile(e,t,s,r,a,n=[]){var l;const u=(0,reactivity_1.ref)(""),i=(0,reactivity_1.reactive)({template:null,script:null,scriptSetup:null,styles:[],customBlocks:[],contents:""}),o=(0,reactivity_1.computed)((()=>{var t;for(const s of b){const r=null===(t=s.compileFileToVue)||void 0===t?void 0:t.call(s,e,u.value);if(r)return r}return{vue:"<template></template>",mappings:[]}})),c=(0,reactivity_1.computed)((()=>{var e;return null===(e=o.value)||void 0===e?void 0:e.vue})),p=(0,reactivity_1.computed)((()=>void 0!==c.value?(0,compiler_sfc_1.parse)(c.value,{sourceMap:!1,ignoreEmpty:!1}):void 0)),d=(0,reactivity_1.computed)((()=>{var e;if(i.template)for(const t of b){const s=null===(e=t.compileTemplateToHtml)||void 0===e?void 0:e.call(t,i.template.lang,i.template.content);if(s)return s}})),f=(0,reactivity_1.computed)((()=>{var e;if(d.value)return(0,vue_code_gen_1.compileSFCTemplate)(d.value.html,r.experimentalTemplateCompilerOptions,null!==(e=r.target)&&void 0!==e?e:3)})),v=useStyleCssClasses(i,(e=>!!e.module)),g=useStyleCssClasses(i,(e=>{var t;const r=null!==(t=s.experimentalResolveStyleCssClasses)&&void 0!==t?t:"scoped";return"scoped"===r&&e.scoped||"always"===r})),m=(0,reactivity_1.computed)((()=>{var e,t,s,n,l,u;if(d.value&&(null===(e=f.value)||void 0===e?void 0:e.ast))return templateGen.generate(a,{target:null!==(t=r.target)&&void 0!==t?t:3,experimentalRuntimeMode:r.experimentalRuntimeMode,experimentalAllowTypeNarrowingInInlineHandlers:null!==(s=r.experimentalAllowTypeNarrowingInInlineHandlers)&&void 0!==s&&s,experimentalSuppressInvalidJsxElementTypeErrors:null===(n=r.experimentalSuppressInvalidJsxElementTypeErrors)||void 0===n||n},null!==(u=null===(l=i.template)||void 0===l?void 0:l.lang)&&void 0!==u?u:"html",f.value.ast,!!i.scriptSetup,Object.values(g.value).map((e=>e.classNames)).flat(),d.value.mapping,{getEmitCompletion:string_1.SearchTexts.EmitCompletion,getPropsCompletion:string_1.SearchTexts.PropsCompletion})})),_=useCssVars(i),S=(0,reactivity_1.computed)((()=>{const e=[];for(const{style:t,ranges:s}of _.value)for(const r of s)e.push(t.content.substring(r.start,r.end));return e})),y=(0,reactivity_1.computed)((()=>{if(i.script)return a.createSourceFile(e+"."+i.script.lang,i.script.content,a.ScriptTarget.Latest)})),T=(0,reactivity_1.computed)((()=>{if(i.scriptSetup)return a.createSourceFile(e+"."+i.scriptSetup.lang,i.scriptSetup.content,a.ScriptTarget.Latest)})),h=(0,reactivity_1.computed)((()=>y.value?(0,scriptRanges_1.parseScriptRanges)(a,y.value,!!i.scriptSetup,!1,!0):void 0)),x=(0,reactivity_1.computed)((()=>T.value?(0,scriptSetupRanges_1.parseScriptSetupRanges)(a,T.value):void 0)),E=(0,reactivity_1.computed)((()=>i.script||i.scriptSetup?i.scriptSetup&&"js"!==i.scriptSetup.lang?i.scriptSetup.lang:i.script&&"js"!==i.script.lang?i.script.lang:"js":"ts")),C=(0,reactivity_1.computed)((()=>T.value?{refs:(0,refSugarRanges_1.parseRefSugarDeclarationRanges)(a,T.value,["$ref","$computed","$shallowRef","$fromRefs"]),raws:(0,refSugarRanges_1.parseRefSugarCallRanges)(a,T.value,["$raw","$fromRefs"])}:void 0)),b=[...n,(0,file_vue_1.default)(),(0,file_html_1.default)(),(0,vue_template_html_1.default)(),(0,vue_typescript_scripts_1.default)(E,h,x,m,r,S,a),(0,vue_typescript_template_1.default)(a,v,g,m,_,h,x,E,r,!!r.experimentalDisableTemplateSupport||(null!==(l=s.jsx)&&void 0!==l?l:a.JsxEmit.Preserve)!==a.JsxEmit.Preserve,e.endsWith(".html")),(0,vue_sfc_styles_1.default)(),(0,vue_sfc_customblocks_1.default)(),(0,vue_sfc_template_1.default)()],k=(0,reactivity_1.computed)((()=>{var e,t;return new source_map_1.SourceMapBase((null!==(t=null===(e=o.value)||void 0===e?void 0:e.mappings)&&void 0!==t?t:[]).map((e=>({data:void 0,mode:source_map_1.Mode.Offset,sourceRange:{start:e.fileOffset,end:e.fileOffset+e.length},mappedRange:{start:e.vueOffset,end:e.vueOffset+e.length}}))))})),R=b.map((t=>{if(t.getEmbeddedFilesCount&&t.getEmbeddedFile){const s=(0,reactivity_1.computed)((()=>t.getEmbeddedFilesCount(e,i))),r=(0,reactivity_1.computed)((()=>{const r=[];for(let a=0;a<s.value;a++){const s=a,n=(0,reactivity_1.computed)((()=>t.getEmbeddedFile(e,i,s))),l=(0,reactivity_1.computed)((()=>{var e,t;if(!n.value)return;const s=[];for(const r of n.value.mappings){const a=q(r.data,r.sourceRange),n=null===(e=k.value.getSourceRange(a.start,a.end))||void 0===e?void 0:e[0];if(n){let e;if(r.additional){e=[];for(const s of r.additional){const a=q(r.data,s.sourceRange),n=null===(t=k.value.getSourceRange(a.start,a.end))||void 0===t?void 0:t[0];n&&e.push({...s,sourceRange:n})}}s.push({...r,sourceRange:n,additional:e})}else if(o.value){const e=o.value.mappings.filter((e=>e.vueOffset>=a.start&&e.vueOffset+e.length<=a.end));for(const t of e){const e={start:t.vueOffset,end:t.vueOffset+t.length},a={start:t.fileOffset,end:t.fileOffset+t.length},n=F(r.data,e);s.push({...r,sourceRange:a,mappedRange:n})}}}const r=new sourceMaps_1.EmbeddedFileSourceMap(s);return{file:n.value,sourceMap:r,teleport:new sourceMaps_1.Teleport(n.value.teleportMappings)}}));r.push(l)}return r}));return r}})).filter(notEmpty),O=(0,reactivity_1.computed)((()=>{if(!e.endsWith(".vue")&&!e.endsWith(".nvue")&&o.value){const t={fileName:e+".vue",content:o.value.vue,capabilities:{diagnostics:!0,foldingRanges:!1,formatting:!1,documentSymbol:!1,codeActions:!0,inlayHints:!0},isTsHostFile:!1,mappings:o.value.mappings.map((e=>({data:{vueTag:void 0,capabilities:{basic:!0,references:!0,definitions:!0,diagnostic:!0,rename:!0,completion:!0,semanticTokens:!0,referencesCodeLens:!1,displayWithLink:!1}},mode:source_map_1.Mode.Offset,sourceRange:{start:e.fileOffset,end:e.fileOffset+e.length},mappedRange:{start:e.vueOffset,end:e.vueOffset+e.length}})))};return{file:t,sourceMap:new sourceMaps_1.EmbeddedFileSourceMap(t.mappings),teleport:void 0}}})),I=(0,reactivity_1.computed)((()=>{const e=[];O.value&&e.push(O.value);for(const t of R)for(const s of t.value)s.value&&(O.value&&!s.value.file.parentFileName?e.push({...s.value,file:{...s.value.file,parentFileName:O.value.file.fileName}}):e.push(s.value));return e})),w=(0,reactivity_1.computed)((()=>{const e=[];for(const t of I.value)t.teleport&&e.push({file:t.file,teleport:t.teleport});return e})),M=(0,reactivity_1.computed)((()=>{const e=[];let t=[...I.value];for(;t.length;){const e=t.length;if(s(),e===t.length)break}for(const s of t)e.push({self:s,embeddeds:[]});return e;function s(){for(let s=t.length-1;s>=0;s--){const a=t[s];if(a.file.parentFileName){const n=r(a.file.parentFileName,e);n&&(n.embeddeds.push({self:a,embeddeds:[]}),t.splice(s,1))}else e.push({self:a,embeddeds:[]}),t.splice(s,1)}}function r(e,t){var s;for(const a of t){if((null===(s=a.self)||void 0===s?void 0:s.file.fileName)===e)return a;let t=r(e,a.embeddeds);if(t)return t}}}));return B(t),{fileName:e,get text(){return u.value},set text(e){B(e)},getCompiledVue:(0,untrack_1.untrack)((()=>k.value)),getSfcTemplateLanguageCompiled:(0,untrack_1.untrack)((()=>d.value)),getSfcVueTemplateCompiled:(0,untrack_1.untrack)((()=>f.value)),getScriptFileName:(0,untrack_1.untrack)((()=>e.endsWith(".html")?e+".__VLS_script."+E.value:e+"."+E.value)),getDescriptor:(0,untrack_1.untrack)((()=>(0,reactivity_1.unref)(i))),getScriptAst:(0,untrack_1.untrack)((()=>y.value)),getScriptSetupAst:(0,untrack_1.untrack)((()=>T.value)),getSfcRefSugarRanges:(0,untrack_1.untrack)((()=>C.value)),getEmbeddeds:(0,untrack_1.untrack)((()=>M.value)),getScriptSetupRanges:(0,untrack_1.untrack)((()=>x.value)),isJsxMissing:()=>{var e;return!r.experimentalDisableTemplateSupport&&(null!==(e=s.jsx)&&void 0!==e?e:a.JsxEmit.Preserve)!==a.JsxEmit.Preserve},getAllEmbeddeds:()=>I.value,getTeleports:()=>w.value};function q(e,t){var s;if(void 0===c.value)throw"vueContent.value === undefined";if("scriptSrc"===e.vueTag){if(!(null===(s=i.script)||void 0===s?void 0:s.src))throw"!sfc.script?.src";const e=c.value.substring(0,i.script.startTagEnd).lastIndexOf(i.script.src);return{start:e-1,end:e+i.script.src.length+1}}if("script"===e.vueTag){if(!i.script)throw"!sfc.script";return{start:t.start+i.script.startTagEnd,end:t.end+i.script.startTagEnd}}if("scriptSetup"===e.vueTag){if(!i.scriptSetup)throw"!sfc.scriptSetup";return{start:t.start+i.scriptSetup.startTagEnd,end:t.end+i.scriptSetup.startTagEnd}}if("template"===e.vueTag){if(!i.template)throw"!sfc.template";return{start:t.start+i.template.startTagEnd,end:t.end+i.template.startTagEnd}}if("style"===e.vueTag){if(void 0===e.vueTagIndex)throw"data.vueTagIndex === undefined";return{start:t.start+i.styles[e.vueTagIndex].startTagEnd,end:t.end+i.styles[e.vueTagIndex].startTagEnd}}if("customBlock"===e.vueTag){if(void 0===e.vueTagIndex)throw"data.vueTagIndex === undefined";return{start:t.start+i.customBlocks[e.vueTagIndex].startTagEnd,end:t.end+i.customBlocks[e.vueTagIndex].startTagEnd}}return t}function F(e,t){if(void 0===c.value)throw"vueContent.value === undefined";if("script"===e.vueTag){if(!i.script)throw"!sfc.script";return{start:t.start-i.script.startTagEnd,end:t.end-i.script.startTagEnd}}if("scriptSetup"===e.vueTag){if(!i.scriptSetup)throw"!sfc.scriptSetup";return{start:t.start-i.scriptSetup.startTagEnd,end:t.end-i.scriptSetup.startTagEnd}}if("template"===e.vueTag){if(!i.template)throw"!sfc.template";return{start:t.start-i.template.startTagEnd,end:t.end-i.template.startTagEnd}}if("style"===e.vueTag){if(void 0===e.vueTagIndex)throw"data.vueTagIndex === undefined";return{start:t.start-i.styles[e.vueTagIndex].startTagEnd,end:t.end-i.styles[e.vueTagIndex].startTagEnd}}if("customBlock"===e.vueTag){if(void 0===e.vueTagIndex)throw"data.vueTagIndex === undefined";return{start:t.start-i.customBlocks[e.vueTagIndex].startTagEnd,end:t.end-i.customBlocks[e.vueTagIndex].startTagEnd}}return t}function B(e){function t(e,t){for(let s in t)e[s]=t[s]}u.value!==e&&(u.value=e,p.value&&(i.contents=e,function(s){var r;const a=s?{tag:"template",start:e.substring(0,s.loc.start.offset).lastIndexOf("<"),end:s.loc.end.offset+e.substring(s.loc.end.offset).indexOf(">")+1,startTagEnd:s.loc.start.offset,endTagStart:s.loc.end.offset,content:s.content,lang:null!==(r=s.lang)&&void 0!==r?r:"html"}:null;i.template&&a?t(i.template,a):i.template=a}(p.value.descriptor.template),function(s){var r;const a=s?{tag:"script",start:e.substring(0,s.loc.start.offset).lastIndexOf("<"),end:s.loc.end.offset+e.substring(s.loc.end.offset).indexOf(">")+1,startTagEnd:s.loc.start.offset,endTagStart:s.loc.end.offset,content:s.content,lang:getValidScriptSyntax(null!==(r=s.lang)&&void 0!==r?r:"js"),src:s.src}:null;i.script&&a?t(i.script,a):i.script=a}(p.value.descriptor.script),function(s){var r;const a=s?{tag:"scriptSetup",start:e.substring(0,s.loc.start.offset).lastIndexOf("<"),end:s.loc.end.offset+e.substring(s.loc.end.offset).indexOf(">")+1,startTagEnd:s.loc.start.offset,endTagStart:s.loc.end.offset,content:s.content,lang:getValidScriptSyntax(null!==(r=s.lang)&&void 0!==r?r:"js")}:null;i.scriptSetup&&a?t(i.scriptSetup,a):i.scriptSetup=a}(p.value.descriptor.scriptSetup),function(s){var r;for(let a=0;a<s.length;a++){const n=s[a],l={tag:"style",start:e.substring(0,n.loc.start.offset).lastIndexOf("<"),end:n.loc.end.offset+e.substring(n.loc.end.offset).indexOf(">")+1,startTagEnd:n.loc.start.offset,endTagStart:n.loc.end.offset,content:n.content,lang:null!==(r=n.lang)&&void 0!==r?r:"css",module:"string"==typeof n.module?n.module:n.module?"$style":void 0,scoped:!!n.scoped};i.styles.length>a?t(i.styles[a],l):i.styles.push(l)}for(;i.styles.length>s.length;)i.styles.pop()}(p.value.descriptor.styles),function(s){var r;for(let a=0;a<s.length;a++){const n=s[a],l={tag:"customBlock",start:e.substring(0,n.loc.start.offset).lastIndexOf("<"),end:n.loc.end.offset+e.substring(n.loc.end.offset).indexOf(">")+1,startTagEnd:n.loc.start.offset,endTagStart:n.loc.end.offset,content:n.content,lang:null!==(r=n.lang)&&void 0!==r?r:"txt",type:n.type};i.customBlocks.length>a?t(i.customBlocks[a],l):i.customBlocks.push(l)}for(;i.customBlocks.length>s.length;)i.customBlocks.pop()}(p.value.descriptor.customBlocks)))}}function useStyleCssClasses(e,t){return(0,reactivity_1.computed)((()=>{const s=[];for(let r=0;r<e.styles.length;r++){const a=e.styles[r];if(t(a)){const e=[...(0,parseCssClassNames_1.parseCssClassNames)(a.content)];s.push({style:a,index:r,classNameRanges:e,classNames:e.map((e=>a.content.substring(e.start+1,e.end)))})}}return s}))}function useCssVars(e){return(0,reactivity_1.computed)((()=>{const t=[];for(let s=0;s<e.styles.length;s++){const r=e.styles[s];t.push({style:r,styleIndex:s,ranges:[...(0,parseCssVars_1.parseCssVars)(r.content)]})}return t}))}exports.createSourceFile=createSourceFile,exports.useStyleCssClasses=useStyleCssClasses,exports.useCssVars=useCssVars;const validScriptSyntaxs=["js","jsx","ts","tsx"];function getValidScriptSyntax(e){return validScriptSyntaxs.includes(e)?e:"js"}function notEmpty(e){return null!=e}