"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.VueScriptCache=exports.getScriptKind=exports.VueEmbedsCacheInfo=void 0;const vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),core_1=require("../../core"),volar=__importStar(require("../packages/vue-typescript"));class VueEmbedsCacheInfo{constructor(e,t,i){this._version=t,this._vueSourceFile=e,this._tsImpl=i,this._scriptSnapshot=void 0,this._lspDocument=vscode_languageserver_textdocument_1.TextDocument.create(e.fileName,"vue",0,e.text),this._embedFiles=new Map;let r=this.sourceFile.getAllEmbeddeds();for(var s=0;s<r.length;s++){let e=r[s].file,t=(0,core_1.toNormalizedPath)(e.fileName,i);this._embedFiles.set(t.toLowerCase(),r[s])}}get sourceFile(){return this._vueSourceFile}getEmbedFile(e){let t=(0,core_1.toNormalizedPath)(e,this._tsImpl);if(t=t.toLowerCase(),this._embedFiles.has(t))return this._embedFiles.get(t)}toLspDocument(){return this._lspDocument}get scriptLanguageId(){var e,t;let i=null===(t=null===(e=this.sourceFile.getDescriptor())||void 0===e?void 0:e.script)||void 0===t?void 0:t.lang;return i||"js"}get version(){return this._version}}function getScriptKind(e,t){let i=t.ScriptKind.JS;if(e)switch(e=e.toLowerCase()){case"jsx":i=t.ScriptKind.JSX;break;case"ts":i=t.ScriptKind.TS;break;case"tsx":i=t.ScriptKind.TSX}return i}exports.VueEmbedsCacheInfo=VueEmbedsCacheInfo,exports.getScriptKind=getScriptKind;class VueScriptCache{constructor(e,t){this.tsImpl=e,this.tsServerHost=t,this.cache=new Map}get allSourceFiles(){let e=[];for(let t of this.cache.keys()){let i=this.cache.get(t);i&&e.push(null==i?void 0:i.sourceFile)}return e}getEmbeddedFileInfo(e){if(this.cache.size>0)for(let t of this.cache.keys()){let i=this.cache.get(t),r=null==i?void 0:i.getEmbedFile(e);if(r)return{file:r,host:i.sourceFile}}}getEmbeddedFile(e){let t=this.getEmbeddedFileInfo(e);if(t)return t.file}hasEmbeddedFile(e){return!!this.getEmbeddedFile(e)}getScriptVersion(e){for(let t of this.cache.keys()){let i=this.cache.get(t);if(null==i?void 0:i.getEmbedFile(e))return i.version}return this.tsServerHost.getScriptVersion(e)}getScriptKind(e){let t=this.getUpToDateInfo(e);return t?getScriptKind(t.scriptLanguageId,this.tsImpl):this.tsImpl.ScriptKind.Unknown}getUpToDateInfo(e){let t=this.cache.get(e),i=this.tsServerHost.getScriptVersion(e);if((null==t?void 0:t.version)===i)return t;let r=this.tsServerHost.getScriptSnapshot(e);if(!r)return;let s=r.getText(0,r.getLength()),o=volar.createSourceFile(e,s,this.tsServerHost.getCompilationSettings(),{target:2,experimentalImplicitWrapComponentOptionsWithDefineComponent:!0,experimentalDowngradePropsAndEmitsToSetupReturnOnScriptSetup:!0,enableTypeScriptValidation:(0,core_1.getConfigurationValue)(this.tsServerHost.getUserPreferences(),"typescript.validate.enable",!0),enableJavaScriptValidation:(0,core_1.getConfigurationValue)(this.tsServerHost.getUserPreferences(),"javascript.validate.enable",!1)},this.tsImpl),n=new VueEmbedsCacheInfo(o,i,this.tsImpl);return this.cache.set(e,n),n}}exports.VueScriptCache=VueScriptCache;