"use strict";var TokenType;Object.defineProperty(exports,"__esModule",{value:!0}),exports.createScanner=exports.ScannerState=exports.TokenType=void 0,function(t){t[t.StartCommentTag=0]="StartCommentTag",t[t.Comment=1]="Comment",t[t.EndCommentTag=2]="EndCommentTag",t[t.StartTagOpen=3]="StartTagOpen",t[t.StartTagClose=4]="StartTagClose",t[t.StartTagSelfClose=5]="StartTagSelfClose",t[t.StartTag=6]="StartTag",t[t.StartInterpolation=7]="StartInterpolation",t[t.EndTagOpen=8]="EndTagOpen",t[t.EndTagClose=9]="EndTagClose",t[t.EndTag=10]="EndTag",t[t.EndInterpolation=11]="EndInterpolation",t[t.DelimiterAssign=12]="DelimiterAssign",t[t.AttributeName=13]="AttributeName",t[t.AttributeValue=14]="AttributeValue",t[t.StartDoctypeTag=15]="StartDoctypeTag",t[t.Doctype=16]="Doctype",t[t.EndDoctypeTag=17]="EndDoctypeTag",t[t.Content=18]="Content",t[t.InterpolationContent=19]="InterpolationContent",t[t.Whitespace=20]="Whitespace",t[t.Unknown=21]="Unknown",t[t.Script=22]="Script",t[t.Styles=23]="Styles",t[t.EOS=24]="EOS"}(TokenType=exports.TokenType||(exports.TokenType={}));class MultiLineStream{constructor(t,e){this.source=t,this.len=t.length,this.position=e}eos(){return this.len<=this.position}getSource(){return this.source}pos(){return this.position}goBackTo(t){this.position=t}goBack(t){this.position-=t}advance(t){this.position+=t}goToEnd(){this.position=this.source.length}nextChar(){return this.source.charCodeAt(this.position++)||0}peekChar(t=0){return this.source.charCodeAt(this.position+t)||0}advanceIfChar(t){return t===this.source.charCodeAt(this.position)&&(this.position++,!0)}advanceIfChars(t){let e;if(this.position+t.length>this.source.length)return!1;for(e=0;e<t.length;e++)if(this.source.charCodeAt(this.position+e)!==t[e])return!1;return this.advance(e),!0}advanceIfRegExp(t){const e=this.source.substr(this.position).match(t);return e?(this.position=this.position+e.index+e[0].length,e[0]):""}advanceUntilRegExp(t){const e=this.source.substr(this.position).match(t);return e?(this.position=this.position+e.index,e[0]):(this.goToEnd(),"")}advanceUntilChar(t){for(;this.position<this.source.length;){if(this.source.charCodeAt(this.position)===t)return!0;this.advance(1)}return!1}advanceUntilChars(t){for(;this.position+t.length<=this.source.length;){let e=0;for(;e<t.length&&this.source.charCodeAt(this.position+e)===t[e];e++);if(e===t.length)return!0;this.advance(1)}return this.goToEnd(),!1}skipWhitespace(){return this.advanceWhileChar((t=>t===_WSP||t===_TAB||t===_NWL||t===_LFD||t===_CAR))>0}advanceWhileChar(t){const e=this.position;for(;this.position<this.len&&t(this.source.charCodeAt(this.position));)this.position++;return this.position-e}}const _BNG="!".charCodeAt(0),_MIN="-".charCodeAt(0),_LAN="<".charCodeAt(0),_RAN=">".charCodeAt(0),_FSL="/".charCodeAt(0),_EQS="=".charCodeAt(0),_DQO='"'.charCodeAt(0),_SQO="'".charCodeAt(0),_NWL="\n".charCodeAt(0),_CAR="\r".charCodeAt(0),_LFD="\f".charCodeAt(0),_WSP=" ".charCodeAt(0),_TAB="\t".charCodeAt(0),_LCR="{".charCodeAt(0),_RCR="}".charCodeAt(0);var ScannerState;!function(t){t[t.WithinContent=0]="WithinContent",t[t.WithinInterpolation=1]="WithinInterpolation",t[t.AfterOpeningStartTag=2]="AfterOpeningStartTag",t[t.AfterOpeningEndTag=3]="AfterOpeningEndTag",t[t.WithinDoctype=4]="WithinDoctype",t[t.WithinTag=5]="WithinTag",t[t.WithinEndTag=6]="WithinEndTag",t[t.WithinComment=7]="WithinComment",t[t.WithinScriptContent=8]="WithinScriptContent",t[t.WithinStyleContent=9]="WithinStyleContent",t[t.AfterAttributeName=10]="AfterAttributeName",t[t.BeforeAttributeValue=11]="BeforeAttributeValue"}(ScannerState=exports.ScannerState||(exports.ScannerState={}));const htmlScriptContents={"text/x-handlebars-template":!0};function createScanner(t,e=0,n=ScannerState.WithinContent){const a=new MultiLineStream(t,e);let i,r,o,c,s,h,p=n,S=0;function T(){return a.advanceIfRegExp(/^[_:\w][_:\w-.\d]*/).toLowerCase()}function g(t,e,n){return i=e,S=t,r=n||"",e}function C(){const t=a.pos();if(a.eos())return g(t,TokenType.EOS);let e;switch(p){case ScannerState.WithinComment:return a.advanceIfChars([_MIN,_MIN,_RAN])?(p=ScannerState.WithinContent,g(t,TokenType.EndCommentTag)):(a.advanceUntilChars([_MIN,_MIN,_RAN]),g(t,TokenType.Comment));case ScannerState.WithinDoctype:return a.advanceIfChar(_RAN)?(p=ScannerState.WithinContent,g(t,TokenType.EndDoctypeTag)):(a.advanceUntilChar(_RAN),g(t,TokenType.Doctype));case ScannerState.WithinContent:if(a.advanceIfChar(_LAN)){if(!a.eos()&&a.peekChar()===_BNG){if(a.advanceIfChars([_BNG,_MIN,_MIN]))return p=ScannerState.WithinComment,g(t,TokenType.StartCommentTag);if(a.advanceIfRegExp(/^!doctype/i))return p=ScannerState.WithinDoctype,g(t,TokenType.StartDoctypeTag)}return a.advanceIfChar(_FSL)?(p=ScannerState.AfterOpeningEndTag,g(t,TokenType.EndTagOpen)):(p=ScannerState.AfterOpeningStartTag,g(t,TokenType.StartTagOpen))}return a.advanceIfChars([_LCR,_LCR])?(p=ScannerState.WithinInterpolation,g(t,TokenType.StartInterpolation)):(a.advanceUntilRegExp(/<|{{/),g(t,TokenType.Content));case ScannerState.WithinInterpolation:return a.advanceIfChars([_RCR,_RCR])?(p=ScannerState.WithinContent,g(t,TokenType.EndInterpolation)):(a.advanceUntilChars([_RCR,_RCR]),g(t,TokenType.InterpolationContent));case ScannerState.AfterOpeningEndTag:return T().length>0?(p=ScannerState.WithinEndTag,g(t,TokenType.EndTag)):a.skipWhitespace()?g(t,TokenType.Whitespace,"Tag name must directly follow the open bracket."):(p=ScannerState.WithinEndTag,a.advanceUntilChar(_RAN),t<a.pos()?g(t,TokenType.Unknown,"End tag name expected."):C());case ScannerState.WithinEndTag:if(a.skipWhitespace())return g(t,TokenType.Whitespace);if(a.advanceIfChar(_RAN))return p=ScannerState.WithinContent,g(t,TokenType.EndTagClose);e="Closing bracket expected.";break;case ScannerState.AfterOpeningStartTag:return c=T(),h=null,s=null,c.length>0?(o=!1,p=ScannerState.WithinTag,g(t,TokenType.StartTag)):a.skipWhitespace()?g(t,TokenType.Whitespace,"Tag name must directly follow the open bracket."):(p=ScannerState.WithinTag,a.advanceUntilChar(_RAN),t<a.pos()?g(t,TokenType.Unknown,"Start tag name expected."):C());case ScannerState.WithinTag:return a.skipWhitespace()?(o=!0,g(t,TokenType.Whitespace)):o&&(s=a.advanceIfRegExp(/^[^\s"'<>/=\x00-\x0F\x7F\x80-\x9F]*/).toLowerCase(),s.length>0)?(p=ScannerState.AfterAttributeName,o=!1,g(t,TokenType.AttributeName)):a.advanceIfChars([_FSL,_RAN])?(p=ScannerState.WithinContent,g(t,TokenType.StartTagSelfClose)):a.advanceIfChar(_RAN)?(p="script"===c?h&&htmlScriptContents[h]?ScannerState.WithinContent:ScannerState.WithinScriptContent:"style"===c?ScannerState.WithinStyleContent:ScannerState.WithinContent,g(t,TokenType.StartTagClose)):(a.advance(1),g(t,TokenType.Unknown,"Unexpected character in tag."));case ScannerState.AfterAttributeName:return a.skipWhitespace()?(o=!0,g(t,TokenType.Whitespace)):a.advanceIfChar(_EQS)?(p=ScannerState.BeforeAttributeValue,g(t,TokenType.DelimiterAssign)):(p=ScannerState.WithinTag,C());case ScannerState.BeforeAttributeValue:if(a.skipWhitespace())return g(t,TokenType.Whitespace);const n=a.advanceIfRegExp(/^[^\s"'`=<>\/]+/);if(n.length>0)return"type"===s&&(h=n),p=ScannerState.WithinTag,o=!1,g(t,TokenType.AttributeValue);const i=a.peekChar();return i===_SQO||i===_DQO?(a.advance(1),a.advanceUntilChar(i)&&a.advance(1),"type"===s&&(h=a.getSource().substring(t+1,a.pos()-1)),p=ScannerState.WithinTag,o=!1,g(t,TokenType.AttributeValue)):(p=ScannerState.WithinTag,o=!1,C());case ScannerState.WithinScriptContent:let r=1;for(;!a.eos();){const e=a.advanceIfRegExp(/<!--|-->|<\/?script\s*\/?>?/i);if(0===e.length)return a.goToEnd(),g(t,TokenType.Script);if("\x3c!--"===e)1===r&&(r=2);else if("--\x3e"===e)r=1;else if("/"!==e[1])2===r&&(r=3);else{if(3!==r){a.goBack(e.length);break}r=2}}return p=ScannerState.WithinContent,t<a.pos()?g(t,TokenType.Script):C();case ScannerState.WithinStyleContent:return a.advanceUntilRegExp(/<\/style/i),p=ScannerState.WithinContent,t<a.pos()?g(t,TokenType.Styles):C()}return a.advance(1),p=ScannerState.WithinContent,g(t,TokenType.Unknown,e)}return{scan:function(){const t=a.pos(),e=p,n=C();return n!==TokenType.EOS&&t===a.pos()?(console.log("Scanner.scan has not advanced at offset "+t+", state before: "+e+" after: "+p),a.advance(1),g(t,TokenType.Unknown)):n},scanForRegexp:function(t){const e=a.pos();return p=ScannerState.WithinContent,a.advanceUntilRegExp(t)?g(e,TokenType.Unknown):g(e,TokenType.EOS)},getTokenType:()=>i,getTokenOffset:()=>S,getTokenLength:()=>a.pos()-S,getTokenEnd:()=>a.pos(),getTokenText:()=>a.getSource().substring(S,a.pos()),getScannerState:()=>p,getTokenError:()=>r}}exports.createScanner=createScanner;