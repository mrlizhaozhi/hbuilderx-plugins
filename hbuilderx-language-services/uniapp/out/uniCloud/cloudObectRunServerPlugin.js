"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.cloudObectRunServerPlugin=void 0;const vscode_uri_1=require("vscode-uri"),hx=require("../../../core"),documents_1=require("../../../core/out/base/documents"),uniCloudUtils_1=require("../utils/uniCloudUtils");let g_documentCacheInfo;class DocumentCacheInfo{constructor(e,t,n){this._cacheInfos=new Map,this._host=e,this._ls=t,this._ts=n}hasScript(e){let t=vscode_uri_1.URI.parse(hx.toNormalizedUri(e,this._ts)).fsPath;return this._cacheInfos.has(t)}getScriptInfo(e){let t=vscode_uri_1.URI.parse(hx.toNormalizedUri(e,this._ts)).fsPath;if(this._cacheInfos.has(t)){let e=this._cacheInfos.get(t);if((null==e?void 0:e.version)===this._host.getScriptVersion(t))return e}let n=this._host.getScriptSnapshot(t),o=null==n?void 0:n.getText(0,n.getLength()),i=(0,uniCloudUtils_1.getCloudObejctFilePath)(t);if(i){i=hx.toNormalizedPath(i,this._ts);let e=this._ls.getProgram(),t=null==e?void 0:e.getSourceFile(i);if(e&&t){o+=this.getSuffix(e,t)}}if(o){let e={version:this._host.getScriptVersion(t),text:o};return this._cacheInfos.set(t,e),e}}getSuffix(e,t){let n=e.getTypeChecker(),o=t.symbol,i=n.getTypeOfSymbolAtLocation(o,t).members,s="";for(let e of i.keys())s+=e+",";return s=s.slice(0,s.length-1),`\nconst {${s}} = require('index.obj.js')`}}class CloudObjectRunParamsDocumentPrvider{constructor(e){this._info=e}setLanguageService(e){this._ls=e}get version(){return this._info.tsinfo.languageServiceHost.getProjectVersion()}get compilerOptions(){return{allowNonTsExtensions:!0,allowJs:!0,lib:["lib.esnext.d.ts"],target:this._info.ts.ScriptTarget.Latest,moduleResolution:this._info.ts.ModuleResolutionKind.Classic,experimentalDecorators:!1}}get documents(){let e=[],t=this._info.tsinfo.languageServiceHost.getScriptFileNames();return t.forEach((n=>{if((0,uniCloudUtils_1.isInCloudObjectRuntime)(n)){let o=(0,uniCloudUtils_1.getCloudObejctFilePath)(n);o&&(o=hx.toNormalizedPath(o,this._info.ts),t.includes(o)||e.push(o))}})),t.push(...e),t}hasDocument(e){return!!(null==g_documentCacheInfo?void 0:g_documentCacheInfo.hasScript(e))}getDocumentVersion(e){if(null==g_documentCacheInfo?void 0:g_documentCacheInfo.hasScript(e)){return(null==g_documentCacheInfo?void 0:g_documentCacheInfo.getScriptInfo(e)).version}return"1"}getDocumentSnapshot(e){let t="";if(null==g_documentCacheInfo?void 0:g_documentCacheInfo.hasScript(e)){let n=null==g_documentCacheInfo?void 0:g_documentCacheInfo.getScriptInfo(e);t=n.text}return{getText:(e,n)=>t.substring(e,n),getLength:()=>t.length,getChangeRange:()=>{}}}}function proxyLanguageService(e,t,n,o){const i=Object.create(null);for(let t of Object.keys(e)){const n=e[t];i[t]=(...t)=>n.apply(e,t)}return i.getCompletionsAtPosition=(t,o,i)=>{if((0,uniCloudUtils_1.isInCloudObjectRuntime)(t)){if(null==g_documentCacheInfo?void 0:g_documentCacheInfo.getScriptInfo(t))return n.getCompletionsAtPosition(t,o,i)}return e.getCompletionsAtPosition(t,o,i)},i.getCompletionEntryDetails=(t,o,i,s,r,u,c)=>{if((0,uniCloudUtils_1.isInCloudObjectRuntime)(t)){if(null==g_documentCacheInfo?void 0:g_documentCacheInfo.getScriptInfo(t))return n.getCompletionEntryDetails(t,o,i,s,r,u,c)}return e.getCompletionEntryDetails(t,o,i,s,r,u,c)},i.getQuickInfoAtPosition=(t,o)=>{if((0,uniCloudUtils_1.isInCloudObjectRuntime)(t)){if(null==g_documentCacheInfo?void 0:g_documentCacheInfo.getScriptInfo(t))return n.getQuickInfoAtPosition(t,o)}return e.getQuickInfoAtPosition(t,o)},i.getDefinitionAndBoundSpan=(t,o)=>{if((0,uniCloudUtils_1.isInCloudObjectRuntime)(t)){if(null==g_documentCacheInfo?void 0:g_documentCacheInfo.getScriptInfo(t)){return n.getDefinitionAndBoundSpan(t,o)}}return e.getDefinitionAndBoundSpan(t,o)},i}function create(e){let t=e.project;if(t&&(t.kind===hx.HXProjectKind.UniApp||t.kind===hx.HXProjectKind.UniApp_Cli)){const n=new CloudObjectRunParamsDocumentPrvider(e),o=(0,documents_1.createLanguageServiceHost)(n,t,e),i=e.ts.createLanguageService2(e,o,e.ts.createDocumentRegistry(!1,t.fsPath));return n.setLanguageService(i),g_documentCacheInfo=new DocumentCacheInfo(e.tsinfo.languageServiceHost,i,e.ts),proxyLanguageService(e.languageService,t,i,e)}return e.languageService}exports.cloudObectRunServerPlugin={create:create};