"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UTSPlugin=void 0;const hx=require("../../../core"),vscode_uri_1=require("vscode-uri"),fs=require("fs"),path=require("path"),tsUtils_1=require("../utils/tsUtils");let utsPluginPlatforms=["app-android","app-ios","web","mp-weixin"],libFiles=new Set,utsLibVersion=0;function isNativePackageNameLike(e){return isAndroidPackageNameLike(e)}function isAndroidPackageNameLike(e){return!/[/\\]+/g.test(e)&&/[.]?/g.test(e)}function findLastSymbolFormPackage(e,t,i){let n=(null==e?void 0:e.trim()).split("."),s=t.find((e=>e.escapedName===n[0]));if(s){if(n.length<=1)return s;n.shift();let e=getSymbol(n,s,i);if(e&&e.escapedName===n[n.length-1])return e}}function isUtsPluginRoot(e,t){if(isUniModule(t)){let e=path.join(t,"utssdk");return fs.existsSync(e)&&fs.statSync(e).isDirectory()}let i=path.basename(t);return path.join(e.sourceRoot,"utssdk",i)===t}function isUtsFile(e){return e.endsWith(".uts")}function isUniModule(e){try{if(/(?<=(\/|\\)uni_modules(\/|\\))\.*/g.test(e)&&fs.existsSync(e))return!0}catch(e){}return!1}function getUniModelName(e){try{let t=/(?<=(\/|\\)uni_modules(\/|\\))[^\/\\]*/g,i=e.match(t);if(i&&i.length>0)return i[0]}catch(e){}}function getDefaultLibs(){return[...libFiles]}function createDocumentProvider(e,t,i){if(!e||!t)return;return{get version(){return t.getProjectVersion()+utsLibVersion},compilerOptions:{allowNonTsExtensions:!0,allowJs:!0,lib:["lib.d.ts"],target:i.ScriptTarget.Latest,moduleResolution:i.ModuleResolutionKind.NodeJs,experimentalDecorators:!1,noLib:!0},get documents(){let n=getDefaultLibs();return t.getScriptInfos().forEach((t=>{var s;e.isProjectOf(t.fileName,i)&&(null===(s=t.fileName)||void 0===s?void 0:s.endsWith(".uts"))&&n.push(t.fileName)})),n},hasDocument(e){let t=hx.toNormalizedUri(e,i);return fs.existsSync(vscode_uri_1.URI.parse(t).fsPath)},getDocumentVersion(e){let n=hx.toNormalizedUri(e,i);return t.getScriptVersion(vscode_uri_1.URI.parse(n).fsPath)},getDocumentSnapshot(e){let n=vscode_uri_1.URI.parse(hx.toNormalizedUri(e,i)),s=getDefaultLibs();for(let e=0;e<s.length;++e)if(n.fsPath.endsWith(s[e])){let e=fs.readFileSync(n.fsPath).toString();return{getText:(t,i)=>e.substring(t,i),getLength:()=>e.length,getChangeRange:()=>{}}}return t.getScriptSnapshot(n.fsPath)},getDocumentKind:e=>isUtsFile(e)||e.endsWith(".ts")?i.ScriptKind.TS:i.ScriptKind.JS,getDefaultLibs:e=>[],resolveModuleNameOverride(e,t,n,s,o,r,l,a){if(!isUtsFile(n))return hx.resolveModuleName(i,e,t,n,s,o,r,l,a)}}}function getSymbol(e,t,i){var n;if(!t)return t;let s=new Array(...e);for(let o=0;o<e.length;++o){if(s.shift(),""===e[o])return t;if(null===(n=t.exports)||void 0===n?void 0:n.has(e[o])){let n=t.exports.get(e[o]);return n.flags==i.SymbolFlags.ValueModule||(n.flags&i.SymbolFlags.ValueModule)===i.SymbolFlags.ValueModule?getSymbol(s,n,i):n}}return t}function getSymbols(e,t,i){let n=[];return e.forEach((e=>{var s;let o=e.escapedName;o=o.toLocaleLowerCase();let r=t.toLocaleLowerCase();if(o.startsWith(r)&&e.flags===i.SymbolFlags.Class&&n.push(e),e.flags!==i.SymbolFlags.ValueModule)return;let l=[];null===(s=e.exports)||void 0===s||s.forEach((e=>{l.push(e)})),n.push(...getSymbols(l,t,i))})),n}function getPackageName(e){let t=e.escapedName,i=e.parent;return i&&(t=getPackageName(i)+"."+t),t}function proxyLanguageService(e,t,i,n){const s=Object.create(null);for(let t of Object.keys(e)){const i=e[t];s[t]=(...t)=>i.apply(e,t)}return s.getDefinitionAndBoundSpan=(s,o)=>{if(isUtsFile(s))return i.getDefinitionAndBoundSpan(s,o);let r=e.getProgram();if(r){let e=r.getSourceFile(s);if(e){let i=n.ts.getTokenAtPosition(e,o);if(n.ts.isStringLiteralLike(i)&&n.ts.isImportDeclaration(i.parent)){let e=i.text.trim();if(e.startsWith("@/")&&(e=path.join(t.sourceRoot,e.substring(2))),isUtsPluginRoot(t,e)){let t={textSpan:{start:i.getStart(),length:i.getEnd()-i.getStart()},definitions:[]},s=[],o=function(t){fs.existsSync(t)&&s.push({name:e,kind:n.ts.ScriptElementKind.unknown,containerName:"",containerKind:n.ts.ScriptElementKind.unknown,fileName:t,textSpan:{start:0,length:0}})},r=path.join(e,"index.uts");return o(r),utsPluginPlatforms.forEach((t=>{r=path.join(e,"utssdk",t,"index.uts"),o(r)})),t.definitions=s,t}}}}return e.getDefinitionAndBoundSpan(s,o)},s.getTypeDefinitionAtPosition=(t,n)=>isUtsFile(t)?i.getTypeDefinitionAtPosition(t,n):e.getTypeDefinitionAtPosition(t,n),s.getQuickInfoAtPosition=(t,n)=>isUtsFile(t)?i.getQuickInfoAtPosition(t,n):e.getQuickInfoAtPosition(t,n),s.getCompletionEntryDetails=(t,s,o,r,l,a,u)=>{var c,d,g;if(isUtsFile(t)){if(null==l?void 0:l.startsWith("uts://")){let e=null===(c=i.getProgram())||void 0===c?void 0:c.getSourceFile(t),r=n.ts.getTokenAtPosition(e,s-1),l=null===(d=i.getProgram())||void 0===d?void 0:d.getTypeChecker(),a=getSymbols(null==l?void 0:l.getSymbolsInScope(r,n.ts.SymbolFlags.Namespace),o,n.ts),p=u,f=null==a?void 0:a.find((e=>e.escapedName===o&&getPackageName(e)===p.exportMapKey));if(f){let i=n.ts.getTouchingPropertyName(e,s-1);const{displayParts:o,documentation:r,symbolKind:a,tags:u}=n.ts.SymbolDisplay.getSymbolDisplayPartsDocumentationAndSymbolKind(l,f,e,i,i,7);let c=n.ts.Completions.createCompletionDetails(f.name,n.ts.SymbolDisplay.getSymbolModifiers(l,f),a,o,r,u,void 0,void 0);c.codeActions||(c.codeActions=[]);let d=e=>{let t=[];return e.forEach((e=>{n.ts.isImportDeclaration(e)&&t.push(e),t.push(...d(e.getChildren()))})),t},p=d(e.getChildren()),m=0;p.forEach((e=>{e.end>m&&e.end<s&&(m=e.end)}));let h={start:m,length:0},S=getPackageName(f),y=`${0!==m?"\n":""}import ${f.escapedName} from '${S}';${0===m?"\n":""}`;return null===(g=null==c?void 0:c.codeActions)||void 0===g||g.push({description:"",changes:[{fileName:t,textChanges:[{span:h,newText:y}]}]}),c.source=[{text:S,kind:"text"}],c}}return i.getCompletionEntryDetails(t,s,o,r,l,a,u)}return e.getCompletionEntryDetails(t,s,o,r,l,a,u)},s.getSemanticDiagnostics=function(t){if(isUtsFile(t)){let e=i.getSemanticDiagnostics(t),s=[];if(e){let o=getDefaultLibs();e.forEach(((e,r)=>{var l,a;const u=e.file,c=e.start;if(u&&c){let e=n.ts.getTokenAtPosition(u,c);if(n.ts.isStringLiteralLike(e)&&n.ts.isImportDeclaration(e.parent)){let s=e.text.trim();if(isNativePackageNameLike(s)){const t=n.ts.getTokenAtPosition(u,e.pos-1),r=n.ts.getTokenAtPosition(u,t.pos-1);if(r.kind===n.ts.SyntaxKind.CloseBraceToken)return;if(n.ts.isIdentifier(r)){const t=i.getProgram();if(t){let i=t.getTypeChecker().getSymbolsInScope(e,n.ts.SymbolFlags.Namespace);i=i.filter((e=>{var t,i;return o.includes(null===(i=null===(t=e.valueDeclaration)||void 0===t?void 0:t.getSourceFile())||void 0===i?void 0:i.fileName)}));let r=s.split(".");if(1===r.length){let e=i.find((e=>e.escapedName===r[0]));if(e&&e.flags!==n.ts.SymbolFlags.ValueModule)return}else if(2===r.length){let e=i.find((e=>e.escapedName===r[0]));if(!e)return;{r.shift();let t=null===(l=e.exports)||void 0===l?void 0:l.get(r[r.length-1]);if(t&&t.flags!==n.ts.SymbolFlags.ValueModule)return}}else if(r.length>2){let e=i.find((e=>e.escapedName===r[0]));if(!e)return;{r.shift();let t=[];r.forEach(((e,i)=>{i!=r.length-1&&t.push(e)}));let i=getSymbol(t,e,n.ts);if(!i||i.escapedName!==t[t.length-1])return;{let e=null===(a=i.exports)||void 0===a?void 0:a.get(r[r.length-1]);if(e&&e.flags!==n.ts.SymbolFlags.ValueModule)return}}}}}}else{let e=s;e.startsWith("@/")&&(e=e.replace("@",n.project.fsPath));let i=path.resolve(path.dirname(t),e);if(fs.existsSync(i)||fs.existsSync(i+".uts"))return}}}s.push(e)}))}return s}return e.getSemanticDiagnostics(t)},s.getSuggestionDiagnostics=function(t){return isUtsFile(t)?i.getSuggestionDiagnostics(t):e.getSuggestionDiagnostics(t)},s.getCompletionsAtPosition=(t,s,o)=>{var r,l;if(isUtsFile(t)){let e=i.getCompletionsAtPosition(t,s,o),a=i.getProgram();if(a){let i=a.getSourceFile(t);if(i){let t=n.ts.getTokenAtPosition(i,s),o=a.getTypeChecker(),u=o.getSymbolsInScope(t,n.ts.SymbolFlags.Namespace),c=getDefaultLibs();u=u.filter((e=>{var t,i;return c.includes(null===(i=null===(t=e.valueDeclaration)||void 0===t?void 0:t.getSourceFile())||void 0===i?void 0:i.fileName)}));let d=n.ts.getTouchingPropertyName(i,s-1);if(n.ts.isStringLiteralLike(t)&&n.ts.isImportDeclaration(t.parent)){let i=null===(r=t.text)||void 0===r?void 0:r.trim();if(isNativePackageNameLike(i)){let t=i.split(".");if(t.length<=1)return u.forEach((t=>{null==e||e.entries.push({name:t.escapedName,kind:n.ts.ScriptElementKind.string,sortText:t.escapedName})})),e;let s=u.find((e=>e.escapedName===t[0]));t.shift();let r=getSymbol(t,s,n.ts);!r||r.flags!==n.ts.SymbolFlags.ValueModule&&(r.flags&n.ts.SymbolFlags.ValueModule)!==n.ts.SymbolFlags.ValueModule||null===(l=r.exports)||void 0===l||l.forEach(((t,i)=>{null==e||e.entries.push({name:i,kind:n.ts.SymbolDisplay.getSymbolKind(o,t,d),sortText:i})}))}return e}if(t.kind===n.ts.SyntaxKind.CloseBraceToken&&n.ts.isNamedImports(t.parent)||n.ts.isIdentifier(t)&&n.ts.isImportEqualsDeclaration(t.parent)||t.kind===n.ts.SyntaxKind.FromKeyword&&n.ts.isImportDeclaration(t.parent));else{let r=n.ts.getTokenAtPosition(i,s-1);if(r&&n.ts.isIdentifier(r)){let i=getSymbols(u,r.escapedText,n.ts),s=o.getSymbolsInScope(t,n.ts.SymbolFlags.All),l=new Map;s.forEach((e=>{l.set(e.escapedName,e)})),i.forEach((t=>{var i;let s=t.escapedName;l.has(s)||null==e||e.entries.push({name:s,kind:n.ts.SymbolDisplay.getSymbolKind(o,t,d),sortText:s,source:"uts://"+(null===(i=t.valueDeclaration)||void 0===i?void 0:i.getSourceFile().fileName),data:{exportName:s,exportMapKey:getPackageName(t)}})}))}}}}return e}return e.getCompletionsAtPosition(t,s,o)},s}function overwritingTypeCheckerApi(e){let t=e.ts.createTypeChecker.bind(e.ts);e.ts.createTypeChecker=function(i,n){let s=t(i,n);return{...s,getSymbolAtLocation(t){let i=s.getSymbolAtLocation(t);if(i)return i;if(e.ts.isStringLiteral(t)&&e.ts.isImportDeclaration(t.parent)){return findLastSymbolFormPackage(t.text,s.getSymbolsInScope(t,e.ts.SymbolFlags.Namespace),e.ts)}}}}}function overwritingHostApi(e,t){var i;const n=null===(i=e.resolveModuleNames)||void 0===i?void 0:i.bind(e);e.resolveModuleNames=(i,s,o,r,l,a)=>{let u=[];i.forEach((e=>u.push(void 0))),n&&(u=n(i,s,o,r,l,a));for(var c=0;c<i.length;c++){let n=i[c],o=u[c];if(!o){t.kind!=hx.HXProjectKind.UniApp&&t.kind!=hx.HXProjectKind.UniApp_Cli||n.startsWith("@/")&&(n=path.join(t.sourceRoot,n.substring(2)));let i=path.resolve(path.dirname(s),n),r=e.fileExists?e.fileExists.bind(e):fs.existsSync.bind(fs);if(isUtsPluginRoot(t,i)){let e=e=>!(!e||!r(e))&&(o={isExternalLibraryImport:!1,resolvedFileName:e},!0),t=isUniModule(i),n=path.join(i,"index.uts");e(n)||(n=path.join(i,t?"utssdk":"","app-android","index.uts"),e(n))}else i&&i.endsWith(".uts")&&r(i)&&(o={isExternalLibraryImport:!1,resolvedFileName:i});u[c]=o}}return u}}function listenUtsPluginLibDir(e){const t=path.join(path.resolve(hx.getExtensionRootPath(),"../uniapp-cli-vite"),"uts-types");let i=()=>{if(fs.statSync(t).isDirectory()){fs.readdirSync(t).forEach((i=>{if(i.endsWith("d.ts")){let n=hx.toNormalizedPath(path.join(t,i),e.ts);libFiles.add(n)}}))}};fs.existsSync(t)&&i(),e.ts.sys.watchFile(t,((t,n)=>{n===e.ts.FileWatcherEventKind.Created?i():n===e.ts.FileWatcherEventKind.Deleted&&libFiles.clear(),utsLibVersion++}),3e3)}function create(e){let t=e.project;if(t&&(t.kind===hx.HXProjectKind.UniApp||t.kind===hx.HXProjectKind.UniApp_Cli)){listenUtsPluginLibDir(e),overwritingHostApi(e.tsinfo.languageServiceHost,e.project),overwritingTypeCheckerApi(e);const i=createDocumentProvider(t,e.tsinfo.project,e.ts);let n=hx.createLanguageServiceHost(i,t,e);overwritingHostApi(n,e.project);const s=e.ts.createLanguageService2(e,n,t.documentRegistry);return proxyLanguageService(e.languageService,t,s,e)}return e.languageService}function createTypeCheckerPlugins(e){let t=e.project;if(t&&(t.kind===hx.HXProjectKind.UniApp||t.kind===hx.HXProjectKind.UniApp_Cli)){let t=function(t,i,n){var s;let o=null===(s=i.moduleSpecifier)||void 0===s?void 0:s.getText();if(o=(0,tsUtils_1.fixTsNodeText)(o),o.endsWith(".js")||o.endsWith(".ts"))return;let r=findLastSymbolFormPackage(o,t.getSymbolsInScope(i.moduleSpecifier,e.ts.SymbolFlags.Namespace),e.ts);if(r){if(n){let e=t.getTypeOfSymbol(r).getProperty(n);if(e)return t.getTypeOfSymbol(e)}return t.getTypeOfSymbol(r)}};return[{checkExpression:function(i,n,s,o,r,l){let a;if(o.kind===e.ts.SyntaxKind.Identifier){let i=s.getResolvedSymbol(o);(null==i?void 0:i.declarations)&&i.declarations.length>0&&i.declarations.forEach((n=>{var o,r,l;if(e.ts.isImportSpecifier(n)&&e.ts.isNamedImports(n.parent)&&(null===(l=null===(r=null===(o=n.parent)||void 0===o?void 0:o.parent)||void 0===r?void 0:r.parent)||void 0===l?void 0:l.kind)===e.ts.SyntaxKind.ImportDeclaration){let e=n.parent.parent.parent;a=t(s,e,i.escapedName.toString())}else if(n.kind===e.ts.SyntaxKind.ImportClause&&n.parent.kind===e.ts.SyntaxKind.ImportDeclaration){let e=n.parent;a=t(s,e,void 0)}}))}return a}}]}return[]}exports.UTSPlugin={create:create,createTypeCheckerPlugins:createTypeCheckerPlugins};