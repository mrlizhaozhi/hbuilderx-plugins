"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),hx=require("../../../core"),core_1=require("../../../core");function cleanText(e){if(!e)return;let t=e;return(e.startsWith('"')||e.startsWith("'"))&&(t=t.slice(1)),(e.endsWith('"')||e.endsWith("'"))&&(t=t.slice(0,t.length-1)),t}function calcFieldProposals(e,t){let n=[];return e.split(",").forEach((e=>{let o=(0,core_1.parseSchema)(e.trim(),t);if(o)for(const[e,t]of o.getProperties().entries())n.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,label:e,detail:t.desc})})),n}function doDBComponentComplete(e,t,n,o){let i=o.get(hx.LanguageServiceType.HTML_LANGUAGE_SERVICE),r=n.ast,l=r.findNodeAt(e.offsetAt(t)).attributes,s=i.getLocationInfoAtPosition(e,t,r);if(l&&s){let e=cleanText(l.collection);if("where"==(null==s?void 0:s.activeAttribute)&&e)return calcFieldProposals(e,n.project.fsPath)}return[]}class JQLHandler{doComplete(e,t,n,o){var i;if(n.kind===core_1.StringLocationInfoKind.IN_HTML_LIKE)return doDBComponentComplete(e,t,n,o);let r=[],l=o.get(core_1.LanguageServiceType.TS),s=n.ast,a=(0,core_1.findNodePathByOffset)(s,e.offsetAt(t)),d=a.length-1,c=a[d]||null;if(c&&(d-=1,c=a[d]||null,c))if((null==c?void 0:c.kind)===l.SyntaxKind.PropertyAssignment||(null==c?void 0:c.kind)===l.SyntaxKind.ShorthandPropertyAssignment)d-=1,c=a[d],c&&(null==c||c.kind,l.SyntaxKind.ObjectLiteralExpression);else{let e=null;if(c.kind==l.SyntaxKind.CallExpression)e=c;else{for(;c&&(null==c?void 0:c.kind)!==l.SyntaxKind.ExpressionStatement;)d-=1,c=a[d];if(c&&(null==c?void 0:c.kind)===l.SyntaxKind.ExpressionStatement){let t=c.expression;t.kind===l.SyntaxKind.CallExpression&&(e=t)}}for(;(null==e?void 0:e.kind)===l.SyntaxKind.CallExpression;){let t=e.expression;if(t.kind===l.SyntaxKind.PropertyAccessExpression){if("collection"===t.name.getText()){let t=e.arguments;if((null==t?void 0:t.length)>0&&(null===(i=t[0])||void 0===i?void 0:i.kind)===l.SyntaxKind.StringLiteral){let e=t[0].text;r.push(...calcFieldProposals(e,n.project.fsPath))}break}e=t.expression}}}return r}doCompleteResolve(e,t,n,o,i){return e}doHover(e,t,n,o){}doDefinition(e,t,n,o){return[]}doReference(e,t,n,o){return[]}}exports.default=JQLHandler;