"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const fs=require("fs"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),core_1=require("../../../core");function uniModules(e){let t=[],r=path.join(e,(0,core_1.getUniModulesDir)());return fs.existsSync(r)&&fs.statSync(r).isDirectory()&&fs.readdirSync(r).forEach((n=>{let o=path.join(r,n);if(fs.statSync(o).isDirectory())for(let r=0;r<core_1.providers.length;++r){let o=path.join(e,(0,core_1.getUniModuleDatabase)(n,core_1.providers[r]));fs.existsSync(o)&&fs.statSync(o).isDirectory()&&t.push(o)}})),t}function getUniModuleSchema(e,t){let r=uniModules(t);for(let t of r)fs.readdirSync(t).forEach((r=>{let n=path.join(t,r);fs.statSync(n).isFile()&&r.endsWith(".schema.json")&&e.add(path.basename(n,".schema.json"))}))}function findUniModuleSchema(e,t){let r,n=uniModules(e);for(let e of n){let r=fs.readdirSync(e);for(let n of r){let r=path.join(e,n);if(fs.statSync(r).isFile()&&n.endsWith(".schema.json")){if(path.basename(n,".schema.json")==t)return r}}}return r}function getTargetText(e,t,r){let n=e.split(",");if(n.length>0){let e=t;for(let t=0;t<n.length;++t){let o=n[t],a=e+o.length;if(r>=e&&r<=a)return{text:o,range:{start:e,end:a}};e=a+1}}return{text:e,range:{start:t,end:t+e.length}}}class DBCollectionHandler{doComplete(e,t,r,n){let o=[],a=e.getText(r.range),s=new Set;if(a.trim().length>0){a.split(",").forEach((e=>{s.add(e.trim())}))}let i=new Set;for(let e=0;e<core_1.providers.length;++e){let t=core_1.providers[e],n=path.join(r.project.fsPath,(0,core_1.getCloudDatabaseRoot)(t));fs.existsSync(n)&&(fs.statSync(n).isDirectory()&&fs.readdirSync(n).forEach((e=>{let t=path.join(n,e);fs.statSync(t).isFile()&&e.endsWith(".schema.json")&&i.add(path.basename(t,".schema.json"))})))}return getUniModuleSchema(i,r.project.fsPath),i.forEach((e=>{e.length>0&&o.push({label:e,kind:vscode_languageserver_protocol_1.CompletionItemKind.Variable,documentation:e})})),o}doCompleteResolve(e,t,r,n,o){return e}doHover(e,t,r,n){}doDefinition(e,t,r,n){let o=r.project.fsPath,a=getTargetText(e.getText(r.range),e.offsetAt(r.range.start),e.offsetAt(t));for(let t=0;t<core_1.providers.length;++t){let r=core_1.providers[t],n=path.join(o,(0,core_1.getCloudDatabaseRoot)(r));if(fs.existsSync(n)&&fs.statSync(n).isDirectory()){let t=fs.readdirSync(n);for(let r=0;r<t.length;++r){if(path.basename(t[r],".schema.json")==a.text)return[{targetUri:path.join(n,t[r]),targetRange:(0,core_1.getNullRange)(),targetSelectionRange:(0,core_1.getNullRange)(),originSelectionRange:{start:e.positionAt(a.range.start),end:e.positionAt(a.range.end)}}]}}}let s=findUniModuleSchema(o,a.text);return s?[{targetUri:s,targetRange:(0,core_1.getNullRange)(),targetSelectionRange:(0,core_1.getNullRange)(),originSelectionRange:{start:e.positionAt(a.range.start),end:e.positionAt(a.range.end)}}]:[]}doReference(e,t,r,n){return[]}}exports.default=DBCollectionHandler;