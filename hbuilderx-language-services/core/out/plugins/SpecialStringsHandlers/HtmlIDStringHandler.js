"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getClassList=exports.getIDList=exports.isHTMLDocument=exports.isCSSDocument=exports.isJSDocument=void 0;const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),indexlib_1=require("../../../../indexlib");function getJSReference(e){return e.references.filter((e=>e.type===indexlib_1.ReferenceFileType.Script))}function getCSSReference(e){return e.references.filter((e=>e.type===indexlib_1.ReferenceFileType.CSS))}function getReferenceByType(e,t){return e.references.filter((e=>e.type===t))}function isJSDocument(e){return"javascript"===e.languageId||"typescript"===e.languageId}function isCSSDocument(e){return"css"===e.languageId||"stylus"===e.languageId||"scss"===e.languageId||"sass"===e.languageId}function isHTMLDocument(e){return"html"===e.languageId||"html_es6"===e.languageId||"pug"===e.languageId}function getList(e,t){let n=new Map;for(const[r,s]of e.allIndexData().entries()){let e=s[t]||null;e&&e instanceof Array&&e.forEach((e=>{n.has(e.label)?n.get(e.label).add(r):n.set(e.label,new Set([r]))}))}return n}function getIDList(e){return getList(e,indexlib_1.IndexDataCategory.ID)}function getClassList(e){return getList(e,indexlib_1.IndexDataCategory.CLASS)}exports.isJSDocument=isJSDocument,exports.isCSSDocument=isCSSDocument,exports.isHTMLDocument=isHTMLDocument,exports.getIDList=getIDList,exports.getClassList=getClassList;class HtmlIDStringHandler{doComplete(e,t,n,r,s,i){let o=[],a=indexlib_1.IndexDataStore.load({uri:vscode_uri_1.URI.file(n.project.fsPath).toString(),name:""}),l=new Map,c=getIDList(a);if(isHTMLDocument(e)){let t=a.indexData(e.uri)[indexlib_1.IndexDataCategory.ID]||null;t&&t instanceof Array&&t.forEach((e=>{l.set(e.label,e.description||e.label)}))}else{let t=new Map;if(isJSDocument(e))for(const[e,n]of a.allIndexData().entries())(e.endsWith(".js")||e.endsWith(".ts"))&&t.set(e,n);else if(isCSSDocument(e))for(const[e,n]of a.allIndexData().entries())(e.endsWith(".css")||e.endsWith(".scss")||e.endsWith(".sass")||e.endsWith(".stylus"))&&t.set(e,n);if(t.size>0&&t.has(e.uri)){t.get(e.uri).references.forEach((e=>{for(const[t,n]of c.entries())n.has(e.uri)&&l.set(t,e.uri)}))}else for(const[e,t]of c.entries()){let n=[];t.forEach((e=>{e.endsWith(".css")||n.push(e)})),n.length>0&&l.set(e,n.join("\n"))}}for(const[e,t]of l.entries())o.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,label:e,detail:t});for(const[e,t]of c.entries())if(!l.has(e)){let n=[];t.forEach((e=>{e.endsWith(".css")||n.push(e)})),n.length>0&&o.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,label:e,detail:Array.from(t).join("\n")})}return o}doCompleteResolve(e,t,n,r,s){return e}doHover(e,t,n,r){}doDefinition(e,t,n,r){const s=e.uri;let i=s.startsWith("file://")?vscode_uri_1.URI.parse(s).toString():vscode_uri_1.URI.file(s).toString(),o=vscode_uri_1.URI.file(n.project.fsPath).toString(),a=indexlib_1.IndexDataStore.load({uri:o,name:""}).allIndexData(),l=new Set,c=[i],u=e.getText(n.range);for(;c.length>0;){let e=c.shift();if((e.endsWith(".html")||e.endsWith(".htm"))&&!l.has(e)){let t=a.get(e);if(t){let e=t[indexlib_1.IndexDataCategory.ID];for(let t=0;t<e.length;t++){let r=e[t];if(r.type===indexlib_1.IndexItemType.DEF&&r.label==u&&"number"==typeof r.offset){let e={start:vscode_languageserver_protocol_1.Position.create(r.position.line,r.position.character),end:vscode_languageserver_protocol_1.Position.create(r.position.line,r.position.character+u.length)};return[{targetUri:vscode_uri_1.URI.parse(s).fsPath.replace(/\\/g,"/"),targetRange:e,targetSelectionRange:e,originSelectionRange:n.range}]}}}}l.add(e),a.forEach(((t,n)=>{if(!l.has(n)){t.references.some((t=>t.uri==e))&&c.push(n)}}))}return[]}doReference(e,t,n,r){return[]}}exports.default=HtmlIDStringHandler;