"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_css_languageservice_1=require("vscode-css-languageservice"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),cssNodes=require("../../base/styleType"),string_1=require("../common/string"),type_resolve_1=require("../common/type-resolve"),vscode_uri_1=require("vscode-uri"),indexlib_1=require("../../../../indexlib"),lspUtil_1=require("../../base/lspUtil"),htmlDataUtils_1=require("../tool/htmlDataUtils"),{html5Tags:html5Tags,svgElements:svgElements}=require("vscode-css-languageservice/lib/umd/languageFacts/builtinData");function getCurrentWord(e,t){let o=t-1;const s=e.getText();for(;o>=0&&-1===' \t\n\r":{[()]},*>+'.indexOf(s.charAt(o));)o--;return s.substring(o+1,t)}function moveCursorInsideParenthesis(e){return e.replace(/\(\)$/,"($1)")}var SortTexts;!function(e){e.Enums=" ",e.Normal="d",e.Class="e",e.Id="f",e.PseudoClass="h",e.PseudoElement="i",e.VendorPrefixed="x",e.Term="y",e.Variable="z"}(SortTexts||(SortTexts={}));class CSSCompletion{constructor(e,t,o){this.sourceDocument=e,this.position=t,this.workspaceRoot=o}doCompletion(e,t){this.textDocument=e,this.textDocumentOffset=t;let o=(0,vscode_css_languageservice_1.getCSSLanguageService)().parseStylesheet(this.textDocument);this.innerOffset=this.sourceDocument.offsetAt(this.position)-t,this.nodePath=getNodePath(o,this.innerOffset),this.currentWord=getCurrentWord(e,this.innerOffset),this.defaultReplaceRange=vscode_languageserver_protocol_1.Range.create(vscode_languageserver_protocol_1.Position.create(this.position.line,this.position.character-this.currentWord.length),this.position);let s=[];for(let e=this.nodePath.length-1;e>=0;e--){const t=this.nodePath[e];if(t.type==cssNodes.NodeType.SimpleSelector){const e=t.findAParent(cssNodes.NodeType.Ruleset);e&&(s=this.getCompletionsForSelector(e))}}if(0==this.nodePath.length||1==this.nodePath.length&&this.nodePath[0].type==cssNodes.NodeType.Stylesheet)this.getIdClassCompletion(!0,!0,!0,!0,s),this.getElementCompletion(s);else{let e=getNodeAtOffset(o,this.innerOffset);if(e){let t=[cssNodes.NodeType.SelectorCombinatorParent,cssNodes.NodeType.SelectorCombinatorSibling,cssNodes.NodeType.SelectorCombinatorAllSiblings];(e.issues&&this.hasCharacterAtPosition(this.innerOffset-1,",")||t.includes(e.type))&&(this.getIdClassCompletion(!0,!0,!0,!0,s),this.getElementCompletion(s))}}return s}findInNodePath(e){for(let t=this.nodePath.length-1;t>=0;t--){const o=this.nodePath[t];if(-1!==e.indexOf(o.type))return o}return null}hasCharacterAtPosition(e,t){const o=this.textDocument.getText();return e>=0&&e<o.length&&o.charAt(e)===t}getCompletionRange(e){if(e&&e.offset<=this.innerOffset&&this.innerOffset<=e.end){const t=-1!==e.end?this.sourceDocument.positionAt(e.end+this.textDocumentOffset):this.position,o=this.sourceDocument.positionAt(e.offset+this.textDocumentOffset);if(o.line===t.line)return vscode_languageserver_protocol_1.Range.create(o,t)}return this.defaultReplaceRange}getIdClassCompletion(e,t,o,s,n){if(this.workspaceRoot&&(e||o)){const r=indexlib_1.IndexDataStore.load(this.workspaceRoot);let i=new Set,l=new Set;r.allIndexData().forEach(((r,a)=>{if(e){let e=r[indexlib_1.IndexDataCategory.ID];e instanceof Array&&e.forEach((e=>{var o;const s=null!==(o=e.label)&&void 0!==o?o:"";s&&!i.has(s)&&(n.push({label:"#"+s,insertText:t?"#"+s:s,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,sortText:SortTexts.Id}),i.add(s))}))}if(o){let e=r[indexlib_1.IndexDataCategory.CLASS];e instanceof Array&&e.forEach((e=>{var t;const o=null!==(t=e.label)&&void 0!==t?t:"";o&&!l.has(o)&&(n.push({label:"."+o,insertText:s?"."+o:o,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,sortText:SortTexts.Class}),l.add(o))}))}}))}}getElementCompletion(e){const t={hxKind:lspUtil_1.HxIconKind.ELEMENT};for(const o of html5Tags)e.push({label:o,kind:vscode_languageserver_protocol_1.CompletionItemKind.Keyword,data:t,sortText:SortTexts.Normal});for(const o of svgElements)e.push({label:o,kind:vscode_languageserver_protocol_1.CompletionItemKind.Keyword,data:t,sortText:SortTexts.Normal})}getTagAttributeCompletion(e){var t,o;const s=(0,htmlDataUtils_1.htmlDataProvider)(),n={hxKind:lspUtil_1.HxIconKind.ATTRIBUTE};let r=new Set;const i=t=>{const o=t.name;r.has(o)||o.startsWith("on")||(e.push({label:o,kind:vscode_languageserver_protocol_1.CompletionItemKind.Value,data:n,sortText:SortTexts.Normal}),r.add(o))};null===(t=s)||void 0===t||t._tags.forEach((e=>{e.attributes.forEach(i)})),null===(o=s)||void 0===o||o._globalAttributes.forEach(i)}getPseudoClassCompletion(e,t){(0,htmlDataUtils_1.cssDataProvider)().providePseudoClasses().forEach((o=>{const s={label:o.name,insertText:e?o.name:o.name.slice(1),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,sortText:SortTexts.PseudoClass};o.name.startsWith(":-")&&(s.sortText=SortTexts.VendorPrefixed),t.push(s)}))}getPseudoElementCompletion(e,t){const o=(0,htmlDataUtils_1.cssDataProvider)().providePseudoElements();e=(e=Math.min(2,e))<0?0:e,o.forEach((o=>{const s={label:o.name,insertText:o.name.slice(2-e),kind:vscode_languageserver_protocol_1.CompletionItemKind.Function,sortText:SortTexts.PseudoElement};o.name.startsWith("::-")&&(s.sortText=SortTexts.VendorPrefixed),t.push(s)}))}getCompletionsForSelector(e){let t=[cssNodes.NodeType.PseudoSelector,cssNodes.NodeType.IdentifierSelector,cssNodes.NodeType.ClassSelector,cssNodes.NodeType.ElementNameSelector,cssNodes.NodeType.AttributeSelector],o=this.findInNodePath(t),s=(this.getCompletionRange(o),[]);if(o)if(o.type==cssNodes.NodeType.IdentifierSelector)this.getIdClassCompletion(!0,!1,!1,!1,s);else if(o.type==cssNodes.NodeType.ClassSelector)this.getIdClassCompletion(!1,!1,!0,!1,s);else if(o.type==cssNodes.NodeType.ElementNameSelector)this.getElementCompletion(s);else if(o.type==cssNodes.NodeType.PseudoSelector){o.getText().startsWith("::")?this.getPseudoElementCompletion(0,s):(this.getPseudoElementCompletion(1,s),this.getPseudoClassCompletion(!1,s))}else if(o.type==cssNodes.NodeType.AttributeSelector){let e=this.innerOffset,t=null,n=o.getChildren();for(let o=0;o<n.length;o++){const s=n[o];if(s.offset<=e&&s.end>=e&&s.type==cssNodes.NodeType.Identifier){t=s;break}}(t||0==n.length)&&this.getTagAttributeCompletion(s)}return s}}function getNodeAtOffset(e,t){let o=null;return!e||t<e.offset||t>e.end?null:(e.accept((e=>-1===e.offset&&-1===e.length||e.offset<=t&&e.end>=t&&(o?e.length<=o.length&&(o=e):o=e,!0))),o)}function getNodePath(e,t){let o=getNodeAtOffset(e,t);const s=[];for(;o;)s.unshift(o),o=o.parent;return s}class CssSelectorStringHandler{doComplete(e,t,o,s,n,r){let i=o.ast,l=(0,type_resolve_1.getTokenAtPosition)(i,e.offsetAt(t));if(!l)return[];let a=l.getStart(),d=l.getText(),c=(0,string_1.removeQuote)(d);c.length!=d.length&&a++;let u,h=vscode_languageserver_textdocument_1.TextDocument.create("file:///select_complete.ts","css",1,c),g=o.project.fsPath;if(g){u={uri:vscode_uri_1.URI.file(g).toString(),name:""}}return new CSSCompletion(e,t,u).doCompletion(h,a)}doCompleteResolve(e,t,o,s,n){return e}doHover(e,t,o,s){}doDefinition(e,t,o,s){return[]}doReference(e,t,o,s){return[]}}exports.default=CssSelectorStringHandler;