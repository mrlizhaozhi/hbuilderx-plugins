"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.doDefinition=exports.doComplete=exports.getClassList=exports.getIDList=exports.isHTMLDocument=exports.isCSSDocument=exports.isJSDocument=void 0;const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),indexlib_1=require("../../../../indexlib");function getJSReference(e){return e.references.filter((e=>e.type===indexlib_1.ReferenceFileType.Script))}function getCSSReference(e){return e.references.filter((e=>e.type===indexlib_1.ReferenceFileType.CSS))}function getReferenceByType(e,t){return e.references.filter((e=>e.type===t))}function isJSDocument(e){return"javascript"===e.languageId||"typescript"===e.languageId}function isCSSDocument(e){return"css"===e.languageId||"stylus"===e.languageId||"scss"===e.languageId||"sass"===e.languageId}function isHTMLDocument(e){return"html"===e.languageId||"html_es6"===e.languageId||"pug"===e.languageId}function getList(e,t){let n=new Map;for(const[i,s]of e.allIndexData().entries()){let e=s[t]||null;e&&e instanceof Array&&e.forEach((e=>{n.has(e.label)?n.get(e.label).add(i):n.set(e.label,new Set([i]))}))}return n}function getIDList(e){return getList(e,indexlib_1.IndexDataCategory.ID)}function getClassList(e){return getList(e,indexlib_1.IndexDataCategory.CLASS)}function doComplete(e,t,n,i){let s=[],r=indexlib_1.IndexDataStore.load({uri:vscode_uri_1.URI.file(n.project.fsPath).toString(),name:""}),o=new Map,a=getIDList(r);if(isHTMLDocument(e)){let t=r.indexData(e.uri)[indexlib_1.IndexDataCategory.ID]||null;t&&t instanceof Array&&t.forEach((e=>{o.set(e.label,e.description||e.label)}))}else{let t=new Map;if(isJSDocument(e))for(const[e,n]of r.allIndexData().entries())(e.endsWith(".js")||e.endsWith(".ts"))&&t.set(e,n);else if(isCSSDocument(e))for(const[e,n]of r.allIndexData().entries())(e.endsWith(".css")||e.endsWith(".scss")||e.endsWith(".sass")||e.endsWith(".stylus"))&&t.set(e,n);if(t.size>0&&t.has(e.uri)){t.get(e.uri).references.forEach((e=>{for(const[t,n]of a.entries())n.has(e.uri)&&o.set(t,e.uri)}))}else for(const[e,t]of a.entries()){let n=[];t.forEach((e=>{e.endsWith(".css")||n.push(e)})),n.length>0&&o.set(e,n.join("\n"))}}for(const[e,t]of o.entries())s.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,label:e,detail:t});for(const[e,t]of a.entries())if(!o.has(e)){let n=[];t.forEach((e=>{e.endsWith(".css")||n.push(e)})),n.length>0&&s.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,label:e,detail:Array.from(t).join("\n")})}return s}function doDefinition(e,t,n,i){const s=e.uri;let r=s.startsWith("file://")?vscode_uri_1.URI.parse(s).toString():vscode_uri_1.URI.file(s).toString(),o=vscode_uri_1.URI.file(n.project.fsPath).toString(),a=indexlib_1.IndexDataStore.load({uri:o,name:""}).allIndexData(),l=new Set,c=[r],u=e.getText(n.range);for(;c.length>0;){let e=c.shift();if((e.endsWith(".html")||e.endsWith(".htm"))&&!l.has(e)){let t=a.get(e);if(t){let e=t[indexlib_1.IndexDataCategory.ID];for(let t=0;t<e.length;t++){let i=e[t];if(i.type===indexlib_1.IndexItemType.DEF&&i.label==u&&"number"==typeof i.offset){let e={start:i.position,end:vscode_languageserver_protocol_1.Position.create(i.position.line,i.position.character+u.length)};return[{targetUri:vscode_uri_1.URI.parse(s).path,targetRange:e,targetSelectionRange:e,originSelectionRange:n.range}]}}}}l.add(e),a.forEach(((t,n)=>{if(!l.has(n)){t.references.some((t=>t.uri==e))&&c.push(n)}}))}return[]}exports.isJSDocument=isJSDocument,exports.isCSSDocument=isCSSDocument,exports.isHTMLDocument=isHTMLDocument,exports.getIDList=getIDList,exports.getClassList=getClassList,exports.doComplete=doComplete,exports.doDefinition=doDefinition;