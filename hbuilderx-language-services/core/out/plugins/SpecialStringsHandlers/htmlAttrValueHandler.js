"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.doComplete=void 0;const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),ts=require("typescript/lib/tsserverlibrary"),vscode_json_languageservice_1=require("vscode-json-languageservice"),lspUtil_1=require("../../base/lspUtil"),type_resolve_1=require("../common/type-resolve"),htmlCustomDataProvider_1=require("../tool/htmlCustomDataProvider"),htmlDataUtils_1=require("../tool/htmlDataUtils"),idClassDataProvider_1=require("../tool/idClassDataProvider"),ProjectFileFilter_1=require("../tool/ProjectFileFilter"),index_1=require("./index"),valuesCache=new Map;function getDistinctAttrsValues(e){var t,r;if(valuesCache.size>0)return null!==(t=valuesCache.get(e))&&void 0!==t?t:[];let o=new Set;return[(0,htmlDataUtils_1.htmlDataProvider)(),(0,htmlCustomDataProvider_1.getCustomHTMLDataProvider)()].forEach((e=>{var t;let r=e.provideTags();for(let i of r){let r=e.provideAttributes(i.name);for(let l of r){let r=e.provideValues(i.name,l.name),a=[];r.forEach((e=>{const t=`${l.name}:${e.name}`;o.has(t)||(a.push(e),o.add(t))})),valuesCache.has(l.name)?null===(t=valuesCache.get(l.name))||void 0===t||t.push(...a):valuesCache.set(l.name,a)}}})),null!==(r=valuesCache.get(e))&&void 0!==r?r:[]}function getCompletionsForAttr(e,t){return getDistinctAttrsValues(e).map((e=>({label:e.name,kind:vscode_languageserver_protocol_1.CompletionItemKind.Unit,textEdit:t?vscode_json_languageservice_1.TextEdit.replace(t,e.name):void 0,data:{hxKind:lspUtil_1.HxIconKind.ATTRIBUTE}})))}const DQ='"'.charCodeAt(0),SQ="'".charCodeAt(0);function getFileCompletions(e,t,r,o,i){var l,a;const s=e.getText();let n=o,d=i.getStart();for(;n>d;){let e=s.charCodeAt(n-1);if(e==DQ||e==SQ)break;n--}let u={extensionFilters:[],prefixPath:s.slice(n,o),timeout:200,withAllCurrentLevelFiles:!0},c=null!==(a=null===(l=(0,ProjectFileFilter_1.getCompletionFilesSync)(t,u,e.uri))||void 0===l?void 0:l.files)&&void 0!==a?a:[],v=[];return c.forEach((e=>{v.push({label:e.relative,kind:e.isDir?vscode_languageserver_protocol_1.CompletionItemKind.Folder:vscode_languageserver_protocol_1.CompletionItemKind.File,data:{hxKind:e.isDir?lspUtil_1.HxIconKind.FOLDER:lspUtil_1.HxIconKind.FILE}})})),v}function getIdCompletions(e,t){let r=[];return(0,idClassDataProvider_1.filterIdData)(t,e,!0).forEach((e=>{r.push(...e.names.map((e=>({label:e}))))})),r}function getClassCompletions(e,t){let r=[];return(0,idClassDataProvider_1.filterClassData)(t,e,!0).forEach((e=>{r.push(...e.names.map((e=>({label:e}))))})),r}function doComplete(e,t,r,o){let i;if(r.kind===index_1.StringLocationInfoKind.IN_JS_LIKE&&(i=r.ast),!i)return[];let l=e.offsetAt(t),a=(0,type_resolve_1.getTokenAtPosition)(i,l);if(a){let t=a.parent;if(t&&t.kind==ts.SyntaxKind.CallExpression){let o=t.arguments,i=-1;for(let e=0;e<o.length;e++){let t=o[e];if(l>=t.getStart()&&l<=t.getEnd()){i=e-1;break}}if(i>=0){let t=o[i];if(t.kind==ts.SyntaxKind.StringLiteral){let o=t.getText(),i=o.charCodeAt(0);i!=DQ&&i!=SQ||(o=o.slice(1,-1));let a=r.project.fsPath,s={name:"",uri:vscode_uri_1.URI.file(a).toString()};return"src"==o?s?getFileCompletions(e,s,r.range,l,t):[]:"id"==o?s?getIdCompletions(e,s):[]:"class"==o?s?getClassCompletions(e,s):[]:getCompletionsForAttr(o,r.range)}}}}return[]}exports.doComplete=doComplete;