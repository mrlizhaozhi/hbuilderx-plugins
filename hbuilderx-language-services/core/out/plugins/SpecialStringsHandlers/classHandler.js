"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.doComplete=void 0;const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),indexlib_1=require("../../../../indexlib"),idHandler_1=require("./idHandler");function addCSSResultClasses(e,s,t){for(const[o,r]of t.entries())r.has(s)&&e.set(o,s)}function addClassResults(e,s,t,o){var r;let n=new Set;n.add(e);let i=t.get(e);null===(r=null==i?void 0:i.references)||void 0===r||r.forEach((e=>{n.add(e.uri)}));for(const[e,t]of s.entries()){let s=new Set;for(let e of n)t.has(e)&&s.add(e);o.set(e,Array.from(s).join("\n"))}}function doComplete(e,s,t,o){let r=[],n=indexlib_1.IndexDataStore.load({uri:vscode_uri_1.URI.file(t.project.fsPath).toString(),name:""}),i=(0,idHandler_1.getClassList)(n),l=new Map;for(const[e,s]of n.allIndexData().entries())(e.endsWith(".css")||e.endsWith(".scss")||e.endsWith(".sass")||e.endsWith(".stylus"))&&l.set(e,s);let d=new Map;if((0,idHandler_1.isHTMLDocument)(e))addClassResults(e.uri,i,l,d);else if((0,idHandler_1.isJSDocument)(e)){let s=new Map;for(const[e,t]of n.allIndexData().entries())(e.endsWith(".js")||e.endsWith(".ts"))&&s.set(e,t);if(s.has(e.uri)){s.get(e.uri).references.forEach((e=>{addClassResults(e.uri,i,l,d)}))}}else(0,idHandler_1.isCSSDocument)(e)&&addCSSResultClasses(d,e.uri,i);for(const[e,s]of d.entries())r.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Class,label:e,detail:s});for(const[e,s]of i.entries())d.has(e)||r.push({kind:vscode_languageserver_protocol_1.CompletionItemKind.Class,label:e,detail:Array.from(d.get(e)).join("\n")});return r}exports.doComplete=doComplete;