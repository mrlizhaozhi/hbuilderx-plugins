"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.doDefinition=exports.doComplete=void 0;const fs=require("fs"),jsonc_1=require("jsonc"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),hx=require("../../index"),type_resolve_1=require("../common/type-resolve"),project_resolve_1=require("../tool/project-resolve"),ProjectFileFilter_1=require("../tool/ProjectFileFilter"),index_1=require("./index");function getBuiltInLibs(e){return(0,project_resolve_1.isUniAppVue)(e)&&!(0,project_resolve_1.isUniAppCli)(e)?["vue","vuex","vue-router","@dcloudio/uni-app"]:[]}function doComplete(e,o,t,i){let r=[],n=(e.uri.endsWith(".vue")||e.uri.endsWith(".nvue"),i.get(index_1.LanguageServiceType.TS)),s=(0,type_resolve_1.getTokenAtPosition)(t.ast,e.offsetAt(o)),l="";s.kind===n.SyntaxKind.StringLiteral&&(l=s.text);let c=t.project.fsPath,p=(0,ProjectFileFilter_1.getCompletionFilesSync)(c,{extensionFilters:[".js",".vue"],prefixPath:l,timeout:1e3},e.uri);if(c&&(0,project_resolve_1.isUniAppVue)(c)&&!(0,project_resolve_1.isUniAppCli)(c)){let e=path.join(c,"abc.js");e=vscode_uri_1.URI.file(e).toString();let o=(0,ProjectFileFilter_1.getCompletionFilesSync)(c,{extensionFilters:[".js",".vue"],prefixPath:"",timeout:1e3},e);null==o||o.files.forEach((e=>{r.push({label:"@/"+e.relative,kind:e.isDir?vscode_languageserver_protocol_1.CompletionItemKind.Folder:vscode_languageserver_protocol_1.CompletionItemKind.File})}))}if(null==p||p.files.forEach((e=>{r.push({label:e.relative,kind:e.isDir?vscode_languageserver_protocol_1.CompletionItemKind.Folder:vscode_languageserver_protocol_1.CompletionItemKind.File})})),c){let e=c+"/package.json";if(fs.existsSync(e)){const[o,t]=jsonc_1.jsonc.safe.parse(fs.readFileSync(e).toString());if(!o)if(t.dependencies&&"object"==typeof t.dependencies)for(let e of Object.keys(t.dependencies))r.push({label:e});else if(t.devDependencies&&"object"==typeof t.devDependencies)for(let e of Object.keys(t.devDependencies))r.push({label:e})}""===l&&getBuiltInLibs(c).forEach((e=>{r.push({label:e})}))}return r}function doDefinition(e,o,t,i){let r=[],n=e.getText(t.range);if(n.startsWith("@/")){let e=t.project.fsPath,o=n.replace("@",e).replace(/\\/g,"/"),s={start:vscode_languageserver_protocol_1.Position.create(0,0),end:vscode_languageserver_protocol_1.Position.create(0,0)};r.unshift({originSelectionRange:t.range,targetUri:hx.toNormalizedUri(o,i.get(hx.LanguageServiceType.TS)),targetRange:s,targetSelectionRange:s})}return r}exports.doComplete=doComplete,exports.doDefinition=doDefinition;