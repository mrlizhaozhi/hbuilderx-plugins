"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getCompletionPathListSync=exports.getPathCompletionItem=exports.getSortText=exports.sortProcessing=exports.getFileIconType=void 0;const fs=require("fs"),path=require("path"),vscode_json_languageservice_1=require("vscode-json-languageservice"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),converts_1=require("../../../base/converts"),lspUtil_1=require("../../../base/lspUtil"),project_1=require("../../../base/project"),index_1=require("../index"),URIType_1=require("./URIType"),imageSize=require("image-size");function getFileIconType(e){let t=lspUtil_1.HxIconKind.FILE;return(0,converts_1.includesList)(e,URIType_1.ImageURIString)?t=lspUtil_1.HxIconKind.IMAGE:(0,converts_1.includesList)(e,[".css",".scss",".less"])?t=lspUtil_1.HxIconKind.CSS:(0,converts_1.includesList)(e,[".js"])?t=lspUtil_1.HxIconKind.JS:(0,converts_1.includesList)(e,[".html"])&&(t=lspUtil_1.HxIconKind.HTML),t}function getSortText(e,t,r){let i="z",o="z",s="z",n="z",a="z";t||(i="b"),r&&(i="a"),e.startsWith("@")&&(o="a");let l=48;e.includes("/")&&(l=48+e.match(/\//gim).length),s=String.fromCharCode(l);let c=48+e.length;return n=String.fromCharCode(c),(e.endsWith(".scss")||e.endsWith(".less"))&&(a="a"),i+o+s+n+a+"_"+e}function sortProcessing(e,t){for(const r of e){if(!r.documentation)return e;if("external module name"!==r.documentation)return e;r.textEdit=vscode_json_languageservice_1.TextEdit.replace(t,r.label),r.sortText=getSortText(r.label,!0,!0)}return e}function getPathCompletionItem(e,t,r,i,o,s){if(!e)return[];let n=[];for(const a of e.pathList){if(e.referencePath&&(a.relativePath=`${e.referencePath}/`+a.relativePath),""===a.relativePath.replace(/..\//g,""))continue;if((t.uri.startsWith("file://")?vscode_uri_1.URI.parse(t.uri).fsPath:t.uri).toLowerCase().replace(/\\/g,"/").startsWith(a.absolutePath.toLowerCase().replace(/\\/g,"/")))continue;let l,c,h=lspUtil_1.HxIconKind.FOLDER;if(a.isDir)l=lspUtil_1.retriggerCommand;else{h=getFileIconType(path.extname(a.absolutePath))}if(c={kind:vscode_languageserver_protocol_1.MarkupKind.Markdown,value:a.absolutePath.replace(/\\/g,"/")},h===lspUtil_1.HxIconKind.IMAGE){let e={width:230,height:180},t=a.absolutePath,r=imageSize(t),i="";if(".svg"!=t.slice(-4).toLocaleLowerCase()){let t=Math.min(e.width/r.width,e.height/r.height);t=Math.min(t,1),t<1&&(i=r.width>r.height?`width="${r.width*t}"`:`height="${r.height*t}"`)}c={kind:vscode_languageserver_protocol_1.MarkupKind.Markdown,value:`<div align='center'><br/><img ${i} src="${t}"/></div>`}}let d=getSortText(a.relativePath,a.isDir),p=a.relativePath;if(o&&(p=a.relativePath.slice(e.referencePath.length+1)),n.push({label:p,documentation:c,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,sortText:d,textEdit:vscode_json_languageservice_1.TextEdit.replace(r,p),command:l,data:{hxKind:h}}),i.project.kind===project_1.HXProjectKind.UniApp&&!a.isDir&&!o&&s&&i.kind!==index_1.StringLocationInfoKind.IN_JSON_LIKE){let e=path.resolve(i.project.fsPath).toLowerCase().replace(/\\/g,"/"),t=a.absolutePath.replace(/\\/g,"/").substring(e.length);t="@"+t;let o=getSortText(t,a.isDir);n.push({label:t,documentation:c,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,sortText:o,textEdit:vscode_json_languageservice_1.TextEdit.replace(r,t),command:l,data:{hxKind:h}})}}return n}function getCompletionPathListSync(e,t,r,i){var o,s,n,a,l;const c=t;if(!fs.existsSync(c))return;const h=i.startsWith("file://")?vscode_uri_1.URI.parse(i).fsPath:i;let d=r.extSuffixFilterList,p=null!==(o=r.extFoldersFilterList)&&void 0!==o?o:[];r.disabledDefaultFoldersFilterList||(p=[...new Set(URIType_1.filterDirs.concat(...p))]);let g=null!==(s=r.prefixPath)&&void 0!==s?s:"";const u=null!==(n=r.fileMax)&&void 0!==n?n:-1,f=null!==(a=r.timeOut)&&void 0!==a?a:1e3;let _=null!==(l=r.ignoredFiles)&&void 0!==l?l:[],x=!!r.enableShowFolders;0===r.extSuffixFilterList.length&&(x=!0);let v=!!r.onlyFolders,m=!!r.onlyCurrentLevel,P=!!r.enableAllPath;const S={isMaximumExceeded:!1,isTimeOut:!1,referencePath:"",pathList:[]};let I="",L="",C=!1,T=!1;if(g){const t=g.lastIndexOf("/"),r=t>=0?g.slice(0,t):"",i=path.dirname(h);g.startsWith("/")&&!g.startsWith("//")?(I=path.resolve(e,r.slice(1)),S.referencePath=r,C=!0):g.startsWith("@")?(I=e,S.referencePath=r,T=!0):"."===g||"./"===g||"."===r||r.startsWith("./")?(I=path.dirname(h),S.referencePath=r.length>0?r:"."):".."===g||"../"===g?(I=path.resolve(i,"../"),S.referencePath=".."):(I=path.resolve(i,r),S.referencePath=r);let o=e.toLowerCase().replace(/\\/g,"/"),s=I.toLowerCase().replace(/\\/g,"/");if(s!==o&&!s.startsWith(o))return;if(!fs.existsSync(I))return;L=T?path.dirname(h):I}else I=c,L=path.dirname(h);const b=e=>{const t=C?"/":"",r=[],i=process.uptime();let o=[I];for(;o.length>0&&(u<0||r.length<u);){let s=o.shift();fs.readdirSync(s,{withFileTypes:!0}).forEach((i=>{const n=i.name.toLowerCase(),a=path.join(s,i.name);if(i.isFile()&&!v){let e=P||0===d.length;if(e||(e=d.some((e=>n.endsWith(e)))),e){let e=path.relative(L,a).replace(/\\/g,"/"),i=path.basename(a);a===h||_.includes(i)||r.push({absolutePath:a,relativePath:t+e,isDir:!1})}}else if(i.isDirectory()&&!URIType_1.filterDirs.includes(i.name.toLocaleLowerCase())&&(m&&e||o.push(a),x)){let e=path.relative(L,a).replace(/\\/g,"/");e&&r.push({absolutePath:a,relativePath:t+e+"/",isDir:!0})}})),x=!1,P=!1;const n=process.uptime();if(f>0&&1e3*(n-i)>f){S.isTimeOut=!0;break}}return r.length===u&&(S.isMaximumExceeded=!0),S.pathList=r,S};let y=b(!1);return y.isMaximumExceeded||y.isTimeOut?b(!0):y}exports.getFileIconType=getFileIconType,exports.getSortText=getSortText,exports.sortProcessing=sortProcessing,exports.getPathCompletionItem=getPathCompletionItem,exports.getCompletionPathListSync=getCompletionPathListSync;class URIHandler{constructor(e,t){this.exts=e,this.enableShowFolders=t,this._exts=e,this._enableShowFolders=t}doComplete(e,t,r,i,o,s){let n=r.project.fsPath,a=r.project.sourceRoot,l=(0,lspUtil_1.getContextData)(e,e.offsetAt(t),"'\"");if(s&&(o=sortProcessing(o,l.contextRange)),r.project.kind!==project_1.HXProjectKind.UniApp&&l.context.startsWith("@"))return o;let c={extSuffixFilterList:this._exts,prefixPath:l.leftText,enableShowFolders:this._enableShowFolders},h=l.contextRange,d=!1;if(this._enableShowFolders){let r=e.offsetAt(t)-e.offsetAt(l.leftRange.start),i=(0,lspUtil_1.getFragmentString)(l.context,r,"\\/"),o=(0,lspUtil_1.getContextData)(e,e.offsetAt(t),"\\/");i===o.context&&(c.onlyFolders=!0,c.onlyCurrentLevel=!0,h=o.contextRange,h.end.character+=1,d=!0)}let p=getPathCompletionItem(getCompletionPathListSync(n,a,c,e.uri),e,h,r,d,l.context.startsWith("@"));return o.push(...p),o}doCompleteResolve(e,t,r,i,o){return e}doHover(e,t,r,i){}doDefinition(e,t,r,i){let o=e.getText(r.range);if(!o.startsWith("@"))return[];let s=[],n=vscode_languageserver_protocol_1.Range.create(vscode_languageserver_protocol_1.Position.create(0,0),vscode_languageserver_protocol_1.Position.create(0,0));return s.push({targetUri:o.replace("@",r.project.fsPath),targetRange:n,targetSelectionRange:n,originSelectionRange:r.range}),s}doReference(e,t,r,i){return[]}}exports.default=URIHandler;