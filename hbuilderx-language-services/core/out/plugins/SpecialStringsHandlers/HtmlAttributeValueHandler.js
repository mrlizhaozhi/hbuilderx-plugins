"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),ts=require("typescript/lib/tsserverlibrary"),vscode_json_languageservice_1=require("vscode-json-languageservice"),lspUtil_1=require("../../base/lspUtil"),type_resolve_1=require("../common/type-resolve"),htmlCustomDataProvider_1=require("../tool/htmlCustomDataProvider"),htmlDataUtils_1=require("../tool/htmlDataUtils"),idClassDataProvider_1=require("../tool/idClassDataProvider"),ProjectFileFilter_1=require("../tool/ProjectFileFilter"),index_1=require("./index"),valuesCache=new Map;function getDistinctAttrsValues(e){var t,r;if(valuesCache.size>0)return null!==(t=valuesCache.get(e))&&void 0!==t?t:[];let l=new Set;return[(0,htmlDataUtils_1.htmlDataProvider)(),(0,htmlCustomDataProvider_1.getCustomHTMLDataProvider)()].forEach((e=>{var t;let r=e.provideTags();for(let i of r){let r=e.provideAttributes(i.name);for(let o of r){let r=e.provideValues(i.name,o.name),a=[];r.forEach((e=>{const t=`${o.name}:${e.name}`;l.has(t)||(a.push(e),l.add(t))})),valuesCache.has(o.name)?null===(t=valuesCache.get(o.name))||void 0===t||t.push(...a):valuesCache.set(o.name,a)}}})),null!==(r=valuesCache.get(e))&&void 0!==r?r:[]}function getCompletionsForAttr(e,t){return getDistinctAttrsValues(e).map((e=>({label:e.name,kind:vscode_languageserver_protocol_1.CompletionItemKind.Unit,textEdit:t?vscode_json_languageservice_1.TextEdit.replace(t,e.name):void 0,data:{hxKind:lspUtil_1.HxIconKind.ATTRIBUTE}})))}const DQ='"'.charCodeAt(0),SQ="'".charCodeAt(0);function getFileCompletions(e,t,r,l,i){var o,a;const s=e.getText();let n=l,d=i.getStart();for(;n>d;){let e=s.charCodeAt(n-1);if(e==DQ||e==SQ)break;n--}let u={extensionFilters:[],prefixPath:s.slice(n,l),timeout:200,withAllCurrentLevelFiles:!0},c=null!==(a=null===(o=(0,ProjectFileFilter_1.getCompletionFilesSync)(t,u,e.uri))||void 0===o?void 0:o.files)&&void 0!==a?a:[],v=[];return c.forEach((e=>{v.push({label:e.relative,kind:e.isDir?vscode_languageserver_protocol_1.CompletionItemKind.Folder:vscode_languageserver_protocol_1.CompletionItemKind.File,data:{hxKind:e.isDir?lspUtil_1.HxIconKind.FOLDER:lspUtil_1.HxIconKind.FILE}})})),v}function getIdCompletions(e,t){let r=[];return(0,idClassDataProvider_1.filterIdData)(t,e,!0).forEach((e=>{r.push(...e.names.map((e=>({label:e}))))})),r}function getClassCompletions(e,t){let r=[];return(0,idClassDataProvider_1.filterClassData)(t,e,!0).forEach((e=>{r.push(...e.names.map((e=>({label:e}))))})),r}class HtmlAttributeValueHandler{doComplete(e,t,r,l,i,o){let a;if(r.kind===index_1.StringLocationInfoKind.IN_JS_LIKE&&(a=r.ast),!a)return[];let s=e.offsetAt(t),n=(0,type_resolve_1.getTokenAtPosition)(a,s);if(n){let t=n.parent;if(t&&t.kind==ts.SyntaxKind.CallExpression){let l=t.arguments,i=-1;for(let e=0;e<l.length;e++){let t=l[e];if(s>=t.getStart()&&s<=t.getEnd()){i=e-1;break}}if(i>=0){let t=l[i];if(t.kind==ts.SyntaxKind.StringLiteral){let l=t.getText(),i=l.charCodeAt(0);i!=DQ&&i!=SQ||(l=l.slice(1,-1));let o=r.project.fsPath,a={name:"",uri:vscode_uri_1.URI.file(o).toString()};return"src"==l?a?getFileCompletions(e,a,r.range,s,t):[]:"id"==l?a?getIdCompletions(e,a):[]:"class"==l?a?getClassCompletions(e,a):[]:getCompletionsForAttr(l,r.range)}}}}return[]}doCompleteResolve(e,t,r,l,i){return e}doHover(e,t,r,l){}doDefinition(e,t,r,l){return[]}doReference(e,t,r,l){return[]}}exports.default=HtmlAttributeValueHandler;