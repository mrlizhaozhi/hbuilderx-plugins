"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TsServerSpecialStringsPlugin=void 0;const vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),converts_1=require("../base/converts"),handler=require("./SpecialStringsHandlers"),ParseUtil_1=require("./tool/ParseUtil");function getTextRange(e,t){let n=e.positionAt(t.getStart()),i=e.positionAt(t.getEnd());return n.character+=1,i.character-=1,{start:n,end:i}}function getInitializationData(e,t,n,i){const r=t.getProgram().getSourceFile(n);if(!r)return;const o=e.ts.getTokenAtPosition(r,i);if(!e.ts.isStringLiteralLike(o))return;let s=ParseUtil_1.ParseUtil.getTypesAtLocation(o,t,n),a=[];for(let e of s){let t=e.includes("HBuilderX.")?e.trim():`HBuilderX.${e.trim()}`;handler.hasType(t)&&a.push(t)}if(0===a.length)return;let c=vscode_uri_1.URI.file(n).toString(),l=n.endsWith(".ts")||n.endsWith(".tsx")?"typescript":"javascript",u=vscode_languageserver_textdocument_1.TextDocument.create(c,l,1,r.text),g=u.positionAt(i);return{types:a,textDocument:u,pos:g,loc:{range:getTextRange(u,o),kind:handler.StringLocationInfoKind.IN_JS_LIKE,ast:r,project:e.project}}}function tsCompleteConversion(e){let t=[];return e.forEach((e=>{t.push({label:e.name,documentation:e.kind})})),t}function create(e){const t=e.languageService,n=Object.create(null);for(let e of Object.keys(t)){const i=t[e];n[e]=(...e)=>i.apply(t,e)}if(!e.ts.__overrideCreateLanguageServiceFn){e.ts.__overrideCreateLanguageServiceFn=!0;let t=e.ts.createLanguageService.bind(e.ts);e.ts.createLanguageService2=function(e,n,i,r){return create({...e,languageService:t(n,i,r)})}}let i=new Map;i.set(handler.LanguageServiceType.TS,e.ts),i.set(handler.LanguageServiceType.TYPESCRIPT_LANGUAGE_SERVICE,n);let r=handler.StringServicesContainer.create(i);return n.getCompletionsAtPosition=function(n,i,o){let s=t.getCompletionsAtPosition(n,i,o),a=getInitializationData(e,t,n,i);if(!a)return s;const c=a.types,l=a.textDocument,u=a.pos,g=a.loc,d=tsCompleteConversion(s.entries);let p=handler.doComplete(c,l,u,g,r,d,!0),f=[],v=[];return p.items.forEach((e=>{f.includes(e.label)||(f.push(e.label),v.push(e))})),p.items=v,(0,converts_1.fromLspCompletions)(p,l,e.ts)},n.getDefinitionAndBoundSpan=function(n,i){let o=t.getDefinitionAndBoundSpan(n,i),s=getInitializationData(e,t,n,i);if(!s)return o;const a=s.types,c=s.textDocument,l=s.pos,u=s.loc;let g={textSpan:void 0,definitions:[]};o&&(g.textSpan=o.textSpan,o.definitions.forEach((e=>{g.definitions.push(e)})));let d=handler.doDefinition(a,c,l,u,r);if(d.length>0){let t=!1;a.includes("HBuilderX.IDString")&&n.endsWith("html")&&(t=!0);let i=(0,converts_1.fromLspDefinition)(d,c,e,void 0,t);i&&(g.textSpan=i.textSpan,g.definitions.push(...i.definitions))}return 0!==g.definitions.length?g:void 0},n.getQuickInfoAtPosition=function(n,i){let o=getInitializationData(e,t,n,i);if(!o)return t.getQuickInfoAtPosition(n,i);const s=o.types,a=o.textDocument,c=o.pos,l=o.loc;let u=handler.doHover(s,a,c,l,r);return(0,converts_1.fromLspHover)(u,a,e.ts)},n}exports.TsServerSpecialStringsPlugin={create:create};