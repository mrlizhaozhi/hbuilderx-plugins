"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createLanguageServiceHost=exports.getDefaultLibs=exports.getNodeLibs=void 0;const project_1=require("./project"),util=require("./util"),fs=require("fs"),path=require("path"),vscode_uri_1=require("vscode-uri");function getNodeLibs(e,t){let i=[],s=path.join(e,"builtin-dts","node_modules","node");return fs.readdirSync(s).forEach((e=>{let o=!0;t.forEach((t=>{e.includes(t)&&(o=!1)})),o&&e.endsWith(".d.ts")&&i.push(path.join(s,e))})),i}function getDefaultLibs(e){let t=[],i=util.getExtensionRootPath();if(e.kind==project_1.HXProjectKind.UniApp)t.push(path.join(i,"builtin-dts","node_modules","vue","types","index.d.ts")),t.push(path.join(i,"builtin-dts","node_modules","vue@3","dist","vue.d.ts")),t.push(path.join(i,"builtin-dts","node_modules","vuex","types","index.d.ts")),t.push(path.join(i,"builtin-dts","node_modules","vue-router","types","index.d.ts")),t.push(path.join(i,"builtin-dts","node_modules","vue-i18n","types","index.d.ts")),t.push(path.join(i,"builtin-dts","node_modules","@dcloudio","types","index.d.ts")),t.push(path.join(i,"builtin-dts","node_modules","@dcloudio","uni-app","dist","uni-app.d.ts")),t.push(path.join(i,"frameworkdts","wechat-miniprogram","index.d.ts"));else if(e.kind==project_1.HXProjectKind.App||e.kind==project_1.HXProjectKind.Wap2App)t.push(path.join(i,"builtin-dts","node_modules","@dcloudio","types","html5plus","plus.d.ts")),t.push(path.join(i,"builtin-dts","node_modules","jQuery","jquery.d.ts"));else if(e.kind==project_1.HXProjectKind.UniApp_Cli){let s=path.join(e.fsPath,"node_modules/@dcloudio/types/index.d.ts");fs.existsSync(s)&&t.push(s),t.push(path.join(i,"frameworkdts","wechat-miniprogram","index.d.ts"))}else e.kind==project_1.HXProjectKind.Web?t.push(path.join(i,"builtin-dts","node_modules","jQuery","jquery.d.ts")):e.kind==project_1.HXProjectKind.Extension?(t.push(path.join(i,"builtin-dts","common","extension_js.d.ts")),t.push(...getNodeLibs(i,["globals.d.ts","index.d.ts"]))):e.kind===project_1.HXProjectKind.WxApp&&t.push(path.join(i,"frameworkdts","wechat-miniprogram","index.d.ts"));return t.push(path.join(i,"builtin-dts","node_modules","node","globals.d.ts")),t.push(path.join(i,"builtin-dts","common","lib.dom2.d.ts")),t}function createLanguageServiceHost(e,t,i){const{ts:s,tsinfo:{languageServiceHost:o}}=i,n=getDefaultLibs(t),r=e.compilerOptions;let d=path.dirname(s.getDefaultLibFilePath(r));return{getCompilationSettings:()=>o?{...o.getCompilationSettings(),...e.compilerOptions}:e.compilerOptions,getScriptFileNames(){let i=[].concat(e.getDefaultLibs?e.getDefaultLibs(t):n);for(let t of e.documents)i.push(t);return i},getScriptKind(t){const i=util.toNormalizedUri(t,s);return e.getDocumentKind?e.getDocumentKind(i):"ts"===t.substr(t.length-2)?s.ScriptKind.TS:s.ScriptKind.JS},getProjectVersion:()=>String(e.version),getScriptVersion(t){const i=util.toNormalizedUri(t,s);return e.hasDocument(i)?e.getDocumentVersion(i):"1"},getScriptSnapshot(t){const i=util.toNormalizedUri(t,s);if(e.hasDocument(i))return e.getDocumentSnapshot(i);let o="",n=vscode_uri_1.URI.parse(i).fsPath;return fs.existsSync(n)&&(o=fs.readFileSync(n).toString()),{getText:(e,t)=>o.substring(e,t),getLength:()=>o.length,getChangeRange:()=>{}}},getCurrentDirectory:()=>t.fsPath,getDefaultLibFileName:e=>e.lib&&e.lib.length>0?path.join(d,e.lib[0]):path.join(d,"lib.esnext.d.ts"),resolveModuleNames(i,o,n,d,u){const p=[];for(let n of i){let i,d={fileExists(t){const i=util.toNormalizedUri(t,s),o=vscode_uri_1.URI.parse(i);return!!e.hasDocument(i)||fs.existsSync(o.fsPath)},readFile(t){const i=util.toNormalizedUri(t,s);if(e.hasDocument(i)){let t=e.getDocumentSnapshot(i);return t.getText(0,t.getLength()-1)}const o=vscode_uri_1.URI.parse(i);return fs.readFileSync(o.fsPath).toString()}};i=e.resolveModuleNameOverride?e.resolveModuleNameOverride(t,n,o,r,d):(0,project_1.resolveModuleName)(s,t,n,o,r,d),p.push(i)}return p}}}exports.getNodeLibs=getNodeLibs,exports.getDefaultLibs=getDefaultLibs,exports.createLanguageServiceHost=createLanguageServiceHost;