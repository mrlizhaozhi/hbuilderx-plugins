"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.fromLspNavigation=exports.fromLspHover=exports.fromLspDefinition=exports.fromLspCompletions=exports.fromLspCompletionDetail=exports.getDeduplicationData=exports.includesList=void 0;const fs=require("fs"),tsserverlibrary_1=require("typescript/lib/tsserverlibrary"),vscode_languageserver_1=require("vscode-languageserver"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri");function includesList(t,e,n){n||(n=!1);for(const i of e)if(t===i)return!n;return n}function getDeduplicationData(t){let e=[];for(var n=t.items.length-1;n>=0;--n)e.includes(t.items[n].label)?t.items.splice(n,1):e.push(t.items[n].label);return t}function fromLspCompletions(t,e,n){let i,r=[];return t.items.forEach((t=>{var n,i,o;let a,s=t.label,l=null!==(n=t.sortText)&&void 0!==n?n:t.label,d=null!==(i=t.insertText)&&void 0!==i?i:t.label,f=t.insertTextFormat===vscode_languageserver_1.InsertTextFormat.Snippet||void 0,c=t.textEdit;c&&(d=c.newText,a={start:e.offsetAt(c.range.start),length:e.offsetAt(c.range.end)-e.offsetAt(c.range.start)});let m=!!t.command||void 0,u={data:t.data?t.data:{},command:t.command,detail:null!==(o=t.detail)&&void 0!==o?o:t.label,documentation:t.documentation},p=JSON.stringify(u),g="lsp://"+e.uri+"?"+encodeURIComponent(p);r.push({name:s,kind:t.kind,kindModifiers:void 0,sortText:l,insertText:d,isSnippet:f,replacementSpan:a,hasAction:m,source:g})})),!0===t.isIncomplete&&(i=!0),{entries:r,isGlobalCompletion:!1,isNewIdentifierLocation:!1,isMemberCompletion:!1,isIncomplete:i}}function fromLspCompletionDetail(t,e,n){var i;let r;if(!t)return r;let o=t.label,a=[{text:null!==(i=t.detail)&&void 0!==i?i:t.label,kind:"text"}],s=[];return t.documentation&&t.documentation.value?s.push({kind:t.documentation.kind,text:t.documentation.value}):t.documentation&&"string"==typeof t.documentation&&(s=[{text:t.documentation,kind:"text"}]),r={name:o,kind:t.kind,kindModifiers:"",displayParts:a,documentation:s},r}function fromLspDefinition(t,e,n,i,r){let o,a=[];if(!t)return o;if(t.length<1)return o;if(!t[0].originSelectionRange)return o;let s=e.offsetAt(t[0].originSelectionRange.end)-e.offsetAt(t[0].originSelectionRange.start),l={start:e.offsetAt(t[0].originSelectionRange.start),length:s},d={start:0,length:0};return t.forEach((t=>{if(!t.targetUri)return;let o="";if(o=t.targetUri.startsWith("file://")?vscode_uri_1.URI.parse(t.targetUri).fsPath:vscode_uri_1.URI.file(t.targetUri).fsPath,i&&i.isEmbedFile(t.targetUri))d=i.getTextSpan(t.targetUri,t.targetRange);else{let e=n.tsinfo.project.getScriptInfo(o);if(e){try{d.start=e.lineOffsetToPosition(t.targetRange.start.line+1,t.targetRange.start.character+1)}catch(t){}d.length=t.targetRange.end.character-t.targetRange.start.character}else{if(!fs.existsSync(o)||fs.statSync(o).isDirectory())return;try{let e=fs.readFileSync(o).toString(),n=vscode_languageserver_textdocument_1.TextDocument.create(o,"any",0,e);d.start=n.offsetAt(t.targetRange.start),d.length=n.offsetAt(t.targetRange.end)-n.offsetAt(t.targetRange.start)}catch(t){}}}a.push({kind:tsserverlibrary_1.ScriptElementKind.unknown,name:e.getText(t.targetSelectionRange),containerKind:tsserverlibrary_1.ScriptElementKind.unknown,containerName:"",textSpan:d,fileName:o,unverified:r})})),o={definitions:a,textSpan:l},o}function fromLspHover(t,e,n){let i;if(null==t)return i;let r="";if(Array.isArray(t.contents)?t.contents.forEach((t=>{"string"==typeof t?r+=t:t.language||t.kind&&(r+=t.value)})):t.contents.kind||t.contents.language?r=t.contents.value:"string"==typeof t.contents&&(r=t.contents),!t.range)return i;let o=e.offsetAt(t.range.end)-e.offsetAt(t.range.start),a={start:e.offsetAt(t.range.start),length:o};return i={kind:tsserverlibrary_1.ScriptElementKind.unknown,kindModifiers:"",textSpan:a,documentation:[{text:r,kind:""}]},i}function symbolInformationToNavigationTree(t,e,n){let i=[],r=e.offsetAt(t.location.range.start),o=e.offsetAt(t.location.range.end),a=t.name.length;if(n){let e=t.name.indexOf("."),n=t.name.indexOf("#");-1!==e?a=-1!==n?e<n?e:n:e:-1!==n&&(a=n)}let s={start:r,length:a},l={start:r,length:o-r};return i.push(l),{text:t.name,kind:t.kind,kindModifiers:"lsp",spans:i,nameSpan:s,childItems:[]}}function addChild(t,e,n,i){n.forEach((n=>{n.childItems||(n.childItems=[]),t.containerName===n.text?n.childItems.push(symbolInformationToNavigationTree(t,e,i)):n.childItems&&addChild(t,e,n.childItems,i)}))}function fromLspNavigation(t,e,n,i){let r=[];if(!(t.length<1))return t.forEach((t=>{t.containerName?addChild(t,e,r,i):r.push(symbolInformationToNavigationTree(t,e,i))})),{text:e.uri,kind:tsserverlibrary_1.ScriptElementKind.alias,kindModifiers:"",spans:[],nameSpan:void 0,childItems:r}}exports.includesList=includesList,exports.getDeduplicationData=getDeduplicationData,exports.fromLspCompletions=fromLspCompletions,exports.fromLspCompletionDetail=fromLspCompletionDetail,exports.fromLspDefinition=fromLspDefinition,exports.fromLspHover=fromLspHover,exports.fromLspNavigation=fromLspNavigation;