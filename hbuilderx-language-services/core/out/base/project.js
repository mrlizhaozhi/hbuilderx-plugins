"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getProjectByPath=exports.createProject=exports.getBuiltinUniappModule=exports.resolveModuleName=exports.HXProject=exports.HXProjectKind=void 0;const fs=require("fs"),path=require("path"),vscode_uri_1=require("vscode-uri"),util=require("./util"),vueVersion_1=require("./vueVersion");var HXProjectKind;!function(e){e[e.UniApp=0]="UniApp",e[e.UniApp_Cli=1]="UniApp_Cli",e[e.Web=2]="Web",e[e.App=3]="App",e[e.Wap2App=4]="Wap2App",e[e.Extension=5]="Extension",e[e.WxApp=6]="WxApp",e[e.Unkown=7]="Unkown"}(HXProjectKind=exports.HXProjectKind||(exports.HXProjectKind={}));class HXProject{constructor(e,t){this._kind=HXProjectKind.Unkown,this.globalDocumentRegistry=t,this._fsPath=e.getCurrentDirectory(),this._tsProject=e}get documentRegistry(){return this.globalDocumentRegistry}get name(){return path.basename(this._fsPath)}get kind(){return this._kind!=HXProjectKind.Unkown?this._kind:this._kind=detectProjectKind(this._fsPath)}get fsPath(){return this._fsPath}get sourceRoot(){return this._sourceRoot&&this._sourceRoot.length>0||(this._sourceRoot=this._fsPath,this.kind==HXProjectKind.UniApp_Cli&&(this._sourceRoot=path.join(this._fsPath,"src"))),this._sourceRoot}isProjectOf(e,t){const i=util.toNormalizedUri(e,t);let o=vscode_uri_1.URI.parse(i).fsPath,s=path.relative(this.fsPath.toLowerCase(),o.toLowerCase());return!s.startsWith("..")&&!path.isAbsolute(s)}}function detectProjectKind(e){let t=[{kind:HXProjectKind.UniApp_Cli,existsFiles:[["src/manifest.json"],["src/pages.json"],["src/App.vue","src/App.nvue"],["src/main.js","src/main.ts"]]},{kind:HXProjectKind.UniApp,existsFiles:[["manifest.json"],["pages.json"],["App.vue","App.nvue"],["main.js","main.ts"]]},{kind:HXProjectKind.Wap2App,existsFiles:[["manifest.json"],["sitemap.json"]]},{kind:HXProjectKind.App,existsFiles:[["manifest.json"]]},{kind:HXProjectKind.WxApp,existsFiles:[["project.config.json"],["app.json"]]},{kind:HXProjectKind.Extension,existsFiles:function(e){var t;if(fs.existsSync(path.join(e,"package.json"))){let i=require(path.join(e,"package.json"));if((null===(t=null==i?void 0:i.engines)||void 0===t?void 0:t.HBuilderX)&&(null==i?void 0:i.main)&&(null==i?void 0:i.contributes))return!0}return!1}}];for(let i of t){let t=i.kind,o=i.existsFiles,s=!0;if("function"==typeof o)s=o(e);else for(let t of o){let i=!1;for(let o of t)if(fs.existsSync(path.join(e,o))){i=!0;break}if(s=s&&i,!s)break}if(s)return t}return HXProjectKind.Web}function resolveModuleName(e,t,i,o,s,n,r,p,u){let d,l=HXProjectKind.Web;t&&(l=t.kind),l!=HXProjectKind.UniApp&&l!=HXProjectKind.UniApp_Cli||i.startsWith("@/")&&(i=path.join(t.sourceRoot,i.substring(2)));let c=e.resolveModuleName(i,o,s,n);if(c.resolvedModule)d=c.resolvedModule;else{let t=e.nodeModuleNameResolver(i,o,s,n);t.resolvedModule&&(d=t.resolvedModule)}if(!d&&l===HXProjectKind.UniApp){let o=getBuiltinUniappModule(i,t);if(o)d={isExternalLibraryImport:!0,resolvedFileName:o};else{let t=path.join(util.getExtensionRootPath(),"builtin-dts","index.js"),o=e.nodeModuleNameResolver(i,t,s,n);o.resolvedModule&&(d=o.resolvedModule)}}return d}function getBuiltinUniappModule(e,t){let i=util.getExtensionRootPath();return{vuex:2===(0,vueVersion_1.vueVersion)(t)?path.join(i,"builtin-dts","node_modules","vuex","types","index.d.ts"):path.join(i,"builtin-dts","node_modules","vuex@4","types","index.d.ts"),"vue-router":path.join(i,"builtin-dts","node_modules","vue-router","types","index.d.ts"),vue:path.join(i,"builtin-dts","common","vue2And3.d.ts"),"@dcloudio/uni-app":path.join(i,"builtin-dts","node_modules","@dcloudio","uni-app","dist","uni-app.d.ts")}[e]}exports.HXProject=HXProject,exports.resolveModuleName=resolveModuleName,exports.getBuiltinUniappModule=getBuiltinUniappModule;const g_project_caches=new Map;function createProject(e,t){let i=new HXProject(e,t);return g_project_caches.set(i.fsPath,i),i}function getProjectByPath(e){if(g_project_caches.has(e))return g_project_caches.get(e)}exports.createProject=createProject,exports.getProjectByPath=getProjectByPath;