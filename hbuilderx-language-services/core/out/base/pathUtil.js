"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getPathCompletionItem=exports.getCompletionPathListSync=exports.fontSuffix=exports.imageSuffix=exports.getSuffixList=exports.tagTrackSuffix=exports.tagVideoSuffix=exports.tagAudioSuffix=exports.tagImgSuffix=void 0;const fs=require("fs"),path=require("path"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),converts_1=require("./converts"),lspUtil_1=require("./lspUtil"),imageSize=require("image-size"),APNG={name:"APNG",suffix:[".apng"],mime:["image/apng"]},AVIF={name:"AVIF",suffix:[".avif"],mime:["image/avif"]},GIF={name:"GIF",suffix:[".gif"],mime:["image/gif"]},JPEG={name:"JPEG",suffix:[".jpg",".jpeg",".jfif",".pjpeg",".pjp","jpe"],mime:["image/jpeg"]},PNG={name:"PNG",suffix:[".png"],mime:["image/png"]},SVG={name:"SVG",suffix:[".svg"],mime:["image/svg+xml"]},WebP={name:"WebP",suffix:[".webp"],mime:["image/webp"]},BMP={name:"BMP",suffix:[".bmp"],mime:["image/bmp"]},ICO={name:"ICO",suffix:[".ico",".cur"],mime:["image/vnd.microsoft.icon","image/x-icon"]},TIFF={name:"TIFF",suffix:[".tif",".tiff"],mime:["image/tiff"]},XBM={name:"XBM",suffix:[".xbm"],mime:["image/xbm","image-xbitmap"]},Audio_3GP={name:"3GP",suffix:[".3gp"],mime:["audio/3gpp","audio/3gpp2","audio/3gp2"]},Audio_ADTS={name:"ADTS",suffix:[".aac"],mime:["audio/aac"]},Audio_FLAC={name:"FLAC",suffix:[".flac"],mime:["audio/flac","audio/x-flac"]},Audio_MPEG={name:"MPEG",suffix:[".mpg",".mpeg"],mime:["audio/mpeg"]},Audio_MP3={name:"MP3",suffix:[".mp3"],mime:["audio/mp3"]},Audio_MP4={name:"MP4",suffix:[".mp4",".m4a"],mime:["audio/mp4"]},Audio_Ogg={name:"Ogg",suffix:[".oga",".ogg"],mime:["audio/ogg"]},Audio_WAV={name:"WAV",suffix:[".wav"],mime:["audio/wave","audio/wav","audio/x-wav","audio/x-pn-wav"]},Audio_WebM={name:"WebM",suffix:[".webm"],mime:["audio/webm"]},Video_3GP={name:"3GP",suffix:[".3gp"],mime:["video/3gpp","video/3gpp2","video/3gp2"]},Video_MPEG={name:"MPEG",suffix:[".mpg",".mpeg"],mime:["video/mpeg"]},Video_MP4={name:"MP4",suffix:[".mp4",".m4v","m4p"],mime:["video/mp4"]},Video_Ogg={name:"Ogg",suffix:[".ogv",".ogg"],mime:["video/ogg"]},Video_QuickTime={name:"QuickTime",suffix:[".mov"],mime:["video/quicktime"]},Video_WebM={name:"WebM",suffix:[".webm"],mime:["video/webm"]},WebVTT={name:"WebVTT",suffix:[".vtt"],mime:["text/vtt"]},TTML={name:"TTML",suffix:[".ttml"]},tagImgSuffix=[].concat(APNG,AVIF,GIF,JPEG,PNG,SVG,WebP,BMP,ICO,TIFF);exports.tagImgSuffix=tagImgSuffix;const tagAudioSuffix=[].concat(Audio_3GP,Audio_ADTS,Audio_FLAC,Audio_MPEG,Audio_MP3,Audio_MP4,Audio_Ogg,Audio_WAV,Audio_WebM);exports.tagAudioSuffix=tagAudioSuffix;const tagVideoSuffix=[].concat(Video_3GP,Video_MPEG,Video_MP4,Video_Ogg,Video_QuickTime,Video_WebM);exports.tagVideoSuffix=tagVideoSuffix;const tagTrackSuffix=[].concat(WebVTT,TTML);function getSuffixList(e){let i=[];return e.forEach((e=>{i=i.concat(e.suffix)})),i}exports.tagTrackSuffix=tagTrackSuffix,exports.getSuffixList=getSuffixList;const imageSuffix=[".wbmp",".icns"].concat(getSuffixList(tagImgSuffix));exports.imageSuffix=imageSuffix;const mediaSuffix=[".3gpp",".wmv",".avi",".qt",".mid",".midi",".asf",".mpa",".m2ts",".swf",".evo",".flv",".cda",".rm",".wma",".ram",".ra",".rmvb",".weba"],fontSuffix=[".otf",".ttf",".woff",".woff2",".svg",".eot"];exports.fontSuffix=fontSuffix;const forwardSlash="/".charCodeAt(0),filterDirs=[".git",".svn","node_modules","unpackage",".hbuilderx"];function getCompletionPathListSync(e,i,t,o){var a,s,f;const m=i;if(!fs.existsSync(m))return;const u=vscode_uri_1.URI.parse(o).fsPath,n=null!==(a=t.fileMax)&&void 0!==a?a:-1;if(0===n)return;const r=null!==(s=t.timeout)&&void 0!==s?s:1e3;let g=null!==(f=t.prefixPath)&&void 0!==f?f:"",p="",d="",l=!1;const c={prefixPath:"",pathList:[]};if(g){const i=g.lastIndexOf("/"),t=i>=0?g.slice(0,i):"";if(g.startsWith("/")&&!g.startsWith("//"))p=path.resolve(e,t.slice(1)),l=!0;else{const e=path.dirname(vscode_uri_1.URI.parse(o).fsPath);p=path.resolve(e,t)}if(!fs.existsSync(p))return;c.prefixPath=t,d=p}else p=m,d=path.dirname(vscode_uri_1.URI.parse(o).fsPath);if(p){const e=l?"/":"",i=[];return(()=>{let o=process.uptime(),a=[p],s=!!t.withCurrentLevelFolder,f=!!t.withAllCurrentLevelFiles;for(;a.length>0&&(n<0||i.length<n);){let m=a.shift();fs.readdirSync(m,{withFileTypes:!0}).forEach((o=>{const n=o.name.toLowerCase(),r=path.join(m,o.name);if(o.isFile()){let o=f||0==t.extensionFilters.length;if(o||(o=t.extensionFilters.some((e=>n.endsWith(e)))),o){let t=path.relative(d,r).replace(/\\/g,"/");r!==u&&i.push({absolutePath:r,relativePath:e+t})}}else if(o.isDirectory()&&!filterDirs.includes(o.name.toLocaleLowerCase())&&(a.push(r),s)){let t=path.relative(d,r).replace(/\\/g,"/");t&&i.push({absolutePath:r,relativePath:e+t+"/",isDir:!0})}})),s=!1,f=!1;const n=process.uptime();if(r>0&&1e3*(n-o)>r)break}return c.pathList=i,c})()}}function getFileIconType(e){let i=lspUtil_1.HxIconKind.FILE;return(0,converts_1.includesList)(e,imageSuffix)?i=lspUtil_1.HxIconKind.IMAGE:(0,converts_1.includesList)(e,[".css",".scss",".less"])?i=lspUtil_1.HxIconKind.CSS:(0,converts_1.includesList)(e,[".js"])&&(i=lspUtil_1.HxIconKind.JS),i}function getPathCompletionItem(e,i){let t=[];for(const o of e.pathList){let e,a=lspUtil_1.HxIconKind.FOLDER;if(!o.isDir){a=getFileIconType(path.extname(o.absolutePath))}if(""===i&&(o.relativePath.includes("/")||(o.relativePath="./"+o.relativePath)),a===lspUtil_1.HxIconKind.IMAGE){let i={width:230,height:180},t=o.absolutePath,a=imageSize(t),s="";if(".svg"!=t.slice(-4).toLocaleLowerCase()){let e=Math.min(i.width/a.width,i.height/a.height);e=Math.min(e,1),e<1&&(s=a.width>a.height?`width="${a.width*e}"`:`height="${a.height*e}"`)}e={kind:vscode_languageserver_protocol_1.MarkupKind.Markdown,value:`<div align='center'><br/><img ${s} src="${t}"/></div>`}}t.push({label:o.relativePath,documentation:e,kind:vscode_languageserver_protocol_1.CompletionItemKind.Property,data:{hxKind:a,isPathCompletion:!0,absolutePath:o.absolutePath}})}return t}exports.getCompletionPathListSync=getCompletionPathListSync,exports.getPathCompletionItem=getPathCompletionItem;