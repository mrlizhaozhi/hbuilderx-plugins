"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getMainExternalFiles=exports.createMainLanguageService=exports.overrideTsApis=exports.registerServerPlugin=void 0;const hx=require("./base/project"),TsServerApiI18nPlugin_1=require("./plugins/TsServerApiI18nPlugin"),TsServerBasePlugin_1=require("./plugins/TsServerBasePlugin"),TsServerSpecialStringsPlugin_1=require("./plugins/TsServerSpecialStringsPlugin"),hxLsPlugins=[];function registerServerPlugin(e){hxLsPlugins.push(e)}exports.registerServerPlugin=registerServerPlugin;const externalExtensions=new Set([".uts"]),baseTypes=["Array","String","Number","Boolean","Symbol","Object"];function overrideTsApis(e){if(e&&e.SymbolDisplay&&e.SymbolDisplay.getSymbolKind&&!e.SymbolDisplay.__overridedSymbolKind){e.SymbolDisplay.__overridedSymbolKind=!0;let r=e.SymbolDisplay.getSymbolKind.bind(e.SymbolDisplay);e.SymbolDisplay.getSymbolKind=function(t,i,n){var l,o,s;let a=baseTypes.some((e=>e==i.escapedName));if(a)return"property";let u=i.type;if(u){if(u.getNonNullableType().getCallSignatures().length>0)return"function"}let c=null===(l=i.valueDeclaration)||void 0===l?void 0:l.initializer;if(c&&e.isFunctionLike(c))return"function";let g=null===(o=i.valueDeclaration)||void 0===o?void 0:o.type;if(g&&e.isFunctionTypeNode(g))return"function";let p=r(t,i,n);if(p){if(p.endsWith("method")||p.endsWith("function"))return"function";if("var"===p&&"require"===i.escapedName)return"function";if("alias"===p){if(0!==t.getTypeOfSymbolAtLocation(i,n).getNonNullableType().getCallSignatures().length)return"function"}if("var"===p||"const"===p||"let"===p||"property"===p){let e=null===(s=i.escapedName)||void 0===s?void 0:s.toString();if(e&&e.startsWith("$")){if(0!==t.getTypeOfSymbolAtLocation(i,n).getNonNullableType().getCallSignatures().length)return"function"}}}return p}}e&&!e.__overridedTsApis&&(e.__overridedTsApis=!0,e.createLanguageService2=function(r,t,i,n){return e.createLanguageService(t,i,n)},e.extensionFromPath=function(r){var t=e.tryGetExtensionFromPath(r);return void 0===t&&externalExtensions.forEach((e=>{r.endsWith(e)&&(t=e)})),void 0!==t?t:e.Debug.fail("File ".concat(r," has unknown extension."))})}function createMainLanguageService(e,r){overrideTsApis(r);let t=e.project.documentRegistry,i=hx.createProject(e.project,t),n=hxLsPlugins;n.push(TsServerApiI18nPlugin_1.TsServerApiI18nPlugin);let l=e.languageService,o=[],s={languageService:l,project:i,tsinfo:e,ts:r};for(var a=0;a<n.length;a++)if(s.languageService=n[a].create(s),n[a].createTypeCheckerPlugins){let e=n[a].createTypeCheckerPlugins(s);e&&o.push(...e)}let u=e.project.getCompilationSettings.bind(e.project);return e.project.getCompilationSettings=()=>{let e=u();return e.checkExpressionOverride=(r,t,n,l)=>{for(let s=0;s<o.length;s++){let a=o[s];try{if(!a||!a.checkExpression)continue;let o=a.checkExpression(i,e,r,t,n,l);if(o)return o}catch(e){console.error(e)}}},e.getContextualTypeOverride=(r,t,n)=>{for(let l=0;l<o.length;l++){let s=o[l];try{if(!s||!s.getContextualType)continue;let l=s.getContextualType(i,e,r,t,n);if(l)return l}catch(e){console.error(e)}}},e.collectCustomModuleReferences=function(r){let t=[];for(let n=0;n<o.length;n++){let l=o[n];try{if(!l||!l.collectCustomModuleReferences)continue;let n=l.collectCustomModuleReferences(i,e,r);n&&t.push(...n)}catch(e){console.error(e)}}return t},e},s.languageService}function getMainExternalFiles(e,r){let t=[],i=hxLsPlugins,n=hx.getProjectByPath(e.getCurrentDirectory());for(var l=0;l<i.length;l++){if(!i[l].getExternalFiles)continue;let e=i[l].getExternalFiles(n,r);e&&e.length>0&&t.push(...e)}return t}exports.overrideTsApis=overrideTsApis,exports.createMainLanguageService=createMainLanguageService,exports.getMainExternalFiles=getMainExternalFiles,registerServerPlugin(TsServerBasePlugin_1.TsServerBasePlugin),registerServerPlugin(TsServerSpecialStringsPlugin_1.TsServerSpecialStringsPlugin);