"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getVueCSSMode=void 0;const vscode_css_languageservice_1=require("vscode-css-languageservice"),languageModelCache_1=require("../languageModelCache"),languageModes_1=require("./languageModes"),embeddedSupport_1=require("./embeddedSupport"),cssModeExtension_1=require("../modes-ext/cssModeExtension"),embeddedCssFormatting_1=require("./embeddedCssFormatting"),server_1=require("../../../../stylusservice/server");function getVueStyleModelCache(e,t){let n="vue:"+t,o=(0,languageModelCache_1.getLanguageModelCache)(10,60,(t=>e.get(t).getEmbeddedDocument(n)));return{get(e){let n=o.get(e);return languageModes_1.TextDocument.create(n.uri,t,n.version,n.getText())},onDocumentRemoved(e){o.onDocumentRemoved(e)},dispose(){o.dispose()}}}function getCSSLanguageMode(e,t,n,o){let a=getVueStyleModelCache(t,n),l=(0,languageModelCache_1.getLanguageModelCache)(10,60,(t=>e.parseStylesheet(t))),s=(0,cssModeExtension_1.getVueStyleModeExt)(e,o),r=(0,embeddedCssFormatting_1.getCssFormatting)(t,"vue:"+n);return{getId:()=>n,async doValidation(t,n=o.settings){let s=a.get(t);return e.doValidation(s,l.get(s),n&&n.css)},async doComplete(e,t,n,r=o.settings){let i=a.get(e);const u=l.get(i);let d=await s.doComplete(e,i,t,u,n);return null!=d?d:{isIncomplete:!0,items:[]}},async doHover(t,n){let o=a.get(t);return e.doHover(o,n,l.get(o))},async findDocumentHighlight(t,n){let o=a.get(t);return e.findDocumentHighlights(o,n,l.get(o))},async findDocumentSymbols(e){let t=a.get(e);return s.findDocumentSymbols(t,l.get(t)).filter((e=>e.name!==embeddedSupport_1.CSS_STYLE_RULE))},async findDefinition(e,t){let n=a.get(e),o=l.get(n);return s.findDefinition(e,n,t,o)},async findReferences(t,n){let o=a.get(t);return e.findReferences(o,n,l.get(o))},async findDocumentColors(t){let n=a.get(t);return e.findDocumentColors(n,l.get(n))},async getColorPresentations(t,n,o){let s=a.get(t);return e.getColorPresentations(s,l.get(s),n,o)},format:async(e,t,n,o)=>r.doFormatting(e,t,n,o),async getFoldingRanges(t){let n=a.get(t);return e.getFoldingRanges(n,{})},async getSelectionRange(t,n){let o=a.get(t);return e.getSelectionRanges(o,[n],l.get(o))[0]},onDocumentRemoved(e){a.onDocumentRemoved(e),l.onDocumentRemoved(e)},dispose(){a.dispose(),l.dispose()}}}function getStylusMode(e,t){let n=getVueStyleModelCache(e,"stylus"),o=((0,cssModeExtension_1.getVueStyleModeExt)(void 0,t),new server_1.ExposedStylusServer);return{getId:()=>"",async doComplete(e,a,l,s=t.settings){let r=n.get(e),i=o.getLanguageServiceExt();return i&&i.doComplete?i.doComplete(r,a):languageModes_1.CompletionList.create()},findDefinition:async(e,t)=>[],onDocumentRemoved(e){n.onDocumentRemoved(e)},dispose(){n.dispose()}}}function getVueCSSMode(e,t,n){const o=(0,vscode_css_languageservice_1.getCSSLanguageService)(e),a=(0,vscode_css_languageservice_1.getSCSSLanguageService)(e),l=(0,vscode_css_languageservice_1.getLESSLanguageService)(e),s=getCSSLanguageMode(o,t,"css",n),r=getCSSLanguageMode(a,t,"scss",n),i=getCSSLanguageMode(l,t,"less",n),u=getStylusMode(t,n);let d=new Map;function g(e,n){let o=t.get(e).getLanguageAtPosition(n);return o?d.get(o):void 0}return d.set("vue:css",s),d.set("vue:scss",r),d.set("vue:less",i),d.set("vue:stylus",u),{getId:()=>languageModes_1.VueLanguageModeId.Style,async doComplete(e,t,o,a=n.settings){let l=g(e,t);return l&&l.doComplete?l.doComplete(e,t,o,a):{isIncomplete:!0,items:[]}},async doHover(e,t){var n,o;let a=g(e,t);return null!==(o=await(null===(n=null==a?void 0:a.doHover)||void 0===n?void 0:n.call(a,e,t)))&&void 0!==o?o:null},async findDocumentHighlight(e,t){var n,o;let a=g(e,t);return null!==(o=await(null===(n=null==a?void 0:a.findDocumentHighlight)||void 0===n?void 0:n.call(a,e,t)))&&void 0!==o?o:[]},async findDocumentSymbols(e){let t=[],n=Array.from(d.values()).map((async t=>{var n,o;return null!==(o=await(null===(n=null==t?void 0:t.findDocumentSymbols)||void 0===n?void 0:n.call(t,e)))&&void 0!==o?o:[]}));return(await Promise.all(n)).forEach((e=>{t.push(...e)})),t},async findDefinition(e,t){var n,o;let a=g(e,t);return null!==(o=await(null===(n=null==a?void 0:a.findDefinition)||void 0===n?void 0:n.call(a,e,t)))&&void 0!==o?o:null},async findReferences(e,t){var n,o;let a=g(e,t);return null!==(o=await(null===(n=null==a?void 0:a.findReferences)||void 0===n?void 0:n.call(a,e,t)))&&void 0!==o?o:[]},async findDocumentColors(e){let t=[],n=Array.from(d.values()).map((async t=>{var n,o;return null!==(o=null===(n=t.findDocumentColors)||void 0===n?void 0:n.call(t,e))&&void 0!==o?o:[]}));return(await Promise.all(n)).forEach((e=>{t.push(...e)})),t},async getColorPresentations(e,t,n){let o=[],a=Array.from(d.values()).map((async o=>{var a,l;return null!==(l=null===(a=null==o?void 0:o.getColorPresentations)||void 0===a?void 0:a.call(o,e,t,n))&&void 0!==l?l:[]}));return(await Promise.all(a)).forEach((e=>{e&&o.push(...e)})),o},async format(e,n,o,a){let l=function(e,n){return t.get(e).getLanguageRanges(n).map((e=>({start:e.start,end:e.end,mode:e.languageId&&d.get(e.languageId),attributeValue:e.attributeValue})))}(e,n),s=[];for(let t of l){let n=t.mode;if(n&&n.format&&!t.attributeValue&&"css"==n.getId()){let l=await n.format(e,t,o,a);for(let e of l)s.push(e)}}if(s.length<=1)return s;let r=languageModes_1.TextDocument.applyEdits(e,s),i=(languageModes_1.TextDocument.create(e.uri+".style.tmp",e.languageId,e.version,r),e.getText().length-e.offsetAt(n.end)),u=r.substring(e.offsetAt(n.start),r.length-i);return[languageModes_1.TextEdit.replace(n,u)]},async getFoldingRanges(e){let t=[],n=Array.from(d.values()).map((async t=>{var n,o;return null!==(o=null===(n=null==t?void 0:t.getFoldingRanges)||void 0===n?void 0:n.call(t,e))&&void 0!==o?o:[]}));return(await Promise.all(n)).forEach((e=>{t.push(...e)})),t},async getSelectionRange(e,t){var n;let o=g(e,t),a=await(null===(n=null==o?void 0:o.getSelectionRange)||void 0===n?void 0:n.call(o,e,t));return a||vscode_css_languageservice_1.SelectionRange.create(languageModes_1.Range.create(t,t))},onDocumentRemoved(e){d.forEach((t=>{t.onDocumentRemoved(e)}))},dispose(){d.forEach((e=>{e.dispose()}))}}}exports.getVueCSSMode=getVueCSSMode;