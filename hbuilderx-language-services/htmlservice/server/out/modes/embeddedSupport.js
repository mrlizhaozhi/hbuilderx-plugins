"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getDocumentRegions=exports.CSS_STYLE_RULE=void 0;const languageModes_1=require("./languageModes");exports.CSS_STYLE_RULE="__";const whiteSpaceCharCode=[" ".charCodeAt(0),"\n".charCodeAt(0),"\t".charCodeAt(0),"\f".charCodeAt(0),"\r".charCodeAt(0)];function regionLanguage(e,t){if("vue"===e.languageId||!e.languageId&&e.uri.toLowerCase().endsWith(".vue")){if("css"===t)return"vue:css";if("scss"===t||"less"===t||"stylus"===t)return"vue:"+t;if("html"===t)return languageModes_1.VueLanguageModeId.Template}return t}function isVueLanguage(e){return"vue"===e.languageId||!e.languageId&&e.uri.toLowerCase().endsWith(".vue")}function getDocumentRegions(e,t){let n,a=[],g=e.createScanner(t.getText()),s="",u=null,r=[],o=g.scan(),i=isVueLanguage(t),l="";for(;o!==languageModes_1.TokenType.EOS;){switch(o){case languageModes_1.TokenType.StartTag:s=g.getTokenText(),u=null,n="javascript";break;case languageModes_1.TokenType.Styles:let e=i&&l?l:"css";a.push({languageId:regionLanguage(t,e),start:g.getTokenOffset(),end:g.getTokenEnd()}),l="";break;case languageModes_1.TokenType.Script:a.push({languageId:n?regionLanguage(t,n):void 0,start:g.getTokenOffset(),end:g.getTokenEnd()});break;case languageModes_1.TokenType.AttributeName:u=g.getTokenText();break;case languageModes_1.TokenType.AttributeValue:if("lang"===u&&"script"===s.toLowerCase()){let e=g.getTokenText();"'"!==e[0]&&'"'!==e[0]||(e=e.substring(1,e.length-1)),n="javascript"}else if("src"===u&&"script"===s.toLowerCase()){let e=g.getTokenText();"'"!==e[0]&&'"'!==e[0]||(e=e.substring(1,e.length-1)),r.push(e)}else if("type"===u&&"script"===s.toLowerCase())n=/["'](module|(text|application)\/(java|ecma)script|text\/babel)["']/.test(g.getTokenText())||/["']text\/typescript["']/.test(g.getTokenText())?"javascript":void 0;else if("lang"===u&&"style"===s.toLowerCase())l=g.getTokenText(),"'"!==l[0]&&'"'!==l[0]||(l=l.substring(1,l.length-1));else{let e=getAttributeLanguage(u);if(e){let n=g.getTokenOffset(),s=g.getTokenEnd(),u=t.getText()[n];"'"!==u&&'"'!==u||(n++,s--),a.push({languageId:regionLanguage(t,e),start:n,end:s,attributeValue:!0})}}u=null;case languageModes_1.TokenType.Content:}o=g.scan()}return{getLanguageRanges:e=>getLanguageRanges(t,a,e),getEmbeddedDocument:(e,n)=>getEmbeddedDocument(t,a,e,n),getLanguageAtPosition:e=>getLanguageAtPosition(t,a,e),getLanguagesInDocument:()=>getLanguagesInDocument(t,a),getImportedScripts:()=>r,get scriptLanguageId(){return n}}}function getLanguageRanges(e,t,n){let a=[],g=n?n.start:languageModes_1.Position.create(0,0),s=n?e.offsetAt(n.start):0,u=n?e.offsetAt(n.end):e.getText().length;for(let n of t)if(n.end>s&&n.start<u){let t=Math.max(n.start,s),r=e.positionAt(t);s<n.start&&a.push({start:g,end:r,languageId:regionLanguage(e,"html")});let o=Math.min(n.end,u),i=e.positionAt(o);o>n.start&&a.push({start:r,end:i,languageId:n.languageId,attributeValue:n.attributeValue}),s=o,g=i}if(s<u){let t=n?n.end:e.positionAt(u);a.push({start:g,end:t,languageId:regionLanguage(e,"html")})}return a}function getLanguagesInDocument(e,t){let n=[];for(let e of t)if(e.languageId&&-1===n.indexOf(e.languageId)&&(n.push(e.languageId),3===n.length))return n;return n.push(regionLanguage(e,"html")),n}function getLanguageAtPosition(e,t,n){let a=e.offsetAt(n);for(let e of t){if(!(e.start<=a))break;if(a<=e.end)return e.languageId}return regionLanguage(e,"html")}function getEmbeddedDocument(e,t,n,a){let g=0,s=e.getText(),u="",r="";for(let e of t)e.languageId!==n||a&&e.attributeValue||(u=substituteWithWhitespace(u,g,e.start,s,r,getPrefix(e)),u+=s.substring(e.start,e.end),g=e.end,r=getSuffix(e));return u=substituteWithWhitespace(u,g,s.length,s,r,""),languageModes_1.TextDocument.create(e.uri,n,e.version,u)}function getPrefix(e){if(e.attributeValue)switch(e.languageId){case"css":case"vue:css":return exports.CSS_STYLE_RULE+"{"}return""}function getSuffix(e){if(e.attributeValue)switch(e.languageId){case"css":case"vue:css":return"}";case"javascript":return";"}return""}function substituteWithWhitespace(e,t,n,a,g,s){let u=0;e+=g;for(let s=t+g.length;s<n;s++){let t=a[s];"\n"===t||"\r"===t?(u=0,e+=t):u++}return e=append(e," ",u-s.length),e+=s}function append(e,t,n){for(;n>0;)1&n&&(e+=t),n>>=1,t+=t;return e}function getAttributeLanguage(e){let t=e.match(/^(style)$|^(on\w+)$/i);return t?t[1]?"css":"javascript":null}exports.getDocumentRegions=getDocumentRegions;