"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.format=void 0;const languageModes_1=require("./languageModes"),arrays_1=require("../utils/arrays"),strings_1=require("../utils/strings");async function format(e,t,a,r,o,n){let s=[],l=a.end,g=t.offsetAt(l),u=t.getText();if(0===l.character&&l.line>0&&g!==u.length){let e=t.offsetAt(languageModes_1.Position.create(l.line-1,0));for(;(0,strings_1.isEOL)(u,g-1)&&g>e;)g--;a=languageModes_1.Range.create(a.start,t.positionAt(g))}let i=e.getModesInRange(t,a),d=0,f=a.start;for(;d<i.length&&(!(m=i[d]).mode||"html"!==m.mode.getId()&&"vue-template"!==m.mode.getId());){let e=i[d];if(!e.attributeValue&&e.mode&&e.mode.format){let a=await e.mode.format(t,languageModes_1.Range.create(f,e.end),r,o);(0,arrays_1.pushAll)(s,a)}f=e.end,d++}var m;if(d===i.length)return s;a=languageModes_1.Range.create(f,a.end);let c=e.getMode("html"),p=await c.format(t,a,r,o),_=languageModes_1.TextDocument.applyEdits(t,p),M=languageModes_1.TextDocument.create(t.uri+".tmp",t.languageId,t.version,_);try{let l=t.getText().length-t.offsetAt(a.end),g=languageModes_1.Range.create(a.start,M.positionAt(_.length-l)),u=e.getModesInRange(M,g),i=[];for(let e of u){let t=e.mode;if(t&&t.format&&n[t.getId()]&&!e.attributeValue){let a=await t.format(M,e,r,o);for(let e of a)i.push(e)}}if(0===i.length)return(0,arrays_1.pushAll)(s,p),s;let d=languageModes_1.TextDocument.applyEdits(M,i),f=d.substring(t.offsetAt(a.start),d.length-l);return s.push(languageModes_1.TextEdit.replace(a,f)),s}finally{e.onDocumentRemoved(M)}}exports.format=format;