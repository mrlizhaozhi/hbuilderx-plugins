"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getVueTemplateMode=exports.initDataProviders=void 0;const path=require("path"),vscode_html_languageservice_1=require("vscode-html-languageservice"),vscode_languageserver_protocol_1=require("vscode-languageserver-protocol"),vscode_uri_1=require("vscode-uri"),utils_1=require("../../../../utils"),languageModelCache_1=require("../languageModelCache"),veturProvider_1=require("../modes-ext/dataprovider/veturProvider"),htmlModeExtentsion_1=require("../modes-ext/htmlModeExtentsion"),idClassCompletion_1=require("../modes-ext/idClassCompletion"),PathCompletionParticipant_1=require("../modes-ext/PathCompletionParticipant"),uniDBAttributeCompletion_1=require("../modes-ext/uniDBAttributeCompletion"),htmlDataProviderWrapper_1=require("../utils/htmlDataProviderWrapper"),strings_1=require("../utils/strings"),htmlMode_1=require("./htmlMode"),htmlDataProvider=require("vscode-html-languageservice/lib/umd/languageFacts/dataProvider");let oldGenerateDocumentation=htmlDataProvider.generateDocumentation,projectDataProviders=new Map,lastWorkspaceFolder="",providersChanged=new vscode_languageserver_protocol_1.Emitter,workspaceDataManager={onProviderChanged:providersChanged.event,getAllDataProiders(){let e=[];return projectDataProviders.forEach((t=>{e.push(...t)})),e},filterWorkspaceDataProvider(e){var t;lastWorkspaceFolder!=e&&(projectDataProviders.forEach((e=>{e.forEach((e=>{e.enable=!1}))})),e&&(null===(t=projectDataProviders.get(e))||void 0===t||t.forEach((e=>{e.enable=!0}))),lastWorkspaceFolder=e||"")}};const dataroot=path.join(__dirname,"../../data");let vueDataProvider=new Map;function initDataProviders(e){e.forEach((e=>{let t=(0,veturProvider_1.getVeturDataProviders)(e);projectDataProviders.set(e,t)})),lastWorkspaceFolder="",providersChanged.fire()}function getRootFolder(e,t){for(let r of t){let t=r.uri;if((0,strings_1.endsWith)(t,"/")||(t+="/"),(0,strings_1.startsWith)(e,t))return r}}function getVueTemplateMode(e,t,r){let a=(0,languageModelCache_1.getLanguageModelCache)(10,60,(e=>t.parseHTMLDocument(e))),o=(0,htmlMode_1.getHTMLMode)(e,t,a,r),i=(0,htmlModeExtentsion_1.getHtmlModeExt)(t,a,r,{vueEnable:!0}),n=[];e.fileSystemProvider&&e.fileSystemProvider.readDirectory&&n.push(new PathCompletionParticipant_1.PathCompletionParticipant(e.fileSystemProvider.readDirectory)),n.push(new idClassCompletion_1.IdClassCompletionParticipant),n.push(new uniDBAttributeCompletion_1.UnicloudDBAttributeCompletion(a)),t.setCompletionParticipants(n);let l=new htmlDataProviderWrapper_1.HTMLDataProviderWrapper("html5",(0,vscode_html_languageservice_1.getDefaultHTMLDataProvider)());function s(){let e=r.folders.map((e=>e.uri));Array.from(projectDataProviders.keys()).forEach((t=>{e.includes(t)||projectDataProviders.delete(t)}));let a=[l];a=a.concat(Array.from(vueDataProvider.values())),a=a.concat(workspaceDataManager.getAllDataProiders()),t.setDataProviders(!1,a),i.updateDataProviders(a)}function u(e){const t=getRootFolder(e.uri,r.folders),a=t?t.uri:"";workspaceDataManager.filterWorkspaceDataProvider(a);let o=!(!a||(0,utils_1.getProjectType)(vscode_uri_1.URI.parse(a).fsPath)!==utils_1.ProjectType.PT_UniApp_Vue),i="vue"==e.languageId&&e.uri.endsWith(".nvue");l.enable=!o;try{vueDataProvider.get("uni_vue_tag").enable=o,vueDataProvider.get("uni_nvue_html").enable=o&&i}catch(e){}}return workspaceDataManager.onProviderChanged((()=>{s()})),s(),o.getId=()=>"vue-template",o.doComplete=async(e,o,l,s=r.settings)=>{let d=s&&s.html&&s.html.suggest;s&&s.html&&s.html.autoClosingTags&&(d.hideAutoCompleteProposals=!0),u(e);let v=getRootFolder(e.uri,r.folders),p=Boolean(vueDataProvider.get("uni_nvue_html").enable);d=null!=d?d:{};const c=a.get(e);return await i.doComplete(e,o,c,(async r=>{var a;n.forEach((e=>{var t;null===(t=e.beginCompletion)||void 0===t||t.call(e,{workspaceFolder:v})}));let i=await t.doComplete2(e,o,c,l,r);if(p){let e=[],t=new Set;i.items.forEach((r=>{t.has(r.label)||(e.push(r),t.add(r.label))})),i.items=e}for(let t=0;t<n.length;t++){const r=n[t];let o=await r.computeCompletions(e,c,l);i.items.push(...o.items),i.isIncomplete=i.isIncomplete||o.isIncomplete,null===(a=r.endCompletion)||void 0===a||a.call(r)}return Boolean(vueDataProvider.get("uni_vue_tag").enable)&&i.items.forEach((e=>{if(e.documentation)if("string"==typeof e.documentation);else{let t=e.documentation.value.toString();if(t.startsWith("vueTagType:")){let r=t.match(/^(vueTagType:)[\S]+[ ]/);if(!r)return;e.detail=e.label+": - "+r[0].replace("vueTagType:",""),e.documentation=e.documentation.value.replace(/^(vueTagType:)[\S]+[ ]/,"")}}})),i}),d)},o.doResolve=async(e,t)=>{u(e);const r=a.get(e);return i.doResolve(e,t,r)},o.doHover=async(e,r)=>{u(e);const o=a.get(e);let n=await i.doHover(e,r,o);if(!n){let a=t.doHover(e,r,o);if(!a)return a;let i=a.contents.value;if(!i)return a;if(i.startsWith("vueTagType:")){if(!i.match(/^(vueTagType:)[\S]+[ ]/))return a;a.contents.value=i.replace(/^(vueTagType:)[\S]+[ ]/,"")}return a}return n},o.findDefinition=async(e,t)=>{const r=a.get(e);return i.findDefinition(e,t,r)},o.updateDataProviders=e=>{i.updateDataProviders(e)},o.setDocuments=e=>{i.setHtmlDocuments(e)},o}vueDataProvider.set("uni_nvue_html",(0,htmlDataProviderWrapper_1.createDataProvider)("uni_nvue_html",path.join(dataroot,"uni_nvue_html.json"))),vueDataProvider.set("uni_vue_tag",(0,htmlDataProviderWrapper_1.createDataProvider)("uni_vue_tag",path.join(dataroot,"uni_vue_tag.json"))),vueDataProvider.set("vue3_html",(0,htmlDataProviderWrapper_1.createDataProvider)("vue3_html",path.join(dataroot,"vue3_html.json"))),vueDataProvider.set("vue_html",(0,htmlDataProviderWrapper_1.createDataProvider)("vue_html",path.join(dataroot,"vue_html.json"))),exports.initDataProviders=initDataProviders,exports.getVueTemplateMode=getVueTemplateMode;