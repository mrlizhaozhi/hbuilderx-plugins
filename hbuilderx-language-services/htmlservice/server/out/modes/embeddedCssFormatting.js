"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getCssFormatting=void 0;const vscode_languageserver_1=require("vscode-languageserver"),entry_1=require("../../../../cssservice/entry"),strings_1=require("../utils/strings");function toNumber(e,t){return"number"==typeof e?e:t}function toBoolean(e,t){return"boolean"==typeof e?e:t}function getLineTextFromPosition(e,t){const n=t.line+1,r=vscode_languageserver_1.Position.create(n,0),i=e.offsetAt(r),s=e.positionAt(i-1),o=vscode_languageserver_1.Range.create(vscode_languageserver_1.Position.create(t.line,0),s);return e.getText(o)}function getCssFormatting(e,t){return{async doFormatting(n,r,i,s){var o;let a=(0,entry_1.getExtraServer)(n).getLanguageServiceExt();if(!a||!a.format)return[];const c=n.getText(),l=e.get(n).getEmbeddedDocument(t,!0),d=computeInitialIndent(n,r,i);let g=!1,u=!0;let f=null!==(o=null==s?void 0:s.css)&&void 0!==o?o:{},h=!1;const v=getLineTextFromPosition(n,r.start),_=getLineTextFromPosition(n,vscode_languageserver_1.Position.create(r.start.line-1,0));f.indentLevel=d,v.includes("<style")?(f.indentLevel=d+1,r.start.character=v.indexOf(">")+1,f.isNeedLineBreak=!0,h=!0):(_.includes("<style"),r.start.character=0);let m=!1;if(c.endsWith("</style>")&&(m=!0),m){const e=getLineTextFromPosition(n,r.end);e.includes("</style")?r.end.character=e.indexOf("</style"):(r.end.character=e.length-1,f.endWithNewline=!1,m=!1,u=!1)}else{const e=getLineTextFromPosition(n,r.end);e.includes("</style")?r.end.character=e.indexOf("</style"):(r.end.character=e.length-1,f.endWithNewline=!1,m=!1,u=!1)}let x=await a.format(l,r,f);!f.endWithNewline&&m&&(g=!0);let p=d;h||(p=d-1);let y="\n";if(g&&u)y+=generateIndent(p,i);else if(g)y="\n";else{if(!u)return x;y=generateIndent(p,i)}return x.push({range:vscode_languageserver_1.Range.create(r.end,r.end),newText:y}),x}}}function computeInitialIndent(e,t,n){let r=e.offsetAt(vscode_languageserver_1.Position.create(t.start.line,0)),i=e.getText(),s=r,o=0,a=n.tabSize||4;for(;s<i.length;){let e=i.charAt(s);if(" "===e)o++;else{if("\t"!==e)break;o+=a}s++}return Math.floor(o/a)}exports.getCssFormatting=getCssFormatting;const whiteSpaceCharCode=[" ".charCodeAt(0),"\t".charCodeAt(0),"\f".charCodeAt(0)],NL="\n".charCodeAt(0);function hasEndOfLineBeforeWord(e,t){let n=e.offsetAt(t.start),r=e.getText(),i=n;for(;i<r.length;){let e=r.charCodeAt(i);if(e==NL)return!0;if(!whiteSpaceCharCode.includes(e))return!1;i++}return!1}function generateIndent(e,t){return t.insertSpaces?(0,strings_1.repeat)(" ",e*t.tabSize):(0,strings_1.repeat)("\t",e)}