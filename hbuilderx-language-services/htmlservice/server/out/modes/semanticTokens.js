"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.newSemanticTokenProvider=void 0;const languageModes_1=require("./languageModes"),positions_1=require("../utils/positions");function newSemanticTokenProvider(e){const t={types:[],modifiers:[]},n={};for(let o of e.getAllModes())if(o.getSemanticTokenLegend&&o.getSemanticTokens){const e=o.getSemanticTokenLegend();n[o.getId()]={types:createMapping(e.types,t.types),modifiers:createMapping(e.modifiers,t.modifiers)}}return{legend:t,async getSemanticTokens(t,o){const r=[];for(let o of e.getAllModesInDocument(t))if(o.getSemanticTokens){const e=n[o.getId()],i=await o.getSemanticTokens(t);applyTypesMapping(i,e.types),applyModifiersMapping(i,e.modifiers);for(let e of i)r.push(e)}return encodeTokens(r,o)}}}function createMapping(e,t){const n=[];let o=!1;for(let r=0;r<e.length;r++){const i=e[r];let s=t.indexOf(i);-1===s&&(s=t.length,t.push(i)),n.push(s),o=o||s!==r}return o?n:void 0}function applyTypesMapping(e,t){if(t)for(let n of e)n.typeIdx=t[n.typeIdx]}function applyModifiersMapping(e,t){if(t)for(let n of e){let e=n.modifierSet;if(e){let o=0,r=0;for(;e>0;)0!=(1&e)&&(r+=1<<t[o]),o++,e>>=1;n.modifierSet=r}}}exports.newSemanticTokenProvider=newSemanticTokenProvider;const fullRange=[languageModes_1.Range.create(languageModes_1.Position.create(0,0),languageModes_1.Position.create(Number.MAX_VALUE,0))];function encodeTokens(e,t){const n=e.sort(((e,t)=>e.start.line-t.start.line||e.start.character-t.start.character));let o=0,r=(t=t?t.sort(((e,t)=>e.start.line-t.start.line||e.start.character-t.start.character)):fullRange)[o++],i=0,s=0,a=[];for(let e=0;e<n.length&&r;e++){const c=n[e],p=c.start;for(;r&&(0,positions_1.beforeOrSame)(r.end,p);)r=t[o++];r&&(0,positions_1.beforeOrSame)(r.start,p)&&(0,positions_1.beforeOrSame)({line:p.line,character:p.character+c.length},r.end)&&(i!==p.line&&(s=0),a.push(p.line-i),a.push(p.character-s),a.push(c.length),a.push(c.typeIdx),a.push(c.modifierSet),i=p.line,s=p.character)}return a}