"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getFoldingRanges=void 0;const languageModes_1=require("./languageModes");async function getFoldingRanges(e,t,n,i){let l=e.getMode("html"),a=languageModes_1.Range.create(languageModes_1.Position.create(0,0),languageModes_1.Position.create(t.lineCount,0)),g=[];l&&l.getFoldingRanges&&g.push(...await l.getFoldingRanges(t));let s=Object.create(null),r=async e=>{if(e.getFoldingRanges){let n=s[e.getId()];return Array.isArray(n)||(n=await e.getFoldingRanges(t)||[],s[e.getId()]=n),n}return[]},o=e.getModesInRange(t,a);for(let e of o){let t=e.mode;if(t&&t!==l&&!e.attributeValue){const n=await r(t);g.push(...n.filter((t=>t.startLine>=e.start.line&&t.endLine<e.end.line)))}}return n&&g.length>n&&(g=limitRanges(g,n)),g}function limitRanges(e,t){let n;e=e.sort(((e,t)=>{let n=e.startLine-t.startLine;return 0===n&&(n=e.endLine-t.endLine),n}));let i=[],l=[],a=[],g=(e,t)=>{l[e]=t,t<30&&(a[t]=(a[t]||0)+1)};for(let t=0;t<e.length;t++){let l=e[t];if(n){if(l.startLine>n.startLine)if(l.endLine<=n.endLine)i.push(n),n=l,g(t,i.length);else if(l.startLine>n.endLine){do{n=i.pop()}while(n&&l.startLine>n.endLine);n&&i.push(n),n=l,g(t,i.length)}}else n=l,g(t,0)}let s=0,r=0;for(let e=0;e<a.length;e++){let n=a[e];if(n){if(n+s>t){r=e;break}s+=n}}let o=[];for(let n=0;n<e.length;n++){let i=l[n];"number"==typeof i&&(i<r||i===r&&s++<t)&&o.push(e[n])}return o}exports.getFoldingRanges=getFoldingRanges;