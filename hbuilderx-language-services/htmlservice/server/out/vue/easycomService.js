"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.fetchVueComponentInfo=exports.collectEasycoms=void 0;const vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_html_languageservice_1=require("vscode-html-languageservice"),vscode_uri_1=require("vscode-uri"),jsonc_1=require("jsonc"),fs=require("fs"),path=require("path"),ts=require("typescript"),utils_1=require("../../../../utils");function visitFiles(e,t){if(!fs.existsSync(e))return;if(fs.statSync(e).isDirectory()){let s=fs.readdirSync(e);for(let i of s){fs.statSync(path.join(e,i)).isDirectory()?visitFiles(path.join(e,i),t):t(path.join(e,i))}}}function scanComponents(e){let t=[];if(!fs.existsSync(e))return t;if(fs.statSync(e).isDirectory()){let s=fs.readdirSync(e);for(let i of s){if(!fs.statSync(path.join(e,i)).isDirectory())continue;let s=[".vue",".nvue"];for(let n of s){let s=path.join(e,i,i+n);if(fs.existsSync(s)){t.push({name:i,filePath:s});break}}}}return t}function collectRuleRegexGroups(e){let t=new Map,s=0,i=-1;for(let n=0;n<e.length;n++){let r=e.charAt(n);"("==r?(s++,i=n):")"==r&&(-1!=i&&n>i&&t.set(s,{start:i,end:n+1}),i=-1)}return t}function buildGroupMappings(e,t){let s=new Map;if(t.size>0){let i="\0",n=0;for(let r=0;r<e.length;r++){let o=e.charAt(r);if(o>="0"&&o<="9"&&"$"==i){let e=Number.parseInt(o);t.has(e)&&(n++,s.set(n,e))}i=o}}return s}function scanAllEasycomByCustomRule(e,t,s,i,n,r){let o=[],a=new RegExp(e),l=e.split("/"),c=vscode_uri_1.URI.parse(r.uri).fsPath;for(;l.length>0;){let e=l.shift(),t=path.join(c,e);if(!fs.existsSync(t))break;c=t}return visitFiles(c,(e=>{let l=path.relative(vscode_uri_1.URI.parse(r.uri).fsPath,e),c=a.exec(l.replace(/\\/g,"/"));if(c){const e=[],a=new Map;for(let t=1;t<c.length;t++)if(n.has(t)){let s=c[t],r=n.get(t),o=i.get(r);e.find((e=>e.start==o.start&&e.end==o.end))||e.push({start:null==o?void 0:o.start,end:null==o?void 0:o.end,newText:s}),a.set(r,s)}e.sort(((e,t)=>t.start-e.start));let l=t;for(let t of e)l=l.substring(0,t.start)+t.newText+l.substring(t.end);let u=s;a.forEach(((e,t)=>{u=u.replace(new RegExp("\\$"+t,"g"),e)})),u=path.join(vscode_uri_1.URI.parse(r.uri).fsPath,u),l.length>0&&fs.existsSync(u)&&(l.startsWith("^")&&(l=l.substring(1)),/^[A-Za-z][A-Za-z0-9\-_]+$/.test(l)&&o.push({name:l,filePath:u}))}return!0})),o}function collectEasycoms(e,t,s){var i,n;let r=[];if(null==s)return r;let o=parseVuePageInstanceOptions(e,t);if(o){let t=o.options.find((e=>"components"==e.name.getText())),a=null==t?void 0:t.initializer;if(a&&ts.isObjectLiteralExpression(a)){let t=new Map;for(let e of o.sourceFile.statements)if(ts.isImportDeclaration(e)){let s=e,r=null===(n=null===(i=s.importClause)||void 0===i?void 0:i.name)||void 0===n?void 0:n.getText(),o=s.moduleSpecifier;if(r&&o&&ts.isStringLiteral(o)){let e=o.text;t.set(r,e)}}a.properties.forEach((i=>{var n;let o=null===(n=i.name)||void 0===n?void 0:n.getText();if(o){let i="";if(t.has(o)){let n=t.get(o);if(n.startsWith("@/"))i=path.join(vscode_uri_1.URI.parse(s.uri).fsPath,n.substring(2));else{let t=path.dirname(vscode_uri_1.URI.parse(e.uri).fsPath);i=path.resolve(t,n)}if(!i.endsWith(".vue")&&!i.endsWith(".nvue"))for(let e of[".vue",".nvue"])if(fs.existsSync(i+e)){i+=e;break}}r.push({name:o,filePath:fs.existsSync(i)?i:""});let n=o.replace(/([A-Z])/g,"-$1").toLowerCase();r.push({name:n.startsWith("-")?n.substring(1):n,filePath:fs.existsSync(i)?i:""})}}))}}let a=vscode_uri_1.URI.parse(s.uri).fsPath,l=utils_1.hx.getProject(a);if(!l)return r;a=l.sourceRoot;let c=path.join(a,"pages.json");if(fs.existsSync(c)){let e;try{e=jsonc_1.jsonc.readSync(c)}catch(e){return console.error(e),r}let t={autoscan:!0,custom:{}};if(e.easycom)for(let s in t)s in e.easycom&&(t[s]=e.easycom[s]);let i=t.custom;for(let e in i){let t=i[e];if("string"!=typeof t)continue;let n=collectRuleRegexGroups(e),o=buildGroupMappings(t,n),a=t;if(n.forEach(((t,s)=>{let i=e.substring(t.start,t.end);a=a.replace(new RegExp("\\$"+s,"g"),i)})),a.startsWith("@/")){scanAllEasycomByCustomRule(a.substr(2),e,t.substr(2),n,o,s).forEach((e=>{r.push(e)}))}else{scanAllEasycomByCustomRule("node_modules/"+a,e,"node_modules/"+t,n,o,s).forEach((e=>{r.push(e)}))}}if(t.autoscan){scanComponents(path.join(a,"components")).forEach((e=>{r.push(e)}));let e=path.join(a,"uni_modules");if(fs.existsSync(e)){let t=fs.readdirSync(e);for(let s of t){scanComponents(path.join(e,s,"components")).forEach((e=>{r.push(e)}))}}}}let u=new Map;r.forEach((e=>{u.set(`${e.name}@${e.filePath}`,e)}));let f=[];return u.forEach(((e,t)=>{f.push(e)})),f}function parseVuePageInstanceOptions(e,t){if(!t)return;let s=t.roots.find((e=>"script"===e.tag));if(s){let t={options:[]},i=e.positionAt(s.startTagEnd),n=e.positionAt(s.endTagStart),r=e.getText({start:i,end:n}),o=ts.createSourceFile(e.uri,r,ts.ScriptTarget.Latest,!0,ts.ScriptKind.TS);t.sourceFile=o;let a=o.statements.find(ts.isExportAssignment);if(a){let e=a.jsDoc;e&&e.length>0&&(t.vuedoc=e[0]);let s=a.expression;if(s&&ts.isObjectLiteralExpression(s)){s.properties.forEach((e=>{if(e&&e.kind==ts.SyntaxKind.PropertyAssignment){let s=e;t.options.push(s)}}))}}return t}}function fetchVueComponentInfo(e){if(!fs.existsSync(e))return;let t=(0,vscode_html_languageservice_1.getLanguageService)(),s=vscode_languageserver_textdocument_1.TextDocument.create(e,"html",1,fs.readFileSync(e).toString()),i=parseVuePageInstanceOptions(s,t.parseHTMLDocument(s));if(i){let t=new Map,s=new Map,n={filePath:e,properties:[],events:[]};if(i.options.length>0){let e=i.options.find((e=>{var t;return"props"===(null===(t=e.name)||void 0===t?void 0:t.getText())}));if(e){let s=e.initializer;if(ts.isObjectLiteralExpression(s)){s.properties.forEach((e=>{var s;let i=null===(s=e.name)||void 0===s?void 0:s.getText();if(i){let s=e.initializer,n="";if(ts.isIdentifier(s))n=s.getText();else if(ts.isObjectLiteralExpression(s)){let e=s.properties.find((e=>{var t;return"type"===(null===(t=e.name)||void 0===t?void 0:t.getText())}));e&&(n=e.initializer.getText())}t.set(i,{name:i,type:n})}}))}}let n=i.options.find((e=>{var t;return"emits"===(null===(t=e.name)||void 0===t?void 0:t.getText())}));if(n){let e=n.initializer;if(e&&ts.isArrayLiteralExpression(e)){e.elements.forEach((e=>{if(ts.isStringLiteral(e)){let t=e.text;s.set(t,{name:t,description:""})}}))}}}let r=i.vuedoc;if(r){let e,i,o=r.comment;if(r.tags){let n;for(let a of r.tags){let r=a.tagName.getText();if("description"!==r){if("tutorial"===r)e=a.comment;else if("property"===r){let e=a.comment;if(e){let s=/\s*{(.*)}\s+(\w+)\s*=\s*\[(.*)\]\s+(.*)/.exec(e);if(s){let e=s[1],i=s[2],r=s[3],o=s[4],a=new Map;r.split("|").forEach((e=>{a.set(e,{value:e})})),t.set(i,{name:i,type:e,description:o,values:a}),n=i}else{let s=/\s*{(.*)}\s+(\w+)\s+(.*)/.exec(e);if(s){let e=s[1],i=s[2],r=s[3];t.set(i,{name:i,type:e,description:r}),n=i}}}}else if("value"===r){let e=a.comment;if(e&&n&&t.has(n)){let s=/\s*(\w+)\s+(.*)/.exec(e);if(s){let e=s[1],i=s[2],r=t.get(n);r.values||(r.values=new Map),r.values.set(e,{value:e,description:i})}}}else if("event"===r){let e=a.comment;if(e){let t=/\s*{(.*)}\s+(\w+)\s+(.*)/.exec(e);if(t){t[1];let e=t[2],i=t[3];s.set(e,{name:e,description:i})}}}else"example"===r&&(i=a.comment);"property"!=r&&"value"!=r&&(n=void 0)}else o=a.comment}}n.description=o,n.example=i,n.tutorial=e}return t.forEach((e=>{var t;null===(t=n.properties)||void 0===t||t.push(e)})),s.forEach((e=>{var t;null===(t=n.events)||void 0===t||t.push(e)})),n}}exports.collectEasycoms=collectEasycoms,exports.fetchVueComponentInfo=fetchVueComponentInfo;