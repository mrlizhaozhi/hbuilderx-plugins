"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TsServerHTMLPlugin=void 0;const tsserverlibrary_1=require("typescript/lib/tsserverlibrary"),vscode_css_languageservice_1=require("vscode-css-languageservice"),vscode_html_languageservice_1=require("vscode-html-languageservice"),core_1=require("../../../core"),styleservice_1=require("../../../styleservice"),HTMLData_1=require("./HTMLData"),HTMLDataProvider_1=require("./HTMLDataProvider"),HTMLScriptCache_1=require("./HTMLScriptCache"),HTMLAdditionalPlugin_1=require("./lspHtmlPlugin/HTMLAdditionalPlugin"),HTMLIdAndClassPlugin_1=require("./lspHtmlPlugin/HTMLIdAndClassPlugin"),plugins_1=require("./plugins"),domtypechecker_1=require("./TsServerHTMLPluginModes/domtypechecker"),TsCssMode_1=require("./TsServerHTMLPluginModes/TsCssMode"),TsHtmlMode_1=require("./TsServerHTMLPluginModes/TsHtmlMode"),TsJavaScriptMode_1=require("./TsServerHTMLPluginModes/TsJavaScriptMode");function isHTMLFile(e){return e.endsWith(".html")||e.endsWith(".htm")||e.endsWith(".shtml")||e.endsWith(".shtm")||e.endsWith(".xhtml")||e.endsWith(".xht")||e.endsWith(".hta")||e.endsWith(".cshtml")||e.endsWith(".jsp")||e.endsWith(".erb")||e.endsWith(".nview")||e.endsWith(".tpl")}function htmlVirtualToRealityFromRange(e,t,n,i){if("html"===n)return i;const r=e.getUpToDateInfo(t);if(!r)return;let s=r.getEmbeddedDocument(n);if(!i)return;let o=s.positionAt(i.start),a=r.htmlDocument.offsetAt(o),l={start:i.start,length:i.length};return l.start=a,l}function create(e){let t=e.languageService;const n=Object.create(null);for(let e of Object.keys(t)){const i=t[e];n[e]=(...e)=>i.apply(t,e)}let i=(0,vscode_html_languageservice_1.getLanguageService)({}),r=[];r.push(new HTMLDataProvider_1.HTMLDataProvider("html5",HTMLData_1.htmlData)),i.setDataProviders(!1,r);let s=e.tsinfo.languageServiceHost;const o=s.getScriptKind.bind(s),a=s.getScriptSnapshot.bind(s),l=new Map,c=new HTMLScriptCache_1.HTMLScriptCache(e.ts,i,{getScriptVersion:e=>s.getScriptVersion(e),getScriptSnapshot(t){if(t.endsWith(".html")&&(t.includes(".vue.")||t.includes(".nvue."))){if(l.has(t)){let n=e.tsinfo.serverHost.readFile(t);return e.ts.ScriptSnapshot.fromString(n)}l.set(t,!0)}return a(t)}});s.getScriptKind=function(e){return isHTMLFile(e)?c.getScriptKind(e):o(e)},s.getScriptSnapshot=e=>isHTMLFile(e)?c.getScriptSnapshot(e):a(e);let u=(0,plugins_1.enablePluginProxy)({languageService:i,project:e.project}),f=[];f.push(new HTMLAdditionalPlugin_1.HTMLAdditionalPlugin(e,r)),f.push(new HTMLIdAndClassPlugin_1.HTMLIdAndClassPlugin(e,new plugins_1.HtmlIdClassProvider(c))),f.forEach((t=>{u=t.create({languageService:u,project:e.project})}));const p=new Map;p.set("javascript",new TsJavaScriptMode_1.JavaScriptEmbedMode(e,c)),p.set("html",new TsHtmlMode_1.HtmlEmbedMode(e,c,u));let g=new Map;g.set("css",(0,vscode_css_languageservice_1.getCSSLanguageService)()),g.set("scss",(0,vscode_css_languageservice_1.getSCSSLanguageService)()),g.set("less",(0,vscode_css_languageservice_1.getLESSLanguageService)());let d=[new styleservice_1.CSSDataProvider(styleservice_1.cssData)],m=new Map;g.forEach(((e,t)=>{e.setDataProviders(!1,d),m.set(t,d)}));let h=(0,styleservice_1.styleEnablePluginProxy)({styleLanguageServiceList:g,project:e.project});function S(e,t){const n=c.getUpToDateInfo(e);if(!n)return;let i=n.htmlDocument.positionAt(t),r=n.getLanguageAtPosition(i);if(!r)return;let s=p.get(r);if(!s)return;let o=t,a=n.htmlDocument.positionAt(t);if("css"===r){o=n.getEmbeddedDocument("css").offsetAt(a)}else if("javascript"===r){o=n.getEmbeddedDocument("javascript").offsetAt(a)}return{modeLang:r,modeOffset:o,modeServer:s}}function v(e,t,n){return e=e.map((e=>(e.spans=e.spans.map((e=>{let i=htmlVirtualToRealityFromRange(c,t,n,e);return i&&(e=i),e})),e.nameSpan=htmlVirtualToRealityFromRange(c,t,n,e.nameSpan),e.childItems&&(e.childItems=v(e.childItems,t,n)),e))),e}function T(e,t,n){return e.childItems?(e.childItems=v(e.childItems,t,n),e):e}function M(e,t){return e=e.map((e=>{if("script"===e.text){if(e.spans.length<1)return e;if(e.childItems||(e.childItems=[]),!t.childItems||t.childItems.length<1)return e;t.childItems.forEach((t=>{var n;let i=t.spans[0],r=i.start,s=r+i.length;e.spans[0].start<r&&e.spans[0].start+e.spans[0].length>s&&(null===(n=e.childItems)||void 0===n||n.push(t))}))}else e.childItems&&e.childItems.length>0&&(e.childItems=M(e.childItems,t));return e})),e}function I(e,t){return e.forEach((e=>{if("style"===e.text){if(e.spans.length<1)return;if(e.childItems||(e.childItems=[]),!t.childItems||t.childItems.length<1)return;t.childItems.forEach((t=>{var n;let i=t.spans[0],r=i.start,s=r+i.length;e.spans[0].start<r&&e.spans[0].start+e.spans[0].length>s&&(null===(n=e.childItems)||void 0===n||n.push(t))}))}else e.childItems&&e.childItems.length>0&&I(e.childItems,t)})),e}function D(e,t,n){return e?("javascript"===n&&e.childItems?e.childItems=M(e.childItems,t):"css"===n&&e.childItems&&(e.childItems=I(e.childItems,t)),e):t}g=new styleservice_1.StyleExtraPluginModule(e,m,r).create({styleLanguageServiceList:h,project:e.project}),p.set("css",new TsCssMode_1.CssEmbedMode(e,c,h)),n.getCompletionsAtPosition=function(n,i,r){if(isHTMLFile(n)){if(!e.tsinfo.project.getScriptInfo(n))return;if(!c.getUpToDateInfo(n))return;let s=S(n,i);if(!s)return;let o=s.modeOffset,a=s.modeLang,l=s.modeServer.getCompletionsAtPosition(t,n,o,r);if(!l)return;let u,f,p=[],g=[];return l.entries.forEach((e=>{p.includes(e.name)||(p.push(e.name),g.push(e))})),l.entries=g,l.entries.forEach((e=>{u?((0,core_1.isSameTextSpan)(u,e.replacementSpan)||(u=e.replacementSpan,f=htmlVirtualToRealityFromRange(c,n,a,e.replacementSpan)),e.replacementSpan=f):(u=e.replacementSpan,f=htmlVirtualToRealityFromRange(c,n,a,e.replacementSpan),e.replacementSpan=f)})),l}return t.getCompletionsAtPosition(n,i,r)},n.getCompletionEntryDetails=function(n,i,r,s,o,a,l){if(isHTMLFile(n)){if(!e.tsinfo.project.getScriptInfo(n))return;if(!c.getUpToDateInfo(n))return;let u=S(n,i);if(!u)return;let f=u.modeOffset,p=u.modeServer.getCompletionEntryDetails(t,n,f,r,s,o,a,l);return p&&(p.codeActions=void 0,p.source=p.sourceDisplay=void 0),p}return t.getCompletionEntryDetails(n,i,r,s,o,a,l)},n.getQuickInfoAtPosition=function(n,i){if(isHTMLFile(n)){if(!e.tsinfo.project.getScriptInfo(n))return;if(!c.getUpToDateInfo(n))return;let r=S(n,i);if(!r)return;let s=r.modeOffset;return r.modeServer.getQuickInfoAtPosition(t,n,s)}return t.getQuickInfoAtPosition(n,i)},n.getSignatureHelpItems=function(n,i,r){if(isHTMLFile(n)){if(!e.tsinfo.project.getScriptInfo(n))return;if(!c.getUpToDateInfo(n))return;let s=S(n,i);if(!s)return;let o=s.modeOffset;return s.modeServer.getSignatureHelpItems(t,n,o,r)}return t.getSignatureHelpItems(n,i,r)},n.getDefinitionAndBoundSpan=function(n,i){var r;if(isHTMLFile(n)){if(!e.tsinfo.project.getScriptInfo(n))return;if(!c.getUpToDateInfo(n))return;let s=S(n,i);if(!s)return;let o=s.modeOffset,a=s.modeLang,l=s.modeServer.getDefinitionAndBoundSpan(t,n,o);if(!l)return;if(!l.definitions||0===l.definitions.length)return;if(l.textSpan=null!==(r=htmlVirtualToRealityFromRange(c,n,a,l.textSpan))&&void 0!==r?r:l.textSpan,"javascript"===a){let e=[];return l.definitions.forEach((t=>{if(t.fileName!==n)return void e.push(t);if(t.unverified)return void e.push(t);let i=htmlVirtualToRealityFromRange(c,n,a,t.textSpan);i&&e.push({kind:tsserverlibrary_1.ScriptElementKind.unknown,name:t.name,containerKind:tsserverlibrary_1.ScriptElementKind.unknown,containerName:"",textSpan:i,fileName:n})})),{textSpan:l.textSpan,definitions:e}}return l}return t.getDefinitionAndBoundSpan(n,i)};let H={getNavigationTree:function(n){let i,r=c,s={text:"",kind:e.ts.ScriptElementKind.alias,kindModifiers:"",spans:[],nameSpan:void 0};return e.tsinfo.project.getScriptInfo(n)&&r.getUpToDateInfo(n)?(["html","javascript","css"].forEach((e=>{let r=p.get(e);if(!r)return;let s=r.getNavigationTree(t,n,u);s&&s.childItems&&("html"!==e&&(s=T(s,n,e)),i=D(i,s,e))})),i||s):s},isHTMLFile:isHTMLFile};function L(e,t){if(!e.scriptDocument||!t)return t;let n=e.scriptDocument.positionAt(t.start);return{start:e.htmlDocument.offsetAt(n),length:t.length}}return e.html=H,n.getNavigationTree=function(e){return H.isHTMLFile(e)?H.getNavigationTree(e):t.getNavigationTree(e)},n.toLineColumnOffset=function(e,n){if(H.isHTMLFile(e)){let t=c.getUpToDateInfo(e);if(t){let e=t.htmlDocument.positionAt(n);return{line:e.line,character:e.character}}}return t.toLineColumnOffset(e,n)},n.getSyntacticDiagnostics=function(n){let i=(0,core_1.getConfigurationValue)(e.tsinfo.project.projectService.getHostPreferences(),"javascript.validate.enable",!1);if(isHTMLFile(n)){let e=c.getUpToDateInfo(n);if(e&&i){let i=t.getSyntacticDiagnostics(n),r=e.scriptDocument;if(r){let t=[];return i.forEach((n=>{let i=r.positionAt(n.start-1);t.push({...n,start:e.htmlDocument.offsetAt(i)+1})})),t}}return[]}return t.getSyntacticDiagnostics(n)},n.getSemanticDiagnostics=function(n){let i=(0,core_1.getConfigurationValue)(e.tsinfo.project.projectService.getHostPreferences(),"javascript.validate.enable",!1);if(isHTMLFile(n)){let e=c.getUpToDateInfo(n);if(e&&i){let i=t.getSemanticDiagnostics(n),r=e.scriptDocument;if(r){let t=[];return i.forEach((n=>{if(n.start){let i=r.positionAt(n.start-1);t.push({...n,start:e.htmlDocument.offsetAt(i)+1})}else t.push({...n})})),t}}return[]}return t.getSemanticDiagnostics(n)},n.getSuggestionDiagnostics=function(n){let i=(0,core_1.getConfigurationValue)(e.tsinfo.project.projectService.getHostPreferences(),"javascript.validate.enable",!1);if(isHTMLFile(n)){let e=c.getUpToDateInfo(n);if(e&&i){let i=t.getSuggestionDiagnostics(n),r=e.scriptDocument;if(r){let t=[];return i.forEach((n=>{let i=r.positionAt(n.start-1);t.push({...n,start:e.htmlDocument.offsetAt(i)+1})})),t}}return[]}return t.getSuggestionDiagnostics(n)},n.findReferences=function(e,n){if(isHTMLFile(e)){let i=c.getUpToDateInfo(e);if(i){if(i.scriptDocument){let r=[],s=function(e,t){if(!e.scriptDocument)return t;let n=e.htmlDocument.positionAt(t);return e.scriptDocument.offsetAt(n)}(i,n),o=t.findReferences(e,s);return null==o||o.forEach((t=>{t.definition.fileName===e&&(t.definition={...t.definition,contextSpan:L(i,t.definition.contextSpan),originalContextSpan:L(i,t.definition.originalContextSpan),textSpan:L(i,t.definition.textSpan)}),t.references=t.references.map((t=>{t.fileName;return t.fileName===e&&(t.textSpan=L(i,t.textSpan),t.contextSpan=L(i,t.contextSpan),t.originalContextSpan=L(i,t.originalContextSpan)),t})),r.push(t)})),r}}}return t.findReferences(e,n)},n}const TsServerHTMLPlugin={create:create,createTypeCheckerPlugins:e=>[new domtypechecker_1.default(e,isHTMLFile)]};exports.TsServerHTMLPlugin=TsServerHTMLPlugin;