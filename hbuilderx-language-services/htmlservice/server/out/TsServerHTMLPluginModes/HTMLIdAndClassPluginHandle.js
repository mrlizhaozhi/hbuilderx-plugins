"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TsHtmlIdClassDefinitionHandle=exports.TsHtmlIdClassCompletionHandle=void 0;const path=require("path"),vscode_css_languageservice_1=require("vscode-css-languageservice"),vscode_html_languageservice_1=require("vscode-html-languageservice"),vscode_uri_1=require("vscode-uri"),core_1=require("../../../../core"),plugins_1=require("../plugins");function getEmbedCssData(e){let t;t="less"===e.languageId?(0,vscode_css_languageservice_1.getLESSLanguageService)().parseStylesheet(e):"scss"===e.languageId?(0,vscode_css_languageservice_1.getSCSSLanguageService)().parseStylesheet(e):(0,vscode_css_languageservice_1.getCSSLanguageService)().parseStylesheet(e);let s=[""],a=[""],n=[];return t.accept((e=>{if(e.type===core_1.NodeType.ClassSelector){let t=e.getText();s.includes(t.replace(".",""))||(s.push(t.replace(".","")),n.push({text:t.replace(".",""),type:"class",offset:e.offset,length:e.length}))}else if(e.type===core_1.NodeType.IdentifierSelector){let t=e.getText();a.includes(t.replace("#",""))||(a.push(t.replace("#","")),n.push({text:t.replace("#",""),type:"id",offset:e.offset,length:e.length}))}else e.type,core_1.NodeType.HexColorValue;return!0})),n}class TsHtmlIdClassCompletionHandle{constructor(e,t,s){this.ls=e,this.allInfo=t,this.cssAndSourceData=s,this.cssLanguageServer=(0,vscode_css_languageservice_1.getCSSLanguageService)()}doExtraCompletion(e,t,s,a){let n=this.ls.getLocationInfoAtPosition(t,s,a);if(!n)return e;if(!n.activeAttribute)return e;if(n.kind===plugins_1.LocationInfoKind.AttributeValue)e=this.addCssIdCompletion(e,t,s,n),e=this.addCssClassCompletion(e,t,s,n);return e}addCssIdCompletion(e,t,s,a){if("id"!==a.activeAttribute)return e;let n=this.cssAndSourceData.getEmbedCssDocument(t);if(!n)return e;let i=this.cssAndSourceData.getSourceDocument(t);if(!i)return e;let o=[];n.forEach((e=>{o=o.concat(getEmbedCssData(e.document))}));let r=[""],c=[];o.forEach((e=>{"id"===e.type&&(r.includes(e.text)||(r.push(e.text),c.push(e)))}));const l=t.offsetAt(s),u=(0,core_1.getContextData)(t,l,void 0),d=i.uri;return c.forEach((t=>{const s=vscode_uri_1.URI.file(d);e.items.push({label:t.text,kind:vscode_html_languageservice_1.CompletionItemKind.Property,detail:t.text,documentation:`定义于\n                [${path.basename(s.fsPath)}](${s.fsPath})`,textEdit:vscode_html_languageservice_1.TextEdit.replace(u.contextRange,t.text),data:{data:void 0,hxKind:core_1.HxIconKind.ID,detail:t.text,documentation:`定义于\n                    [${path.basename(s.fsPath)}](${s.fsPath})`}})})),e}addCssClassCompletion(e,t,s,a){if("class"!==a.activeAttribute)return e;let n=this.cssAndSourceData.getEmbedCssDocument(t);if(!n)return e;let i=this.cssAndSourceData.getSourceDocument(t);if(!i)return e;let o=[];n.forEach((e=>{o=o.concat(getEmbedCssData(e.document))}));let r=[""],c=[];o.forEach((e=>{"class"===e.type&&(r.includes(e.text)||(r.push(e.text),c.push(e)))}));const l=t.offsetAt(s),u=(0,core_1.getContextData)(t,l,void 0),d=i.uri;return c.forEach((t=>{const s=vscode_uri_1.URI.file(d);e.items.push({label:t.text,kind:vscode_html_languageservice_1.CompletionItemKind.Property,detail:t.text,documentation:`定义于\n                [${path.basename(s.fsPath)}](${s.fsPath})`,textEdit:vscode_html_languageservice_1.TextEdit.replace(u.contextRange,t.text),data:{data:void 0,hxKind:core_1.HxIconKind.CLASS,detail:t.text,documentation:`定义于\n                    [${path.basename(s.fsPath)}](${s.fsPath})`}})})),e}}exports.TsHtmlIdClassCompletionHandle=TsHtmlIdClassCompletionHandle;class TsHtmlIdClassDefinitionHandle{constructor(e,t,s){this.ls=e,this.allInfo=t,this.cssAndSourceData=s,this.cssLanguageServer=(0,vscode_css_languageservice_1.getCSSLanguageService)()}doExtraDefinition(e,t,s,a){let n=this.ls.getLocationInfoAtPosition(t,s,a);if(!n)return e;if(!n.activeAttribute)return e;if(e||(e=[]),n.kind===plugins_1.LocationInfoKind.AttributeValue)e=this.getDefinitionFromClass(e,t,s,n);return e}getDefinitionFromClass(e,t,s,a){if("vue"!==t.languageId)return e;let n=this.cssAndSourceData.getEmbedCssDocument(t);if(!n||0===n.length)return e;let i=[],o=[""],r=[];const c=t.offsetAt(s),l=(0,core_1.getContextData)(t,c,void 0);let u=l.context,d=l.contextRange;return n.forEach((t=>{t.sourceMap&&(i=i.concat(getEmbedCssData(t.document)),0!==i.length&&(i.forEach((e=>{"class"===e.type&&(o.includes(e.text)||(o.push(e.text),r.push(e)))})),r.forEach((s=>{if(!s.offset||!s.length)return;if(s.text!==u)return;let a=t.document.positionAt(s.offset),n=t.document.positionAt(s.offset);n.character=n.character+s.length;let i={start:a,end:n},o={targetUri:t.document.uri,targetRange:i,targetSelectionRange:i,originSelectionRange:d};e.unshift(o)}))))})),e}}exports.TsHtmlIdClassDefinitionHandle=TsHtmlIdClassDefinitionHandle;