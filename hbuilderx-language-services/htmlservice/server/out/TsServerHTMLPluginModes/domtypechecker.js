"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_html_languageservice_1=require("vscode-html-languageservice");class DomCheckerPlugin{constructor(e,t){this.info=e,this.isHTML=t}checkExpression(e,t,i,n,r,s){var l,a;let o=null===(l=n.getSourceFile())||void 0===l?void 0:l.fileName;if(!o||!this.isHTML(o))return;let g=this.info.tsinfo.project.getScriptInfo(o);if(!g)return;let u=(0,vscode_html_languageservice_1.getLanguageService)({}),f=g.getSnapshot().getText(0,g.getSnapshot().getLength()),c=vscode_html_languageservice_1.TextDocument.create(o,"html",0,f),h=u.parseHTMLDocument(c);if(n.kind===this.info.ts.SyntaxKind.PropertyAccessExpression){if((null===(a=n.parent)||void 0===a?void 0:a.kind)===this.info.ts.SyntaxKind.CallExpression){let e=i.defaultCheckExpression(n,r,s),t=i.getSignaturesOfType(e,this.info.ts.SignatureKind.Call);return t&&t.forEach((e=>{var t;let r=e.getReturnType();if(r&&"HTMLElement"===(null===(t=r.symbol)||void 0===t?void 0:t.escapedName)||r.getProperty("getElementsByTagName")){let t=n.parent,r=t.getFullText(n.getSourceFile()),s="";if(r.indexOf(".getElementById")>0){let e=m(t.arguments);e&&e.kind==this.info.ts.SyntaxKind.StringLiteral&&(s=e.text)}else if(r.indexOf(".querySelector")){let e=m(t.arguments);if(e&&e.kind==this.info.ts.SyntaxKind.StringLiteral){let t=e.text;t&&t.startsWith("#")&&(s=t.substring(1))}}if(null==s||0==s.length)return;let l="";if(d(null==h?void 0:h.roots,(e=>{if(e.attributes&&e.attributes.id){let t=e.attributes.id;if((t.startsWith('"')&&t.startsWith('"')||t.startsWith("'")&&t.startsWith("'"))&&(t=t.substring(1,t.length-1)),t===s&&e.tag)return l=e.tag,!1}return!0})),l&&l.length>0){l=l.toLowerCase();let t={a:"Link",img:"Image",li:"LI",ul:"UList",textarea:"TextArea",p:"Paragraph",ol:"OList",iframe:"IFrame",hr:"HR",br:"BR"};if(t[l])l=t[l];else{let e=l[0].toUpperCase();l=e+l.substring(1)}let r=i.getSymbolsInScope(n,this.info.ts.SymbolFlags.Interface|this.info.ts.SymbolFlags.Class).find((e=>e.escapedName===`HTML${l}Element`));r&&(e.resolvedReturnType=i.getDeclaredTypeOfSymbol(r))}}})),e}}return;function d(e,t){if(e&&e.length>0)for(let i=0;i<e.length;i++)t(e[i])&&d(e[i].children,t)}function m(e){if(e&&e.length>0)return e[0]}}}exports.default=DomCheckerPlugin;