"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.HTMLScriptCache=exports.HTMLEmbedsCacheInfo=void 0;const vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),core_1=require("../../../core"),embeddedSupport_1=require("./modes/embeddedSupport");class HTMLEmbedsCacheInfo{constructor(t,e,s,r){this._version=s,this._scriptLanguageId=e.scriptLanguageId,this._regions=e,this._tsImpl=r,this._scriptSnapshot=void 0,this._htmlDocument=t}get scriptDocument(){return this._regions.getEmbeddedDocument(this.scriptLanguageId,!1)}get htmlDocument(){return this._htmlDocument}get scriptLanguageId(){return this._scriptLanguageId?this._scriptLanguageId:"javascript"}get scriptSnapshot(){if(this._scriptSnapshot)return this._scriptSnapshot;let t=this.getEmbeddedDocument(this.scriptLanguageId,!1).getText(),e=this._regions.getImportedScripts();if(e&&e.length>0){let s=[""];e.forEach((t=>{t&&t.length>0&&s.push(`require("./${t}")`)})),t+=s.join("\n")}let s=this._tsImpl.ScriptSnapshot.fromString(t);return this._scriptSnapshot=s}get version(){return this._version}getLanguageAtPosition(t){return this._regions.getLanguageAtPosition(t)}getEmbeddedDocument(t,e){return this._regions.getEmbeddedDocument(t,e)}}exports.HTMLEmbedsCacheInfo=HTMLEmbedsCacheInfo;class HTMLScriptCache{constructor(t,e,s){this.tsImpl=t,this.tsServerHost=s,this.cache=new Map,this.htmlLanguageService=e}getScriptKind(t){let e=this.getUpToDateInfo(t);return e?"typescript"===e.scriptLanguageId?this.tsImpl.ScriptKind.TS:this.tsImpl.ScriptKind.JS:this.tsImpl.ScriptKind.Unknown}getScriptSnapshot(t){let e=this.getUpToDateInfo(t);if(e)return e.scriptSnapshot}fileInCache(t){if(t=(0,core_1.toNormalizedPath)(t,this.tsImpl),this.cache.size<1)return!1;for(let e of this.cache.keys())if(e===t)return!0;return!1}getSourceFileFromEmbeddedFileName(t){let e=this.getUpToDateInfo(t);if(e)return e.htmlDocument}getUpToDateInfo(t){let e=this.cache.get(t),s=this.tsServerHost.getScriptVersion(t);if((null==e?void 0:e.version)===s)return e;let r=this.tsServerHost.getScriptSnapshot(t);if(!r)return;let i=r.getText(0,r.getLength()),n=vscode_languageserver_textdocument_1.TextDocument.create(t,"html",0,i),o=(0,embeddedSupport_1.getDocumentRegions)(this.htmlLanguageService,n),c=new HTMLEmbedsCacheInfo(n,o,s,this.tsImpl);return this.cache.set(t,c),c}getTsImpl(){return this.tsImpl}}exports.HTMLScriptCache=HTMLScriptCache;