"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getHtmlModeExt=exports.ModeExtension=void 0;const vscode_html_languageservice_1=require("vscode-html-languageservice"),fs=require("fs"),path=require("path"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_languageserver_types_1=require("vscode-languageserver-types"),vscode_uri_1=require("vscode-uri"),entry_1=require("../../../../cssservice/entry"),serverinterface_1=require("../../../../serverinterface"),utils_1=require("../../../../utils"),strings_1=require("../utils/strings"),easycomService=require("../vue/easycomService"),interpolationService=require("../vue/interpolationService"),vueScanner_1=require("../vue/vueScanner"),vueModifierData_1=require("./dataprovider/vueModifierData"),dataProviderUtils_1=require("./utils/dataProviderUtils"),utils_2=require("../../../../utils"),customDirectives_1=require("./customDirectives");let iconKindMap=new Map;var ModeExtension;iconKindMap.set(vscode_html_languageservice_1.CompletionItemKind.Property,utils_2.HxIconKind.ELEMENT),iconKindMap.set(vscode_html_languageservice_1.CompletionItemKind.Value,utils_2.HxIconKind.ATTRIBUTE),iconKindMap.set(vscode_html_languageservice_1.CompletionItemKind.Function,utils_2.HxIconKind.EVENT),iconKindMap.set(vscode_html_languageservice_1.CompletionItemKind.Unit,utils_2.HxIconKind.ATTRIBUTE),function(e){e.VueEventPrefix="[event]"}(ModeExtension=exports.ModeExtension||(exports.ModeExtension={}));const dotCharCode=".".charCodeAt(0),vueModifierProvider=(0,vueModifierData_1.getModifierProvider)();var VueDirectiveType;!function(e){e[e.Empty=0]="Empty",e[e.String=1]="String",e[e.Event=2]="Event",e[e.Attribute=3]="Attribute"}(VueDirectiveType||(VueDirectiveType={}));const selfColsingTags=["br","hr","img","link","base","area","input","source"];function vueDirectiveType(e){return"v-on"==e||"@"==e?VueDirectiveType.Event:"v-bind"==e||":"==e?VueDirectiveType.Attribute:"v-pre"==e||"v-cloak"==e||"v-once"==e||"v-else"==e?VueDirectiveType.Empty:VueDirectiveType.String}function checkVueBindOrOnDirective(e){return e.startsWith("v-on:")?"v-on":e.startsWith("@")?"@":e.startsWith("v-bind:")?"v-bind":e.startsWith(":")?":":e.startsWith("v-model")?"v-model":""}function getWordStart(e,t,n){for(;t>n&&!strings_1.whiteSpaceCharCode.includes(e.charCodeAt(t-1));)t--;return t}function getWordEnd(e,t,n){for(;t<n&&!strings_1.whiteSpaceCharCode.includes(e.charCodeAt(t));)t++;return t}function getModifierRange(e,t,n){let i=t,r=t;for(;i>n.start&&e.charCodeAt(i-1)!==dotCharCode;)i--;for(;r<n.end&&e.charCodeAt(r)!==dotCharCode;)r++;return{start:i,end:r}}function isFollowedBy(e,t,n,i){for(var r=(0,vueScanner_1.createScanner)(e,t,n),o=r.scan();o===vueScanner_1.TokenType.Whitespace;)o=r.scan();return o===i}class HTMLLanguageServiceExt{constructor(e,t,n,i){var r;this.vueEnable=!1,this.service=e,this.workspace=n,this.dataProviders=[],this.vueDirectives=new Set,this.vueEnable=null!==(r=null==i?void 0:i.vueEnable)&&void 0!==r&&r,this.htmlDocuments=t}getRootFolder(e){for(let t of this.workspace.folders){let n=t.uri;if((0,strings_1.endsWith)(n,"/")||(n+="/"),(0,strings_1.startsWith)(e,n))return t}}getClassText(e,t,n,i){let r=i>n?-1:e.slice(i,n).search(/\s/),o=t,a=-1==r?n:r+i;for(let n=i-1;n>=t;n--)if(""===e.charAt(n).trimLeft()){o=n+1;break}return{start:o,end:a}}getStyleTagContents(e,t){var n,i;let r=[],o=[...t.roots];for(;o.length>0;){let t=o.splice(0,1)[0];if("style"===t.tag){let o=null!==(i=null===(n=t.attributes)||void 0===n?void 0:n.lang)&&void 0!==i?i:"css";"'"!=o[0]&&'"'!=o[0]||(o=o.slice(1,-1));const a=t.startTagEnd?t.startTagEnd:t.start;let s=e.positionAt(a),l=e.positionAt(t.endTagStart?t.endTagStart:t.end);const c=e.getText({start:s,end:l});let d=vscode_languageserver_textdocument_1.TextDocument.create(e.uri,o,1,c);r.push({offset:a,document:d})}o.push(...t.children)}return r}getTextDocument(e,t=""){var n;const i=vscode_uri_1.URI.file(e).toString();let r=null===(n=this.documents)||void 0===n?void 0:n.get(i);return r||(r=vscode_languageserver_textdocument_1.TextDocument.create(i,t,1,fs.readFileSync(e,{encoding:"utf-8"}))),r}async findCssClass(e,t,n){let i=this.getRootFolder(e.uri);if(!i)return null;const r=vscode_html_languageservice_1.Range.create(e.positionAt(n.start),e.positionAt(n.end));let o={text:e.getText(r),type:serverinterface_1.SymbolType.StyleClass};const a=async(e,t)=>{t||(t=this.htmlDocuments.get(e));let n=this.getStyleTagContents(e,t);for(let t=0;t<n.length;t++){let a=n[t],s=(0,entry_1.getExtraServer)(a.document).getLanguageServiceExt();if(s&&s.findSymbol){let t=await s.findSymbol(a.document,o,i),n=(t instanceof Array?t:[t]).map((t=>{if(t.uri==a.document.uri){t.uri=e.uri;let n=a.document.offsetAt(t.range.start)+a.offset,i=a.document.offsetAt(t.range.end)+a.offset;t.range=vscode_html_languageservice_1.Range.create(e.positionAt(n),e.positionAt(i))}return vscode_html_languageservice_1.LocationLink.create(t.uri,t.range,t.range,r)}));if(n.length>0)return n}}return[]};o.sourceDocument=e;let s=await a(e,t);if(s.length>0)return s;if(this.vueEnable&&"vue"===e.languageId){let e=vscode_uri_1.URI.parse(i.uri).fsPath,t="";if((0,utils_1.isUniAppCli)(e)?t=path.join(e,"src","App.vue"):(0,utils_1.isUniAppVue)(e)&&(t=path.join(e,"App.vue")),t&&fs.existsSync(t)){let e=this.getTextDocument(t,"vue");return o.sourceDocument=e,a(e)}return null}if("html"==e.languageId||"html_es6"==e.languageId||e.uri.endsWith(".html")){let e=(0,entry_1.getExtraServer)("css").getLanguageServiceExt();if(e&&e.findSymbol){let t=await e.findSymbol(vscode_languageserver_textdocument_1.TextDocument.create("temp.css","css",1,""),o,i);return(t instanceof Array?t:[t]).map((e=>vscode_html_languageservice_1.LocationLink.create(e.uri,e.range,e.range,r)))}}return null}findDefinition(e,t,n){var i;let r=e.offsetAt(t),o=n.findNodeAt(r);if(!o)return Promise.resolve(null);const a=this.getRootFolder(e.uri);let s=r,l=e.getText(),c=-1;const d=(0,vueScanner_1.createScanner)(l,o.start);let u=d.scan(),v="";for(;u!==vueScanner_1.TokenType.EOS&&d.getTokenOffset()<=s;){switch(u){case vueScanner_1.TokenType.StartTag:case vueScanner_1.TokenType.EndTag:if(r>=d.getTokenOffset()&&r<=d.getTokenEnd()){let t=d.getTokenText(),i=easycomService.collectEasycoms(e,n,a).find((e=>e.name==t));if(i&&i.filePath){let e={uri:vscode_uri_1.URI.file(i.filePath).toString(),range:{start:{line:0,character:0},end:{line:0,character:0}}};return Promise.resolve(e)}}break;case vueScanner_1.TokenType.StartInterpolation:c=d.getTokenEnd(),s=Math.max(r,null!==(i=o.endTagStart)&&void 0!==i?i:o.end);break;case vueScanner_1.TokenType.EndInterpolation:if(-1!=c&&d.getTokenOffset()>=r){let i=d.getTokenOffset();if(a){let r=e.positionAt(c),o=e.positionAt(i);return interpolationService.findDefinition(e,n,{start:r,end:o},t,a)}c=-1}break;case vueScanner_1.TokenType.AttributeName:v=d.getTokenText().toLowerCase();break;case vueScanner_1.TokenType.AttributeValue:if(d.getTokenOffset()<=r&&r<=d.getTokenEnd()){let i=d.getTokenOffset(),o=d.getTokenEnd();if("'"!==l[i]&&'"'!==l[i]||(i++,o--),"class"===v){let t=l.charAt(r).trimLeft(),a=l.charAt(r-1).trimLeft();if(""!==t||""!==a){let t=this.getClassText(l,i,o,r);return this.findCssClass(e,n,t)}}else if(this.vueEnable&&a&&(/^(v-|[:@])\S+/.test(v)||"collection"==v)){let r=e.positionAt(i),s=e.positionAt(o);return interpolationService.findDefinition(e,n,{start:r,end:s},t,a)}}}u=d.scan()}return Promise.resolve(null)}async doHover(e,t,n){var i,r,o;let a=e.offsetAt(t),s=n.findNodeAt(a);if(!s)return Promise.resolve(null);const l=this.getRootFolder(e.uri);if(!l)return Promise.resolve(null);let c=a,d=e.getText(),u=-1;const v=(0,vueScanner_1.createScanner)(d,s.start);let m=v.scan();for(;m!==vueScanner_1.TokenType.EOS&&v.getTokenOffset()<=c;){switch(m){case vueScanner_1.TokenType.StartInterpolation:u=v.getTokenEnd(),c=Math.max(a,null!==(i=s.endTagStart)&&void 0!==i?i:s.end);break;case vueScanner_1.TokenType.EndInterpolation:if(-1!=u&&v.getTokenOffset()>=a){let i=v.getTokenOffset();if(l){let r=e.positionAt(u),o=e.positionAt(i);return interpolationService.doHover(e,n,{start:r,end:o},t,l)}u=-1}break;case vueScanner_1.TokenType.AttributeName:let d=v.getTokenText();if(v.getTokenOffset()<=a&&a<=v.getTokenEnd()){let t=s.tag,i=easycomService.collectEasycoms(e,n,l).find((e=>e.name==t));if(i){let t=easycomService.fetchVueComponentInfo(i.filePath);if(t){let n=null===(r=t.properties)||void 0===r?void 0:r.find((e=>d==e.name||d==":"+e.name||d=="v-bind:"+e.name)),i=null===(o=t.events)||void 0===o?void 0:o.find((e=>d==e.name||d=="@"+e.name||d=="v-on:"+e.name));if(n){let i=[];return i.push(`**${n.name}**`),i.push("<hr>"),n.description&&(i.push(`${n.description}`),i.push("<br />"),i.push("<br />")),i.push(`<b>定义于：</b> <a href='file://${t.filePath}'>${path.relative(vscode_uri_1.URI.parse(null==l?void 0:l.uri).fsPath,t.filePath)}</a>`),{range:{start:e.positionAt(v.getTokenOffset()),end:e.positionAt(v.getTokenEnd())},contents:{kind:"markdown",value:i.join("\n")}}}if(i){let n=[];return n.push(`**${i.name}**`),n.push("<hr>"),i.description&&(n.push(`${i.description}`),n.push("<br />"),n.push("<br />")),n.push(`<b>定义于：</b> <a href='file://${t.filePath}'>${path.relative(vscode_uri_1.URI.parse(null==l?void 0:l.uri).fsPath,t.filePath)}</a>`),{range:{start:e.positionAt(v.getTokenOffset()),end:e.positionAt(v.getTokenEnd())},contents:{kind:"markdown",value:n.join("\n")}}}}}}break;case vueScanner_1.TokenType.StartTag:case vueScanner_1.TokenType.EndTag:if(a>=v.getTokenOffset()&&a<=v.getTokenEnd()){let t=v.getTokenText(),i=easycomService.collectEasycoms(e,n,l).find((e=>e.name==t));if(i){let n=easycomService.fetchVueComponentInfo(i.filePath);if(n){let i=[];return i.push(`**${t}**`),i.push("<hr>"),n.description&&(i.push(`${n.description}`),i.push("<br />"),i.push("<br />")),i.push(`<b>定义于：</b> <a href='file://${n.filePath}'>${path.relative(vscode_uri_1.URI.parse(null==l?void 0:l.uri).fsPath,n.filePath)}</a>`),n.tutorial&&(i.push("<br />"),i.push(`<b>文档：</b><a data-kind='tutorial' href='${n.tutorial}'>${n.tutorial}</a>`)),{range:{start:e.positionAt(v.getTokenOffset()),end:e.positionAt(v.getTokenEnd())},contents:{kind:"markdown",value:i.join("\n")}}}}}}m=v.scan()}return Promise.resolve(null)}async doResolve(e,t,n){if(t.data&&t.data.kind){const e=t.data;if("vue-component"===e.kind){if(e.filePath){let n=easycomService.fetchVueComponentInfo(e.filePath);n&&(t.detail=n.description,t.documentation=n.description)}}else if("vue-mustache"===e.kind&&(t.kind==vscode_html_languageservice_1.CompletionItemKind.Function||t.kind==vscode_html_languageservice_1.CompletionItemKind.Method)&&t.insertTextFormat==vscode_html_languageservice_1.InsertTextFormat.PlainText){let e=t.label;e=e.replace(/\$/g,"\\$");let n=`${e}($1)$0`;return t.textEdit?t.textEdit.newText=n:t.insertText=n,t.insertTextFormat=vscode_html_languageservice_1.InsertTextFormat.Snippet,delete t.data,Promise.resolve(t)}}return Promise.resolve(t)}async doComplete(e,t,n,i,r){var o;let a=e.offsetAt(t),s=n.findNodeAt(a);if(!s)return Promise.resolve(vscode_languageserver_types_1.CompletionList.create());const l={isIncomplete:!1,items:[]};let c=a,d="",u="";const v=e.getText();this.vueDirectives;const m=this.getRootFolder(e.uri);let g=-1;this.vueEnable&&(g=2,m&&(g=(0,utils_1.vueVersion)(vscode_uri_1.URI.parse(m.uri).fsPath))),(r=null!=r?r:{}).vue_html=2===g,r.vue3_html=3===g;const f=this.dataProviders.filter((t=>t.isApplicable(e.languageId)&&(!r||!1!==r[t.getId()])));function p(t,n=a){return t>a&&(t=a),{start:e.positionAt(t),end:e.positionAt(n)}}function h(t,i,r=a){if(0===f.length)return l;v.slice(i,r);let o=v.slice(i,a),s=r;for(;s<r&&"<"!==v[s];)s++;const c={title:"Suggest",command:"editor.action.triggerSuggest"};function u(e,t){const n=p(t.start,t.end);e.forEach((e=>{l.items.push({label:e.label,kind:vscode_html_languageservice_1.CompletionItemKind.Method,textEdit:vscode_html_languageservice_1.TextEdit.replace(n,e.label),insertTextFormat:vscode_html_languageservice_1.InsertTextFormat.PlainText,documentation:(0,dataProviderUtils_1.normalizeMarkupContent)(e.documentation),data:{hxKind:utils_2.HxIconKind.ATTRIBUTE}})}))}if("@"===t||"v-on"==t){let o=1===t.length?t:"v-on:",s=o.length+i;for(;s<r&&v.charCodeAt(s)!==dotCharCode;)s++;if(a<=s)!function(t,i){let r=isFollowedBy(v,i.end,vueScanner_1.ScannerState.AfterAttributeName,vueScanner_1.TokenType.DelimiterAssign),o=r?void 0:c;const a=p(i.start,i.end);f.forEach((e=>{e.provideAttributes(d).forEach((e=>{var n,i;let s=0;if((null===(n=e.name)||void 0===n?void 0:n.startsWith(ModeExtension.VueEventPrefix))?s=ModeExtension.VueEventPrefix.length:(null===(i=e.name)||void 0===i?void 0:i.startsWith("on"))&&(s=2),s>0){const n=e.name.slice(s);let i=t+n+(r?"":'="$1"');l.items.push({label:t+n,kind:vscode_html_languageservice_1.CompletionItemKind.Function,documentation:(0,dataProviderUtils_1.generateDocumentation)(e,void 0,!0),textEdit:vscode_html_languageservice_1.TextEdit.replace(a,i),insertTextFormat:vscode_html_languageservice_1.InsertTextFormat.Snippet,command:o,data:{hxKind:utils_2.HxIconKind.EVENT}})}}))}));let s=easycomService.collectEasycoms(e,n,m).find((e=>e.name==d));if(s){let e=easycomService.fetchVueComponentInfo(s.filePath);e&&e.events&&e.events.forEach((e=>{if(e.name){let n=t+e.name+(r?"":'="$1"');l.items.push({label:t+e.name,kind:vscode_html_languageservice_1.CompletionItemKind.Function,documentation:e.description,textEdit:vscode_html_languageservice_1.TextEdit.replace(a,n),insertTextFormat:vscode_html_languageservice_1.InsertTextFormat.Snippet,command:o,data:{hxKind:utils_2.HxIconKind.EVENT}})}}))}}(o,{start:i,end:s});else if(s<r){const e=v.slice(o.length+i,s);let t=getModifierRange(v,a,{start:s+1,end:r});const n=["keydown","keypress","keyup"],l=["click","dblclick","mouseup","mousedown"];u(vueModifierProvider.eventModifiers,t),n.includes(e)?(u(vueModifierProvider.keyModifiers,t),u(vueModifierProvider.systemModifiers,t)):l.includes(e)&&(u(vueModifierProvider.mouseModifiers,t),u(vueModifierProvider.systemModifiers,t))}}else if(":"===t||"v-bind"===t){let o=1===t.length?t:"v-bind:",g=o.length+i;for(;g<r&&v.charCodeAt(g)!==dotCharCode;)g++;if(a<=g)!function(t,i){let r=[...f],o=isFollowedBy(e.getText(),i.end,vueScanner_1.ScannerState.AfterAttributeName,vueScanner_1.TokenType.DelimiterAssign),a=o?void 0:c;const s=p(i.start,i.end);r.forEach((e=>{e.provideAttributes(d).forEach((e=>{if(e.name&&!e.name.startsWith(ModeExtension.VueEventPrefix)&&!e.name.startsWith("on")&&!e.name.startsWith("v-")){let n=t+e.name+(o?"":'="$1"');l.items.push({label:t+e.name,kind:vscode_html_languageservice_1.CompletionItemKind.Value,documentation:(0,dataProviderUtils_1.generateDocumentation)(e,void 0,!0),textEdit:vscode_html_languageservice_1.TextEdit.replace(s,n),insertTextFormat:vscode_html_languageservice_1.InsertTextFormat.Snippet,command:a})}}))}));let u=easycomService.collectEasycoms(e,n,m).find((e=>e.name==d));if(u){let e=easycomService.fetchVueComponentInfo(u.filePath);e&&e.properties&&e.properties.forEach((e=>{if(e.name){let n=t+e.name+(o?"":'="$1"');l.items.push({label:t+e.name,kind:vscode_html_languageservice_1.CompletionItemKind.Value,documentation:e.description,textEdit:vscode_html_languageservice_1.TextEdit.replace(s,n),insertTextFormat:vscode_html_languageservice_1.InsertTextFormat.Snippet,command:a})}}))}}(o,{start:i,end:s});else if(g<r){let e=getModifierRange(v,a,{start:g+1,end:r});u(vueModifierProvider.propsModifiers,e)}}else if("v-model"===t){if(o.length<=t.length)return l;if("."===o[t.length]){let e=getModifierRange(v,a,{start:a,end:s});u(vueModifierProvider.propsModifiers,e),u(vueModifierProvider.vModelModifiers,e)}}let g=[],h=[];return l.items.forEach((e=>{g.includes(e.label)||(g.push(e.label),h.push(e))})),l.items=h,l}function _(t,i){if(m){let r=easycomService.collectEasycoms(e,n,m),o=p(t,i);r.forEach((t=>{l.items.push({label:t.name,kind:vscode_html_languageservice_1.CompletionItemKind.Property,data:{hxKind:utils_2.HxIconKind.ELEMENT,languageId:"vue-template",uri:e.uri,kind:"vue-component",filePath:t.filePath},textEdit:vscode_html_languageservice_1.TextEdit.replace(o,t.name+"$0></"+t.name+">"),insertTextFormat:vscode_html_languageservice_1.InsertTextFormat.Snippet})}))}return l}function T(t,n=a){if(m){let n=a,i=a;const r=[":".charCodeAt(0),".".charCodeAt(0)];for(;n>t&&!r.includes(v.charCodeAt(n-1));)n--;if(n==t){for(;i<t&&!r.includes(v.charCodeAt(i));)i++;let o=p(n,i);(0,customDirectives_1.getCustomDirectives)(m,e.uri).forEach((e=>{e="v-"+e,l.items.push({label:e,kind:vscode_html_languageservice_1.CompletionItemKind.Property,textEdit:vscode_html_languageservice_1.TextEdit.replace(o,e)})}))}}}let E=-1;const S=(0,vueScanner_1.createScanner)(v,s.start);let k=S.scan(),x=!1,y=!1;for(;k!==vueScanner_1.TokenType.EOS&&S.getTokenOffset()<=c&&!x;){switch(k){case vueScanner_1.TokenType.StartTagOpen:if(S.getTokenEnd()===a){let e=a;k=S.scan(),k===vueScanner_1.TokenType.StartTag&&S.getTokenOffset()===a&&(e=S.getTokenEnd()),_(a,e),x=!0}break;case vueScanner_1.TokenType.StartTag:S.getTokenOffset()<=a&&a<=S.getTokenEnd()&&(_(S.getTokenOffset(),S.getTokenEnd()),x=!0),d=S.getTokenText();break;case vueScanner_1.TokenType.EndTagOpen:case vueScanner_1.TokenType.EndTag:y=!0;break;case vueScanner_1.TokenType.EndTagClose:y=!1;break;case vueScanner_1.TokenType.StartInterpolation:E=S.getTokenEnd(),c=Math.max(a,null!==(o=s.endTagStart)&&void 0!==o?o:s.end);break;case vueScanner_1.TokenType.EndInterpolation:if(this.vueEnable&&-1!=E&&S.getTokenOffset()>=a){let i=S.getTokenOffset();if(m){let r=e.positionAt(E),o=e.positionAt(i);return interpolationService.doCompletion2(e,n,{start:r,end:o},t,m)}E=-1}break;case vueScanner_1.TokenType.AttributeName:if(u=S.getTokenText(),d&&S.getTokenOffset()<=a&&a<=S.getTokenEnd()){let t=d,i=easycomService.collectEasycoms(e,n,m).find((e=>e.name==t));if(i){let e=easycomService.fetchVueComponentInfo(i.filePath);if(e&&e.properties){var b=isFollowedBy(v,S.getTokenEnd(),vueScanner_1.ScannerState.AfterAttributeName,vueScanner_1.TokenType.DelimiterAssign)?"":'="$1"';let t={title:"Suggest",command:"editor.action.triggerSuggest"},n=p(S.getTokenOffset(),S.getTokenEnd());e.properties.forEach(((e,i)=>{l.items.push({label:e.name,kind:vscode_html_languageservice_1.CompletionItemKind.Property,documentation:e.description,textEdit:vscode_html_languageservice_1.TextEdit.replace(n,e.name+b),insertTextFormat:vscode_html_languageservice_1.InsertTextFormat.Snippet,command:b.length>0?t:void 0})}))}}if(this.vueEnable)if(/^s(cript|tyle)/.test(d))r.html5=!1;else{let e=S.getTokenOffset(),t=S.getTokenEnd(),n=checkVueBindOrOnDirective(v.slice(e,a));if(n.length>0)return h(n,e,t);T(e,t)}x=!0;break}break;case vueScanner_1.TokenType.AttributeValue:if(this.vueEnable&&/^(v-|[:@])\S+/.test(u)){if("unicloud-db"!=d||"v-slot:default"!=u){let i=S.getTokenOffset(),r=S.getTokenEnd();if("'"!==v[i]&&'"'!==v[i]||i++,r>i&&("'"===v[r-1]||'"'===v[r-1])&&r--,i<=a&&a<=r&&m){let o=e.positionAt(i),a=e.positionAt(r);return interpolationService.doCompletion2(e,n,{start:o,end:a},t,m)}}}else{let t=s.tag,i=easycomService.collectEasycoms(e,n,m).find((e=>e.name==t));if(i){let e=easycomService.fetchVueComponentInfo(i.filePath);if(e&&e.properties){let t=e.properties.find((e=>u==e.name));t&&t.values&&t.values.forEach(((e,t)=>{l.items.push({label:t,detail:e.description})}))}}}break;case vueScanner_1.TokenType.Whitespace:if(a<=S.getTokenEnd()){const e=S.getScannerState();x=e==vueScanner_1.ScannerState.WithinTag||e==vueScanner_1.ScannerState.AfterAttributeName,x&&this.vueEnable&&(/^s(cript|tyle)/.test(d)?r.html5=!1:T(a,a))}}k=S.scan()}let A=/^s(cript|tyle)/.test(d),I=await i(r),C=[];return I.items.forEach((t=>{var n,i;if(t.label&&!t.label.startsWith(ModeExtension.VueEventPrefix)){if(t.kind===vscode_html_languageservice_1.CompletionItemKind.Property){if(-1===t.label.search(/^<?\//)&&t.textEdit&&t.textEdit.newText)if(selfColsingTags.includes(t.label)){let e="br"!==t.label;t.insertTextFormat=e?vscode_html_languageservice_1.InsertTextFormat.Snippet:vscode_html_languageservice_1.InsertTextFormat.PlainText,t.textEdit.newText=t.label+(e?" $1/>":" />")}else t.insertTextFormat=vscode_html_languageservice_1.InsertTextFormat.Snippet,t.textEdit.newText=t.label+"$0></"+t.label+">";if(!y&&t.label.startsWith("/"))return}else if(this.vueDirectives.has(t.label)){if(A)return;let e=vueDirectiveType(t.label);e!=VueDirectiveType.Event&&e!=VueDirectiveType.Attribute||t.textEdit&&(t.textEdit.newText=t.label+":"),e!=VueDirectiveType.Empty&&(t.command={title:"Suggest",command:"editor.action.triggerSuggest"})}else if(t.kind===vscode_html_languageservice_1.CompletionItemKind.Function||t.kind===vscode_html_languageservice_1.CompletionItemKind.Value){if(this.vueEnable&&"vue"==e.languageId&&("data-"==t.label||t.label.startsWith("on")))return;!t.command&&(null==t?void 0:t.insertTextFormat)===vscode_html_languageservice_1.InsertTextFormat.Snippet&&(null===(i=null===(n=t.textEdit)||void 0===n?void 0:n.newText)||void 0===i?void 0:i.includes("$1"))&&(t.command={title:"Suggest",command:"editor.action.triggerSuggest"})}t.data&&void 0!==t.data.hxKind||(t.kind===vscode_html_languageservice_1.CompletionItemKind.Value&&t.label.startsWith("on")?t.data={hxKind:utils_2.HxIconKind.EVENT,data:t.data}:t.kind&&iconKindMap.has(t.kind)&&(t.data={hxKind:iconKindMap.get(t.kind),data:t.data})),t.textEdit&&"scoped"===t.label&&(t.command=void 0,t.textEdit.newText=t.label),C.push(t)}})),I.items=C,l.items.push(...I.items),l.isIncomplete=I.isIncomplete,l}updateDataProviders(e){this.dataProviders=[],this.vueDirectives.clear(),this.dataProviders.push(...e),this.dataProviders.forEach((e=>{"vue_html"!=e.getId()&&"vue3_html"!=e.getId()||e.provideAttributes("").forEach((e=>{e.name.startsWith("v-")&&this.vueDirectives.add(e.name)}))}))}setHtmlDocuments(e){this.documents=e}}function getHtmlModeExt(e,t,n,i){return new HTMLLanguageServiceExt(e,t,n,i)}exports.getHtmlModeExt=getHtmlModeExt;