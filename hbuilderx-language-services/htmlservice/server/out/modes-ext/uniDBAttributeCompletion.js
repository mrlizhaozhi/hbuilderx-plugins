"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UnicloudDBAttributeCompletion=void 0;const vscode_html_languageservice_1=require("vscode-html-languageservice"),vscode_uri_1=require("vscode-uri"),utils_1=require("../../../../utils"),strings_1=require("../utils/strings"),interpolationDocProvider_1=require("./utils/interpolationDocProvider"),ts=require("typescript"),{node:node}=require("../../../../lib/field"),slotDefaultKey=["data","pagination","loading","hasMore","error","options"];let documentVersion=100;function getLanguageService(t,e){let i=utils_1.hx.getProject(t);if(i)return i.createTSLanguageService(e)}function attributeInfo(t){const e=t.document,i=e.getText(t.range),o=(0,strings_1.stripQuotes)(i);let r=e.offsetAt(t.position),n=r-e.offsetAt(t.range.start);return o.length!=i.length&&n--,{value:o,offset:r,innerOffset:n}}class UnicloudDBAttributeCompletion{constructor(t){this.documentCache=t,this.attributeCompletions=[],this.documentProvider=new interpolationDocProvider_1.InterpolationDocProvider}onHtmlAttributeValue(t){"unicloud-db"==t.tag&&this.attributeCompletions.push(t)}beginCompletion(t){this.currentWorkspace=null==t?void 0:t.workspaceFolder,this.attributeCompletions=[]}getCompletionOptions(t,e,i){const o=this.currentWorkspace?vscode_uri_1.URI.parse(this.currentWorkspace.uri).fsPath:void 0,r=t.getText(i.range),n=(0,strings_1.stripQuotes)(r);let s=t.offsetAt(i.position),l=s-t.offsetAt(i.range.start);n.length!=r.length&&l--;let u=e.findNodeAt(s),a={};if(u.attributes){for(let t in u.attributes){let e=u.attributes[t];a[t]=e?(0,strings_1.stripQuotes)(e):null}a[i.attribute]=null}return{workspaceFolder:o,locationType:utils_1.SpecialValueLocationType.IN_HTML,replaceRange:i.range,htmlContext:{currentAttribute:{name:i.attribute,value:n,offset:l},attributes:a,docOffset:s}}}async computeCompletions(t,e,i){const o={items:[],isIncomplete:!1};if(!this.currentWorkspace)return o;const r=vscode_uri_1.URI.parse(this.currentWorkspace.uri).fsPath;this.documentCache.get(t);if(this.attributeCompletions.length>0){const i=this.attributeCompletions[0];if("collection"==i.attribute){let e={workspaceFolder:r,locationType:utils_1.SpecialValueLocationType.IN_HTML,replaceRange:i.range};return(0,utils_1.doComplete)(["HBuilderX.DBCollectionString"],i.position,t,e).forEach((t=>{t.kind==vscode_html_languageservice_1.CompletionItemKind.Property&&(t.data={hxKind:utils_1.HxIconKind.ATTRIBUTE}),o.items.push(t)})),o}if("field"==i.attribute||"orderby"==i.attribute){let r=this.getCompletionOptions(t,e,i);return(0,utils_1.doComplete)(["HBuilderX.DBFieldString"],i.position,t,r).forEach((t=>{t.kind==vscode_html_languageservice_1.CompletionItemKind.Property&&(t.data={hxKind:utils_1.HxIconKind.ATTRIBUTE}),o.items.push(t)})),o}if("where"==i.attribute){let r=this.getCompletionOptions(t,e,i);return(0,utils_1.doComplete)(["HBuilderX.JQLString"],i.position,t,r).forEach((t=>{t.kind==vscode_html_languageservice_1.CompletionItemKind.Property&&(t.data={hxKind:utils_1.HxIconKind.ATTRIBUTE}),o.items.push(t)})),o}if("v-slot:default"==i.attribute){let t=getLanguageService(r,this.documentProvider);if(t){documentVersion++;const e=attributeInfo(i),r="file:///__slot_value.ts",n=vscode_html_languageservice_1.TextDocument.create(r,"typescript",documentVersion,e.value);this.documentProvider.setDocuments([n]),this.documentProvider.updateVersion();let s=t.getProgram(),l=null==s?void 0:s.getSourceFile(r),u=l?(0,utils_1.findNodePathByOffset)(l,e.innerOffset):[];for(let t=u.length-1;t>=0;--t){let e=u[t];if(e.kind==ts.SyntaxKind.Identifier||e.kind==ts.SyntaxKind.Block){o.items=slotDefaultKey.map((t=>({label:t,kind:vscode_html_languageservice_1.CompletionItemKind.Property,data:{hxKind:utils_1.HxIconKind.ATTRIBUTE}})));break}}}}}return o}}exports.UnicloudDBAttributeCompletion=UnicloudDBAttributeCompletion;