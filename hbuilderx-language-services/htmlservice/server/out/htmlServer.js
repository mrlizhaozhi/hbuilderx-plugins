"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.startServer=void 0;const vscode_languageserver_1=require("vscode-languageserver"),languageModes_1=require("./modes/languageModes"),vscode_uri_1=require("vscode-uri"),formatting_1=require("./modes/formatting"),arrays_1=require("./utils/arrays"),documentContext_1=require("./utils/documentContext"),runner_1=require("./utils/runner"),customData_1=require("./customData"),htmlFolding_1=require("./modes/htmlFolding"),selectionRanges_1=require("./modes/selectionRanges"),semanticTokens_1=require("./modes/semanticTokens"),requests_1=require("./requests"),path=require("path"),cssModeExtension_1=require("./modes-ext/cssModeExtension"),vueTemplateMode_1=require("./modes/vueTemplateMode"),formattingSettings_1=require("./utils/formattingSettings"),imageSize=require("image-size");var CustomDataChangedNotification,TagCloseRequest,OnTypeRenameRequest,SemanticTokenRequest,SemanticTokenLegendRequest;function startServer(e,t){const n=new vscode_languageserver_1.TextDocuments(languageModes_1.TextDocument);n.listen(e);let o,r=[],i=!1,s=!1,a=!1,u=!1,c=Number.MAX_VALUE;const l=()=>Promise.reject("Not Ready");let g={getContent:l,stat:l,readDirectory:l},m={},d={};function f(t,n){if(a&&n()){let n=d[t.uri];if(!n){const o=t.uri,r={items:[{scopeUri:o,section:"css"},{scopeUri:o,section:"html"},{scopeUri:o,section:"javascript"}]};n=e.sendRequest(vscode_languageserver_1.ConfigurationRequest.type,r).then((e=>({css:e[0],html:e[1],javascript:e[2]}))),d[t.uri]=n}return n}return Promise.resolve(void 0)}n.onDidClose((e=>{delete d[e.document.uri]})),e.onInitialize((l=>{const d=l.initializationOptions;r=l.workspaceFolders,Array.isArray(r)||(r=[],l.rootPath&&r.push({name:"",uri:vscode_uri_1.URI.file(l.rootPath).toString()})),g=(0,requests_1.getRequestService)(l.initializationOptions.handledSchemas||["file"],e,t);const f={get settings(){return m},get folders(){return r}};(0,vueTemplateMode_1.initDataProviders)(r.map((e=>e.uri))),o=(0,languageModes_1.getLanguageModes)(d?d.embeddedLanguages:{css:!0,javascript:!0},f,l.capabilities,g),o.getAllModes().forEach((e=>{var t;null===(t=e.setDocuments)||void 0===t||t.call(e,n)}));const p=l.initializationOptions.dataPaths||[];function h(e,t){const n=e.split(".");let o=l.capabilities;for(let e=0;o&&e<n.length;e++){if(!o.hasOwnProperty(n[e]))return t;o=o[n[e]]}return o}(0,customData_1.fetchHTMLDataProviders)(p,g).then((e=>{o.updateDataProviders(e)})),n.onDidClose((e=>{o.onDocumentRemoved(e.document)})),e.onShutdown((()=>{o.dispose()})),i=h("textDocument.completion.completionItem.snippetSupport",!1),s=h("textDocument.rangeFormatting.dynamicRegistration",!1)&&"boolean"!=typeof l.initializationOptions.provideFormatter,a=h("workspace.configuration",!1),u=h("workspace.workspaceFolders",!1),c=h("textDocument.foldingRange.rangeLimit",Number.MAX_VALUE);return{capabilities:{textDocumentSync:vscode_languageserver_1.TextDocumentSyncKind.Incremental,completionProvider:i?{resolveProvider:!0,triggerCharacters:[".",":","<",'"',"=","/"]}:void 0,hoverProvider:!0,documentHighlightProvider:!0,documentRangeFormattingProvider:!0===l.initializationOptions.provideFormatter,documentLinkProvider:{resolveProvider:!1},documentSymbolProvider:!0,definitionProvider:!0,signatureHelpProvider:{triggerCharacters:["("]},referencesProvider:!0,colorProvider:{},foldingRangeProvider:!0,selectionRangeProvider:!0,renameProvider:!0}}})),e.onInitialized((()=>{u&&(e.client.register(vscode_languageserver_1.DidChangeWorkspaceFoldersNotification.type),e.onNotification(vscode_languageserver_1.DidChangeWorkspaceFoldersNotification.type,(e=>{const t=e.event.added,o=e.event.removed,i=[];if(r)for(const e of r)o.some((t=>t.uri===e.uri))||t.some((t=>t.uri===e.uri))||i.push(e);r=i.concat(t),(0,vueTemplateMode_1.initDataProviders)(t.map((e=>e.uri))),n.all().forEach(_)}))),cssModeExtension_1.cssModeExtensionEnv.scopedSettingsSupport=a,cssModeExtension_1.cssModeExtensionEnv.serverConnection=e,(0,formattingSettings_1.formattingSettingListen)(e)}));let p=null;e.onDidChangeConfiguration((t=>{if(m=t.settings,d={},n.all().forEach(_),s){if(m&&m.html&&m.html.format&&m.html.format.enable){if(!p){const t=[{language:"html"},{language:"handlebars"}];p=e.client.register(vscode_languageserver_1.DocumentRangeFormattingRequest.type,{documentSelector:t})}}else p&&(p.then((e=>e.dispose())),p=null)}}));const h={};function v(e){const t=h[e.uri];t&&(clearTimeout(t),delete h[e.uri])}function _(t){v(t),h[t.uri]=setTimeout((()=>{delete h[t.uri],async function(t){try{const r=t.version,i=[];if("html"===t.languageId||"vue"===t.languageId){const s=o.getAllModesInDocument(t),a=await f(t,(()=>s.some((e=>!!e.doValidation)))),u=n.get(t.uri);if(u&&u.version===r){for(const e of s)e.doValidation&&D(e.getId(),a)&&(0,arrays_1.pushAll)(i,await e.doValidation(u,a));e.sendDiagnostics({uri:u.uri,diagnostics:i})}}}catch(n){e.console.error((0,runner_1.formatError)(`Error while validating ${t.uri}`,n))}}(t)}),500)}function D(e,t=m){const n=t&&t.html&&t.html.validate;return n?"css"===e&&!1!==n.styles||"javascript"===e&&!1!==n.scripts:"javascript"===e||"typescript"===e}let y;function R(){return y||(y=(0,semanticTokens_1.newSemanticTokenProvider)(o)),y}n.onDidChangeContent((e=>{_(e.document)})),n.onDidClose((t=>{v(t.document),e.sendDiagnostics({uri:t.document.uri,diagnostics:[]})})),e.onDidChangeWatchedFiles((e=>{e.changes.forEach((e=>{if("package.json"==path.basename(e.uri)){let t=path.dirname(e.uri);for(let e=0;e<r.length;e++){let n=r[e].uri;n==t&&(0,vueTemplateMode_1.initDataProviders)([n])}}}))})),e.onCompletion((async(t,i)=>(0,runner_1.runSafe)((async()=>{const i=n.get(t.textDocument.uri);if(!i)return null;const s=o.getModeAtPosition(i,t.position);if(!s||!s.doComplete)return{isIncomplete:!0,items:[]};const a=s.doComplete;"html"!==s.getId()&&e.telemetry.logEvent({key:"html.embbedded.complete",value:{languageId:s.getId()}});const u=await f(i,(()=>a.length>2)),c=(0,documentContext_1.getDocumentContext)(i.uri,r);return await a(i,t.position,c,u)}),null,`Error while computing completions for ${t.textDocument.uri}`,i))),e.onCompletionResolve(((e,t)=>(0,runner_1.runSafe)((async()=>{let t=e.data;if(t&&Object.keys(t).length<=2&&void 0!==t.hxKind&&(e.data=t.data,t=t.data),t)if(t.isPathCompletion){if(t.imageUri){let n={width:230,height:180},o=vscode_uri_1.URI.parse(t.imageUri).fsPath;try{let r=imageSize(o),i="";if(".svg"!=o.slice(-4).toLocaleLowerCase()){let e=Math.min(n.width/r.width,n.height/r.height);e=Math.min(e,1),e<1&&(i=r.width>r.height?`width="${r.width*e}"`:`height="${r.height*e}"`)}let s={...e};return delete e.data.data,s.documentation={kind:vscode_languageserver_1.MarkupKind.Markdown,value:`<div align='center'><br/><img ${i} src="${t.imageUri}"/></div>`},s}catch(e){}}}else if(t.languageId&&t.uri){const r=o.getMode(t.languageId),i=n.get(t.uri);if(r&&r.doResolve&&i)return e.data.hxHtmlFlag="hxHtmlFlag"+t.languageId,r.doResolve(i,e)}return e}),e,"Error while resolving completion proposal",t))),e.onHover(((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);if(t){const n=o.getModeAtPosition(t,e.position);if(n&&n.doHover)return n.doHover(t,e.position)}return null}),null,`Error while computing hover for ${e.textDocument.uri}`,t))),e.onDocumentHighlight(((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);if(t){const n=o.getModeAtPosition(t,e.position);if(n&&n.findDocumentHighlight)return n.findDocumentHighlight(t,e.position)}return[]}),[],`Error while computing document highlights for ${e.textDocument.uri}`,t))),e.onDefinition(((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);if(t){const n=o.getModeAtPosition(t,e.position);if(n&&n.findDefinition)return n.findDefinition(t,e.position)}return[]}),null,`Error while computing definitions for ${e.textDocument.uri}`,t))),e.onReferences(((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);if(t){const n=o.getModeAtPosition(t,e.position);if(n&&n.findReferences)return n.findReferences(t,e.position)}return[]}),[],`Error while computing references for ${e.textDocument.uri}`,t))),e.onSignatureHelp(((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);if(t){const n=o.getModeAtPosition(t,e.position);if(n&&n.doSignatureHelp)return n.doSignatureHelp(t,e.position)}return null}),null,`Error while computing signature help for ${e.textDocument.uri}`,t))),e.onDocumentRangeFormatting((async(e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);if(t){let n=await f(t,(()=>!0));n||(n=m);const r=n&&n.html&&n.html.format&&n.html.format.unformatted||"",i={css:!r.match(/\bstyle\b/),javascript:!r.match(/\bscript\b/)};return i["vue-style"]=i.css,n.css=await(0,formattingSettings_1.getCssSettings)(),(0,formatting_1.format)(o,t,e.range,e.options,n,i)}return[]}),[],`Error while formatting range for ${e.textDocument.uri}`,t))),e.onDocumentLinks(((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri),i=[];if(t){const e=(0,documentContext_1.getDocumentContext)(t.uri,r);for(const n of o.getAllModesInDocument(t))n.findDocumentLinks&&(0,arrays_1.pushAll)(i,await n.findDocumentLinks(t,e))}return i}),[],`Error while document links for ${e.textDocument.uri}`,t))),e.onDocumentSymbol(((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri),r=[];if(t)for(const e of o.getAllModesInDocument(t))e.findDocumentSymbols&&(0,arrays_1.pushAll)(r,await e.findDocumentSymbols(t));return r}),[],`Error while computing document symbols for ${e.textDocument.uri}`,t))),e.onRequest(vscode_languageserver_1.DocumentColorRequest.type,((e,t)=>(0,runner_1.runSafe)((async()=>{const t=[],r=n.get(e.textDocument.uri);if(r)for(const e of o.getAllModesInDocument(r))e.findDocumentColors&&(0,arrays_1.pushAll)(t,await e.findDocumentColors(r));return t}),[],`Error while computing document colors for ${e.textDocument.uri}`,t))),e.onRequest(vscode_languageserver_1.ColorPresentationRequest.type,((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);if(t){const n=o.getModeAtPosition(t,e.range.start);if(n&&n.getColorPresentations)return n.getColorPresentations(t,e.color,e.range)}return[]}),[],`Error while computing color presentations for ${e.textDocument.uri}`,t))),e.onRequest(TagCloseRequest.type,((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);if(t){const n=e.position;if(n.character>0){const e=o.getModeAtPosition(t,languageModes_1.Position.create(n.line,n.character-1));if(e&&e.doAutoClose)return e.doAutoClose(t,n)}}return null}),null,`Error while computing tag close actions for ${e.textDocument.uri}`,t))),e.onFoldingRanges(((e,t)=>(0,runner_1.runSafe)((async()=>{const r=n.get(e.textDocument.uri);return r?(0,htmlFolding_1.getFoldingRanges)(o,r,c,t):null}),null,`Error while computing folding regions for ${e.textDocument.uri}`,t))),e.onSelectionRanges(((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);return t?(0,selectionRanges_1.getSelectionRanges)(o,t,e.positions):[]}),[],`Error while computing selection ranges for ${e.textDocument.uri}`,t))),e.onRenameRequest(((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri),r=e.position;if(t){const n=o.getMode("html");if(n&&n.doRename)return n.doRename(t,r,e.newName)}return null}),null,`Error while computing rename for ${e.textDocument.uri}`,t))),e.onRequest(OnTypeRenameRequest.type,((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);if(t){const n=e.position;if(n.character>0){const e=o.getModeAtPosition(t,languageModes_1.Position.create(n.line,n.character-1));if(e&&e.doOnTypeRename)return e.doOnTypeRename(t,n)}}return null}),null,`Error while computing synced regions for ${e.textDocument.uri}`,t))),e.onRequest(SemanticTokenRequest.type,((e,t)=>(0,runner_1.runSafe)((async()=>{const t=n.get(e.textDocument.uri);return t?R().getSemanticTokens(t,e.ranges):null}),null,`Error while computing semantic tokens for ${e.textDocument.uri}`,t))),e.onRequest(SemanticTokenLegendRequest.type,((e,t)=>(0,runner_1.runSafe)((async()=>R().legend),null,"Error while computing semantic tokens legend",t))),e.onNotification(CustomDataChangedNotification.type,(e=>{(0,customData_1.fetchHTMLDataProviders)(e,g).then((e=>{o.updateDataProviders(e)}))})),e.listen()}!function(e){e.type=new vscode_languageserver_1.NotificationType("html/customDataChanged")}(CustomDataChangedNotification||(CustomDataChangedNotification={})),function(e){e.type=new vscode_languageserver_1.RequestType("html/tag")}(TagCloseRequest||(TagCloseRequest={})),function(e){e.type=new vscode_languageserver_1.RequestType("html/onTypeRename")}(OnTypeRenameRequest||(OnTypeRenameRequest={})),function(e){e.type=new vscode_languageserver_1.RequestType("html/semanticTokens")}(SemanticTokenRequest||(SemanticTokenRequest={})),function(e){e.type=new vscode_languageserver_1.RequestType("html/semanticTokenLegend")}(SemanticTokenLegendRequest||(SemanticTokenLegendRequest={})),exports.startServer=startServer;