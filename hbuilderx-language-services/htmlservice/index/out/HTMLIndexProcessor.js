"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createFileIndexProcessor=void 0;var vscode_html_languageservice_1=require("vscode-html-languageservice"),indexlib_1=require("../../../indexlib"),pathresolve_1=require("./pathresolve"),vscode_uri_1=require("vscode-uri"),htmlBasicTags=null;function initHtmlBasicTags(){htmlBasicTags||(htmlBasicTags=new Set,(0,vscode_html_languageservice_1.getDefaultHTMLDataProvider)().provideTags().forEach((function(e){htmlBasicTags.add(e.name)})))}function normalizeRef(e){var t=e[0];return t!==e[e.length-1]||"'"!==t&&'"'!==t||(e=e.substr(1,e.length-2)),e}function validateRef(e,t){return!!e.length&&(("handlebars"!==t||!/{{|}}/.test(e))&&/\b(w[\w\d+.-]*:\/\/)?[^\s()<>]+(?:\([\w\d]+\)|([^[:punct:]\s]|\/?))/.test(e))}function parseReferenceUri(e,t,s,r){var n=normalizeRef(t);if(validateRef(n,e.languageId)&&!(/^\s*javascript\:/i.test(n)||/[\n\r]/.test(n)||/^\#/i.test(n)||/^\/\//i.test(n)||/^https?:\/\//i.test(n)))return/^file:\/\//i.test(n)?n:s.resolveReference(n,r||e.uri)}var HTMLFileIndexProcessor=function(){function e(e){this.lastUri="",this.lastProcTime=-1,this.processorMnger=e,this.languageService=(0,vscode_html_languageservice_1.getLanguageService)()}return e.prototype.support=function(e,t){if(this.lastUri&&e.uri==this.lastUri&&process.uptime()-this.lastProcTime<1)return!1;if(this.lastUri="","vue"==e.languageId||"html"==e.languageId||"html_es6"==e.languageId)return!0;var s=e.uri.toLowerCase();return s.endsWith(".html")||s.endsWith(".vue")},e.prototype.doIndex=function(e,t){var s,r=this;initHtmlBasicTags();this.languageService.parseHTMLDocument(e);var n=(0,pathresolve_1.getDocumentContext)(e.uri,null==t?void 0:t.uri),a=this.searchHtmlNode(e,n,{css:!0,script:!0}),i=a.htmlIndex,o=new indexlib_1.IndexData;i.id.length>0&&(o.categories.push(indexlib_1.IndexDataCategory.ID),o[indexlib_1.IndexDataCategory.ID]=i.id),i.class.length>0&&(o.categories.push(indexlib_1.IndexDataCategory.CLASS),o[indexlib_1.IndexDataCategory.CLASS]=i.class),i.references&&i.references.length>0&&(s=o.references).push.apply(s,i.references),i["vue-components"].length>0&&(o.categories.push("vue-components"),o["vue-components"]=i["vue-components"]);var l=new Set;return a.otherLanguage.forEach((function(e){l.add(e.language)})),l.forEach((function(s){var n=r.getEmbeddedDocument(e,a.otherLanguage,s);r.processorMnger.getProcessorForLanguage(s).forEach((function(s){var r;if(s.support(n,t,e)){var a=s.doIndex(n,t,e);a.categories.forEach((function(t){-1===o.categories.indexOf(t)&&(o.categories.push(t),o[t]=[]);var s=o[t];a[t].forEach((function(t){!t.offset&&t.position&&(t.offset=e.offsetAt(t.position)),s.push(t)}))})),(r=o.references).push.apply(r,a.references)}}))})),this.lastUri=e.uri,this.lastProcTime=process.uptime(),o},e.prototype.getEmbeddedDocument=function(e,t,s){function r(e,t,s,r,n,a){var i=0;e+=n;for(var o=t+n.length;o<s;o++){var l=r[o];"\n"===l||"\r"===l?(i=0,e+=l):i++}return e=function(e,t,s){for(;s>0;)1&s&&(e+=t),s>>=1,t+=t;return e}(e," ",i-a.length),e+=a}for(var n=0,a=e.getText(),i="",o="",l=0,c=t;l<c.length;l++){var u=c[l];if(u.language===s){var g=u.isAttribute&&"css"==u.language?"__{":"";if(i=r(i,n,u.start,a,o,g),i+=a.substring(u.start,u.start+u.length),n=u.start+u.length,u.isAttribute)switch(u.language){case"css":o="}";break;case"javascript":o=";"}o=""}}return i=r(i,n,a.length,a,o,""),vscode_html_languageservice_1.TextDocument.create(e.uri,s,e.version,i)},e.prototype.searchHtmlNode=function(e,t,s){for(var r,n,a,i={id:[],class:[],"vue-components":[],references:[]},o=[],l=new Set,c=new Set,u=void 0,g="",f="",h=e.getText(),d=this.languageService.createScanner(h),v=d.scan(),p={},m=null,T={events:[]};v!=vscode_html_languageservice_1.TokenType.EOS;){switch(v){case vscode_html_languageservice_1.TokenType.StartTag:m=e.positionAt(d.getTokenOffset()),g=d.getTokenText(),p={};break;case vscode_html_languageservice_1.TokenType.EndTag:g&&m&&!(null==htmlBasicTags?void 0:htmlBasicTags.has(g))&&T.events.length&&i["vue-components"].push({label:g,position:m,data:T}),g="",T={events:[]};break;case vscode_html_languageservice_1.TokenType.AttributeName:var _=(f=d.getTokenText()).match(/^(@|v-on:)([^\.:\s]*)/i),x=_?_[2]:"";x&&T.events.push(x);break;case vscode_html_languageservice_1.TokenType.AttributeValue:var b=d.getTokenText();if("base"===g&&"href"===f)(u=normalizeRef(b))&&t&&(u=t.resolveReference(u,e.uri));else if("link"==g){if("href"!==f&&"rel"!==f||(p[f]=normalizeRef(b)),"stylesheet"===p.rel&&p.href)if(I=parseReferenceUri(e,p.href,t,u))(k=(y=vscode_uri_1.URI.parse(I).fsPath).indexOf("?"))>=0&&(I=vscode_uri_1.URI.file(y.slice(0,k)).toString()),null===(r=i.references)||void 0===r||r.push({uri:I,type:indexlib_1.ReferenceFileType.CSS})}else if("script"==g){var I,y,k;if((null==s?void 0:s.script)&&"src"==f)if(I=parseReferenceUri(e,normalizeRef(b),t,u))(k=(y=vscode_uri_1.URI.parse(I).fsPath).indexOf("?"))>=0&&(I=vscode_uri_1.URI.file(y.slice(0,k)).toString()),null===(n=i.references)||void 0===n||n.push({uri:I,type:indexlib_1.ReferenceFileType.Script})}else if("style"==g)(null==s?void 0:s.css)&&"lang"==f&&(p.lang=d.getTokenText());else if("id"===f){var R=this.getIdIndexItem(e,d.getTokenText(),d.getTokenOffset());R.label&&!l.has(R.label)&&(l.add(R.label),i.id.push(R))}else if("class"===f){this.getClassIndexItems(e,d.getTokenText(),d.getTokenOffset()).forEach((function(e){c.has(e.label)||(i.class.push(e),c.add(e.label))}))}else if((null==s?void 0:s.css)||(null==s?void 0:s.script)){var S=f.match(/^(style)$|^(on\w+)$/i);if(S){var D=S[1]?"css":"javascript",E=d.getTokenOffset(),L=d.getTokenEnd(),P=h[E];"'"!==P&&'"'!==P||(E++,L--),o.push({language:D,start:E,length:L-E,isAttribute:!0})}}break;case vscode_html_languageservice_1.TokenType.Script:if(null==s?void 0:s.script){var w=p.type;D="javascript";w&&/["']text\/typescript["']/.test(w)&&(D="typescript"),o.push({language:D,start:d.getTokenOffset(),length:d.getTokenLength()})}break;case vscode_html_languageservice_1.TokenType.Styles:if(null==s?void 0:s.css)(D=normalizeRef(D=null!==(a=p.lang)&&void 0!==a?a:""))||(D="css"),o.push({language:D,start:d.getTokenOffset(),length:d.getTokenLength()})}v=d.scan()}return{otherLanguage:o,htmlIndex:i}},e.prototype.getIdIndexItem=function(e,t,s){var r=t[0],n=s+("'"===r||'"'===r?1:0);return{label:normalizeRef(t),position:e.positionAt(n),type:indexlib_1.IndexItemType.DEF,offset:n}},e.prototype.getClassIndexItems=function(e,t,s){for(var r=t[0],n=s+("'"===r||'"'===r?1:0),a=normalizeRef(t),i=n,o=[];a.length>0;){var l=a.search(/\s/);if(0!==l){var c=a.slice(0,-1===l?void 0:l);c&&o.push({label:c,position:e.positionAt(i),type:indexlib_1.IndexItemType.REF,offset:i}),i+=c.length}if(-1==l)break;a=a.slice(l+1),i++}return o},e}();function createFileIndexProcessor(e){return new HTMLFileIndexProcessor(e)}exports.createFileIndexProcessor=createFileIndexProcessor;