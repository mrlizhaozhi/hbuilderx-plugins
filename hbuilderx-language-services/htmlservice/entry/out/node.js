"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getTagAttributes=exports.getHtmlTags=exports.getLanguageServerExt=exports.HtmlServiceExtUtils=void 0;const chardet=require("chardet"),fs=require("fs"),vscode_html_languageservice_1=require("vscode-html-languageservice"),indexlib_1=require("../../../indexlib"),serverinterface_1=require("../../../serverinterface"),vscode_languageserver_1=require("vscode-languageserver"),vscode_languageserver_textdocument_1=require("vscode-languageserver-textdocument"),vscode_uri_1=require("vscode-uri"),utils_1=require("./utils"),dataProviderManager_1=require("./dataProviderManager"),utils_2=require("../../../utils");var utils_3=require("./utils");Object.defineProperty(exports,"HtmlServiceExtUtils",{enumerable:!0,get:function(){return utils_3.HtmlServiceExtUtils}});const dataManager=(0,dataProviderManager_1.getDataManager)();class HtmlLanguageServiceExt{constructor(){this.languageService=(0,vscode_html_languageservice_1.getLanguageService)()}findSymbol(e,t,r){return r?Promise.resolve().then((()=>{if(t.type!=serverinterface_1.SymbolType.ElementId)return[];let a=indexlib_1.IndexDataStore.load(r).allIndexData(),i=[];return a.forEach(((r,a)=>{r.references.find((r=>{if(r.uri===e.uri){let e=this.findIdInDocument(a,t.text);if(e)return i=vscode_languageserver_1.Location.create(a,e),!0}return!1}))})),i})):Promise.resolve([])}findIdInDocument(e,t){try{let r=fs.readFileSync(vscode_uri_1.URI.parse(e).fsPath),a=chardet.detect(r),i=r.toString(a||"utf-8");r=void 0;let s=vscode_languageserver_textdocument_1.TextDocument.create(e,"html",1,i),n=this.languageService.parseHTMLDocument(s),u=null;return utils_1.HtmlServiceExtUtils.searchHtmlNode(n.roots,(e=>{let r=utils_1.HtmlServiceExtUtils.getAttributeInDocument(s,this.languageService,e,"id");return!r||t!=s.getText(r)||(u=r,!1)})),u}catch(t){console.log("find id symbol in "+e+" faild:"+t)}return null}}function getLanguageServerExt(){let e=new HtmlLanguageServiceExt;return{findSymbol:(t,r,a)=>e.findSymbol(t,r,a)}}function getHtmlTags(e){let t=new Set;return e&&(0,utils_2.getProjectType)(vscode_uri_1.URI.parse(e.uri).fsPath)===utils_2.ProjectType.PT_UniApp_Vue?dataManager.vueDataProvides().forEach((e=>{e.provideTags().forEach((e=>{t.has(e.name)||t.add(e.name)}))})):dataManager.defaultDataProvider().provideTags().forEach((e=>{t.has(e.name)||t.add(e.name)})),Array.from(t.values())}function getTagAttributes(e,t){let r=new Set,a=[];a=e&&(0,utils_2.getProjectType)(vscode_uri_1.URI.parse(e.uri).fsPath)===utils_2.ProjectType.PT_UniApp_Vue?dataManager.vueDataProvides():[dataManager.defaultDataProvider()];const i=e=>{e.name.startsWith("[event]")||e.name.startsWith("on")||r.has(e.name)||r.add(e.name)};return void 0===t?a.forEach((e=>{var t,r,a;null===(t=e)||void 0===t||t._tags.forEach((e=>{e.attributes.forEach(i)})),null===(a=null===(r=e)||void 0===r?void 0:r._globalAttributes)||void 0===a||a.forEach(i)})):a.forEach((e=>{e.provideAttributes(t).forEach(i)})),Array.from(r.values())}exports.getLanguageServerExt=getLanguageServerExt,exports.getHtmlTags=getHtmlTags,exports.getTagAttributes=getTagAttributes;